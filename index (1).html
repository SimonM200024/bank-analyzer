<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer - NLB Statement Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f8fafc; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #34d399, #22d3ee); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .logo h1 { font-size: 20px; font-weight: 600; }
    .logo p { font-size: 12px; color: #64748b; }
    .upload-zone { border: 2px dashed #334155; border-radius: 16px; padding: 48px 24px; text-align: center; margin-bottom: 24px; background: rgba(30, 41, 59, 0.5); cursor: pointer; transition: all 0.3s; }
    .upload-zone:hover, .upload-zone.dragging { border-color: #34d399; background: rgba(52, 211, 153, 0.1); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 48px; margin-bottom: 16px; }
    .upload-zone h3 { font-size: 18px; margin-bottom: 8px; }
    .upload-zone p { color: #64748b; font-size: 14px; }
    .file-tags { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 16px; }
    .file-tag { padding: 6px 12px; background: rgba(52, 211, 153, 0.2); color: #34d399; border-radius: 20px; font-size: 13px; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
    .card-income { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-color: rgba(16, 185, 129, 0.2); }
    .card-expense { background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.05)); border-color: rgba(244, 63, 94, 0.2); }
    .card-balance { background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(34, 211, 238, 0.05)); border-color: rgba(34, 211, 238, 0.2); }
    .card-label { color: #94a3b8; font-size: 14px; margin-bottom: 8px; }
    .card-value { font-size: 28px; font-weight: 700; font-family: monospace; }
    .card-value.green { color: #34d399; }
    .card-value.red { color: #fb7185; }
    .card-value.blue { color: #22d3ee; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { padding: 24px; border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; }
    .chart-box h3 { font-size: 16px; margin-bottom: 20px; }
    .chart-container { position: relative; height: 280px; }
    .category-list { margin-top: 16px; }
    .category-item { display: flex; align-items: center; gap: 12px; padding: 14px; margin-bottom: 8px; background: rgba(51, 65, 85, 0.3); border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .category-item:hover { background: rgba(51, 65, 85, 0.5); }
    .category-item.active { background: #334155; }
    .category-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .category-info { flex: 1; }
    .category-name { font-weight: 500; margin-bottom: 4px; }
    .category-bar { height: 4px; background: #334155; border-radius: 2px; }
    .category-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .category-amount { font-family: monospace; color: #94a3b8; }
    .category-percent { color: #64748b; font-size: 13px; width: 50px; text-align: right; }
    .transactions { border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; overflow: hidden; margin-bottom: 24px; }
    .transactions-header { padding: 16px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .transactions-header h3 { font-size: 16px; }
    .transactions-count { color: #64748b; font-size: 13px; }
    .transaction { display: flex; align-items: center; gap: 14px; padding: 14px 20px; border-bottom: 1px solid #1e293b; transition: background 0.2s; }
    .transaction:hover { background: rgba(51, 65, 85, 0.3); }
    .transaction:last-child { border-bottom: none; }
    .transaction-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .transaction-details { flex: 1; min-width: 0; }
    .transaction-desc { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .transaction-meta { font-size: 12px; color: #64748b; }
    .transaction-cat { padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }
    .transaction-amount { text-align: right; flex-shrink: 0; }
    .transaction-amount-value { font-weight: 600; font-family: monospace; }
    .transaction-amount-value.positive { color: #34d399; }
    .transaction-balance { font-size: 11px; color: #64748b; margin-top: 2px; }
    .show-more { width: 100%; padding: 14px; background: transparent; border: none; border-top: 1px solid #1e293b; color: #94a3b8; cursor: pointer; font-size: 14px; }
    .show-more:hover { background: rgba(51, 65, 85, 0.3); color: #e2e8f0; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-clear { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
    .btn-clear:hover { background: rgba(239, 68, 68, 0.2); }
    .btn-filter { padding: 4px 12px; background: #334155; color: #94a3b8; border-radius: 20px; margin-left: 8px; font-size: 12px; border: none; cursor: pointer; }
    .empty-state { text-align: center; padding: 80px 20px; color: #64748b; }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
    .empty-state h2 { color: #e2e8f0; margin-bottom: 8px; }
    .footer { text-align: center; padding: 32px 0; color: #64748b; font-size: 13px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #22d3ee; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .error-box { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; padding: 16px; border-radius: 12px; margin-bottom: 24px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üí≥</div>
        <div>
          <h1>Bank Analyzer</h1>
          <p>NLB Statement Dashboard</p>
        </div>
      </div>
      <div id="headerActions" class="hidden">
        <span id="txnCount" style="color: #94a3b8; font-size: 14px; margin-right: 12px;"></span>
        <button class="btn btn-clear" onclick="clearAllData()">üóëÔ∏è Clear All</button>
      </div>
    </header>

    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf" multiple>
      <div id="uploadContent">
        <div class="upload-icon">üìÑ</div>
        <h3>Drop NLB bank statements here</h3>
        <p>or click to browse ‚Ä¢ PDF files only</p>
      </div>
      <div id="uploadLoading" class="hidden">
        <div class="spinner"></div>
        <h3>Processing PDF...</h3>
        <p id="loadingStatus" style="color: #64748b; margin-top: 8px;"></p>
      </div>
      <div class="file-tags" id="fileTags"></div>
    </div>

    <div id="errorBox" class="error-box hidden"></div>

    <div id="emptyState" class="empty-state">
      <div class="empty-state-icon">üìä</div>
      <h2>No transactions yet</h2>
      <p>Upload your NLB bank statement PDFs to see analytics</p>
    </div>

    <div id="dashboard" class="hidden">
      <div class="cards">
        <div class="card card-income">
          <div class="card-label">üí∞ Total Income</div>
          <div class="card-value green" id="totalIncome">‚Ç¨0.00</div>
        </div>
        <div class="card card-expense">
          <div class="card-label">üí∏ Total Expenses</div>
          <div class="card-value red" id="totalExpenses">‚Ç¨0.00</div>
        </div>
        <div class="card card-balance">
          <div class="card-label">üìà Net Balance</div>
          <div class="card-value blue" id="netBalance">‚Ç¨0.00</div>
        </div>
      </div>

      <div class="charts">
        <div class="chart-box">
          <h3>üìä Spending by Category</h3>
          <div class="chart-container"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="chart-box">
          <h3>üìâ Balance Over Time</h3>
          <div class="chart-container"><canvas id="lineChart"></canvas></div>
        </div>
      </div>

      <div class="chart-box">
        <h3>üìã Category Breakdown</h3>
        <div class="category-list" id="categoryList"></div>
      </div>

      <div class="transactions">
        <div class="transactions-header">
          <h3>üìù <span id="txnTitle">Recent Transactions</span>
            <button class="btn-filter hidden" id="clearFilter" onclick="clearFilter()">Clear √ó</button>
          </h3>
          <span class="transactions-count" id="txnListCount"></span>
        </div>
        <div id="transactionList"></div>
        <button class="show-more hidden" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
      </div>

      <footer class="footer">Bank Analyzer ‚Ä¢ Data stored locally in your browser</footer>
    </div>
  </div>

  <script type="module">
    // Import PDF.js as ES module
    const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

    // Make functions globally available
    window.clearAllData = clearAllData;
    window.clearFilter = clearFilter;
    window.toggleShowAll = toggleShowAll;
    window.filterByCategory = filterByCategory;

    let transactions = [];
    let uploadedFiles = [];
    let selectedCategory = null;
    let showAll = false;
    let pieChart = null;
    let lineChart = null;

    const CATEGORIES = {
      'Groceries': { keywords: ['LIDL', 'HOFER', 'SPAR', 'INTERSPAR', 'MERCATOR', 'SUPERMARKET', 'TUS'], color: '#10B981', icon: 'üõí' },
      'Fuel': { keywords: ['MOL ', 'PETROL', 'OMV', 'ESSO', 'SHELL'], color: '#F59E0B', icon: '‚õΩ' },
      'Restaurants': { keywords: ['MCDONALDS', 'PUB', 'BAR', 'RESTAVRACIJA', 'PIVNICA', 'GOSTILNA', 'NEBO', 'TROPIC'], color: '#EC4899', icon: 'üçî' },
      'Travel': { keywords: ['ASFINAG', 'DARS', 'EVINJETA', 'BOOKING', 'HOTEL', 'TERME', 'AVTOCAMP', 'RAILWAYS', 'BANKOMAT DVIG'], color: '#3B82F6', icon: '‚úàÔ∏è' },
      'Shopping': { keywords: ['ZARA', 'AMAZON', 'AMZN', 'ALDI', 'H&M', 'ABOUTYOU', 'ABOUT YOU', 'MERKUR', 'DM -', 'DM-'], color: '#8B5CF6', icon: 'üõçÔ∏è' },
      'Entertainment': { keywords: ['BOLDER SCENA', 'OLAII', 'VSTOPNICE', 'KINO', 'NETFLIX'], color: '#06B6D4', icon: 'üé¨' },
      'Transportation': { keywords: ['CAR PAYMENT', 'AUTOHAUS', 'TEHNICNI PREGLEDI', 'PSTOP', 'PARK'], color: '#EF4444', icon: 'üöó' },
      'Transfers': { keywords: ['REVOLUT', 'QUASI CASH', 'FLIK'], color: '#6366F1', icon: 'üí∏' },
      'Education': { keywords: ['UL EF', 'FAKULT', 'UNIV'], color: '#F472B6', icon: 'üéì' },
      'Services': { keywords: ['POSTA', 'PROVIZIJA', 'TELEKOM', 'NYX'], color: '#64748B', icon: 'üìã' },
      'Income': { keywords: ['ADRIAL', 'REDNO DELO', 'PLACA', 'SICOD', 'RETURN'], color: '#22C55E', icon: 'üí∞' },
      'Personal': { keywords: ['ROK ', 'MILAN V', 'ANDRAZ', 'NEJC P', 'MIHA M', 'ANJUSA'], color: '#14B8A6', icon: 'üë§' },
      'Other': { keywords: [], color: '#94A3B8', icon: 'üí≥' }
    };

    function formatCurrency(amount) {
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
    }

    function categorize(description) {
      const upper = description.toUpperCase();
      for (const [cat, config] of Object.entries(CATEGORIES)) {
        if (cat === 'Other') continue;
        if (config.keywords.some(k => upper.includes(k.toUpperCase()))) return cat;
      }
      return 'Other';
    }

    function parseStatement(text) {
      const txns = [];
      const cleanText = text.replace(/\s+/g, ' ');
      
      // Find all date patterns
      const datePattern = /(\d{2}\.\d{2}\.\d{2})/g;
      const dates = [];
      let match;
      
      while ((match = datePattern.exec(cleanText)) !== null) {
        dates.push({ date: match[1], index: match.index });
      }
      
      console.log('Found', dates.length, 'dates in PDF');
      
      for (let i = 0; i < dates.length; i++) {
        const startIdx = dates[i].index;
        const endIdx = (i + 1 < dates.length) ? dates[i + 1].index : cleanText.length;
        const segment = cleanText.substring(startIdx, endIdx).trim();
        
        // Skip headers
        if (/STANJE|SKUPNI|Datum izpiska|predhodnega|LETNA OBRESTNA|EUR\s*-\s*EVRO|NLB PAKET|Obvestilo|Varnostna/i.test(segment)) {
          continue;
        }
        
        const date = dates[i].date;
        
        // Find amounts in format: -51,13 or +2.276,11 or 14.715,58
        const amountPattern = /([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g;
        const amounts = [];
        let amtMatch;
        
        while ((amtMatch = amountPattern.exec(segment)) !== null) {
          amounts.push(amtMatch[1]);
        }
        
        if (amounts.length >= 2) {
          const amtStr = amounts[amounts.length - 2];
          const balStr = amounts[amounts.length - 1];
          
          let amt = parseFloat(amtStr.replace(/\./g, '').replace(',', '.'));
          const bal = parseFloat(balStr.replace(/\./g, '').replace(',', '.'));
          
          // Get description
          const firstAmtIdx = segment.indexOf(amounts[0]);
          let desc = segment.substring(date.length, firstAmtIdx).trim();
          desc = desc.replace(/^\s*[\.,]\s*/, '').trim();
          
          if (!desc || desc.length < 2) continue;
          
          // Determine sign
          const isIncome = amtStr.startsWith('+') || /ADRIAL|REDNO DELO|RETURN|SICOD/i.test(desc);
          
          if (!amtStr.startsWith('+') && !amtStr.startsWith('-') && !isIncome) {
            amt = -Math.abs(amt);
          }
          
          let category = categorize(desc);
          if (amt > 0 && category === 'Other') category = 'Income';
          
          txns.push({
            id: `${date}-${txns.length}-${Math.random().toString(36).substr(2, 5)}`,
            date,
            description: desc,
            amount: amt,
            balance: bal,
            category
          });
        }
      }
      
      console.log('Parsed', txns.length, 'transactions');
      return txns;
    }

    async function extractPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        document.getElementById('loadingStatus').textContent = `Reading page ${i} of ${pdf.numPages}...`;
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        
        let lastY = null;
        content.items.forEach(item => {
          if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
            fullText += '\n';
          }
          fullText += item.str + ' ';
          lastY = item.transform[5];
        });
        fullText += '\n';
      }
      
      return fullText;
    }

    async function handleFiles(files) {
      const pdfs = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) return;

      document.getElementById('uploadContent').classList.add('hidden');
      document.getElementById('uploadLoading').classList.remove('hidden');
      document.getElementById('errorBox').classList.add('hidden');

      try {
        for (const file of pdfs) {
          if (uploadedFiles.includes(file.name)) continue;
          
          document.getElementById('loadingStatus').textContent = `Processing ${file.name}...`;
          
          const text = await extractPDF(file);
          console.log('Extracted text length:', text.length);
          
          const parsed = parseStatement(text);
          
          if (parsed.length === 0) {
            document.getElementById('errorBox').textContent = `No transactions found in ${file.name}. The PDF might be in a different format.`;
            document.getElementById('errorBox').classList.remove('hidden');
            console.log('Sample text:', text.substring(0, 2000));
          } else {
            transactions = [...transactions, ...parsed];
            uploadedFiles.push(file.name);
          }
        }

        // Remove duplicates
        const seen = new Set();
        transactions = transactions.filter(t => {
          const key = `${t.date}-${t.description}-${t.amount}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        // Sort by date
        transactions.sort((a, b) => {
          const [dA, mA, yA] = a.date.split('.');
          const [dB, mB, yB] = b.date.split('.');
          return new Date(2000 + +yA, +mA - 1, +dA) - new Date(2000 + +yB, +mB - 1, +dB);
        });

        saveData();
        render();
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('errorBox').textContent = `Error processing PDF: ${err.message}`;
        document.getElementById('errorBox').classList.remove('hidden');
      }

      document.getElementById('uploadContent').classList.remove('hidden');
      document.getElementById('uploadLoading').classList.add('hidden');
    }

    function saveData() {
      localStorage.setItem('bankAnalyzer', JSON.stringify({ transactions, uploadedFiles }));
    }

    function loadData() {
      const saved = localStorage.getItem('bankAnalyzer');
      if (saved) {
        const data = JSON.parse(saved);
        transactions = data.transactions || [];
        uploadedFiles = data.uploadedFiles || [];
      }
    }

    function clearAllData() {
      if (confirm('Clear all data?')) {
        transactions = [];
        uploadedFiles = [];
        localStorage.removeItem('bankAnalyzer');
        render();
      }
    }

    function filterByCategory(cat) {
      selectedCategory = selectedCategory === cat ? null : cat;
      render();
    }

    function clearFilter() {
      selectedCategory = null;
      render();
    }

    function toggleShowAll() {
      showAll = !showAll;
      render();
    }

    function render() {
      document.getElementById('fileTags').innerHTML = uploadedFiles.map(f => `<span class="file-tag">üìÑ ${f}</span>`).join('');

      if (transactions.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('headerActions').classList.add('hidden');
        return;
      }

      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('headerActions').classList.remove('hidden');

      const income = transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      const expenses = Math.abs(transactions.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      const net = income - expenses;

      document.getElementById('totalIncome').textContent = formatCurrency(income);
      document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
      document.getElementById('netBalance').textContent = (net >= 0 ? '+' : '') + formatCurrency(net);
      document.getElementById('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
      document.getElementById('txnCount').textContent = transactions.length + ' transactions';

      // Category totals
      const catTotals = {};
      transactions.filter(t => t.amount < 0).forEach(t => {
        catTotals[t.category] = (catTotals[t.category] || 0) + Math.abs(t.amount);
      });

      const sortedCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);

      // Render categories
      document.getElementById('categoryList').innerHTML = sortedCats.map(([cat, amount]) => {
        const config = CATEGORIES[cat] || CATEGORIES.Other;
        const pct = expenses > 0 ? ((amount / expenses) * 100).toFixed(1) : '0';
        return `
          <div class="category-item ${selectedCategory === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">
            <div class="category-icon" style="background:${config.color}20">${config.icon}</div>
            <div class="category-info">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span class="category-name">${cat}</span>
                <span class="category-amount">${formatCurrency(amount)}</span>
              </div>
              <div class="category-bar"><div class="category-bar-fill" style="width:${pct}%;background:${config.color}"></div></div>
            </div>
            <span class="category-percent">${pct}%</span>
          </div>
        `;
      }).join('');

      renderCharts(sortedCats, expenses);
      renderTransactions();
    }

    function renderCharts(sortedCats, expenses) {
      // Pie chart
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      
      pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels: sortedCats.map(([c]) => c),
          datasets: [{
            data: sortedCats.map(([, v]) => v),
            backgroundColor: sortedCats.map(([c]) => (CATEGORIES[c] || CATEGORIES.Other).color),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}` } }
          },
          onClick: (e, elements) => {
            if (elements.length) filterByCategory(sortedCats[elements[0].index][0]);
          }
        }
      });

      // Line chart
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();

      const dailyBal = [];
      const balByDate = {};
      transactions.forEach(t => balByDate[t.date] = t.balance);
      Object.entries(balByDate).forEach(([date, balance]) => dailyBal.push({ date, balance }));

      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: dailyBal.map(d => d.date),
          datasets: [{
            data: dailyBal.map(d => d.balance),
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34, 211, 238, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: '#334155' }, ticks: { color: '#64748b', maxTicksLimit: 6 } },
            y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => (v/1000).toFixed(0) + 'k' } }
          }
        }
      });
    }

    function renderTransactions() {
      const filtered = selectedCategory ? transactions.filter(t => t.category === selectedCategory) : transactions;
      const displayed = showAll ? filtered : filtered.slice(-10).reverse();

      document.getElementById('txnTitle').textContent = selectedCategory ? `${selectedCategory} Transactions` : 'Recent Transactions';
      document.getElementById('clearFilter').classList.toggle('hidden', !selectedCategory);
      document.getElementById('txnListCount').textContent = `${filtered.length} items`;

      document.getElementById('transactionList').innerHTML = displayed.map(t => {
        const config = CATEGORIES[t.category] || CATEGORIES.Other;
        const isPositive = t.amount > 0;
        return `
          <div class="transaction">
            <div class="transaction-icon" style="background:${config.color}20">${config.icon}</div>
            <div class="transaction-details">
              <div class="transaction-desc">${t.description}</div>
              <div class="transaction-meta">${t.date}<span class="transaction-cat" style="background:${config.color}20;color:${config.color}">${t.category}</span></div>
            </div>
            <div class="transaction-amount">
              <div class="transaction-amount-value ${isPositive ? 'positive' : ''}">${isPositive ? '+' : ''}${formatCurrency(t.amount)}</div>
              <div class="transaction-balance">Bal: ${formatCurrency(t.balance)}</div>
            </div>
          </div>
        `;
      }).join('');

      const showBtn = document.getElementById('showMoreBtn');
      if (filtered.length > 10) {
        showBtn.classList.remove('hidden');
        showBtn.textContent = showAll ? '‚ñ≤ Show less' : `‚ñº Show all ${filtered.length}`;
      } else {
        showBtn.classList.add('hidden');
      }
    }

    // Event listeners
    document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));
    
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragging'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
    uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragging'); handleFiles(e.dataTransfer.files); });

    // Initialize
    loadData();
    render();
    console.log('Bank Analyzer loaded successfully!');
  </script>
</body>
</html>
