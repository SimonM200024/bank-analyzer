<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer - NLB Statement Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, sans-serif; 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
      color: #f8fafc; 
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #34d399, #22d3ee); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .logo h1 { font-size: 20px; font-weight: 600; }
    .logo p { font-size: 12px; color: #64748b; }
    .upload-zone { border: 2px dashed #334155; border-radius: 16px; padding: 48px 24px; text-align: center; margin-bottom: 24px; background: rgba(30, 41, 59, 0.5); cursor: pointer; transition: all 0.3s; }
    .upload-zone:hover, .upload-zone.dragging { border-color: #34d399; background: rgba(52, 211, 153, 0.1); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 48px; margin-bottom: 16px; }
    .upload-zone h3 { font-size: 18px; margin-bottom: 8px; }
    .upload-zone p { color: #64748b; font-size: 14px; }
    .file-tags { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 16px; }
    .file-tag { padding: 6px 12px; background: rgba(52, 211, 153, 0.2); color: #34d399; border-radius: 20px; font-size: 13px; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
    .card-income { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-color: rgba(16, 185, 129, 0.2); }
    .card-expense { background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.05)); border-color: rgba(244, 63, 94, 0.2); }
    .card-balance { background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(34, 211, 238, 0.05)); border-color: rgba(34, 211, 238, 0.2); }
    .card-label { color: #94a3b8; font-size: 14px; margin-bottom: 8px; }
    .card-value { font-size: 28px; font-weight: 700; font-family: monospace; }
    .card-value.green { color: #34d399; }
    .card-value.red { color: #fb7185; }
    .card-value.blue { color: #22d3ee; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { padding: 24px; border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; }
    .chart-box h3 { font-size: 16px; margin-bottom: 20px; }
    .chart-container { position: relative; height: 280px; }
    .category-list { margin-top: 16px; }
    .category-item { display: flex; align-items: center; gap: 12px; padding: 14px; margin-bottom: 8px; background: rgba(51, 65, 85, 0.3); border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .category-item:hover { background: rgba(51, 65, 85, 0.5); }
    .category-item.active { background: #334155; }
    .category-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .category-info { flex: 1; }
    .category-name { font-weight: 500; margin-bottom: 4px; }
    .category-bar { height: 4px; background: #334155; border-radius: 2px; }
    .category-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .category-amount { font-family: monospace; color: #94a3b8; }
    .category-percent { color: #64748b; font-size: 13px; width: 50px; text-align: right; }
    .transactions { border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; overflow: hidden; margin-bottom: 24px; }
    .transactions-header { padding: 16px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .transactions-header h3 { font-size: 16px; }
    .transactions-count { color: #64748b; font-size: 13px; }
    .transaction { display: flex; align-items: center; gap: 14px; padding: 14px 20px; border-bottom: 1px solid #1e293b; transition: background 0.2s; }
    .transaction:hover { background: rgba(51, 65, 85, 0.3); }
    .transaction:last-child { border-bottom: none; }
    .transaction-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .transaction-details { flex: 1; min-width: 0; }
    .transaction-desc { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .transaction-meta { font-size: 12px; color: #64748b; }
    .transaction-cat { padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }
    .transaction-amount { text-align: right; }
    .transaction-amount-value { font-weight: 600; font-family: monospace; }
    .transaction-amount-value.positive { color: #34d399; }
    .transaction-balance { font-size: 11px; color: #64748b; margin-top: 2px; }
    .show-more { width: 100%; padding: 14px; background: transparent; border: none; border-top: 1px solid #1e293b; color: #94a3b8; cursor: pointer; font-size: 14px; }
    .show-more:hover { background: rgba(51, 65, 85, 0.3); color: #e2e8f0; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-clear { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
    .btn-clear:hover { background: rgba(239, 68, 68, 0.2); }
    .btn-filter { padding: 4px 12px; background: #334155; color: #94a3b8; border-radius: 20px; margin-left: 8px; font-size: 12px; }
    .empty-state { text-align: center; padding: 80px 20px; color: #64748b; }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
    .empty-state h2 { color: #e2e8f0; margin-bottom: 8px; }
    .footer { text-align: center; padding: 32px 0; color: #64748b; font-size: 13px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #22d3ee; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .debug { background: #1e293b; padding: 16px; border-radius: 8px; margin-bottom: 24px; font-family: monospace; font-size: 12px; max-height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üí≥</div>
        <div>
          <h1>Bank Analyzer</h1>
          <p>NLB Statement Dashboard</p>
        </div>
      </div>
      <div id="headerActions" class="hidden">
        <span id="txnCount" style="color: #94a3b8; font-size: 14px; margin-right: 12px;"></span>
        <button class="btn btn-clear" onclick="clearAllData()">üóëÔ∏è Clear All</button>
      </div>
    </header>

    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
      <input type="file" id="fileInput" accept=".pdf" multiple>
      <div id="uploadContent">
        <div class="upload-icon">üìÑ</div>
        <h3>Drop NLB bank statements here</h3>
        <p>or click to browse ‚Ä¢ PDF files only</p>
      </div>
      <div id="uploadLoading" class="hidden">
        <div class="spinner"></div>
        <h3>Processing...</h3>
      </div>
      <div class="file-tags" id="fileTags"></div>
    </div>

    <div id="debugBox" class="debug hidden"></div>

    <div id="emptyState" class="empty-state">
      <div class="empty-state-icon">üìä</div>
      <h2>No transactions yet</h2>
      <p>Upload your NLB bank statement PDFs to see analytics</p>
    </div>

    <div id="dashboard" class="hidden">
      <div class="cards">
        <div class="card card-income">
          <div class="card-label">üí∞ Total Income</div>
          <div class="card-value green" id="totalIncome">‚Ç¨0.00</div>
        </div>
        <div class="card card-expense">
          <div class="card-label">üí∏ Total Expenses</div>
          <div class="card-value red" id="totalExpenses">‚Ç¨0.00</div>
        </div>
        <div class="card card-balance">
          <div class="card-label">üìà Net Balance</div>
          <div class="card-value blue" id="netBalance">‚Ç¨0.00</div>
        </div>
      </div>

      <div class="charts">
        <div class="chart-box">
          <h3>üìä Spending by Category</h3>
          <div class="chart-container">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
        <div class="chart-box">
          <h3>üìâ Balance Over Time</h3>
          <div class="chart-container">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-box">
        <h3>üìã Category Breakdown</h3>
        <div class="category-list" id="categoryList"></div>
      </div>

      <div class="transactions">
        <div class="transactions-header">
          <h3>üìù <span id="txnTitle">Recent Transactions</span>
            <button class="btn btn-filter hidden" id="clearFilter" onclick="clearFilter()">Clear filter √ó</button>
          </h3>
          <span class="transactions-count" id="txnListCount"></span>
        </div>
        <div id="transactionList"></div>
        <button class="show-more hidden" id="showMoreBtn" onclick="toggleShowAll()">Show all transactions</button>
      </div>

      <footer class="footer">
        Bank Analyzer ‚Ä¢ Your data is stored locally in your browser
      </footer>
    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    var transactions = [];
    var uploadedFiles = [];
    var selectedCategory = null;
    var showAll = false;
    var pieChart = null;
    var lineChart = null;

    var CATEGORIES = {
      'Groceries': { keywords: ['LIDL', 'HOFER', 'SPAR', 'INTERSPAR', 'MERCATOR', 'SUPERMARKET', 'TUS'], color: '#10B981', icon: 'üõí' },
      'Fuel': { keywords: ['MOL ', 'PETROL', 'OMV', 'ESSO', 'SHELL'], color: '#F59E0B', icon: '‚õΩ' },
      'Restaurants': { keywords: ['MCDONALDS', 'PUB', 'BAR', 'RESTAVRACIJA', 'PIVNICA', 'GOSTILNA', 'NEBO', 'TROPIC'], color: '#EC4899', icon: 'üçî' },
      'Travel': { keywords: ['ASFINAG', 'DARS', 'EVINJETA', 'BOOKING', 'HOTEL', 'TERME', 'AVTOCAMP', 'RAILWAYS', 'BANKOMAT DVIG'], color: '#3B82F6', icon: '‚úàÔ∏è' },
      'Shopping': { keywords: ['ZARA', 'AMAZON', 'AMZN', 'ALDI', 'H&M', 'ABOUTYOU', 'ABOUT YOU', 'MERKUR', 'DM -', 'DM-'], color: '#8B5CF6', icon: 'üõçÔ∏è' },
      'Entertainment': { keywords: ['BOLDER SCENA', 'OLAII', 'VSTOPNICE', 'KINO', 'NETFLIX'], color: '#06B6D4', icon: 'üé¨' },
      'Transportation': { keywords: ['CAR PAYMENT', 'AUTOHAUS', 'TEHNICNI PREGLEDI', 'PSTOP', 'PARK'], color: '#EF4444', icon: 'üöó' },
      'Transfers': { keywords: ['REVOLUT', 'QUASI CASH', 'FLIK'], color: '#6366F1', icon: 'üí∏' },
      'Education': { keywords: ['UL EF', 'FAKULT', 'UNIV'], color: '#F472B6', icon: 'üéì' },
      'Services': { keywords: ['POSTA', 'PROVIZIJA', 'TELEKOM', 'NYX'], color: '#64748B', icon: 'üìã' },
      'Income': { keywords: ['ADRIAL', 'REDNO DELO', 'PLACA', 'SICOD', 'RETURN'], color: '#22C55E', icon: 'üí∞' },
      'Personal': { keywords: ['ROK ', 'MILAN V', 'ANDRAZ', 'NEJC P', 'MIHA M', 'ANJUSA'], color: '#14B8A6', icon: 'üë§' },
      'Other': { keywords: [], color: '#94A3B8', icon: 'üí≥' }
    };

    function formatCurrency(amount) {
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
    }

    function categorize(description) {
      var upper = description.toUpperCase();
      for (var cat in CATEGORIES) {
        if (cat === 'Other') continue;
        var keywords = CATEGORIES[cat].keywords;
        for (var i = 0; i < keywords.length; i++) {
          if (upper.indexOf(keywords[i].toUpperCase()) !== -1) return cat;
        }
      }
      return 'Other';
    }

    // Improved NLB statement parser
    function parseStatement(text) {
      var txns = [];
      
      // Clean up the text - PDF.js sometimes adds extra spaces
      var cleanText = text.replace(/\s+/g, ' ');
      
      // Debug: show raw text
      console.log('Raw PDF text (first 2000 chars):', cleanText.substring(0, 2000));
      
      // Split by date pattern to find transactions
      // NLB format: DD.MM.YY followed by description, then amounts
      var datePattern = /(\d{2}\.\d{2}\.\d{2})/g;
      var dates = [];
      var match;
      
      while ((match = datePattern.exec(cleanText)) !== null) {
        dates.push({ date: match[1], index: match.index });
      }
      
      console.log('Found dates:', dates.length);
      
      // For each date, extract the transaction
      for (var i = 0; i < dates.length; i++) {
        var startIdx = dates[i].index;
        var endIdx = (i + 1 < dates.length) ? dates[i + 1].index : cleanText.length;
        var segment = cleanText.substring(startIdx, endIdx).trim();
        
        // Skip header/summary lines
        if (segment.indexOf('STANJE') !== -1 || 
            segment.indexOf('SKUPNI') !== -1 || 
            segment.indexOf('Datum izpiska') !== -1 ||
            segment.indexOf('predhodnega') !== -1) {
          continue;
        }
        
        // Extract date
        var date = dates[i].date;
        
        // Find amounts - look for patterns like -51,13 or +2.276,11 or 14.715,58
        // The last number is the balance, before that is the transaction amount
        var amountPattern = /([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g;
        var amounts = [];
        var amtMatch;
        
        while ((amtMatch = amountPattern.exec(segment)) !== null) {
          amounts.push(amtMatch[1]);
        }
        
        if (amounts.length >= 2) {
          // Last amount is balance, second to last is transaction amount
          var amtStr = amounts[amounts.length - 2];
          var balStr = amounts[amounts.length - 1];
          
          // Parse amounts (European format: 1.234,56)
          var amt = parseFloat(amtStr.replace(/\./g, '').replace(',', '.'));
          var bal = parseFloat(balStr.replace(/\./g, '').replace(',', '.'));
          
          // Extract description (between date and first amount)
          var firstAmtIdx = segment.indexOf(amounts[0]);
          var desc = segment.substring(date.length, firstAmtIdx).trim();
          
          // Clean up description
          desc = desc.replace(/^\s*[\.,]\s*/, '').trim();
          
          // Skip if description is empty or looks like header
          if (!desc || desc.length < 2) continue;
          
          // Determine if it's income or expense based on sign or keywords
          var isIncome = amtStr.indexOf('+') === 0 || 
                         /ADRIAL|REDNO DELO|RETURN|SICOD/i.test(desc);
          
          // If no explicit sign and not income keyword, it's an expense (negative)
          if (amtStr.indexOf('+') !== 0 && amtStr.indexOf('-') !== 0) {
            if (!isIncome) {
              amt = -Math.abs(amt);
            }
          }
          
          var category = categorize(desc);
          
          // Override category for income
          if (amt > 0 && category === 'Other') {
            category = 'Income';
          }
          
          txns.push({
            id: date + '-' + txns.length + '-' + Math.random().toString(36).substr(2, 5),
            date: date,
            description: desc,
            amount: amt,
            balance: bal,
            category: category
          });
        }
      }
      
      console.log('Parsed transactions:', txns.length);
      return txns;
    }

    function extractPDF(file) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var typedArray = new Uint8Array(e.target.result);
          pdfjsLib.getDocument({ data: typedArray }).promise.then(function(pdf) {
            var promises = [];
            for (var i = 1; i <= pdf.numPages; i++) {
              promises.push(
                pdf.getPage(i).then(function(page) {
                  return page.getTextContent().then(function(content) {
                    // Preserve some structure by adding newlines
                    var text = '';
                    var lastY = null;
                    content.items.forEach(function(item) {
                      if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                        text += '\n';
                      }
                      text += item.str + ' ';
                      lastY = item.transform[5];
                    });
                    return text;
                  });
                })
              );
            }
            Promise.all(promises).then(function(pages) {
              resolve(pages.join('\n'));
            });
          }).catch(reject);
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function handleFiles(files) {
      var pdfs = [];
      for (var i = 0; i < files.length; i++) {
        if (files[i].name.toLowerCase().indexOf('.pdf') !== -1) {
          pdfs.push(files[i]);
        }
      }
      if (!pdfs.length) return;

      document.getElementById('uploadContent').classList.add('hidden');
      document.getElementById('uploadLoading').classList.remove('hidden');

      var processFile = function(index) {
        if (index >= pdfs.length) {
          // Remove duplicates
          var seen = {};
          transactions = transactions.filter(function(t) {
            var key = t.date + t.description + t.amount;
            if (seen[key]) return false;
            seen[key] = true;
            return true;
          });

          // Sort by date
          transactions.sort(function(a, b) {
            var partsA = a.date.split('.');
            var partsB = b.date.split('.');
            var dateA = new Date(2000 + parseInt(partsA[2]), parseInt(partsA[1]) - 1, parseInt(partsA[0]));
            var dateB = new Date(2000 + parseInt(partsB[2]), parseInt(partsB[1]) - 1, parseInt(partsB[0]));
            return dateA - dateB;
          });

          saveData();
          render();
          document.getElementById('uploadContent').classList.remove('hidden');
          document.getElementById('uploadLoading').classList.add('hidden');
          return;
        }

        var file = pdfs[index];
        if (uploadedFiles.indexOf(file.name) !== -1) {
          processFile(index + 1);
          return;
        }

        extractPDF(file).then(function(text) {
          console.log('Extracted text length:', text.length);
          var parsed = parseStatement(text);
          console.log('Parsed', parsed.length, 'transactions from', file.name);
          
          if (parsed.length === 0) {
            // Show debug info
            document.getElementById('debugBox').classList.remove('hidden');
            document.getElementById('debugBox').textContent = 'Debug - PDF text sample:\n' + text.substring(0, 1500);
          }
          
          transactions = transactions.concat(parsed);
          uploadedFiles.push(file.name);
          processFile(index + 1);
        }).catch(function(err) {
          console.error('Error processing PDF:', err);
          alert('Error processing PDF: ' + err.message);
          processFile(index + 1);
        });
      };

      processFile(0);
    }

    function saveData() {
      localStorage.setItem('bankAnalyzer', JSON.stringify({ transactions: transactions, uploadedFiles: uploadedFiles }));
    }

    function loadData() {
      var saved = localStorage.getItem('bankAnalyzer');
      if (saved) {
        var data = JSON.parse(saved);
        transactions = data.transactions || [];
        uploadedFiles = data.uploadedFiles || [];
      }
    }

    function clearAllData() {
      if (confirm('Are you sure you want to clear all data?')) {
        transactions = [];
        uploadedFiles = [];
        localStorage.removeItem('bankAnalyzer');
        document.getElementById('debugBox').classList.add('hidden');
        render();
      }
    }

    function filterByCategory(cat) {
      selectedCategory = selectedCategory === cat ? null : cat;
      render();
    }

    function clearFilter() {
      selectedCategory = null;
      render();
    }

    function toggleShowAll() {
      showAll = !showAll;
      render();
    }

    function render() {
      var fileTags = document.getElementById('fileTags');
      var emptyState = document.getElementById('emptyState');
      var dashboard = document.getElementById('dashboard');
      var headerActions = document.getElementById('headerActions');

      fileTags.innerHTML = uploadedFiles.map(function(f) { return '<span class="file-tag">üìÑ ' + f + '</span>'; }).join('');

      if (transactions.length === 0) {
        emptyState.classList.remove('hidden');
        dashboard.classList.add('hidden');
        headerActions.classList.add('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      dashboard.classList.remove('hidden');
      headerActions.classList.remove('hidden');
      document.getElementById('debugBox').classList.add('hidden');

      var income = 0, expenses = 0;
      for (var i = 0; i < transactions.length; i++) {
        if (transactions[i].amount > 0) income += transactions[i].amount;
        else expenses += Math.abs(transactions[i].amount);
      }
      var net = income - expenses;

      document.getElementById('totalIncome').textContent = formatCurrency(income);
      document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
      document.getElementById('netBalance').textContent = (net >= 0 ? '+' : '') + formatCurrency(net);
      document.getElementById('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
      document.getElementById('txnCount').textContent = transactions.length + ' transactions';

      var catTotals = {};
      for (var i = 0; i < transactions.length; i++) {
        var t = transactions[i];
        if (t.amount < 0) {
          catTotals[t.category] = (catTotals[t.category] || 0) + Math.abs(t.amount);
        }
      }

      var sortedCats = [];
      for (var cat in catTotals) {
        sortedCats.push([cat, catTotals[cat]]);
      }
      sortedCats.sort(function(a, b) { return b[1] - a[1]; });

      var categoryList = document.getElementById('categoryList');
      var categoryHTML = '';
      for (var i = 0; i < sortedCats.length; i++) {
        var cat = sortedCats[i][0];
        var amount = sortedCats[i][1];
        var config = CATEGORIES[cat] || CATEGORIES.Other;
        var pct = expenses > 0 ? ((amount / expenses) * 100).toFixed(1) : '0';
        var isActive = selectedCategory === cat;
        categoryHTML += '<div class="category-item ' + (isActive ? 'active' : '') + '" onclick="filterByCategory(\'' + cat + '\')">' +
          '<div class="category-icon" style="background:' + config.color + '20">' + config.icon + '</div>' +
          '<div class="category-info">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
              '<span class="category-name">' + cat + '</span>' +
              '<span class="category-amount">' + formatCurrency(amount) + '</span>' +
            '</div>' +
            '<div class="category-bar"><div class="category-bar-fill" style="width:' + pct + '%;background:' + config.color + '"></div></div>' +
          '</div>' +
          '<span class="category-percent">' + pct + '%</span>' +
        '</div>';
      }
      categoryList.innerHTML = categoryHTML;

      renderPieChart(sortedCats);
      renderLineChart();
      renderTransactions();
    }

    function renderPieChart(sortedCats) {
      var ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();

      var labels = [], data = [], colors = [];
      for (var i = 0; i < sortedCats.length; i++) {
        labels.push(sortedCats[i][0]);
        data.push(sortedCats[i][1]);
        colors.push((CATEGORIES[sortedCats[i][0]] || CATEGORIES.Other).color);
      }

      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + formatCurrency(ctx.raw); } } }
          },
          onClick: function(e, elements) {
            if (elements.length > 0) {
              filterByCategory(sortedCats[elements[0].index][0]);
            }
          }
        }
      });
    }

    function renderLineChart() {
      var ctx = document.getElementById('lineChart').getContext('2d');
      var dailyBal = [];
      var balByDate = {};
      
      for (var i = 0; i < transactions.length; i++) {
        balByDate[transactions[i].date] = transactions[i].balance;
      }
      for (var date in balByDate) {
        dailyBal.push({ date: date, balance: balByDate[date] });
      }

      if (lineChart) lineChart.destroy();

      lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dailyBal.map(function(d) { return d.date; }),
          datasets: [{
            data: dailyBal.map(function(d) { return d.balance; }),
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34, 211, 238, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(ctx) { return formatCurrency(ctx.raw); } } }
          },
          scales: {
            x: { grid: { color: '#334155' }, ticks: { color: '#64748b', maxTicksLimit: 6 } },
            y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: function(v) { return (v / 1000).toFixed(0) + 'k'; } } }
          }
        }
      });
    }

    function renderTransactions() {
      var filtered = selectedCategory 
        ? transactions.filter(function(t) { return t.category === selectedCategory; })
        : transactions;
      
      var displayed = showAll ? filtered : filtered.slice(-10).reverse();
      
      document.getElementById('txnTitle').textContent = selectedCategory 
        ? selectedCategory + ' Transactions' 
        : 'Recent Transactions';
      
      document.getElementById('clearFilter').classList.toggle('hidden', !selectedCategory);
      document.getElementById('txnListCount').textContent = filtered.length + ' items';

      var list = document.getElementById('transactionList');
      var html = '';
      for (var i = 0; i < displayed.length; i++) {
        var t = displayed[i];
        var config = CATEGORIES[t.category] || CATEGORIES.Other;
        var isPositive = t.amount > 0;
        html += '<div class="transaction">' +
          '<div class="transaction-icon" style="background:' + config.color + '20">' + config.icon + '</div>' +
          '<div class="transaction-details">' +
            '<div class="transaction-desc">' + t.description + '</div>' +
            '<div class="transaction-meta">' + t.date + 
              '<span class="transaction-cat" style="background:' + config.color + '20;color:' + config.color + '">' + t.category + '</span>' +
            '</div>' +
          '</div>' +
          '<div class="transaction-amount">' +
            '<div class="transaction-amount-value ' + (isPositive ? 'positive' : '') + '">' + 
              (isPositive ? '+' : '') + formatCurrency(t.amount) + 
            '</div>' +
            '<div class="transaction-balance">Bal: ' + formatCurrency(t.balance) + '</div>' +
          '</div>' +
        '</div>';
      }
      list.innerHTML = html;

      var showMoreBtn = document.getElementById('showMoreBtn');
      if (filtered.length > 10) {
        showMoreBtn.classList.remove('hidden');
        showMoreBtn.textContent = showAll ? '‚ñ≤ Show less' : '‚ñº Show all ' + filtered.length + ' transactions';
      } else {
        showMoreBtn.classList.add('hidden');
      }
    }

    document.getElementById('fileInput').addEventListener('change', function(e) { handleFiles(e.target.files); });

    var uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragging'); });
    uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragging'); });
    uploadZone.addEventListener('drop', function(e) { 
      e.preventDefault(); 
      uploadZone.classList.remove('dragging');
      handleFiles(e.dataTransfer.files);
    });

    loadData();
    render();
  </script>
</body>
</html>
