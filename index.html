<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer - NLB Statement Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f8fafc; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #34d399, #22d3ee); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .logo h1 { font-size: 20px; font-weight: 600; }
    .logo p { font-size: 12px; color: #64748b; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .upload-zone { border: 2px dashed #334155; border-radius: 16px; padding: 48px 24px; text-align: center; margin-bottom: 24px; background: rgba(30, 41, 59, 0.5); cursor: pointer; transition: all 0.3s; }
    .upload-zone:hover, .upload-zone.dragging { border-color: #34d399; background: rgba(52, 211, 153, 0.1); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 48px; margin-bottom: 16px; }
    .upload-zone h3 { font-size: 18px; margin-bottom: 8px; }
    .upload-zone p { color: #64748b; font-size: 14px; }
    .file-tags { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 16px; }
    .file-tag { padding: 6px 12px; background: rgba(52, 211, 153, 0.2); color: #34d399; border-radius: 20px; font-size: 13px; }
    
    .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-label { font-size: 13px; color: #94a3b8; }
    .filter-select { padding: 8px 12px; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; border-radius: 8px; color: #f8fafc; font-size: 14px; cursor: pointer; }
    .filter-select:focus { outline: none; border-color: #22d3ee; }
    .month-pills { display: flex; gap: 6px; flex-wrap: wrap; }
    .month-pill { padding: 6px 12px; background: rgba(51, 65, 85, 0.5); border: 1px solid #334155; border-radius: 20px; color: #94a3b8; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .month-pill:hover { background: rgba(51, 65, 85, 0.8); color: #e2e8f0; }
    .month-pill.active { background: #22d3ee; color: #0f172a; border-color: #22d3ee; }
    .filter-btn { padding: 8px 16px; background: rgba(100, 116, 139, 0.2); border: 1px solid #475569; border-radius: 8px; color: #94a3b8; font-size: 13px; cursor: pointer; }
    .filter-btn:hover { background: rgba(100, 116, 139, 0.3); color: #e2e8f0; }
    
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card { padding: 18px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
    .card-income { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-color: rgba(16, 185, 129, 0.2); }
    .card-expense { background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.05)); border-color: rgba(244, 63, 94, 0.2); }
    .card-balance { background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(34, 211, 238, 0.05)); border-color: rgba(34, 211, 238, 0.2); }
    .card-savings { background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05)); border-color: rgba(168, 85, 247, 0.2); }
    .card-count { background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05)); border-color: rgba(251, 191, 36, 0.2); }
    .card-label { color: #94a3b8; font-size: 12px; margin-bottom: 6px; }
    .card-value { font-size: 22px; font-weight: 700; font-family: monospace; }
    .card-value.green { color: #34d399; }
    .card-value.red { color: #fb7185; }
    .card-value.blue { color: #22d3ee; }
    .card-value.purple { color: #a78bfa; }
    .card-value.yellow { color: #fbbf24; }
    .card-sub { font-size: 11px; color: #64748b; margin-top: 4px; }
    
    .comparison-box { background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; border-radius: 16px; padding: 20px; margin-bottom: 24px; }
    .comparison-box h3 { font-size: 16px; margin-bottom: 16px; }
    .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .comparison-item { text-align: center; padding: 16px; background: rgba(51, 65, 85, 0.3); border-radius: 12px; }
    .comparison-label { font-size: 12px; color: #94a3b8; margin-bottom: 8px; }
    .comparison-value { font-size: 20px; font-weight: 700; font-family: monospace; }
    .comparison-change { font-size: 13px; margin-top: 6px; display: flex; align-items: center; justify-content: center; gap: 4px; }
    .comparison-change.up { color: #fb7185; }
    .comparison-change.down { color: #34d399; }
    .comparison-change.neutral { color: #94a3b8; }
    
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { padding: 24px; border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; }
    .chart-box h3 { font-size: 16px; margin-bottom: 20px; }
    .chart-container { position: relative; height: 280px; }
    .chart-container.tall { height: 350px; }
    
    .top-expenses { margin-bottom: 24px; }
    .top-expense-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(51, 65, 85, 0.3); border-radius: 10px; margin-bottom: 8px; }
    .top-expense-rank { width: 28px; height: 28px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #0f172a; flex-shrink: 0; }
    .top-expense-rank.silver { background: linear-gradient(135deg, #94a3b8, #64748b); }
    .top-expense-rank.bronze { background: linear-gradient(135deg, #b45309, #92400e); color: #fef3c7; }
    .top-expense-details { flex: 1; min-width: 0; }
    .top-expense-desc { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .top-expense-meta { font-size: 12px; color: #64748b; margin-top: 2px; }
    .top-expense-amount { font-family: monospace; font-weight: 600; color: #fb7185; font-size: 15px; flex-shrink: 0; }
    
    .category-list { margin-top: 16px; }
    .category-item { display: flex; align-items: center; gap: 12px; padding: 14px; margin-bottom: 8px; background: rgba(51, 65, 85, 0.3); border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .category-item:hover { background: rgba(51, 65, 85, 0.5); }
    .category-item.active { background: #334155; }
    .category-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .category-info { flex: 1; min-width: 0; }
    .category-name { font-weight: 500; margin-bottom: 4px; }
    .category-bar { height: 4px; background: #334155; border-radius: 2px; }
    .category-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .category-amount { font-family: monospace; color: #94a3b8; font-size: 14px; }
    .category-percent { color: #64748b; font-size: 13px; width: 50px; text-align: right; flex-shrink: 0; }
    
    .transactions { border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; overflow: hidden; margin-bottom: 24px; }
    .transactions-header { padding: 16px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .transactions-header h3 { font-size: 16px; }
    .transactions-count { color: #64748b; font-size: 13px; }
    .transaction { display: flex; align-items: center; gap: 14px; padding: 14px 20px; border-bottom: 1px solid #1e293b; transition: background 0.2s; }
    .transaction:hover { background: rgba(51, 65, 85, 0.3); }
    .transaction:last-child { border-bottom: none; }
    .transaction-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .transaction-details { flex: 1; min-width: 0; }
    .transaction-desc { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .transaction-meta { font-size: 12px; color: #64748b; }
    .transaction-cat { padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }
    .transaction-amount { text-align: right; flex-shrink: 0; }
    .transaction-amount-value { font-weight: 600; font-family: monospace; }
    .transaction-amount-value.positive { color: #34d399; }
    .transaction-balance { font-size: 11px; color: #64748b; margin-top: 2px; }
    .show-more { width: 100%; padding: 14px; background: transparent; border: none; border-top: 1px solid #1e293b; color: #94a3b8; cursor: pointer; font-size: 14px; }
    .show-more:hover { background: rgba(51, 65, 85, 0.3); color: #e2e8f0; }
    
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-clear { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
    .btn-clear:hover { background: rgba(239, 68, 68, 0.2); }
    .btn-export { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #4ade80; }
    .btn-export:hover { background: rgba(34, 197, 94, 0.2); }
    .btn-filter { padding: 4px 12px; background: #334155; color: #94a3b8; border-radius: 20px; margin-left: 8px; font-size: 12px; border: none; cursor: pointer; }
    
    .empty-state { text-align: center; padding: 80px 20px; color: #64748b; }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
    .empty-state h2 { color: #e2e8f0; margin-bottom: 8px; }
    .footer { text-align: center; padding: 32px 0; color: #64748b; font-size: 13px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #22d3ee; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .error-box { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; padding: 16px; border-radius: 12px; margin-bottom: 24px; }
    .search-box { flex: 1; min-width: 200px; max-width: 300px; padding: 8px 12px; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; border-radius: 8px; color: #f8fafc; font-size: 14px; }
    .search-box:focus { outline: none; border-color: #22d3ee; }
    .search-box::placeholder { color: #64748b; }
    .savings-gauge { width: 100%; height: 8px; background: #334155; border-radius: 4px; margin-top: 8px; overflow: hidden; }
    .savings-gauge-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
    .savings-gauge-fill.good { background: linear-gradient(90deg, #22c55e, #34d399); }
    .savings-gauge-fill.ok { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .savings-gauge-fill.bad { background: linear-gradient(90deg, #ef4444, #fb7185); }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üí≥</div>
        <div>
          <h1>Bank Analyzer</h1>
          <p>NLB Statement Dashboard</p>
        </div>
      </div>
      <div class="header-actions" id="headerActions">
        <button class="btn btn-export" onclick="exportToCSV()">üì• Export CSV</button>
        <button class="btn btn-clear" onclick="clearAllData()">üóëÔ∏è Clear</button>
      </div>
    </header>

    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf" multiple>
      <div id="uploadContent">
        <div class="upload-icon">üìÑ</div>
        <h3>Drop NLB bank statements here</h3>
        <p>or click to browse ‚Ä¢ PDF files only ‚Ä¢ Multiple files supported</p>
      </div>
      <div id="uploadLoading" class="hidden">
        <div class="spinner"></div>
        <h3>Processing PDFs...</h3>
        <p id="loadingStatus" style="color: #64748b; margin-top: 8px;"></p>
      </div>
      <div class="file-tags" id="fileTags"></div>
    </div>

    <div id="errorBox" class="error-box hidden"></div>

    <div id="emptyState" class="empty-state">
      <div class="empty-state-icon">üìä</div>
      <h2>No transactions yet</h2>
      <p>Upload your NLB bank statement PDFs to see analytics</p>
    </div>

    <div id="dashboard" class="hidden">
      <div class="filters">
        <div class="filter-group">
          <span class="filter-label">üìÖ</span>
          <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
        </div>
        <div class="filter-group">
          <div class="month-pills" id="monthPills"></div>
        </div>
        <div class="filter-group" style="margin-left: auto;">
          <button class="filter-btn" onclick="resetFilters()">‚Ü∫ Reset</button>
        </div>
      </div>

      <div class="cards">
        <div class="card card-income">
          <div class="card-label">üí∞ Income</div>
          <div class="card-value green" id="totalIncome">‚Ç¨0</div>
          <div class="card-sub" id="incomeCount">0 transactions</div>
        </div>
        <div class="card card-expense">
          <div class="card-label">üí∏ Expenses</div>
          <div class="card-value red" id="totalExpenses">‚Ç¨0</div>
          <div class="card-sub" id="expenseCount">0 transactions</div>
        </div>
        <div class="card card-balance">
          <div class="card-label">üìà Net</div>
          <div class="card-value blue" id="netBalance">‚Ç¨0</div>
          <div class="card-sub" id="avgDaily">Avg/day: ‚Ç¨0</div>
        </div>
        <div class="card card-savings">
          <div class="card-label">üéØ Savings Rate</div>
          <div class="card-value purple" id="savingsRate">0%</div>
          <div class="savings-gauge"><div class="savings-gauge-fill" id="savingsGauge"></div></div>
        </div>
        <div class="card card-count">
          <div class="card-label">üìä Transactions</div>
          <div class="card-value yellow" id="txnTotal">0</div>
          <div class="card-sub" id="dateRange">-</div>
        </div>
      </div>

      <div class="comparison-box" id="comparisonBox">
        <h3>üìä Spending Comparison</h3>
        <div class="comparison-grid" id="comparisonGrid"></div>
      </div>

      <div class="charts">
        <div class="chart-box">
          <h3>üìä Spending by Category</h3>
          <div class="chart-container"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="chart-box">
          <h3>üìâ Balance Over Time</h3>
          <div class="chart-container"><canvas id="lineChart"></canvas></div>
        </div>
      </div>

      <div class="chart-box top-expenses">
        <h3>üî• Top 10 Biggest Expenses</h3>
        <div id="topExpensesList"></div>
      </div>

      <div class="chart-box" style="margin-bottom: 24px;">
        <h3>üìÜ Monthly Income vs Expenses</h3>
        <div class="chart-container tall"><canvas id="monthlyChart"></canvas></div>
      </div>

      <div class="chart-box" style="margin-bottom: 24px;">
        <h3>üìã Category Breakdown</h3>
        <div class="category-list" id="categoryList"></div>
      </div>

      <div class="transactions">
        <div class="transactions-header">
          <h3>üìù <span id="txnTitle">Transactions</span>
            <button class="btn-filter hidden" id="clearCatFilter" onclick="clearCategoryFilter()">Clear √ó</button>
          </h3>
          <input type="text" class="search-box" id="searchBox" placeholder="üîç Search..." oninput="applyFilters()">
          <span class="transactions-count" id="txnListCount"></span>
        </div>
        <div id="transactionList"></div>
        <button class="show-more hidden" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
      </div>

      <footer class="footer">Bank Analyzer v3 ‚Ä¢ Data stored locally in your browser</footer>
    </div>
  </div>

  <script type="module">
    const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

    window.clearAllData = clearAllData;
    window.clearCategoryFilter = clearCategoryFilter;
    window.toggleShowAll = toggleShowAll;
    window.filterByCategory = filterByCategory;
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;
    window.selectMonth = selectMonth;
    window.exportToCSV = exportToCSV;

    let allTransactions = [];
    let filteredTransactions = [];
    let uploadedFiles = [];
    let selectedCategory = null;
    let selectedYear = 'all';
    let selectedMonth = 'all';
    let searchQuery = '';
    let showAll = false;
    let pieChart = null;
    let lineChart = null;
    let monthlyChart = null;

    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const FULL_MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    const CATEGORIES = {
      'Groceries': { keywords: ['LIDL', 'HOFER', 'SPAR', 'INTERSPAR', 'MERCATOR', 'SUPERMARKET', 'TUS', 'EUROSPIN'], color: '#10B981', icon: 'üõí' },
      'Fuel': { keywords: ['MOL ', 'MOL-', 'PETROL', 'OMV', 'ESSO', 'SHELL'], color: '#F59E0B', icon: '‚õΩ' },
      'Restaurants': { keywords: ['MCDONALDS', 'PUB', 'BAR ', 'RESTAVRACIJA', 'PIVNICA', 'GOSTILNA', 'NEBO', 'TROPIC', 'PIZZA', 'BURGER', 'DONER', 'KEBAB'], color: '#EC4899', icon: 'üçî' },
      'Travel': { keywords: ['ASFINAG', 'DARS', 'EVINJETA', 'BOOKING', 'HOTEL', 'TERME', 'AVTOCAMP', 'RAILWAYS', 'BANKOMAT DVIG', 'AIRBNB', 'HOSTEL', 'RENT A CAR'], color: '#3B82F6', icon: '‚úàÔ∏è' },
      'Shopping': { keywords: ['ZARA', 'AMAZON', 'AMZN', 'ALDI', 'H&M', 'ABOUTYOU', 'ABOUT YOU', 'MERKUR', 'DM -', 'DM-', 'IKEA', 'DECATHLON', 'ALIEXPRESS', 'SHEIN'], color: '#8B5CF6', icon: 'üõçÔ∏è' },
      'Entertainment': { keywords: ['BOLDER SCENA', 'OLAII', 'VSTOPNICE', 'KINO', 'NETFLIX', 'SPOTIFY', 'YOUTUBE', 'STEAM', 'PLAYSTATION', 'XBOX'], color: '#06B6D4', icon: 'üé¨' },
      'Transportation': { keywords: ['CAR PAYMENT', 'AUTOHAUS', 'TEHNICNI PREGLEDI', 'PSTOP', 'PARK', 'TAXI', 'UBER', 'BOLT', 'BUS', 'TRAIN'], color: '#EF4444', icon: 'üöó' },
      'Transfers': { keywords: ['REVOLUT', 'QUASI CASH', 'FLIK', 'PAYPAL', 'WISE'], color: '#6366F1', icon: 'üí∏' },
      'Education': { keywords: ['UL EF', 'FAKULT', 'UNIV', 'STUDENT', 'KNJIG'], color: '#F472B6', icon: 'üéì' },
      'Health': { keywords: ['LEKARNA', 'APOTEKA', 'ZDRAVSTV', 'DOCTOR', 'CLINIC', 'HOSPITAL'], color: '#84CC16', icon: 'üè•' },
      'Services': { keywords: ['POSTA', 'PROVIZIJA', 'TELEKOM', 'NYX', 'TELEMACH', 'A1 ', 'ELEKTRO', 'KOMUNALA'], color: '#64748B', icon: 'üìã' },
      'Income': { keywords: ['ADRIAL', 'REDNO DELO', 'PLACA', 'SICOD', 'RETURN', 'VRACILO', 'STIPENDIJA'], color: '#22C55E', icon: 'üí∞' },
      'Personal': { keywords: ['ROK ', 'MILAN V', 'ANDRAZ', 'NEJC P', 'MIHA M', 'ANJUSA', 'SIMON', 'FLIK PLA'], color: '#14B8A6', icon: 'üë§' },
      'Other': { keywords: [], color: '#94A3B8', icon: 'üí≥' }
    };

    function formatCurrency(amount) {
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
    }

    function categorize(description) {
      const upper = description.toUpperCase();
      for (const [cat, config] of Object.entries(CATEGORIES)) {
        if (cat === 'Other') continue;
        if (config.keywords.some(k => upper.includes(k.toUpperCase()))) return cat;
      }
      return 'Other';
    }

    // FIXED: More robust date parsing
    function parseDate(dateStr) {
      try {
        if (!dateStr || typeof dateStr !== 'string') {
          return null;
        }
        
        const parts = dateStr.split('.');
        if (parts.length !== 3) {
          return null;
        }
        
        const d = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        let y = parseInt(parts[2], 10);
        
        // Validate parsed values
        if (isNaN(d) || isNaN(m) || isNaN(y)) {
          return null;
        }
        
        // Handle 2-digit year
        if (y < 100) {
          y = 2000 + y;
        }
        
        // Validate ranges
        if (d < 1 || d > 31 || m < 1 || m > 12 || y < 2000 || y > 2100) {
          return null;
        }
        
        const date = new Date(y, m - 1, d);
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
          return null;
        }
        
        return date;
      } catch (e) {
        console.error('Date parse error:', e, dateStr);
        return null;
      }
    }

    function parseStatement(text) {
      const txns = [];
      const cleanText = text.replace(/\s+/g, ' ');
      const datePattern = /(\d{2}\.\d{2}\.\d{2})/g;
      const dates = [];
      let match;
      
      while ((match = datePattern.exec(cleanText)) !== null) {
        dates.push({ date: match[1], index: match.index });
      }
      
      for (let i = 0; i < dates.length; i++) {
        const startIdx = dates[i].index;
        const endIdx = (i + 1 < dates.length) ? dates[i + 1].index : cleanText.length;
        const segment = cleanText.substring(startIdx, endIdx).trim();
        
        if (/STANJE|SKUPNI|Datum izpiska|predhodnega|LETNA OBRESTNA|EUR\s*-\s*EVRO|NLB PAKET|Obvestilo|Varnostna/i.test(segment)) {
          continue;
        }
        
        const date = dates[i].date;
        const amountPattern = /([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g;
        const amounts = [];
        let amtMatch;
        
        while ((amtMatch = amountPattern.exec(segment)) !== null) {
          amounts.push(amtMatch[1]);
        }
        
        if (amounts.length >= 2) {
          const amtStr = amounts[amounts.length - 2];
          const balStr = amounts[amounts.length - 1];
          
          let amt = parseFloat(amtStr.replace(/\./g, '').replace(',', '.'));
          const bal = parseFloat(balStr.replace(/\./g, '').replace(',', '.'));
          
          const firstAmtIdx = segment.indexOf(amounts[0]);
          let desc = segment.substring(date.length, firstAmtIdx).trim();
          desc = desc.replace(/^\s*[\.,]\s*/, '').trim();
          
          if (!desc || desc.length < 2) continue;
          
          const isIncome = amtStr.startsWith('+') || /ADRIAL|REDNO DELO|RETURN|SICOD|VRACILO/i.test(desc);
          
          if (!amtStr.startsWith('+') && !amtStr.startsWith('-') && !isIncome) {
            amt = -Math.abs(amt);
          }
          
          let category = categorize(desc);
          if (amt > 0 && category === 'Other') category = 'Income';
          
          // FIXED: Only add if date is valid
          const parsedDate = parseDate(date);
          if (parsedDate) {
            txns.push({
              id: `${date}-${txns.length}-${Math.random().toString(36).substr(2, 5)}`,
              date,
              parsedDate,
              year: parsedDate.getFullYear(),
              month: parsedDate.getMonth(),
              description: desc,
              amount: amt,
              balance: bal,
              category
            });
          }
        }
      }
      
      return txns;
    }

    async function extractPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        
        let lastY = null;
        content.items.forEach(item => {
          if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
            fullText += '\n';
          }
          fullText += item.str + ' ';
          lastY = item.transform[5];
        });
        fullText += '\n';
      }
      
      return fullText;
    }

    async function handleFiles(files) {
      const pdfs = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) return;

      document.getElementById('uploadContent').classList.add('hidden');
      document.getElementById('uploadLoading').classList.remove('hidden');
      document.getElementById('errorBox').classList.add('hidden');

      let totalParsed = 0;
      
      try {
        for (let idx = 0; idx < pdfs.length; idx++) {
          const file = pdfs[idx];
          if (uploadedFiles.includes(file.name)) continue;
          
          document.getElementById('loadingStatus').textContent = `Processing ${idx + 1}/${pdfs.length}: ${file.name}`;
          
          const text = await extractPDF(file);
          const parsed = parseStatement(text);
          
          totalParsed += parsed.length;
          allTransactions = [...allTransactions, ...parsed];
          uploadedFiles.push(file.name);
        }

        const seen = new Set();
        allTransactions = allTransactions.filter(t => {
          const key = `${t.date}-${t.description}-${t.amount}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        // FIXED: Sort with null check
        allTransactions.sort((a, b) => {
          if (!a.parsedDate || !b.parsedDate) return 0;
          return a.parsedDate.getTime() - b.parsedDate.getTime();
        });

        if (totalParsed === 0 && allTransactions.length === 0) {
          document.getElementById('errorBox').textContent = 'No transactions found in the uploaded files.';
          document.getElementById('errorBox').classList.remove('hidden');
        }

        saveData();
        applyFilters();
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('errorBox').textContent = `Error: ${err.message}`;
        document.getElementById('errorBox').classList.remove('hidden');
      }

      document.getElementById('uploadContent').classList.remove('hidden');
      document.getElementById('uploadLoading').classList.add('hidden');
    }

    function saveData() {
      try {
        const dataToSave = {
          transactions: allTransactions.map(t => ({
            ...t,
            parsedDate: t.parsedDate ? t.parsedDate.toISOString() : null
          })),
          uploadedFiles
        };
        localStorage.setItem('bankAnalyzer', JSON.stringify(dataToSave));
      } catch (e) {
        console.error('Save error:', e);
      }
    }

    function loadData() {
      try {
        const saved = localStorage.getItem('bankAnalyzer');
        if (saved) {
          const data = JSON.parse(saved);
          allTransactions = (data.transactions || []).map(t => {
            let parsedDate = null;
            if (t.parsedDate) {
              parsedDate = new Date(t.parsedDate);
              if (isNaN(parsedDate.getTime())) {
                parsedDate = parseDate(t.date);
              }
            } else {
              parsedDate = parseDate(t.date);
            }
            return {
              ...t,
              parsedDate,
              year: parsedDate ? parsedDate.getFullYear() : 2025,
              month: parsedDate ? parsedDate.getMonth() : 0
            };
          }).filter(t => t.parsedDate !== null);
          uploadedFiles = data.uploadedFiles || [];
        }
      } catch (e) {
        console.error('Load error:', e);
        allTransactions = [];
        uploadedFiles = [];
      }
    }

    function clearAllData() {
      if (confirm('Clear all data?')) {
        allTransactions = [];
        filteredTransactions = [];
        uploadedFiles = [];
        localStorage.removeItem('bankAnalyzer');
        location.reload();
      }
    }

    function filterByCategory(cat) {
      selectedCategory = selectedCategory === cat ? null : cat;
      applyFilters();
    }

    function clearCategoryFilter() {
      selectedCategory = null;
      applyFilters();
    }

    function selectMonth(month) {
      selectedMonth = selectedMonth === month ? 'all' : month;
      applyFilters();
    }

    function resetFilters() {
      selectedYear = 'all';
      selectedMonth = 'all';
      selectedCategory = null;
      searchQuery = '';
      document.getElementById('yearFilter').value = 'all';
      document.getElementById('searchBox').value = '';
      applyFilters();
    }

    function applyFilters() {
      selectedYear = document.getElementById('yearFilter')?.value || 'all';
      searchQuery = document.getElementById('searchBox')?.value?.toLowerCase() || '';
      
      filteredTransactions = allTransactions.filter(t => {
        if (!t.parsedDate) return false;
        if (selectedYear !== 'all' && t.year !== parseInt(selectedYear)) return false;
        if (selectedMonth !== 'all' && t.month !== parseInt(selectedMonth)) return false;
        if (selectedCategory && t.category !== selectedCategory) return false;
        if (searchQuery && !t.description.toLowerCase().includes(searchQuery)) return false;
        return true;
      });
      
      showAll = false;
      render();
    }

    function toggleShowAll() {
      showAll = !showAll;
      renderTransactions();
    }

    function exportToCSV() {
      const headers = ['Date', 'Description', 'Amount', 'Balance', 'Category'];
      const rows = filteredTransactions.map(t => [
        t.date,
        `"${t.description.replace(/"/g, '""')}"`,
        t.amount.toFixed(2),
        t.balance.toFixed(2),
        t.category
      ]);
      
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `bank-transactions-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      URL.revokeObjectURL(url);
    }

    function getMonthComparison() {
      if (allTransactions.length === 0) return null;
      
      let currentMonth, currentYear, prevMonth, prevYear;
      
      if (selectedMonth !== 'all' && selectedYear !== 'all') {
        currentMonth = parseInt(selectedMonth);
        currentYear = parseInt(selectedYear);
      } else {
        const validTxns = allTransactions.filter(t => t.parsedDate);
        if (validTxns.length === 0) return null;
        const latestTxn = validTxns[validTxns.length - 1];
        currentMonth = latestTxn.month;
        currentYear = latestTxn.year;
      }
      
      if (currentMonth === 0) {
        prevMonth = 11;
        prevYear = currentYear - 1;
      } else {
        prevMonth = currentMonth - 1;
        prevYear = currentYear;
      }
      
      const currentData = allTransactions.filter(t => t.year === currentYear && t.month === currentMonth);
      const prevData = allTransactions.filter(t => t.year === prevYear && t.month === prevMonth);
      
      if (currentData.length === 0 && prevData.length === 0) return null;
      
      const currentExpenses = Math.abs(currentData.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      const prevExpenses = Math.abs(prevData.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      
      const currentIncome = currentData.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      const prevIncome = prevData.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      
      const expenseChange = prevExpenses > 0 ? ((currentExpenses - prevExpenses) / prevExpenses) * 100 : 0;
      const incomeChange = prevIncome > 0 ? ((currentIncome - prevIncome) / prevIncome) * 100 : 0;
      
      return {
        currentMonth: FULL_MONTHS[currentMonth],
        currentYear,
        prevMonth: FULL_MONTHS[prevMonth],
        prevYear,
        currentExpenses,
        prevExpenses,
        currentIncome,
        prevIncome,
        expenseChange,
        incomeChange
      };
    }

    function render() {
      document.getElementById('fileTags').innerHTML = uploadedFiles.map(f => `<span class="file-tag">üìÑ ${f}</span>`).join('');

      if (allTransactions.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('headerActions').classList.add('hidden');
        return;
      }

      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('headerActions').classList.remove('hidden');

      const years = [...new Set(allTransactions.map(t => t.year))].sort();
      document.getElementById('yearFilter').innerHTML = '<option value="all">All Years</option>' + 
        years.map(y => `<option value="${y}" ${selectedYear == y ? 'selected' : ''}>${y}</option>`).join('');

      document.getElementById('monthPills').innerHTML = 
        `<span class="month-pill ${selectedMonth === 'all' ? 'active' : ''}" onclick="selectMonth('all')">All</span>` +
        MONTHS.map((m, i) => `<span class="month-pill ${selectedMonth === i ? 'active' : ''}" onclick="selectMonth(${i})">${m}</span>`).join('');

      const income = filteredTransactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      const expenses = Math.abs(filteredTransactions.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      const net = income - expenses;
      const incomeCount = filteredTransactions.filter(t => t.amount > 0).length;
      const expenseCount = filteredTransactions.filter(t => t.amount < 0).length;

      const savingsRate = income > 0 ? ((income - expenses) / income) * 100 : 0;
      const savingsClass = savingsRate >= 20 ? 'good' : savingsRate >= 10 ? 'ok' : 'bad';

      let dateRange = '-';
      let avgDaily = 0;
      if (filteredTransactions.length > 0) {
        const validTxns = filteredTransactions.filter(t => t.parsedDate);
        if (validTxns.length > 0) {
          const first = validTxns[0].date;
          const last = validTxns[validTxns.length - 1].date;
          dateRange = `${first} - ${last}`;
          
          const firstDate = validTxns[0].parsedDate;
          const lastDate = validTxns[validTxns.length - 1].parsedDate;
          const days = Math.max(1, Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)));
          avgDaily = expenses / days;
        }
      }

      document.getElementById('totalIncome').textContent = formatCurrency(income);
      document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
      document.getElementById('netBalance').textContent = (net >= 0 ? '+' : '') + formatCurrency(net);
      document.getElementById('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
      document.getElementById('incomeCount').textContent = `${incomeCount} transactions`;
      document.getElementById('expenseCount').textContent = `${expenseCount} transactions`;
      document.getElementById('savingsRate').textContent = savingsRate.toFixed(1) + '%';
      document.getElementById('savingsGauge').style.width = Math.max(0, Math.min(100, savingsRate)) + '%';
      document.getElementById('savingsGauge').className = 'savings-gauge-fill ' + savingsClass;
      document.getElementById('txnTotal').textContent = filteredTransactions.length;
      document.getElementById('dateRange').textContent = dateRange;
      document.getElementById('avgDaily').textContent = `Avg/day: ${formatCurrency(avgDaily)}`;

      const comparison = getMonthComparison();
      if (comparison && (comparison.prevExpenses > 0 || comparison.currentExpenses > 0)) {
        document.getElementById('comparisonBox').classList.remove('hidden');
        document.getElementById('comparisonGrid').innerHTML = `
          <div class="comparison-item">
            <div class="comparison-label">üìÖ ${comparison.currentMonth} ${comparison.currentYear}</div>
            <div class="comparison-value" style="color: #fb7185;">${formatCurrency(comparison.currentExpenses)}</div>
            <div class="comparison-change ${comparison.expenseChange > 0 ? 'up' : comparison.expenseChange < 0 ? 'down' : 'neutral'}">
              ${comparison.expenseChange > 0 ? '‚Üë' : comparison.expenseChange < 0 ? '‚Üì' : '‚Üí'} 
              ${Math.abs(comparison.expenseChange).toFixed(1)}% vs ${comparison.prevMonth}
            </div>
          </div>
          <div class="comparison-item">
            <div class="comparison-label">üìÖ ${comparison.prevMonth} ${comparison.prevYear}</div>
            <div class="comparison-value" style="color: #94a3b8;">${formatCurrency(comparison.prevExpenses)}</div>
            <div class="comparison-change neutral">Previous month</div>
          </div>
          <div class="comparison-item">
            <div class="comparison-label">üí∞ Income Change</div>
            <div class="comparison-value" style="color: ${comparison.incomeChange >= 0 ? '#34d399' : '#fb7185'};">
              ${comparison.incomeChange >= 0 ? '+' : ''}${comparison.incomeChange.toFixed(1)}%
            </div>
            <div class="comparison-change ${comparison.incomeChange >= 0 ? 'down' : 'up'}">
              ${formatCurrency(comparison.currentIncome)} vs ${formatCurrency(comparison.prevIncome)}
            </div>
          </div>
          <div class="comparison-item">
            <div class="comparison-label">üíµ Difference</div>
            <div class="comparison-value" style="color: ${comparison.currentExpenses <= comparison.prevExpenses ? '#34d399' : '#fb7185'};">
              ${comparison.currentExpenses <= comparison.prevExpenses ? '‚àí' : '+'}${formatCurrency(Math.abs(comparison.currentExpenses - comparison.prevExpenses))}
            </div>
            <div class="comparison-change ${comparison.currentExpenses <= comparison.prevExpenses ? 'down' : 'up'}">
              ${comparison.currentExpenses <= comparison.prevExpenses ? 'Saved!' : 'Spent more'}
            </div>
          </div>
        `;
      } else {
        document.getElementById('comparisonBox').classList.add('hidden');
      }

      const catTotals = {};
      filteredTransactions.filter(t => t.amount < 0).forEach(t => {
        catTotals[t.category] = (catTotals[t.category] || 0) + Math.abs(t.amount);
      });
      const sortedCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);

      document.getElementById('categoryList').innerHTML = sortedCats.map(([cat, amount]) => {
        const config = CATEGORIES[cat] || CATEGORIES.Other;
        const pct = expenses > 0 ? ((amount / expenses) * 100).toFixed(1) : '0';
        return `
          <div class="category-item ${selectedCategory === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">
            <div class="category-icon" style="background:${config.color}20">${config.icon}</div>
            <div class="category-info">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span class="category-name">${cat}</span>
                <span class="category-amount">${formatCurrency(amount)}</span>
              </div>
              <div class="category-bar"><div class="category-bar-fill" style="width:${pct}%;background:${config.color}"></div></div>
            </div>
            <span class="category-percent">${pct}%</span>
          </div>
        `;
      }).join('');

      renderTopExpenses();
      renderCharts(sortedCats, expenses);
      renderMonthlyChart();
      renderTransactions();
    }

    function renderTopExpenses() {
      const topExpenses = filteredTransactions
        .filter(t => t.amount < 0)
        .sort((a, b) => a.amount - b.amount)
        .slice(0, 10);

      document.getElementById('topExpensesList').innerHTML = topExpenses.map((t, i) => {
        const config = CATEGORIES[t.category] || CATEGORIES.Other;
        let rankClass = i === 0 ? '' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'silver';
        
        return `
          <div class="top-expense-item">
            <div class="top-expense-rank ${rankClass}">${i + 1}</div>
            <div class="category-icon" style="background:${config.color}20; width:32px; height:32px; font-size:14px;">${config.icon}</div>
            <div class="top-expense-details">
              <div class="top-expense-desc">${t.description}</div>
              <div class="top-expense-meta">${t.date} ‚Ä¢ ${t.category}</div>
            </div>
            <div class="top-expense-amount">${formatCurrency(t.amount)}</div>
          </div>
        `;
      }).join('');
    }

    function renderCharts(sortedCats, expenses) {
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      
      if (sortedCats.length > 0) {
        pieChart = new Chart(pieCtx, {
          type: 'doughnut',
          data: {
            labels: sortedCats.map(([c]) => c),
            datasets: [{
              data: sortedCats.map(([, v]) => v),
              backgroundColor: sortedCats.map(([c]) => (CATEGORIES[c] || CATEGORIES.Other).color),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}` } }
            },
            onClick: (e, elements) => {
              if (elements.length) filterByCategory(sortedCats[elements[0].index][0]);
            }
          }
        });
      }

      const lineCtx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();

      const dailyBal = [];
      const balByDate = {};
      filteredTransactions.forEach(t => balByDate[t.date] = t.balance);
      Object.entries(balByDate).forEach(([date, balance]) => dailyBal.push({ date, balance }));

      if (dailyBal.length > 0) {
        lineChart = new Chart(lineCtx, {
          type: 'line',
          data: {
            labels: dailyBal.map(d => d.date),
            datasets: [{
              data: dailyBal.map(d => d.balance),
              borderColor: '#22d3ee',
              backgroundColor: 'rgba(34, 211, 238, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { color: '#334155' }, ticks: { color: '#64748b', maxTicksLimit: 8 } },
              y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => (v/1000).toFixed(0) + 'k' } }
            }
          }
        });
      }
    }

    function renderMonthlyChart() {
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if (monthlyChart) monthlyChart.destroy();

      const monthlyData = {};
      allTransactions.forEach(t => {
        if (!t.year || t.month === undefined) return;
        const key = `${t.year}-${String(t.month + 1).padStart(2, '0')}`;
        if (!monthlyData[key]) monthlyData[key] = { income: 0, expenses: 0 };
        if (t.amount > 0) monthlyData[key].income += t.amount;
        else monthlyData[key].expenses += Math.abs(t.amount);
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      
      if (sortedMonths.length > 0) {
        const labels = sortedMonths.map(k => {
          const [y, m] = k.split('-');
          return `${MONTHS[parseInt(m) - 1]} ${y.slice(2)}`;
        });

        monthlyChart = new Chart(monthlyCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Income', data: sortedMonths.map(k => monthlyData[k].income), backgroundColor: '#22C55E' },
              { label: 'Expenses', data: sortedMonths.map(k => monthlyData[k].expenses), backgroundColor: '#fb7185' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true, position: 'top', labels: { color: '#94a3b8', usePointStyle: true } },
              tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } }
            },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#64748b' } },
              y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => (v/1000).toFixed(0) + 'k' } }
            }
          }
        });
      }
    }

    function renderTransactions() {
      const displayed = showAll ? filteredTransactions.slice().reverse() : filteredTransactions.slice(-15).reverse();

      document.getElementById('txnTitle').textContent = selectedCategory ? `${selectedCategory}` : 'Transactions';
      document.getElementById('clearCatFilter').classList.toggle('hidden', !selectedCategory);
      document.getElementById('txnListCount').textContent = `${filteredTransactions.length} items`;

      document.getElementById('transactionList').innerHTML = displayed.map(t => {
        const config = CATEGORIES[t.category] || CATEGORIES.Other;
        const isPositive = t.amount > 0;
        return `
          <div class="transaction">
            <div class="transaction-icon" style="background:${config.color}20">${config.icon}</div>
            <div class="transaction-details">
              <div class="transaction-desc">${t.description}</div>
              <div class="transaction-meta">${t.date}<span class="transaction-cat" style="background:${config.color}20;color:${config.color}">${t.category}</span></div>
            </div>
            <div class="transaction-amount">
              <div class="transaction-amount-value ${isPositive ? 'positive' : ''}">${isPositive ? '+' : ''}${formatCurrency(t.amount)}</div>
              <div class="transaction-balance">Bal: ${formatCurrency(t.balance)}</div>
            </div>
          </div>
        `;
      }).join('');

      const showBtn = document.getElementById('showMoreBtn');
      if (filteredTransactions.length > 15) {
        showBtn.classList.remove('hidden');
        showBtn.textContent = showAll ? '‚ñ≤ Show less' : `‚ñº Show all ${filteredTransactions.length}`;
      } else {
        showBtn.classList.add('hidden');
      }
    }

    document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));
    
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragging'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
    uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragging'); handleFiles(e.dataTransfer.files); });

    loadData();
    applyFilters();
    console.log('Bank Analyzer v3.1 loaded!');
  </script>
</body>
</html>
