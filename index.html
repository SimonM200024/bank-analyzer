<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer v9</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
:root{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:rgba(30,41,59,0.5);--bg-item:rgba(51,65,85,0.3);--border:#334155;--text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;--accent:#22d3ee;--accent2:#34d399}
.light-mode{--bg-primary:#f1f5f9;--bg-secondary:#e2e8f0;--bg-card:rgba(255,255,255,0.8);--bg-item:rgba(241,245,249,0.8);--border:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--text-muted:#64748b}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',system-ui,sans-serif;background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary));color:var(--text-primary);min-height:100vh}
.app-container{display:flex;flex-direction:column;min-height:100vh}
.nav-tabs{display:flex;gap:0;background:var(--bg-card);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100}
.nav-tab{padding:16px 24px;font-size:14px;font-weight:500;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;display:flex;align-items:center;gap:8px;transition:all .2s}
.nav-tab:hover{color:var(--text-primary);background:var(--bg-item)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.nav-tab .badge{background:var(--accent);color:#0f172a;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
.page{display:none;padding:20px;flex:1}.page.active{display:block}
.container{max-width:1200px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.logo{display:flex;align-items:center;gap:12px}.logo-icon{width:44px;height:44px;background:linear-gradient(135deg,#34d399,#22d3ee);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.logo h1{font-size:20px}.logo p{font-size:12px;color:var(--text-muted)}.header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{background:var(--bg-item);border-color:var(--accent)}
.user-menu{position:relative}.user-dropdown{position:absolute;top:48px;right:0;background:var(--bg-primary);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:220px;z-index:1000;display:none}
.user-dropdown.show{display:block}.user-item{padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-content:center;gap:10px}
.user-item:hover{background:var(--bg-item)}
.filters{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.filter-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px}
.month-pills{display:flex;gap:6px;flex-wrap:wrap}.month-pill{padding:6px 12px;background:var(--bg-item);border:1px solid var(--border);border-radius:20px;color:var(--text-secondary);font-size:12px;cursor:pointer}
.month-pill.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}.filter-btn{padding:8px 16px;background:var(--bg-item);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-bottom:24px}
.card{padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.1);background:var(--bg-card)}.card-label{color:var(--text-secondary);font-size:12px;margin-bottom:4px}
.card-value{font-size:20px;font-weight:700;font-family:monospace}.card-value.green{color:#34d399}.card-value.red{color:#fb7185}.card-value.blue{color:#22d3ee}.card-value.purple{color:#a78bfa}.card-value.yellow{color:#fbbf24}
.card-sub{font-size:11px;color:var(--text-muted);margin-top:4px}
.chart-box{padding:20px;border-radius:14px;background:var(--bg-card);border:1px solid var(--border);margin-bottom:20px}
.chart-box h3{font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px}.badge{font-size:10px;padding:2px 6px;background:var(--accent);color:#0f172a;border-radius:8px}
.chart-container{position:relative;height:260px}.chart-container.tall{height:320px}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px}
.item-list{display:flex;flex-direction:column;gap:8px}.list-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-item);border-radius:10px}
.list-item:hover{background:var(--bg-card)}.list-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.list-info{flex:1;min-width:0}.list-title{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.list-sub{font-size:12px;color:var(--text-muted)}
.list-value{font-family:monospace;font-weight:600;color:#fb7185;font-size:14px}.list-value.cyan{color:#22d3ee}
.rank{width:24px;height:24px;background:var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}
.transactions{border-radius:14px;background:var(--bg-card);border:1px solid var(--border);overflow:hidden;margin-bottom:24px}
.transactions-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.transaction{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--bg-secondary);cursor:pointer}.transaction:hover{background:var(--bg-item)}
.txn-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.txn-details{flex:1;min-width:0}.txn-desc{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.txn-meta{font-size:11px;color:var(--text-muted)}
.txn-cat{padding:2px 6px;border-radius:8px;font-size:10px;margin-left:6px}.txn-note{font-size:10px;color:#a78bfa;margin-left:6px}
.txn-amount{text-align:right}.txn-amt{font-weight:600;font-family:monospace;font-size:14px}.txn-amt.pos{color:#34d399}
.txn-bal{font-size:10px;color:var(--text-muted)}.show-more{width:100%;padding:12px;background:transparent;border:none;border-top:1px solid var(--bg-secondary);color:var(--text-secondary);cursor:pointer}
.btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:6px;font-weight:500}
.btn-red{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#f87171}.btn-green{background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#4ade80}
.btn-blue{background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#a5b4fc}.btn-yellow{background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);color:#fbbf24}
.btn-cyan{background:rgba(34,211,238,0.15);border:1px solid rgba(34,211,238,0.3);color:#22d3ee}
.btn-primary{background:linear-gradient(135deg,#22d3ee,#34d399);color:#0f172a;border:none}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}.empty-icon{font-size:56px;margin-bottom:16px}
.footer{text-align:center;padding:24px 0;color:var(--text-muted);font-size:12px}.hidden{display:none!important}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}@keyframes spin{to{transform:rotate(360deg)}}
.search-box{flex:1;max-width:260px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px}
.savings-gauge{width:100%;height:6px;background:var(--border);border-radius:3px;margin-top:6px;overflow:hidden}
.savings-gauge-fill{height:100%;border-radius:3px}.savings-gauge-fill.good{background:#34d399}.savings-gauge-fill.ok{background:#fbbf24}.savings-gauge-fill.bad{background:#fb7185}
.heatmap-container{overflow-x:auto}.heatmap{display:flex;gap:6px}.heatmap-grid{display:flex;gap:2px}.heatmap-week{display:flex;flex-direction:column;gap:2px}
.heatmap-cell{width:12px;height:12px;border-radius:2px;background:var(--bg-item)}.heatmap-cell.l1{background:rgba(34,197,94,0.3)}.heatmap-cell.l2{background:rgba(250,204,21,0.4)}.heatmap-cell.l3{background:rgba(249,115,22,0.5)}.heatmap-cell.l4{background:rgba(239,68,68,0.7)}
.heatmap-legend{display:flex;align-items:center;gap:6px;margin-top:12px;justify-content:flex-end;font-size:10px;color:var(--text-muted)}
.weekday-bars{display:flex;gap:6px;align-items:flex-end;height:160px;padding:16px 0}.weekday-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.weekday-fill{width:100%;border-radius:4px 4px 0 0;min-height:4px}.weekday-label{font-size:11px;color:var(--text-secondary)}.weekday-value{font-size:10px;color:var(--text-muted);font-family:monospace}
.weekday-bar.highlight .weekday-label{color:#fb7185;font-weight:600}
.yoy-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.yoy-item{padding:16px 14px;background:var(--bg-item);border-radius:10px;text-align:center;min-height:110px;display:flex;flex-direction:column;justify-content:space-between}
.yoy-label{font-size:11px;color:var(--text-muted);margin-bottom:4px}.yoy-values{display:flex;justify-content:center;gap:12px;margin-bottom:6px}
.yoy-year{text-align:center}.yoy-year-label{font-size:10px;color:var(--text-muted)}.yoy-year-value{font-size:16px;font-weight:600;font-family:monospace}
.yoy-change{font-size:12px;font-weight:500}.yoy-change.up{color:#fb7185}.yoy-change.down{color:#34d399}.yoy-change.neutral{color:var(--text-muted)}
.auth-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0f172a,#1e293b);display:flex;align-items:center;justify-content:center;z-index:10000}
.auth-box{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;max-width:380px;width:90%}
.auth-box h2{margin-bottom:8px;font-size:24px}.auth-box p{color:var(--text-muted);margin-bottom:24px;font-size:14px}
.auth-input{width:100%;padding:12px 16px;background:var(--bg-item);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:14px;margin-bottom:12px}
.auth-input:focus{outline:none;border-color:var(--accent)}
.auth-btn{width:100%;padding:14px;border-radius:10px;font-size:15px;font-weight:600;margin-top:8px}
.auth-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--text-muted);font-size:13px}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-toggle{color:var(--accent);cursor:pointer;margin-top:20px;font-size:13px}.auth-toggle:hover{text-decoration:underline}
.auth-error{color:#fb7185;font-size:12px;margin-top:12px;padding:10px;background:rgba(251,113,133,0.1);border-radius:8px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000}
.modal-box{background:var(--bg-primary);border:1px solid var(--border);border-radius:14px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal-box h2{margin-bottom:14px}.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
.cat-editor{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:14px}
.cat-opt{padding:10px 6px;background:var(--bg-item);border:2px solid transparent;border-radius:8px;cursor:pointer;text-align:center}
.cat-opt:hover{background:var(--bg-card)}.cat-opt.selected{border-color:var(--accent);background:rgba(34,211,238,0.1)}
.cat-opt-icon{font-size:20px;margin-bottom:4px}.cat-opt-name{font-size:10px;color:var(--text-secondary)}
.note-input{width:100%;padding:10px;background:var(--bg-item);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px;margin-bottom:10px}
.rule-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-item);border-radius:8px;margin-bottom:6px}
.rule-desc{flex:1;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:10px}
.rule-cat{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary)}
.rule-delete{color:#fb7185;cursor:pointer;padding:4px 8px;font-size:12px}
.notif-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
.notif{padding:14px 18px;background:var(--bg-primary);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:12px;animation:slideIn .3s;max-width:340px;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.notif.warning{border-color:rgba(251,191,36,0.5);background:rgba(251,191,36,0.1)}.notif.success{border-color:rgba(34,197,94,0.5);background:rgba(34,197,94,0.1)}
.notif.info{border-color:rgba(99,102,241,0.5);background:rgba(99,102,241,0.1)}
.notif-icon{font-size:20px}.notif-text{flex:1;font-size:13px}.notif-close{cursor:pointer;color:var(--text-muted);font-size:16px}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.import-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.import-card.inactive{opacity:0.6}.import-card:hover{border-color:var(--accent)}
.import-icon{width:48px;height:48px;background:var(--bg-item);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
.import-info{flex:1}.import-name{font-weight:600;font-size:15px;margin-bottom:4px}.import-meta{font-size:12px;color:var(--text-muted);display:flex;gap:12px;flex-wrap:wrap}
.import-actions{display:flex;gap:8px;align-items:center}
.import-toggle{width:48px;height:26px;background:var(--border);border-radius:13px;position:relative;cursor:pointer;transition:background .2s}
.import-toggle.active{background:var(--accent2)}
.import-toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
.import-toggle.active::after{transform:translateX(22px)}
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px 24px;text-align:center;margin-bottom:24px;background:var(--bg-card);cursor:pointer}
.upload-zone:hover{border-color:var(--accent2)}.upload-zone input{display:none}.upload-icon{font-size:48px;margin-bottom:12px}
.import-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
.import-stat{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.import-stat-value{font-size:24px;font-weight:700;font-family:monospace;color:var(--accent)}.import-stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
.bulk-actions{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.user-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.user-card:hover{border-color:var(--accent)}.user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#0f172a;font-weight:600}
.user-info{flex:1}.user-name{font-weight:600;font-size:15px;margin-bottom:2px}.user-email{font-size:12px;color:var(--text-muted)}.user-meta{font-size:11px;color:var(--text-muted);margin-top:4px}
.user-actions{display:flex;gap:8px}
.role-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
.role-badge.admin{background:rgba(251,191,36,0.2);color:#fbbf24}.role-badge.user{background:rgba(34,211,238,0.2);color:#22d3ee}
.loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0f172a,#1e293b);display:flex;align-items:center;justify-content:center;z-index:10001;flex-direction:column;gap:16px}
.loading-screen .spinner{width:48px;height:48px}
@media print{body{background:#fff!important;color:#000!important}.no-print,.nav-tabs{display:none!important}.page{display:block!important}}
  </style>
</head>
<body>
<div class="notif-container" id="notifContainer"></div>
<div class="loading-screen" id="loadingScreen"><div class="spinner"></div><p style="color:var(--text-muted)">Loading...</p></div>
<!-- AUTH SCREEN -->
<div class="auth-screen hidden" id="authScreen">
  <div class="auth-box">
    <div style="font-size:48px;margin-bottom:16px">üí≥</div>
    <h2>Bank Analyzer</h2>
    <p id="authSubtitle">Sign in to continue</p>
    <div id="authForm">
      <input type="email" class="auth-input" id="authEmail" placeholder="Email address">
      <input type="password" class="auth-input" id="authPassword" placeholder="Password">
      <input type="text" class="auth-input hidden" id="authName" placeholder="Your name">
      <button class="btn btn-primary auth-btn" id="authSubmit" onclick="handleAuth()">Sign In</button>
      <div class="auth-error hidden" id="authError"></div>
    </div>
    <div class="auth-toggle" id="authToggle" onclick="toggleAuthMode()">Don't have an account? Sign up</div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app-container hidden" id="mainApp">
  <nav class="nav-tabs no-print">
    <div class="nav-tab active" onclick="switchPage('overview')" id="tabOverview">üìä Overview</div>
    <div class="nav-tab" onclick="switchPage('imports')" id="tabImports">üìÅ Imports <span class="badge" id="importsBadge">0</span></div>
    <div class="nav-tab hidden" onclick="switchPage('users')" id="tabUsers">üë• Users <span class="badge" id="usersBadge">0</span></div>
    <div style="flex:1"></div>
    <div class="header-actions" style="padding:8px 0">
      <select class="filter-select hidden" id="viewAsUser" onchange="viewAsUser()" style="max-width:160px"><option value="">My Data</option></select>
      <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="Theme">üåô</button>
      <button class="icon-btn" onclick="showRulesModal()" title="Rules">üìã</button>
      <button class="icon-btn" onclick="exportCSV()" title="Export">üì•</button>
      <div class="user-menu">
        <button class="icon-btn" onclick="toggleUserMenu()" id="userMenuBtn" title="Account">üë§</button>
        <div class="user-dropdown" id="userDropdown">
          <div style="padding:12px;border-bottom:1px solid var(--border)">
            <div style="font-weight:600" id="menuUserName">User</div>
            <div style="font-size:12px;color:var(--text-muted)" id="menuUserEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e0858d81898ca08598818d908c85ce838f8d">[email&#160;protected]</a></div>
          </div>
          <div class="user-item" onclick="showProfileModal()">‚öôÔ∏è Settings</div>
          <div class="user-item" onclick="signOut()" style="color:#fb7185">üö™ Sign Out</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- OVERVIEW PAGE -->
  <div class="page active" id="pageOverview">
    <div class="container">
      <header class="header">
        <div class="logo"><div class="logo-icon">üí≥</div><div><h1>Bank Analyzer</h1><p id="profileName">Loading...</p></div></div>
      </header>
      <div id="emptyState" class="empty-state"><div class="empty-icon">üìä</div><h2>No transactions loaded</h2><p>Go to Imports tab to add bank statements</p><button class="btn btn-cyan" onclick="switchPage('imports')" style="margin-top:16px">üìÅ Go to Imports</button></div>
      <div id="dashboard" class="hidden">
        <div class="filters no-print">
          <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
          <div class="month-pills" id="monthPills"></div>
          <button class="filter-btn" onclick="resetFilters()" style="margin-left:auto">‚Ü∫ Reset</button>
        </div>
        <div class="cards">
          <div class="card" style="border-color:rgba(16,185,129,0.2)"><div class="card-label">üí∞ Income</div><div class="card-value green" id="totalIncome">‚Ç¨0</div><div class="card-sub" id="incomeCount">0</div></div>
          <div class="card" style="border-color:rgba(244,63,94,0.2)"><div class="card-label">üí∏ Expenses</div><div class="card-value red" id="totalExpenses">‚Ç¨0</div><div class="card-sub" id="expenseCount">0</div></div>
          <div class="card" style="border-color:rgba(34,211,238,0.2)"><div class="card-label">üìà Net</div><div class="card-value blue" id="netBalance">‚Ç¨0</div><div class="card-sub" id="avgDaily">Avg: ‚Ç¨0/day</div></div>
          <div class="card" style="border-color:rgba(168,85,247,0.2)"><div class="card-label">üéØ Savings</div><div class="card-value purple" id="savingsRate">0%</div><div class="savings-gauge"><div class="savings-gauge-fill" id="savingsGauge"></div></div></div>
          <div class="card" style="border-color:rgba(251,191,36,0.2)"><div class="card-label">üìä Total</div><div class="card-value yellow" id="txnTotal">0</div><div class="card-sub" id="dateRange">-</div></div>
        </div>
        <div class="chart-box" id="yoyBox"><h3>üìÖ Year-over-Year <span class="badge" id="yoyYears"></span></h3><div class="yoy-grid" id="yoyGrid"></div></div>
        <div class="chart-box"><h3>üóìÔ∏è Spending Heatmap</h3><div class="heatmap-container" id="heatmapBox"></div><div class="heatmap-legend"><span>Less</span><div style="display:flex;gap:2px"><div class="heatmap-cell"></div><div class="heatmap-cell l1"></div><div class="heatmap-cell l2"></div><div class="heatmap-cell l3"></div><div class="heatmap-cell l4"></div></div><span>More</span></div></div>
        <div class="grid-2">
          <div class="chart-box" style="margin-bottom:0"><h3>üìÖ By Weekday</h3><div class="weekday-bars" id="weekdayBars"></div></div>
          <div class="chart-box" style="margin-bottom:0"><h3>üîÑ Recurring <span class="badge" id="recurringCount">0</span></h3><div class="item-list" id="recurringList"></div></div>
        </div>
        <div class="grid-2" style="margin-top:20px">
          <div class="chart-box" style="margin-bottom:0"><h3>üìä By Category</h3><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
          <div class="chart-box" style="margin-bottom:0"><h3>üìâ Balance</h3><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
        </div>
        <div class="grid-2" style="margin-top:20px">
          <div class="chart-box" style="margin-bottom:0"><h3>üè™ Top Merchants</h3><div class="item-list" id="merchantsAmt"></div></div>
          <div class="chart-box" style="margin-bottom:0"><h3>üî¢ Most Visited</h3><div class="item-list" id="merchantsFreq"></div></div>
        </div>
        <div class="chart-box" style="margin-top:20px"><h3>üî• Top 10 Expenses</h3><div class="item-list" id="topExpenses"></div></div>
        <div class="chart-box"><h3>üìÜ Monthly Overview</h3><div class="chart-container tall"><canvas id="monthlyChart"></canvas></div></div>
        <div class="chart-box"><h3>üìã Categories</h3><div class="item-list" id="categoryList"></div></div>
        <div class="transactions">
          <div class="transactions-header"><h3>üìù <span id="txnTitle">Transactions</span><button class="hidden no-print" id="clearCatBtn" onclick="clearCatFilter()" style="margin-left:8px;padding:4px 10px;background:var(--border);border:none;border-radius:12px;color:var(--text-secondary);cursor:pointer;font-size:11px">Clear</button></h3><input type="text" class="search-box no-print" id="searchBox" placeholder="üîç Search..." oninput="applyFilters()"><span id="txnListCount" style="color:var(--text-muted);font-size:12px"></span></div>
          <div id="txnList"></div>
          <button class="show-more hidden no-print" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
        </div>
        <footer class="footer">Bank Analyzer v9 ‚Ä¢ Cloud Sync</footer>
      </div>
    </div>
  </div>

  <!-- IMPORTS PAGE -->
  <div class="page" id="pageImports">
    <div class="container">
      <header class="header"><div class="logo"><div class="logo-icon">üìÅ</div><div><h1>Import Manager</h1><p>Manage your bank statements</p></div></div></header>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".pdf" multiple>
        <div id="uploadContent"><div class="upload-icon">üìÑ</div><h3>Drop NLB statements here</h3><p>PDF files ‚Ä¢ Multiple supported</p></div>
        <div id="uploadLoading" class="hidden"><div class="spinner"></div><p id="loadingStatus">Processing...</p></div>
      </div>
      <div class="import-stats" id="importStats">
        <div class="import-stat"><div class="import-stat-value" id="statFiles">0</div><div class="import-stat-label">Files</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statTxns">0</div><div class="import-stat-label">Transactions</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statActive">0</div><div class="import-stat-label">Active</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statRange">-</div><div class="import-stat-label">Date Range</div></div>
      </div>
      <div class="bulk-actions">
        <button class="btn btn-green" onclick="activateAll()">‚úì Load All</button>
        <button class="btn btn-yellow" onclick="deactivateAll()">‚óã Unload All</button>
        <button class="btn btn-red" onclick="deleteAllImports()">üóëÔ∏è Delete All</button>
      </div>
      <div id="importsList"></div>
      <div id="noImports" class="empty-state"><div class="empty-icon">üìÅ</div><h2>No imports yet</h2><p>Upload bank statements above</p></div>
    </div>
  </div>

  <!-- USERS PAGE (Admin Only) -->
  <div class="page" id="pageUsers">
    <div class="container">
      <header class="header"><div class="logo"><div class="logo-icon">üë•</div><div><h1>User Management</h1><p>Manage accounts</p></div></div><button class="btn btn-primary" onclick="showInviteModal()">+ Invite User</button></header>
      <div id="usersList"></div>
    </div>
  </div>
</div>
<!-- MODALS -->
<div class="modal hidden" id="catModal"><div class="modal-box"><h2>üìÅ Edit Transaction</h2><p id="editTxnDesc" style="color:var(--text-muted);font-size:13px;margin-bottom:12px"></p><div style="margin-bottom:14px"><label style="font-size:12px;color:var(--text-secondary)">üìù Note</label><input type="text" class="note-input" id="txnNoteInput" placeholder="Add a note..."></div><label style="font-size:12px;color:var(--text-secondary)">üìÅ Category</label><div class="cat-editor" id="catEditor"></div><div class="modal-actions"><button class="btn btn-red" onclick="hideCatModal()">Cancel</button><button class="btn btn-green" onclick="saveCat()">Save</button></div></div></div>
<div class="modal hidden" id="rulesModal"><div class="modal-box"><h2>üìã Category Rules</h2><p style="color:var(--text-muted);font-size:13px;margin-bottom:14px">Auto-assign categories by description</p><div id="rulesList"></div><div class="modal-actions"><button class="btn btn-red" onclick="clearAllRules()">Clear All</button><button class="btn btn-blue" onclick="hideRulesModal()">Close</button></div></div></div>
<div class="modal hidden" id="profileModal"><div class="modal-box"><h2>‚öôÔ∏è Settings</h2><div style="margin:16px 0"><label style="font-size:12px;color:var(--text-secondary)">Display Name</label><input type="text" class="note-input" id="settingsName" placeholder="Your name"></div><div class="modal-actions"><button class="btn btn-red" onclick="hideProfileModal()">Cancel</button><button class="btn btn-green" onclick="saveSettings()">Save</button></div></div></div>
<div class="modal hidden" id="inviteModal"><div class="modal-box"><h2>üë§ Invite User</h2><p style="color:var(--text-muted);font-size:13px;margin-bottom:14px">Create account for a new user</p><input type="email" class="note-input" id="inviteEmail" placeholder="Email address"><input type="text" class="note-input" id="inviteName" placeholder="Name"><input type="password" class="note-input" id="invitePassword" placeholder="Temporary password"><div class="modal-actions"><button class="btn btn-red" onclick="hideInviteModal()">Cancel</button><button class="btn btn-green" onclick="createUser()">Create User</button></div></div></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="module">
// Firebase Config - REPLACE WITH YOUR OWN
const firebaseConfig = {
  apiKey: "AIzaSyCs0G1y10riQMXF-E9ittB2WCsbKNnZLSw",
  authDomain: "bank-analyzer-65413.firebaseapp.com",
  databaseURL: "https://bank-analyzer-65413-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bank-analyzer-65413",
  storageBucket: "bank-analyzer-65413.firebasestorage.app",
  messagingSenderId: "987901453174",
  appId: "1:987901453174:web:dabc5a60a20415cad65057"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// PDF.js
const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs');
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

// Expose functions to window
const fns = ['handleAuth','toggleAuthMode','signOut','switchPage','toggleImport','deleteImport','activateAll','deactivateAll','deleteAllImports','toggleTheme','showRulesModal','hideRulesModal','deleteRule','clearAllRules','editTxnCat','hideCatModal','saveCat','selectCatOpt','filterByCat','clearCatFilter','applyFilters','resetFilters','selectMonth','toggleShowAll','exportCSV','toggleUserMenu','showProfileModal','hideProfileModal','saveSettings','showInviteModal','hideInviteModal','createUser','viewAsUser','deleteUser','makeAdmin'];
fns.forEach(fn => window[fn] = eval(fn));

// State
let currentUser = null, userData = null, isAdmin = false, viewingUserId = null;
let imports = {}, activeTxns = [], filteredTxns = [], catOverrides = {}, txnNotes = {};
let selCat = null, selYear = 'all', selMonth = 'all', searchQ = '', showAll = false, isDark = true;
let pieChart = null, lineChart = null, monthlyChart = null, editingTxn = null, selNewCat = null;
let authMode = 'login', allUsers = {};

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const WDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const WCOLORS = ['#f87171','#fb923c','#fbbf24','#a3e635','#34d399','#22d3ee','#a78bfa'];
const CATS = {Groceries:{kw:['LIDL','HOFER','SPAR','MERCATOR','TUS','EUROSPIN'],c:'#10B981',i:'üõí'},Fuel:{kw:['MOL','PETROL','OMV'],c:'#F59E0B',i:'‚õΩ'},Restaurants:{kw:['MCDONALDS','RESTAVRACIJA','PIZZA','GOSTILNA'],c:'#EC4899',i:'üçî'},Travel:{kw:['BOOKING','HOTEL','AIRBNB','BANKOMAT'],c:'#3B82F6',i:'‚úàÔ∏è'},Shopping:{kw:['AMAZON','IKEA','MERKUR'],c:'#8B5CF6',i:'üõçÔ∏è'},Clothing:{kw:['ZARA','H&M','ABOUTYOU','C&A','MANGO','PULL&BEAR','BERSHKA','RESERVED'],c:'#F97316',i:'üëï'},Jewelry:{kw:['ZLATARNA','PANDORA','SWAROVSKI'],c:'#FBBF24',i:'üíç'},Sports:{kw:['INTERSPORT','DECATHLON','SPORTINA','HERVIS','FITNESS','GYM'],c:'#22D3EE',i:'üèÉ'},Parties:{kw:['CLUB','DISCO','NIGHT','LOUNGE','COCKTAIL'],c:'#E879F9',i:'üéâ'},Entertainment:{kw:['NETFLIX','SPOTIFY','STEAM','KINO'],c:'#06B6D4',i:'üé¨'},Transportation:{kw:['PSTOP','PARK','TAXI','UBER'],c:'#EF4444',i:'üöó'},Transfers:{kw:['REVOLUT','FLIK','PAYPAL'],c:'#6366F1',i:'üí∏'},Education:{kw:['UL EF','FAKULT','UNIV'],c:'#F472B6',i:'üéì'},Health:{kw:['LEKARNA','APOTEKA'],c:'#84CC16',i:'üè•'},Services:{kw:['POSTA','TELEKOM','PROVIZIJA'],c:'#64748B',i:'üìã'},Income:{kw:['PLACA','REDNO DELO','VRACILO','SICOD'],c:'#22C55E',i:'üí∞'},Personal:{kw:['ROK ','MILAN','ANDRAZ','FLIK PLA'],c:'#14B8A6',i:'üë§'},Other:{kw:[],c:'#94A3B8',i:'üí≥'}};

// Helpers
function $(id) { return document.getElementById(id); }
function fmt(a) { return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(a); }
function showNotif(msg, type='info', duration=4000) {
  const n = document.createElement('div');
  n.className = 'notif ' + type;
  n.innerHTML = `<span class="notif-icon">${type==='warning'?'‚ö†Ô∏è':type==='success'?'‚úÖ':'‚ÑπÔ∏è'}</span><span class="notif-text">${msg}</span><span class="notif-close" onclick="this.parentElement.remove()">√ó</span>`;
  $('notifContainer').appendChild(n);
  setTimeout(() => n.remove(), duration);
}

// Auth
auth.onAuthStateChanged(async user => {
  $('loadingScreen').classList.add('hidden');
  if (user) {
    currentUser = user;
    await loadUserData();
    $('authScreen').classList.add('hidden');
    $('mainApp').classList.remove('hidden');
  } else {
    currentUser = null;
    $('authScreen').classList.remove('hidden');
    $('mainApp').classList.add('hidden');
  }
});

function toggleAuthMode() {
  authMode = authMode === 'login' ? 'register' : 'login';
  $('authName').classList.toggle('hidden', authMode === 'login');
  $('authSubmit').textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
  $('authSubtitle').textContent = authMode === 'login' ? 'Sign in to continue' : 'Create your account';
  $('authToggle').textContent = authMode === 'login' ? "Don't have an account? Sign up" : 'Already have an account? Sign in';
  $('authError').classList.add('hidden');
}

async function handleAuth() {
  const email = $('authEmail').value.trim();
  const password = $('authPassword').value;
  const name = $('authName').value.trim();
  
  if (!email || !password) return showAuthError('Please fill all fields');
  if (authMode === 'register' && !name) return showAuthError('Please enter your name');
  
  try {
    $('authSubmit').disabled = true;
    $('authSubmit').textContent = 'Please wait...';
    
    if (authMode === 'login') {
      await auth.signInWithEmailAndPassword(email, password);
    } else {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      await db.ref('users/' + cred.user.uid).set({
        email: email,
        name: name,
        role: 'user',
        createdAt: Date.now()
      });
    }
  } catch (e) {
    showAuthError(e.message);
  }
  $('authSubmit').disabled = false;
  $('authSubmit').textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
}

function showAuthError(msg) {
  $('authError').textContent = msg;
  $('authError').classList.remove('hidden');
}

function signOut() {
  auth.signOut();
  toggleUserMenu();
}

async function loadUserData() {
  const uid = viewingUserId || currentUser.uid;
  
  // Load user profile
  const userSnap = await db.ref('users/' + currentUser.uid).once('value');
  userData = userSnap.val() || { name: 'User', role: 'user' };
  isAdmin = userData.role === 'admin';
  
  // Update UI
  $('profileName').textContent = userData.name || currentUser.email;
  $('menuUserName').textContent = userData.name || 'User';
  $('menuUserEmail').textContent = currentUser.email;
  $('tabUsers').classList.toggle('hidden', !isAdmin);
  $('viewAsUser').classList.toggle('hidden', !isAdmin);
  
  // Load data for target user
  const dataSnap = await db.ref('data/' + uid).once('value');
  const data = dataSnap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  
  if (isAdmin) {
    await loadAllUsers();
  }
  
  renderImportsList();
  loadActiveTxns();
}

async function loadAllUsers() {
  const snap = await db.ref('users').once('value');
  allUsers = snap.val() || {};
  $('usersBadge').textContent = Object.keys(allUsers).length;
  
  // Populate view-as dropdown
  const sel = $('viewAsUser');
  sel.innerHTML = '<option value="">My Data</option>' + 
    Object.entries(allUsers).map(([id, u]) => 
      `<option value="${id}" ${viewingUserId===id?'selected':''}>${u.name || u.email}</option>`
    ).join('');
  
  renderUsersList();
}

function viewAsUser() {
  viewingUserId = $('viewAsUser').value || null;
  loadUserData();
  showNotif(viewingUserId ? 'Viewing as ' + (allUsers[viewingUserId]?.name || 'user') : 'Viewing your data', 'info');
}
// Save to Firebase
async function saveData() {
  const uid = viewingUserId || currentUser.uid;
  await db.ref('data/' + uid).set({
    imports: imports,
    overrides: catOverrides,
    notes: txnNotes,
    updatedAt: Date.now()
  });
}

// Page Navigation
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  $('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
  $('tab' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
  if (page === 'overview') loadActiveTxns();
}

// Import Management
function loadActiveTxns() {
  activeTxns = [];
  Object.values(imports).filter(i => i.active).forEach(imp => {
    (imp.txns || []).forEach(t => {
      const pd = new Date(t.parsedDate);
      const cat = catOverrides[t.description] || t.category;
      activeTxns.push({...t, parsedDate: pd, year: pd.getFullYear(), month: pd.getMonth(), weekday: pd.getDay(), category: cat});
    });
  });
  activeTxns.sort((a,b) => a.parsedDate - b.parsedDate);
  applyFilters();
}

async function toggleImport(id) {
  if (imports[id]) {
    imports[id].active = !imports[id].active;
    await saveData();
    renderImportsList();
    loadActiveTxns();
    showNotif(imports[id].active ? 'Loaded' : 'Unloaded', 'info');
  }
}

async function deleteImport(id) {
  if (!confirm('Delete this import?')) return;
  delete imports[id];
  await saveData();
  renderImportsList();
  loadActiveTxns();
  showNotif('Deleted', 'info');
}

async function activateAll() {
  Object.keys(imports).forEach(id => imports[id].active = true);
  await saveData();
  renderImportsList();
  loadActiveTxns();
  showNotif('All loaded', 'success');
}

async function deactivateAll() {
  Object.keys(imports).forEach(id => imports[id].active = false);
  await saveData();
  renderImportsList();
  loadActiveTxns();
  showNotif('All unloaded', 'info');
}

async function deleteAllImports() {
  if (!confirm('Delete ALL imports?')) return;
  imports = {};
  await saveData();
  renderImportsList();
  loadActiveTxns();
  showNotif('All deleted', 'info');
}

function renderImportsList() {
  const keys = Object.keys(imports).sort((a,b) => (imports[b].importedAt||0) - (imports[a].importedAt||0));
  $('importsBadge').textContent = keys.length;
  $('noImports').classList.toggle('hidden', keys.length > 0);
  
  const totalTxns = Object.values(imports).reduce((s,i) => s + (i.txns?.length||0), 0);
  const activeFiles = Object.values(imports).filter(i => i.active).length;
  const allDates = Object.values(imports).flatMap(i => (i.txns||[]).map(t => new Date(t.parsedDate))).sort((a,b) => a-b);
  const range = allDates.length ? `${allDates[0].toLocaleDateString('sl')} - ${allDates[allDates.length-1].toLocaleDateString('sl')}` : '-';
  
  $('statFiles').textContent = keys.length;
  $('statTxns').textContent = totalTxns;
  $('statActive').textContent = activeFiles;
  $('statRange').textContent = range.length > 20 ? range.split(' - ').join('\n') : range;
  
  $('importsList').innerHTML = keys.map(id => {
    const imp = imports[id];
    const dates = (imp.txns||[]).map(t => new Date(t.parsedDate)).sort((a,b) => a-b);
    const dr = dates.length ? dates[0].toLocaleDateString('sl') + ' - ' + dates[dates.length-1].toLocaleDateString('sl') : '';
    const impDate = imp.importedAt ? new Date(imp.importedAt).toLocaleDateString('sl') : '';
    return `<div class="import-card ${imp.active?'':'inactive'}">
      <div class="import-icon">üìÑ</div>
      <div class="import-info"><div class="import-name">${imp.filename}</div><div class="import-meta"><span>üìä ${imp.txns?.length||0}</span><span>üìÖ ${dr}</span><span>‚¨ÜÔ∏è ${impDate}</span></div></div>
      <div class="import-actions"><div class="import-toggle ${imp.active?'active':''}" onclick="toggleImport('${id}')"></div><button class="btn btn-red" onclick="deleteImport('${id}')" style="padding:6px 10px">üóëÔ∏è</button></div>
    </div>`;
  }).join('');
}

// Users Management (Admin)
function renderUsersList() {
  $('usersList').innerHTML = Object.entries(allUsers).map(([id, u]) => {
    const initial = (u.name || u.email || '?')[0].toUpperCase();
    return `<div class="user-card">
      <div class="user-avatar">${initial}</div>
      <div class="user-info">
        <div class="user-name">${u.name || 'No name'} <span class="role-badge ${u.role}">${u.role}</span></div>
        <div class="user-email">${u.email}</div>
        <div class="user-meta">Joined ${new Date(u.createdAt).toLocaleDateString()}</div>
      </div>
      <div class="user-actions">
        <button class="btn btn-cyan" onclick="viewAsUser();$('viewAsUser').value='${id}';viewAsUser()">View</button>
        ${u.role !== 'admin' ? `<button class="btn btn-yellow" onclick="makeAdmin('${id}')">Make Admin</button>` : ''}
        ${id !== currentUser.uid ? `<button class="btn btn-red" onclick="deleteUser('${id}')">Delete</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function makeAdmin(uid) {
  if (!confirm('Make this user an admin?')) return;
  await db.ref('users/' + uid + '/role').set('admin');
  await loadAllUsers();
  showNotif('User is now admin', 'success');
}

async function deleteUser(uid) {
  if (!confirm('Delete this user and all their data?')) return;
  await db.ref('users/' + uid).remove();
  await db.ref('data/' + uid).remove();
  await loadAllUsers();
  showNotif('User deleted', 'info');
}

function showInviteModal() { $('inviteModal').classList.remove('hidden'); }
function hideInviteModal() { $('inviteModal').classList.add('hidden'); }

async function createUser() {
  const email = $('inviteEmail').value.trim();
  const name = $('inviteName').value.trim();
  const password = $('invitePassword').value;
  
  if (!email || !name || !password) return showNotif('Fill all fields', 'warning');
  if (password.length < 6) return showNotif('Password min 6 chars', 'warning');
  
  try {
    // Create user via secondary auth (keeps admin signed in)
    const tempAuth = firebase.initializeApp(firebaseConfig, 'temp').auth();
    const cred = await tempAuth.createUserWithEmailAndPassword(email, password);
    await db.ref('users/' + cred.user.uid).set({ email, name, role: 'user', createdAt: Date.now() });
    await tempAuth.signOut();
    firebase.app('temp').delete();
    
    hideInviteModal();
    await loadAllUsers();
    showNotif('User created', 'success');
    $('inviteEmail').value = '';
    $('inviteName').value = '';
    $('invitePassword').value = '';
  } catch (e) {
    showNotif(e.message, 'warning');
  }
}

// Settings
function showProfileModal() {
  $('settingsName').value = userData?.name || '';
  $('profileModal').classList.remove('hidden');
  toggleUserMenu();
}
function hideProfileModal() { $('profileModal').classList.add('hidden'); }

async function saveSettings() {
  const name = $('settingsName').value.trim();
  if (name) {
    await db.ref('users/' + currentUser.uid + '/name').set(name);
    userData.name = name;
    $('profileName').textContent = name;
    $('menuUserName').textContent = name;
  }
  hideProfileModal();
  showNotif('Saved', 'success');
}

// Rules
function showRulesModal() { renderRulesList(); $('rulesModal').classList.remove('hidden'); }
function hideRulesModal() { $('rulesModal').classList.add('hidden'); }

function renderRulesList() {
  const rules = Object.entries(catOverrides);
  $('rulesList').innerHTML = rules.length ? rules.map(([desc, cat]) => 
    `<div class="rule-item"><div class="rule-desc" title="${desc}">${desc.slice(0,30)}${desc.length>30?'...':''}</div><div class="rule-cat">${CATS[cat]?.i||'üí≥'} ${cat}</div><span class="rule-delete" onclick="deleteRule(\`${desc.replace(/`/g,'\\`')}\`)">√ó</span></div>`
  ).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No rules</div>';
}

async function deleteRule(desc) {
  delete catOverrides[desc];
  await saveData();
  renderRulesList();
  loadActiveTxns();
  showNotif('Deleted', 'info');
}

async function clearAllRules() {
  if (!confirm('Clear all rules?')) return;
  catOverrides = {};
  await saveData();
  renderRulesList();
  loadActiveTxns();
  showNotif('Cleared', 'info');
}

// Transaction Edit
function editTxnCat(id) {
  editingTxn = id;
  const t = activeTxns.find(x => x.id === id);
  if (!t) return;
  selNewCat = t.category;
  $('editTxnDesc').textContent = t.description.slice(0,50) + (t.description.length>50?'...':'');
  $('txnNoteInput').value = txnNotes[t.description] || '';
  renderCatEditor();
  $('catModal').classList.remove('hidden');
}

function renderCatEditor() {
  $('catEditor').innerHTML = Object.entries(CATS).map(([n,c]) => 
    `<div class="cat-opt ${selNewCat===n?'selected':''}" onclick="selectCatOpt('${n}')"><div class="cat-opt-icon">${c.i}</div><div class="cat-opt-name">${n}</div></div>`
  ).join('');
}

function selectCatOpt(c) { selNewCat = c; renderCatEditor(); }
function hideCatModal() { $('catModal').classList.add('hidden'); editingTxn = null; selNewCat = null; }

async function saveCat() {
  if (!editingTxn || !selNewCat) return;
  const t = activeTxns.find(x => x.id === editingTxn);
  if (t) {
    catOverrides[t.description] = selNewCat;
    const note = $('txnNoteInput').value.trim();
    if (note) txnNotes[t.description] = note;
    else delete txnNotes[t.description];
    await saveData();
    loadActiveTxns();
    showNotif('Saved', 'success');
  }
  hideCatModal();
}

// Theme
function toggleTheme() {
  isDark = !isDark;
  document.documentElement.classList.toggle('light-mode', !isDark);
  $('themeBtn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('bankTheme', isDark ? 'dark' : 'light');
  if (pieChart) render();
}

function loadTheme() {
  if (localStorage.getItem('bankTheme') === 'light') {
    isDark = false;
    document.documentElement.classList.add('light-mode');
    $('themeBtn').textContent = '‚òÄÔ∏è';
  }
}

function toggleUserMenu() { $('userDropdown').classList.toggle('show'); }
// PDF Parsing
function categorize(d) {
  if (catOverrides[d]) return catOverrides[d];
  const u = d.toUpperCase();
  for (const [c, cfg] of Object.entries(CATS)) {
    if (c === 'Other') continue;
    if (cfg.kw.some(k => u.includes(k))) return c;
  }
  return 'Other';
}

function parseDate(s) {
  try {
    if (!s) return null;
    const p = s.split('.');
    if (p.length !== 3) return null;
    const d = parseInt(p[0]), m = parseInt(p[1]);
    let y = parseInt(p[2]);
    if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
    if (y < 100) y += 2000;
    if (d < 1 || d > 31 || m < 1 || m > 12 || y < 2000 || y > 2100) return null;
    const dt = new Date(y, m-1, d);
    return isNaN(dt.getTime()) ? null : dt;
  } catch (e) { return null; }
}

function parseStmt(txt) {
  const txns = [], clean = txt.replace(/\s+/g, ' ');
  const dp = /(\d{2}\.\d{2}\.\d{2})/g, dates = [];
  let m;
  while ((m = dp.exec(clean)) !== null) dates.push({d: m[1], i: m.index});
  
  for (let i = 0; i < dates.length; i++) {
    const seg = clean.substring(dates[i].i, (i+1 < dates.length) ? dates[i+1].i : clean.length).trim();
    if (/STANJE|SKUPNI|Datum izpiska|LETNA OBRESTNA|EUR\s*-\s*EVRO|NLB PAKET/i.test(seg)) continue;
    
    const dt = dates[i].d;
    const ap = /([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g, amts = [];
    let am;
    while ((am = ap.exec(seg)) !== null) amts.push(am[1]);
    
    if (amts.length >= 2) {
      const as = amts[amts.length-2], bs = amts[amts.length-1];
      let amt = parseFloat(as.replace(/\./g, '').replace(',', '.'));
      const bal = parseFloat(bs.replace(/\./g, '').replace(',', '.'));
      let desc = seg.substring(dt.length, seg.indexOf(amts[0])).trim().replace(/^\s*[\.,]\s*/, '').trim();
      if (!desc || desc.length < 2) continue;
      
      const isInc = as.startsWith('+') || /PLACA|REDNO DELO|VRACILO|SICOD/i.test(desc);
      if (!as.startsWith('+') && !as.startsWith('-') && !isInc) amt = -Math.abs(amt);
      
      const id = dt + '-' + txns.length + '-' + Math.random().toString(36).substr(2, 6);
      let cat = categorize(desc);
      if (amt > 0 && cat === 'Other') cat = 'Income';
      const pd = parseDate(dt);
      if (pd) txns.push({id, date: dt, parsedDate: pd.toISOString(), description: desc, amount: amt, balance: bal, category: cat});
    }
  }
  return txns;
}

async function extractPDF(f) {
  const ab = await f.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: ab}).promise;
  let txt = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const pg = await pdf.getPage(i);
    const ct = await pg.getTextContent();
    let ly = null;
    ct.items.forEach(it => {
      if (ly !== null && Math.abs(it.transform[5] - ly) > 5) txt += '\n';
      txt += it.str + ' ';
      ly = it.transform[5];
    });
    txt += '\n';
  }
  return txt;
}

async function handleFiles(files) {
  const pdfs = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
  if (!pdfs.length) return;
  
  $('uploadContent').classList.add('hidden');
  $('uploadLoading').classList.remove('hidden');
  let totalNew = 0;
  
  try {
    for (let i = 0; i < pdfs.length; i++) {
      const f = pdfs[i];
      if (Object.values(imports).find(imp => imp.filename === f.name)) {
        showNotif(`${f.name} already imported`, 'warning');
        continue;
      }
      
      $('loadingStatus').textContent = `${i+1}/${pdfs.length}: ${f.name}`;
      const txt = await extractPDF(f);
      const parsed = parseStmt(txt);
      
      if (parsed.length === 0) {
        showNotif(`No transactions in ${f.name}`, 'warning');
        continue;
      }
      
      const id = 'imp_' + Date.now() + '_' + i;
      imports[id] = { filename: f.name, importedAt: Date.now(), txns: parsed, active: true };
      totalNew += parsed.length;
    }
    
    await saveData();
    renderImportsList();
    loadActiveTxns();
    if (totalNew > 0) showNotif(`Imported ${totalNew} transactions`, 'success');
  } catch (e) {
    showNotif('Error: ' + e.message, 'warning');
  }
  
  $('uploadContent').classList.remove('hidden');
  $('uploadLoading').classList.add('hidden');
}

// Filters
function filterByCat(c) { selCat = selCat === c ? null : c; applyFilters(); }
function clearCatFilter() { selCat = null; applyFilters(); }
function selectMonth(m) { selMonth = selMonth === m ? 'all' : m; applyFilters(); }
function resetFilters() { selYear = 'all'; selMonth = 'all'; selCat = null; searchQ = ''; $('yearFilter').value = 'all'; $('searchBox').value = ''; applyFilters(); }

function applyFilters() {
  selYear = $('yearFilter')?.value || 'all';
  searchQ = $('searchBox')?.value?.toLowerCase() || '';
  filteredTxns = activeTxns.filter(t => {
    if (selYear !== 'all' && t.year !== parseInt(selYear)) return false;
    if (selMonth !== 'all' && t.month !== parseInt(selMonth)) return false;
    if (selCat && t.category !== selCat) return false;
    if (searchQ && !t.description.toLowerCase().includes(searchQ)) return false;
    return true;
  });
  showAll = false;
  render();
}

function toggleShowAll() { showAll = !showAll; renderTxns(); }

function exportCSV() {
  const h = ['Date','Day','Description','Amount','Balance','Category','Note'];
  const r = filteredTxns.map(t => [t.date, WDAYS[t.weekday], '"'+t.description.replace(/"/g,'""')+'"', t.amount.toFixed(2), t.balance.toFixed(2), t.category, '"'+(txnNotes[t.description]||'')+'"']);
  const csv = [h.join(','), ...r.map(x => x.join(','))].join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'bank-' + new Date().toISOString().split('T')[0] + '.csv';
  link.click();
  showNotif('Exported', 'success');
}

// Analysis helpers
function normMerch(d) {
  let n = d.toUpperCase().replace(/^(NAKUP |POS |PSTOP )/, '').replace(/\s+(LJUBLJANA|MARIBOR|KRANJ).*$/i, '').replace(/\s+\d+.*$/, '');
  ['SPAR','LIDL','HOFER','MERCATOR','PETROL','MOL','AMAZON'].forEach(m => { if (n.includes(m)) n = m; });
  return n.split(/\s+/).filter(x => x.length > 2).slice(0,2).join(' ') || n.slice(0,18);
}

function detectRecur(txns) {
  const g = {};
  txns.filter(t => t.amount < 0).forEach(t => {
    const m = normMerch(t.description), a = Math.abs(t.amount).toFixed(2), k = m + '|' + a;
    if (!g[k]) g[k] = {m, a: Math.abs(t.amount), dates: []};
    g[k].dates.push(t.parsedDate);
  });
  const r = [];
  for (const gr of Object.values(g)) {
    if (gr.dates.length >= 2) {
      gr.dates.sort((a,b) => a-b);
      const iv = [];
      for (let i = 1; i < gr.dates.length; i++) iv.push(Math.round((gr.dates[i] - gr.dates[i-1]) / 864e5));
      const avg = iv.reduce((a,b) => a+b, 0) / iv.length;
      if ((avg >= 25 && avg <= 35) || (avg >= 5 && avg <= 9)) {
        r.push({m: gr.m, a: gr.a, pat: avg >= 25 ? 'Monthly' : 'Weekly', cnt: gr.dates.length, tot: gr.a * gr.dates.length});
      }
    }
  }
  return r.sort((a,b) => b.tot - a.tot).slice(0,6);
}

function getMerchRank(txns) {
  const m = {};
  txns.filter(t => t.amount < 0).forEach(t => {
    const n = normMerch(t.description);
    if (!m[n]) m[n] = {n, tot: 0, cnt: 0};
    m[n].tot += Math.abs(t.amount);
    m[n].cnt++;
  });
  const l = Object.values(m);
  return { byAmt: [...l].sort((a,b) => b.tot - a.tot).slice(0,8), byFreq: [...l].sort((a,b) => b.cnt - a.cnt).slice(0,8) };
}

function getWdaySpend(txns) {
  const w = [0,0,0,0,0,0,0];
  txns.filter(t => t.amount < 0 && t.parsedDate).forEach(t => w[t.parsedDate.getDay()] += Math.abs(t.amount));
  const max = Math.max(...w);
  return WDAYS.map((n,i) => ({n, tot: w[i], pct: max > 0 ? (w[i]/max)*100 : 0}));
}

function getHeatmap(txns) {
  const ds = {};
  txns.filter(t => t.amount < 0 && t.parsedDate).forEach(t => {
    const k = t.parsedDate.toISOString().split('T')[0];
    ds[k] = (ds[k] || 0) + Math.abs(t.amount);
  });
  const v = Object.values(ds), max = Math.max(...v, 1);
  const th = [0, max*.15, max*.35, max*.6, max*.85];
  return {ds, th};
}
// Render functions
function renderHeatmap() {
  const {ds, th} = getHeatmap(filteredTxns);
  const vt = filteredTxns.filter(t => t.parsedDate);
  if (!vt.length) { $('heatmapBox').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted)">No data</div>'; return; }
  const start = new Date(vt[0].parsedDate), end = new Date(vt[vt.length-1].parsedDate);
  start.setDate(start.getDate() - start.getDay());
  const weeks = []; let cur = new Date(start);
  while (cur <= end) { const wk = []; for (let d = 0; d < 7; d++) { const k = cur.toISOString().split('T')[0], sp = ds[k] || 0; let lv = 0; for (let i = th.length-1; i >= 0; i--) if (sp >= th[i]) { lv = i; break; } wk.push({k, sp, lv}); cur.setDate(cur.getDate() + 1); } weeks.push(wk); }
  $('heatmapBox').innerHTML = '<div class="heatmap"><div class="heatmap-grid">' + weeks.map(wk => '<div class="heatmap-week">' + wk.map(d => `<div class="heatmap-cell ${d.lv?'l'+d.lv:''}" title="${d.k}: ${fmt(d.sp)}"></div>`).join('') + '</div>').join('') + '</div></div>';
}

function renderYoY() {
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  if (years.length < 2) { $('yoyBox').classList.add('hidden'); return; }
  $('yoyBox').classList.remove('hidden');
  const y1 = years[years.length-2], y2 = years[years.length-1]; $('yoyYears').textContent = y1 + ' vs ' + y2;
  const y1T = activeTxns.filter(t => t.year === y1), y2T = activeTxns.filter(t => t.year === y2);
  const y1Inc = y1T.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0), y2Inc = y2T.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const y1Exp = Math.abs(y1T.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0)), y2Exp = Math.abs(y2T.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const y1Sav = y1Inc - y1Exp, y2Sav = y2Inc - y2Exp;
  const incChg = y1Inc > 0 ? ((y2Inc - y1Inc) / y1Inc * 100) : 0, expChg = y1Exp > 0 ? ((y2Exp - y1Exp) / y1Exp * 100) : 0, savChg = y1Sav !== 0 ? ((y2Sav - y1Sav) / Math.abs(y1Sav) * 100) : 0;
  const catY1 = {}, catY2 = {}; y1T.filter(t => t.amount < 0).forEach(t => { catY1[t.category] = (catY1[t.category]||0) + Math.abs(t.amount); }); y2T.filter(t => t.amount < 0).forEach(t => { catY2[t.category] = (catY2[t.category]||0) + Math.abs(t.amount); });
  const topCats = [...new Set([...Object.keys(catY1), ...Object.keys(catY2)])].map(c => ({c, y1: catY1[c]||0, y2: catY2[c]||0})).sort((a,b) => b.y2 - a.y2).slice(0,4);
  $('yoyGrid').innerHTML = `<div class="yoy-item"><div class="yoy-label">üí∞ Income</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(y1Inc)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(y2Inc)}</div></div></div><div class="yoy-change ${incChg>0?'down':'up'}">${incChg>0?'‚Üë':'‚Üì'} ${Math.abs(incChg).toFixed(1)}%</div></div><div class="yoy-item"><div class="yoy-label">üí∏ Expenses</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(y1Exp)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(y2Exp)}</div></div></div><div class="yoy-change ${expChg>0?'up':'down'}">${expChg>0?'‚Üë':'‚Üì'} ${Math.abs(expChg).toFixed(1)}%</div></div><div class="yoy-item"><div class="yoy-label">üéØ Saved</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value" style="color:${y1Sav>=0?'#34d399':'#fb7185'}">${fmt(y1Sav)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value" style="color:${y2Sav>=0?'#34d399':'#fb7185'}">${fmt(y2Sav)}</div></div></div><div class="yoy-change ${savChg>0?'down':'up'}">${savChg>0?'‚Üë':'‚Üì'} ${Math.abs(savChg).toFixed(1)}%</div></div>${topCats.map(cat => { const chg = cat.y1 > 0 ? ((cat.y2 - cat.y1) / cat.y1 * 100) : 0; return `<div class="yoy-item"><div class="yoy-label">${CATS[cat.c]?.i||'üí≥'} ${cat.c}</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value" style="font-size:14px">${fmt(cat.y1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value" style="font-size:14px">${fmt(cat.y2)}</div></div></div><div class="yoy-change ${chg>0?'up':'down'}">${chg>0?'‚Üë':'‚Üì'} ${Math.abs(chg).toFixed(1)}%</div></div>`; }).join('')}`;
}

function render() {
  if (!activeTxns.length) { $('emptyState').classList.remove('hidden'); $('dashboard').classList.add('hidden'); return; }
  $('emptyState').classList.add('hidden'); $('dashboard').classList.remove('hidden');
  const yrs = [...new Set(activeTxns.map(t => t.year))].sort();
  $('yearFilter').innerHTML = '<option value="all">All Years</option>' + yrs.map(y => `<option value="${y}" ${selYear==y?'selected':''}>${y}</option>`).join('');
  $('monthPills').innerHTML = `<span class="month-pill ${selMonth==='all'?'active':''}" onclick="selectMonth('all')">All</span>` + MONTHS.map((m,i) => `<span class="month-pill ${selMonth===i?'active':''}" onclick="selectMonth(${i})">${m}</span>`).join('');
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0), expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0)), net = income - expenses, sr = income > 0 ? ((income - expenses) / income) * 100 : 0, sc = sr >= 20 ? 'good' : sr >= 10 ? 'ok' : 'bad';
  const vt = filteredTxns.filter(t => t.parsedDate), dr = vt.length ? vt[0].date + ' - ' + vt[vt.length-1].date : '-', days = vt.length > 1 ? Math.max(1, Math.ceil((vt[vt.length-1].parsedDate - vt[0].parsedDate) / 864e5)) : 1;
  $('totalIncome').textContent = fmt(income); $('totalExpenses').textContent = fmt(expenses); $('netBalance').textContent = (net >= 0 ? '+' : '') + fmt(net); $('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
  $('incomeCount').textContent = filteredTxns.filter(t => t.amount > 0).length + ' txns'; $('expenseCount').textContent = filteredTxns.filter(t => t.amount < 0).length + ' txns';
  $('savingsRate').textContent = sr.toFixed(1) + '%'; $('savingsGauge').style.width = Math.max(0, Math.min(100, sr)) + '%'; $('savingsGauge').className = 'savings-gauge-fill ' + sc;
  $('txnTotal').textContent = filteredTxns.length; $('dateRange').textContent = dr; $('avgDaily').textContent = 'Avg: ' + fmt(expenses/days) + '/day';
  renderYoY(); renderHeatmap(); renderWday(); renderRecur(); renderMerch();
  const catTot = {}; filteredTxns.filter(t => t.amount < 0).forEach(t => { catTot[t.category] = (catTot[t.category]||0) + Math.abs(t.amount); });
  const sortedCats = Object.entries(catTot).sort((a,b) => b[1] - a[1]);
  $('categoryList').innerHTML = sortedCats.map(([cat, amt]) => { const cfg = CATS[cat] || CATS.Other, pct = expenses > 0 ? ((amt/expenses)*100).toFixed(1) : '0'; return `<div class="list-item" style="cursor:pointer" onclick="filterByCat('${cat}')"><div class="list-icon" style="background:${cfg.c}20">${cfg.i}</div><div class="list-info"><div class="list-title">${cat}</div><div style="height:4px;background:var(--border);border-radius:2px;margin-top:4px"><div style="height:100%;width:${pct}%;background:${cfg.c};border-radius:2px"></div></div></div><div style="text-align:right"><div class="list-value">${fmt(amt)}</div><div style="font-size:11px;color:var(--text-muted)">${pct}%</div></div></div>`; }).join('');
  renderTopExp(); renderCharts(sortedCats); renderMonthly(); renderTxns();
}

function renderWday() { const d = getWdaySpend(filteredTxns), mx = d.reduce((m,x) => x.tot > m.tot ? x : m, d[0]); $('weekdayBars').innerHTML = d.map((x,i) => `<div class="weekday-bar ${x.n===mx.n?'highlight':''}"><div class="weekday-value">${fmt(x.tot)}</div><div class="weekday-fill" style="height:${x.pct}%;background:${WCOLORS[i]}"></div><div class="weekday-label">${x.n}</div></div>`).join(''); }
function renderRecur() { const r = detectRecur(filteredTxns); $('recurringCount').textContent = r.length; $('recurringList').innerHTML = r.length ? r.map(x => `<div class="list-item"><div class="list-icon" style="background:rgba(99,102,241,0.2)">üîÑ</div><div class="list-info"><div class="list-title">${x.m}</div><div class="list-sub">${x.pat} ‚Ä¢ ${x.cnt}√ó</div></div><div style="text-align:right"><div class="list-value" style="color:#a5b4fc">${fmt(-x.a)}</div><div class="list-sub">Tot: ${fmt(-x.tot)}</div></div></div>`).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No recurring</div>'; }
function renderMerch() { const {byAmt, byFreq} = getMerchRank(filteredTxns); $('merchantsAmt').innerHTML = byAmt.length ? byAmt.map((m,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${m.n}</div><div class="list-sub">${m.cnt} visits</div></div><div class="list-value">${fmt(-m.tot)}</div></div>`).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No data</div>'; $('merchantsFreq').innerHTML = byFreq.length ? byFreq.map((m,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${m.n}</div><div class="list-sub">${fmt(-m.tot)}</div></div><div class="list-value cyan">${m.cnt}√ó</div></div>`).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No data</div>'; }
function renderTopExp() { const t = filteredTxns.filter(x => x.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10); $('topExpenses').innerHTML = t.map((x,i) => { const cfg = CATS[x.category] || CATS.Other, note = txnNotes[x.description]; return `<div class="list-item" onclick="editTxnCat('${x.id}')" style="cursor:pointer"><div class="rank" style="${i<3?'background:linear-gradient(135deg,#f59e0b,#f97316);color:#0f172a':''}">${i+1}</div><div class="list-icon" style="background:${cfg.c}20">${cfg.i}</div><div class="list-info"><div class="list-title">${x.description}${note?'<span class="txn-note"> üìù '+note+'</span>':''}</div><div class="list-sub">${x.date} ‚Ä¢ ${x.category}</div></div><div class="list-value">${fmt(x.amount)}</div></div>`; }).join(''); }
function renderCharts(sortedCats) {
  const tc = isDark ? '#94a3b8' : '#64748b', gc = isDark ? '#334155' : '#e2e8f0';
  const pc = $('pieChart').getContext('2d'); if (pieChart) pieChart.destroy();
  if (sortedCats.length) { pieChart = new Chart(pc, { type: 'doughnut', data: { labels: sortedCats.map(([c]) => c), datasets: [{ data: sortedCats.map(([,v]) => v), backgroundColor: sortedCats.map(([c]) => (CATS[c]||CATS.Other).c), borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.label + ': ' + fmt(ctx.raw) } } }, onClick: (e, el) => { if (el.length) filterByCat(sortedCats[el[0].index][0]); } } }); }
  const lc = $('lineChart').getContext('2d'); if (lineChart) lineChart.destroy();
  const db = []; filteredTxns.forEach(t => { const ex = db.find(d => d.date === t.date); if (ex) ex.bal = t.balance; else db.push({date: t.date, bal: t.balance}); });
  if (db.length) { lineChart = new Chart(lc, { type: 'line', data: { labels: db.map(d => d.date), datasets: [{ data: db.map(d => d.bal), borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.3, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gc }, ticks: { color: tc, maxTicksLimit: 6 } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0) + 'k' } } } } }); }
}

function renderMonthly() {
  const tc = isDark ? '#94a3b8' : '#64748b', gc = isDark ? '#334155' : '#e2e8f0';
  const ctx = $('monthlyChart').getContext('2d'); if (monthlyChart) monthlyChart.destroy();
  const d = {}; activeTxns.forEach(t => { if (!t.year || t.month === undefined) return; const k = t.year + '-' + String(t.month+1).padStart(2,'0'); if (!d[k]) d[k] = {inc: 0, exp: 0}; if (t.amount > 0) d[k].inc += t.amount; else d[k].exp += Math.abs(t.amount); });
  const m = Object.keys(d).sort();
  if (m.length) { monthlyChart = new Chart(ctx, { type: 'bar', data: { labels: m.map(k => MONTHS[parseInt(k.split('-')[1])-1] + ' ' + k.split('-')[0].slice(2)), datasets: [{ label: 'Income', data: m.map(k => d[k].inc), backgroundColor: '#22C55E' }, { label: 'Expenses', data: m.map(k => d[k].exp), backgroundColor: '#fb7185' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { color: tc, usePointStyle: true } }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) } } }, scales: { x: { grid: { display: false }, ticks: { color: tc } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0) + 'k' } } } } }); }
}

function renderTxns() {
  const disp = showAll ? filteredTxns.slice().reverse() : filteredTxns.slice(-12).reverse();
  $('txnTitle').textContent = selCat || 'Transactions'; $('clearCatBtn').classList.toggle('hidden', !selCat); $('txnListCount').textContent = filteredTxns.length + ' items';
  $('txnList').innerHTML = disp.map(t => { const cfg = CATS[t.category] || CATS.Other, pos = t.amount > 0, note = txnNotes[t.description]; return `<div class="transaction" onclick="editTxnCat('${t.id}')"><div class="txn-icon" style="background:${cfg.c}20">${cfg.i}</div><div class="txn-details"><div class="txn-desc">${t.description}${note?'<span class="txn-note"> üìù</span>':''}</div><div class="txn-meta">${t.date} ‚Ä¢ ${WDAYS[t.weekday]}<span class="txn-cat" style="background:${cfg.c}20;color:${cfg.c}">${t.category}</span>${note?'<span class="txn-note">'+note+'</span>':''}</div></div><div class="txn-amount"><div class="txn-amt ${pos?'pos':''}">${pos?'+':''}${fmt(t.amount)}</div><div class="txn-bal">Bal: ${fmt(t.balance)}</div></div></div>`; }).join('');
  const btn = $('showMoreBtn'); if (filteredTxns.length > 12) { btn.classList.remove('hidden'); btn.textContent = showAll ? '‚ñ≤ Less' : '‚ñº All ' + filteredTxns.length; } else btn.classList.add('hidden');
}

// Init
$('uploadZone').addEventListener('click', () => $('fileInput').click());
$('fileInput').addEventListener('change', e => handleFiles(e.target.files));
const uz = $('uploadZone');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.style.borderColor = 'var(--accent2)'; });
uz.addEventListener('dragleave', () => uz.style.borderColor = '');
uz.addEventListener('drop', e => { e.preventDefault(); uz.s