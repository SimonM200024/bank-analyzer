<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer - NLB Statement Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f8fafc; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #34d399, #22d3ee); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .logo h1 { font-size: 20px; font-weight: 600; }
    .logo p { font-size: 12px; color: #64748b; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .upload-zone { border: 2px dashed #334155; border-radius: 16px; padding: 48px 24px; text-align: center; margin-bottom: 24px; background: rgba(30, 41, 59, 0.5); cursor: pointer; transition: all 0.3s; }
    .upload-zone:hover, .upload-zone.dragging { border-color: #34d399; background: rgba(52, 211, 153, 0.1); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 48px; margin-bottom: 16px; }
    .upload-zone h3 { font-size: 18px; margin-bottom: 8px; }
    .upload-zone p { color: #64748b; font-size: 14px; }
    .file-tags { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 16px; }
    .file-tag { padding: 6px 12px; background: rgba(52, 211, 153, 0.2); color: #34d399; border-radius: 20px; font-size: 13px; }
    
    .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-label { font-size: 13px; color: #94a3b8; }
    .filter-select { padding: 8px 12px; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; border-radius: 8px; color: #f8fafc; font-size: 14px; cursor: pointer; }
    .filter-select:focus { outline: none; border-color: #22d3ee; }
    .month-pills { display: flex; gap: 6px; flex-wrap: wrap; }
    .month-pill { padding: 6px 12px; background: rgba(51, 65, 85, 0.5); border: 1px solid #334155; border-radius: 20px; color: #94a3b8; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .month-pill:hover { background: rgba(51, 65, 85, 0.8); color: #e2e8f0; }
    .month-pill.active { background: #22d3ee; color: #0f172a; border-color: #22d3ee; }
    .filter-btn { padding: 8px 16px; background: rgba(100, 116, 139, 0.2); border: 1px solid #475569; border-radius: 8px; color: #94a3b8; font-size: 13px; cursor: pointer; }
    .filter-btn:hover { background: rgba(100, 116, 139, 0.3); color: #e2e8f0; }
    
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card { padding: 18px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
    .card-income { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-color: rgba(16, 185, 129, 0.2); }
    .card-expense { background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.05)); border-color: rgba(244, 63, 94, 0.2); }
    .card-balance { background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(34, 211, 238, 0.05)); border-color: rgba(34, 211, 238, 0.2); }
    .card-savings { background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05)); border-color: rgba(168, 85, 247, 0.2); }
    .card-count { background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05)); border-color: rgba(251, 191, 36, 0.2); }
    .card-label { color: #94a3b8; font-size: 12px; margin-bottom: 6px; }
    .card-value { font-size: 22px; font-weight: 700; font-family: monospace; }
    .card-value.green { color: #34d399; }
    .card-value.red { color: #fb7185; }
    .card-value.blue { color: #22d3ee; }
    .card-value.purple { color: #a78bfa; }
    .card-value.yellow { color: #fbbf24; }
    .card-sub { font-size: 11px; color: #64748b; margin-top: 4px; }
    
    .comparison-box { background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; border-radius: 16px; padding: 20px; margin-bottom: 24px; }
    .comparison-box h3 { font-size: 16px; margin-bottom: 16px; }
    .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .comparison-item { text-align: center; padding: 16px; background: rgba(51, 65, 85, 0.3); border-radius: 12px; }
    .comparison-label { font-size: 12px; color: #94a3b8; margin-bottom: 8px; }
    .comparison-value { font-size: 20px; font-weight: 700; font-family: monospace; }
    .comparison-change { font-size: 13px; margin-top: 6px; display: flex; align-items: center; justify-content: center; gap: 4px; }
    .comparison-change.up { color: #fb7185; }
    .comparison-change.down { color: #34d399; }
    .comparison-change.neutral { color: #94a3b8; }
    
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { padding: 24px; border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; margin-bottom: 24px; }
    .chart-box h3 { font-size: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
    .chart-box h3 .badge { font-size: 11px; padding: 2px 8px; background: #22d3ee; color: #0f172a; border-radius: 10px; font-weight: 500; }
    .chart-container { position: relative; height: 280px; }
    .chart-container.tall { height: 350px; }
    .chart-container.short { height: 200px; }
    
    .top-expenses { margin-bottom: 24px; }
    .top-expense-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(51, 65, 85, 0.3); border-radius: 10px; margin-bottom: 8px; }
    .top-expense-rank { width: 28px; height: 28px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #0f172a; flex-shrink: 0; }
    .top-expense-rank.silver { background: linear-gradient(135deg, #94a3b8, #64748b); }
    .top-expense-rank.bronze { background: linear-gradient(135deg, #b45309, #92400e); color: #fef3c7; }
    .top-expense-details { flex: 1; min-width: 0; }
    .top-expense-desc { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .top-expense-meta { font-size: 12px; color: #64748b; margin-top: 2px; }
    .top-expense-amount { font-family: monospace; font-weight: 600; color: #fb7185; font-size: 15px; flex-shrink: 0; }
    
    /* Merchant & Recurring styles */
    .merchant-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(51, 65, 85, 0.3); border-radius: 10px; margin-bottom: 8px; }
    .merchant-rank { width: 24px; height: 24px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #94a3b8; flex-shrink: 0; }
    .merchant-info { flex: 1; min-width: 0; }
    .merchant-name { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .merchant-stats { font-size: 12px; color: #64748b; margin-top: 2px; }
    .merchant-total { font-family: monospace; font-weight: 600; color: #fb7185; font-size: 14px; flex-shrink: 0; text-align: right; }
    .merchant-count { font-size: 11px; color: #64748b; }
    
    .recurring-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 10px; margin-bottom: 8px; }
    .recurring-icon { width: 36px; height: 36px; background: rgba(99, 102, 241, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .recurring-info { flex: 1; min-width: 0; }
    .recurring-name { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recurring-pattern { font-size: 12px; color: #a5b4fc; margin-top: 2px; }
    .recurring-amount { text-align: right; flex-shrink: 0; }
    .recurring-value { font-family: monospace; font-weight: 600; color: #a5b4fc; font-size: 14px; }
    .recurring-freq { font-size: 11px; color: #64748b; margin-top: 2px; }
    
    /* Weekday chart */
    .weekday-bars { display: flex; gap: 8px; align-items: flex-end; height: 180px; padding: 20px 0; }
    .weekday-bar { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .weekday-bar-fill { width: 100%; border-radius: 6px 6px 0 0; transition: height 0.5s; min-height: 4px; }
    .weekday-bar-label { font-size: 12px; color: #94a3b8; font-weight: 500; }
    .weekday-bar-value { font-size: 11px; color: #64748b; font-family: monospace; }
    .weekday-bar.highlight .weekday-bar-label { color: #fb7185; font-weight: 600; }
    .weekday-bar.highlight .weekday-bar-fill { box-shadow: 0 0 20px rgba(251, 113, 133, 0.4); }
    
    .category-list { margin-top: 16px; }
    .category-item { display: flex; align-items: center; gap: 12px; padding: 14px; margin-bottom: 8px; background: rgba(51, 65, 85, 0.3); border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .category-item:hover { background: rgba(51, 65, 85, 0.5); }
    .category-item.active { background: #334155; }
    .category-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .category-info { flex: 1; min-width: 0; }
    .category-name { font-weight: 500; margin-bottom: 4px; }
    .category-bar { height: 4px; background: #334155; border-radius: 2px; }
    .category-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .category-amount { font-family: monospace; color: #94a3b8; font-size: 14px; }
    .category-percent { color: #64748b; font-size: 13px; width: 50px; text-align: right; flex-shrink: 0; }
    
    .transactions { border-radius: 16px; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; overflow: hidden; margin-bottom: 24px; }
    .transactions-header { padding: 16px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .transactions-header h3 { font-size: 16px; }
    .transactions-count { color: #64748b; font-size: 13px; }
    .transaction { display: flex; align-items: center; gap: 14px; padding: 14px 20px; border-bottom: 1px solid #1e293b; transition: background 0.2s; }
    .transaction:hover { background: rgba(51, 65, 85, 0.3); }
    .transaction:last-child { border-bottom: none; }
    .transaction-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .transaction-details { flex: 1; min-width: 0; }
    .transaction-desc { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .transaction-meta { font-size: 12px; color: #64748b; }
    .transaction-cat { padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }
    .transaction-amount { text-align: right; flex-shrink: 0; }
    .transaction-amount-value { font-weight: 600; font-family: monospace; }
    .transaction-amount-value.positive { color: #34d399; }
    .transaction-balance { font-size: 11px; color: #64748b; margin-top: 2px; }
    .show-more { width: 100%; padding: 14px; background: transparent; border: none; border-top: 1px solid #1e293b; color: #94a3b8; cursor: pointer; font-size: 14px; }
    .show-more:hover { background: rgba(51, 65, 85, 0.3); color: #e2e8f0; }
    
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-clear { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
    .btn-clear:hover { background: rgba(239, 68, 68, 0.2); }
    .btn-export { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #4ade80; }
    .btn-export:hover { background: rgba(34, 197, 94, 0.2); }
    .btn-filter { padding: 4px 12px; background: #334155; color: #94a3b8; border-radius: 20px; margin-left: 8px; font-size: 12px; border: none; cursor: pointer; }
    
    .empty-state { text-align: center; padding: 80px 20px; color: #64748b; }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
    .empty-state h2 { color: #e2e8f0; margin-bottom: 8px; }
    .footer { text-align: center; padding: 32px 0; color: #64748b; font-size: 13px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #22d3ee; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .error-box { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; padding: 16px; border-radius: 12px; margin-bottom: 24px; }
    .search-box { flex: 1; min-width: 200px; max-width: 300px; padding: 8px 12px; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; border-radius: 8px; color: #f8fafc; font-size: 14px; }
    .search-box:focus { outline: none; border-color: #22d3ee; }
    .search-box::placeholder { color: #64748b; }
    .savings-gauge { width: 100%; height: 8px; background: #334155; border-radius: 4px; margin-top: 8px; overflow: hidden; }
    .savings-gauge-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
    .savings-gauge-fill.good { background: linear-gradient(90deg, #22c55e, #34d399); }
    .savings-gauge-fill.ok { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .savings-gauge-fill.bad { background: linear-gradient(90deg, #ef4444, #fb7185); }
    
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 24px; }
    
    .no-data { text-align: center; padding: 40px; color: #64748b; }
    .no-data-icon { font-size: 32px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üí≥</div>
        <div>
          <h1>Bank Analyzer</h1>
          <p>NLB Statement Dashboard</p>
        </div>
      </div>
      <div class="header-actions" id="headerActions">
        <button class="btn btn-export" onclick="exportToCSV()">üì• Export CSV</button>
        <button class="btn btn-clear" onclick="clearAllData()">üóëÔ∏è Clear</button>
      </div>
    </header>

    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf" multiple>
      <div id="uploadContent">
        <div class="upload-icon">üìÑ</div>
        <h3>Drop NLB bank statements here</h3>
        <p>or click to browse ‚Ä¢ PDF files only ‚Ä¢ Multiple files supported</p>
      </div>
      <div id="uploadLoading" class="hidden">
        <div class="spinner"></div>
        <h3>Processing PDFs...</h3>
        <p id="loadingStatus" style="color: #64748b; margin-top: 8px;"></p>
      </div>
      <div class="file-tags" id="fileTags"></div>
    </div>

    <div id="errorBox" class="error-box hidden"></div>

    <div id="emptyState" class="empty-state">
      <div class="empty-state-icon">üìä</div>
      <h2>No transactions yet</h2>
      <p>Upload your NLB bank statement PDFs to see analytics</p>
    </div>

    <div id="dashboard" class="hidden">
      <div class="filters">
        <div class="filter-group">
          <span class="filter-label">üìÖ</span>
          <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
        </div>
        <div class="filter-group">
          <div class="month-pills" id="monthPills"></div>
        </div>
        <div class="filter-group" style="margin-left: auto;">
          <button class="filter-btn" onclick="resetFilters()">‚Ü∫ Reset</button>
        </div>
      </div>

      <div class="cards">
        <div class="card card-income">
          <div class="card-label">üí∞ Income</div>
          <div class="card-value green" id="totalIncome">‚Ç¨0</div>
          <div class="card-sub" id="incomeCount">0 transactions</div>
        </div>
        <div class="card card-expense">
          <div class="card-label">üí∏ Expenses</div>
          <div class="card-value red" id="totalExpenses">‚Ç¨0</div>
          <div class="card-sub" id="expenseCount">0 transactions</div>
        </div>
        <div class="card card-balance">
          <div class="card-label">üìà Net</div>
          <div class="card-value blue" id="netBalance">‚Ç¨0</div>
          <div class="card-sub" id="avgDaily">Avg/day: ‚Ç¨0</div>
        </div>
        <div class="card card-savings">
          <div class="card-label">üéØ Savings Rate</div>
          <div class="card-value purple" id="savingsRate">0%</div>
          <div class="savings-gauge"><div class="savings-gauge-fill" id="savingsGauge"></div></div>
        </div>
        <div class="card card-count">
          <div class="card-label">üìä Transactions</div>
          <div class="card-value yellow" id="txnTotal">0</div>
          <div class="card-sub" id="dateRange">-</div>
        </div>
      </div>

      <div class="comparison-box" id="comparisonBox">
        <h3>üìä Spending Comparison</h3>
        <div class="comparison-grid" id="comparisonGrid"></div>
      </div>

      <!-- Weekday Analysis & Recurring Transactions -->
      <div class="insights-grid">
        <div class="chart-box" style="margin-bottom: 0;">
          <h3>üìÖ Spending by Weekday</h3>
          <div class="weekday-bars" id="weekdayBars"></div>
        </div>
        
        <div class="chart-box" style="margin-bottom: 0;">
          <h3>üîÑ Recurring Transactions <span class="badge" id="recurringCount">0</span></h3>
          <div id="recurringList"></div>
        </div>
      </div>

      <div class="grid-2">
        <div class="chart-box" style="margin-bottom: 0;">
          <h3>üìä Spending by Category</h3>
          <div class="chart-container"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="chart-box" style="margin-bottom: 0;">
          <h3>üìâ Balance Over Time</h3>
          <div class="chart-container"><canvas id="lineChart"></canvas></div>
        </div>
      </div>

      <!-- Merchant Rankings -->
      <div class="grid-2" style="margin-top: 24px;">
        <div class="chart-box" style="margin-bottom: 0;">
          <h3>üè™ Top Merchants <span class="badge">by amount</span></h3>
          <div id="merchantsByAmount"></div>
        </div>
        <div class="chart-box" style="margin-bottom: 0;">
          <h3>üî¢ Most Visited <span class="badge">by frequency</span></h3>
          <div id="merchantsByFrequency"></div>
        </div>
      </div>

      <div class="chart-box top-expenses" style="margin-top: 24px;">
        <h3>üî• Top 10 Biggest Expenses</h3>
        <div id="topExpensesList"></div>
      </div>

      <div class="chart-box">
        <h3>üìÜ Monthly Income vs Expenses</h3>
        <div class="chart-container tall"><canvas id="monthlyChart"></canvas></div>
      </div>

      <div class="chart-box">
        <h3>üìã Category Breakdown</h3>
        <div class="category-list" id="categoryList"></div>
      </div>

      <div class="transactions">
        <div class="transactions-header">
          <h3>üìù <span id="txnTitle">Transactions</span>
            <button class="btn-filter hidden" id="clearCatFilter" onclick="clearCategoryFilter()">Clear √ó</button>
          </h3>
          <input type="text" class="search-box" id="searchBox" placeholder="üîç Search..." oninput="applyFilters()">
          <span class="transactions-count" id="txnListCount"></span>
        </div>
        <div id="transactionList"></div>
        <button class="show-more hidden" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
      </div>

      <footer class="footer">Bank Analyzer v4 ‚Ä¢ Data stored locally in your browser</footer>
    </div>
  </div>

  <script type="module">
    const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

    window.clearAllData = clearAllData;
    window.clearCategoryFilter = clearCategoryFilter;
    window.toggleShowAll = toggleShowAll;
    window.filterByCategory = filterByCategory;
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;
    window.selectMonth = selectMonth;
    window.exportToCSV = exportToCSV;

    let allTransactions = [];
    let filteredTransactions = [];
    let uploadedFiles = [];
    let selectedCategory = null;
    let selectedYear = 'all';
    let selectedMonth = 'all';
    let searchQuery = '';
    let showAll = false;
    let pieChart = null;
    let lineChart = null;
    let monthlyChart = null;

    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const FULL_MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const WEEKDAY_COLORS = ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#34d399', '#22d3ee', '#a78bfa'];

    const CATEGORIES = {
      'Groceries': { keywords: ['LIDL', 'HOFER', 'SPAR', 'INTERSPAR', 'MERCATOR', 'SUPERMARKET', 'TUS', 'EUROSPIN'], color: '#10B981', icon: 'üõí' },
      'Fuel': { keywords: ['MOL ', 'MOL-', 'PETROL', 'OMV', 'ESSO', 'SHELL'], color: '#F59E0B', icon: '‚õΩ' },
      'Restaurants': { keywords: ['MCDONALDS', 'PUB', 'BAR ', 'RESTAVRACIJA', 'PIVNICA', 'GOSTILNA', 'NEBO', 'TROPIC', 'PIZZA', 'BURGER', 'DONER', 'KEBAB'], color: '#EC4899', icon: 'üçî' },
      'Travel': { keywords: ['ASFINAG', 'DARS', 'EVINJETA', 'BOOKING', 'HOTEL', 'TERME', 'AVTOCAMP', 'RAILWAYS', 'BANKOMAT DVIG', 'AIRBNB', 'HOSTEL', 'RENT A CAR'], color: '#3B82F6', icon: '‚úàÔ∏è' },
      'Shopping': { keywords: ['ZARA', 'AMAZON', 'AMZN', 'ALDI', 'H&M', 'ABOUTYOU', 'ABOUT YOU', 'MERKUR', 'DM -', 'DM-', 'IKEA', 'DECATHLON', 'ALIEXPRESS', 'SHEIN'], color: '#8B5CF6', icon: 'üõçÔ∏è' },
      'Entertainment': { keywords: ['BOLDER SCENA', 'OLAII', 'VSTOPNICE', 'KINO', 'NETFLIX', 'SPOTIFY', 'YOUTUBE', 'STEAM', 'PLAYSTATION', 'XBOX'], color: '#06B6D4', icon: 'üé¨' },
      'Transportation': { keywords: ['CAR PAYMENT', 'AUTOHAUS', 'TEHNICNI PREGLEDI', 'PSTOP', 'PARK', 'TAXI', 'UBER', 'BOLT', 'BUS', 'TRAIN'], color: '#EF4444', icon: 'üöó' },
      'Transfers': { keywords: ['REVOLUT', 'QUASI CASH', 'FLIK', 'PAYPAL', 'WISE'], color: '#6366F1', icon: 'üí∏' },
      'Education': { keywords: ['UL EF', 'FAKULT', 'UNIV', 'STUDENT', 'KNJIG'], color: '#F472B6', icon: 'üéì' },
      'Health': { keywords: ['LEKARNA', 'APOTEKA', 'ZDRAVSTV', 'DOCTOR', 'CLINIC', 'HOSPITAL'], color: '#84CC16', icon: 'üè•' },
      'Services': { keywords: ['POSTA', 'PROVIZIJA', 'TELEKOM', 'NYX', 'TELEMACH', 'A1 ', 'ELEKTRO', 'KOMUNALA'], color: '#64748B', icon: 'üìã' },
      'Income': { keywords: ['ADRIAL', 'REDNO DELO', 'PLACA', 'SICOD', 'RETURN', 'VRACILO', 'STIPENDIJA'], color: '#22C55E', icon: 'üí∞' },
      'Personal': { keywords: ['ROK ', 'MILAN V', 'ANDRAZ', 'NEJC P', 'MIHA M', 'ANJUSA', 'SIMON', 'FLIK PLA'], color: '#14B8A6', icon: 'üë§' },
      'Other': { keywords: [], color: '#94A3B8', icon: 'üí≥' }
    };

    function formatCurrency(amount) {
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
    }

    function categorize(description) {
      const upper = description.toUpperCase();
      for (const [cat, config] of Object.entries(CATEGORIES)) {
        if (cat === 'Other') continue;
        if (config.keywords.some(k => upper.includes(k.toUpperCase()))) return cat;
      }
      return 'Other';
    }

    function parseDate(dateStr) {
      try {
        if (!dateStr || typeof dateStr !== 'string') return null;
        const parts = dateStr.split('.');
        if (parts.length !== 3) return null;
        const d = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        let y = parseInt(parts[2], 10);
        if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
        if (y < 100) y = 2000 + y;
        if (d < 1 || d > 31 || m < 1 || m > 12 || y < 2000 || y > 2100) return null;
        const date = new Date(y, m - 1, d);
        if (isNaN(date.getTime())) return null;
        return date;
      } catch (e) {
        return null;
      }
    }

    // Normalize merchant name for grouping
    function normalizeMerchant(desc) {
      let name = desc.toUpperCase().trim();
      // Remove common prefixes
      name = name.replace(/^(NAKUP |POS |PSTOP |PARK\. )/, '');
      // Remove location suffixes
      name = name.replace(/\s+(LJUBLJANA|MARIBOR|KRANJ|CELJE|CERKLJE|MOSTE|VODICE).*$/i, '');
      // Remove numbers and special patterns
      name = name.replace(/\s+\d+.*$/, '');
      name = name.replace(/\*[A-Z0-9]+/, '');
      // Normalize known merchants
      if (name.includes('SPAR')) return 'SPAR';
      if (name.includes('LIDL')) return 'LIDL';
      if (name.includes('HOFER')) return 'HOFER';
      if (name.includes('MERCATOR')) return 'MERCATOR';
      if (name.includes('PETROL')) return 'PETROL';
      if (name.includes('MOL')) return 'MOL';
      if (name.includes('AMAZON')) return 'AMAZON';
      if (name.includes('MCDONALDS')) return 'MCDONALDS';
      // Take first meaningful word(s)
      const words = name.split(/\s+/).filter(w => w.length > 2);
      return words.slice(0, 2).join(' ') || name.slice(0, 20);
    }

    // Detect recurring transactions
    function detectRecurring(transactions) {
      const merchantGroups = {};
      
      transactions.filter(t => t.amount < 0).forEach(t => {
        const merchant = normalizeMerchant(t.description);
        const amount = Math.abs(t.amount).toFixed(2);
        const key = `${merchant}|${amount}`;
        
        if (!merchantGroups[key]) {
          merchantGroups[key] = { merchant, amount: Math.abs(t.amount), dates: [], transactions: [] };
        }
        merchantGroups[key].dates.push(t.parsedDate);
        merchantGroups[key].transactions.push(t);
      });

      const recurring = [];
      
      for (const [key, group] of Object.entries(merchantGroups)) {
        if (group.dates.length >= 2) {
          // Sort dates
          group.dates.sort((a, b) => a - b);
          
          // Calculate intervals between transactions
          const intervals = [];
          for (let i = 1; i < group.dates.length; i++) {
            const days = Math.round((group.dates[i] - group.dates[i-1]) / (1000 * 60 * 60 * 24));
            intervals.push(days);
          }
          
          // Check for patterns
          const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          const isMonthly = avgInterval >= 25 && avgInterval <= 35;
          const isWeekly = avgInterval >= 5 && avgInterval <= 9;
          const isBiweekly = avgInterval >= 12 && avgInterval <= 16;
          
          if ((isMonthly || isWeekly || isBiweekly) && group.dates.length >= 2) {
            let pattern = 'Regular';
            if (isMonthly) pattern = 'Monthly';
            else if (isWeekly) pattern = 'Weekly';
            else if (isBiweekly) pattern = 'Bi-weekly';
            
            recurring.push({
              merchant: group.merchant,
              amount: group.amount,
              pattern,
              count: group.dates.length,
              lastDate: group.dates[group.dates.length - 1],
              totalSpent: group.amount * group.dates.length
            });
          }
        }
      }
      
      // Sort by total spent
      return recurring.sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 8);
    }

    // Get merchant rankings
    function getMerchantRankings(transactions) {
      const merchants = {};
      
      transactions.filter(t => t.amount < 0).forEach(t => {
        const name = normalizeMerchant(t.description);
        if (!merchants[name]) {
          merchants[name] = { name, total: 0, count: 0, category: t.category };
        }
        merchants[name].total += Math.abs(t.amount);
        merchants[name].count++;
      });

      const list = Object.values(merchants);
      const byAmount = [...list].sort((a, b) => b.total - a.total).slice(0, 10);
      const byFrequency = [...list].sort((a, b) => b.count - a.count).slice(0, 10);
      
      return { byAmount, byFrequency };
    }

    // Get weekday spending
    function getWeekdaySpending(transactions) {
      const weekdays = [0, 0, 0, 0, 0, 0, 0]; // Sun-Sat
      const counts = [0, 0, 0, 0, 0, 0, 0];
      
      transactions.filter(t => t.amount < 0 && t.parsedDate).forEach(t => {
        const day = t.parsedDate.getDay();
        weekdays[day] += Math.abs(t.amount);
        counts[day]++;
      });
      
      const max = Math.max(...weekdays);
      
      return WEEKDAYS.map((name, i) => ({
        name,
        total: weekdays[i],
        count: counts[i],
        percent: max > 0 ? (weekdays[i] / max) * 100 : 0
      }));
    }

    function parseStatement(text) {
      const txns = [];
      const cleanText = text.replace(/\s+/g, ' ');
      const datePattern = /(\d{2}\.\d{2}\.\d{2})/g;
      const dates = [];
      let match;
      
      while ((match = datePattern.exec(cleanText)) !== null) {
        dates.push({ date: match[1], index: match.index });
      }
      
      for (let i = 0; i < dates.length; i++) {
        const startIdx = dates[i].index;
        const endIdx = (i + 1 < dates.length) ? dates[i + 1].index : cleanText.length;
        const segment = cleanText.substring(startIdx, endIdx).trim();
        
        if (/STANJE|SKUPNI|Datum izpiska|predhodnega|LETNA OBRESTNA|EUR\s*-\s*EVRO|NLB PAKET|Obvestilo|Varnostna/i.test(segment)) {
          continue;
        }
        
        const date = dates[i].date;
        const amountPattern = /([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g;
        const amounts = [];
        let amtMatch;
        
        while ((amtMatch = amountPattern.exec(segment)) !== null) {
          amounts.push(amtMatch[1]);
        }
        
        if (amounts.length >= 2) {
          const amtStr = amounts[amounts.length - 2];
          const balStr = amounts[amounts.length - 1];
          
          let amt = parseFloat(amtStr.replace(/\./g, '').replace(',', '.'));
          const bal = parseFloat(balStr.replace(/\./g, '').replace(',', '.'));
          
          const firstAmtIdx = segment.indexOf(amounts[0]);
          let desc = segment.substring(date.length, firstAmtIdx).trim();
          desc = desc.replace(/^\s*[\.,]\s*/, '').trim();
          
          if (!desc || desc.length < 2) continue;
          
          const isIncome = amtStr.startsWith('+') || /ADRIAL|REDNO DELO|RETURN|SICOD|VRACILO/i.test(desc);
          
          if (!amtStr.startsWith('+') && !amtStr.startsWith('-') && !isIncome) {
            amt = -Math.abs(amt);
          }
          
          let category = categorize(desc);
          if (amt > 0 && category === 'Other') category = 'Income';
          
          const parsedDate = parseDate(date);
          if (parsedDate) {
            txns.push({
              id: `${date}-${txns.length}-${Math.random().toString(36).substr(2, 5)}`,
              date,
              parsedDate,
              year: parsedDate.getFullYear(),
              month: parsedDate.getMonth(),
              weekday: parsedDate.getDay(),
              description: desc,
              amount: amt,
              balance: bal,
              category
            });
          }
        }
      }
      
      return txns;
    }

    async function extractPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        
        let lastY = null;
        content.items.forEach(item => {
          if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
            fullText += '\n';
          }
          fullText += item.str + ' ';
          lastY = item.transform[5];
        });
        fullText += '\n';
      }
      
      return fullText;
    }

    async function handleFiles(files) {
      const pdfs = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) return;

      document.getElementById('uploadContent').classList.add('hidden');
      document.getElementById('uploadLoading').classList.remove('hidden');
      document.getElementById('errorBox').classList.add('hidden');

      let totalParsed = 0;
      
      try {
        for (let idx = 0; idx < pdfs.length; idx++) {
          const file = pdfs[idx];
          if (uploadedFiles.includes(file.name)) continue;
          
          document.getElementById('loadingStatus').textContent = `Processing ${idx + 1}/${pdfs.length}: ${file.name}`;
          
          const text = await extractPDF(file);
          const parsed = parseStatement(text);
          
          totalParsed += parsed.length;
          allTransactions = [...allTransactions, ...parsed];
          uploadedFiles.push(file.name);
        }

        const seen = new Set();
        allTransactions = allTransactions.filter(t => {
          const key = `${t.date}-${t.description}-${t.amount}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        allTransactions.sort((a, b) => {
          if (!a.parsedDate || !b.parsedDate) return 0;
          return a.parsedDate.getTime() - b.parsedDate.getTime();
        });

        saveData();
        applyFilters();
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('errorBox').textContent = `Error: ${err.message}`;
        document.getElementById('errorBox').classList.remove('hidden');
      }

      document.getElementById('uploadContent').classList.remove('hidden');
      document.getElementById('uploadLoading').classList.add('hidden');
    }

    function saveData() {
      try {
        localStorage.setItem('bankAnalyzer', JSON.stringify({ 
          transactions: allTransactions.map(t => ({...t, parsedDate: t.parsedDate?.toISOString()})), 
          uploadedFiles 
        }));
      } catch (e) { console.error('Save error:', e); }
    }

    function loadData() {
      try {
        const saved = localStorage.getItem('bankAnalyzer');
        if (saved) {
          const data = JSON.parse(saved);
          allTransactions = (data.transactions || []).map(t => {
            const parsedDate = t.parsedDate ? new Date(t.parsedDate) : parseDate(t.date);
            return {
              ...t,
              parsedDate,
              year: parsedDate?.getFullYear() || 2025,
              month: parsedDate?.getMonth() || 0,
              weekday: parsedDate?.getDay() || 0
            };
          }).filter(t => t.parsedDate);
          uploadedFiles = data.uploadedFiles || [];
        }
      } catch (e) {
        allTransactions = [];
        uploadedFiles = [];
      }
    }

    function clearAllData() {
      if (confirm('Clear all data?')) {
        localStorage.removeItem('bankAnalyzer');
        location.reload();
      }
    }

    function filterByCategory(cat) {
      selectedCategory = selectedCategory === cat ? null : cat;
      applyFilters();
    }

    function clearCategoryFilter() {
      selectedCategory = null;
      applyFilters();
    }

    function selectMonth(month) {
      selectedMonth = selectedMonth === month ? 'all' : month;
      applyFilters();
    }

    function resetFilters() {
      selectedYear = 'all';
      selectedMonth = 'all';
      selectedCategory = null;
      searchQuery = '';
      document.getElementById('yearFilter').value = 'all';
      document.getElementById('searchBox').value = '';
      applyFilters();
    }

    function applyFilters() {
      selectedYear = document.getElementById('yearFilter')?.value || 'all';
      searchQuery = document.getElementById('searchBox')?.value?.toLowerCase() || '';
      
      filteredTransactions = allTransactions.filter(t => {
        if (!t.parsedDate) return false;
        if (selectedYear !== 'all' && t.year !== parseInt(selectedYear)) return false;
        if (selectedMonth !== 'all' && t.month !== parseInt(selectedMonth)) return false;
        if (selectedCategory && t.category !== selectedCategory) return false;
        if (searchQuery && !t.description.toLowerCase().includes(searchQuery)) return false;
        return true;
      });
      
      showAll = false;
      render();
    }

    function toggleShowAll() {
      showAll = !showAll;
      renderTransactions();
    }

    function exportToCSV() {
      const headers = ['Date', 'Weekday', 'Description', 'Amount', 'Balance', 'Category'];
      const rows = filteredTransactions.map(t => [
        t.date,
        WEEKDAYS[t.weekday],
        `"${t.description.replace(/"/g, '""')}"`,
        t.amount.toFixed(2),
        t.balance.toFixed(2),
        t.category
      ]);
      
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `bank-transactions-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function getMonthComparison() {
      if (allTransactions.length === 0) return null;
      
      let currentMonth, currentYear, prevMonth, prevYear;
      
      if (selectedMonth !== 'all' && selectedYear !== 'all') {
        currentMonth = parseInt(selectedMonth);
        currentYear = parseInt(selectedYear);
      } else {
        const validTxns = allTransactions.filter(t => t.parsedDate);
        if (validTxns.length === 0) return null;
        const latestTxn = validTxns[validTxns.length - 1];
        currentMonth = latestTxn.month;
        currentYear = latestTxn.year;
      }
      
      prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
      prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
      
      const currentData = allTransactions.filter(t => t.year === currentYear && t.month === currentMonth);
      const prevData = allTransactions.filter(t => t.year === prevYear && t.month === prevMonth);
      
      if (currentData.length === 0 && prevData.length === 0) return null;
      
      const currentExpenses = Math.abs(currentData.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      const prevExpenses = Math.abs(prevData.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      const currentIncome = currentData.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      const prevIncome = prevData.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      
      return {
        currentMonth: FULL_MONTHS[currentMonth],
        currentYear,
        prevMonth: FULL_MONTHS[prevMonth],
        prevYear,
        currentExpenses,
        prevExpenses,
        currentIncome,
        prevIncome,
        expenseChange: prevExpenses > 0 ? ((currentExpenses - prevExpenses) / prevExpenses) * 100 : 0,
        incomeChange: prevIncome > 0 ? ((currentIncome - prevIncome) / prevIncome) * 100 : 0
      };
    }

    function render() {
      document.getElementById('fileTags').innerHTML = uploadedFiles.map(f => `<span class="file-tag">üìÑ ${f}</span>`).join('');

      if (allTransactions.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('headerActions').classList.add('hidden');
        return;
      }

      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('headerActions').classList.remove('hidden');

      // Year filter
      const years = [...new Set(allTransactions.map(t => t.year))].sort();
      document.getElementById('yearFilter').innerHTML = '<option value="all">All Years</option>' + 
        years.map(y => `<option value="${y}" ${selectedYear == y ? 'selected' : ''}>${y}</option>`).join('');

      // Month pills
      document.getElementById('monthPills').innerHTML = 
        `<span class="month-pill ${selectedMonth === 'all' ? 'active' : ''}" onclick="selectMonth('all')">All</span>` +
        MONTHS.map((m, i) => `<span class="month-pill ${selectedMonth === i ? 'active' : ''}" onclick="selectMonth(${i})">${m}</span>`).join('');

      // Stats
      const income = filteredTransactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
      const expenses = Math.abs(filteredTransactions.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
      const net = income - expenses;
      const savingsRate = income > 0 ? ((income - expenses) / income) * 100 : 0;
      const savingsClass = savingsRate >= 20 ? 'good' : savingsRate >= 10 ? 'ok' : 'bad';

      let dateRange = '-', avgDaily = 0;
      const validTxns = filteredTransactions.filter(t => t.parsedDate);
      if (validTxns.length > 0) {
        dateRange = `${validTxns[0].date} - ${validTxns[validTxns.length - 1].date}`;
        const days = Math.max(1, Math.ceil((validTxns[validTxns.length - 1].parsedDate - validTxns[0].parsedDate) / (1000 * 60 * 60 * 24)));
        avgDaily = expenses / days;
      }

      document.getElementById('totalIncome').textContent = formatCurrency(income);
      document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
      document.getElementById('netBalance').textContent = (net >= 0 ? '+' : '') + formatCurrency(net);
      document.getElementById('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
      document.getElementById('incomeCount').textContent = `${filteredTransactions.filter(t => t.amount > 0).length} transactions`;
      document.getElementById('expenseCount').textContent = `${filteredTransactions.filter(t => t.amount < 0).length} transactions`;
      document.getElementById('savingsRate').textContent = savingsRate.toFixed(1) + '%';
      document.getElementById('savingsGauge').style.width = Math.max(0, Math.min(100, savingsRate)) + '%';
      document.getElementById('savingsGauge').className = 'savings-gauge-fill ' + savingsClass;
      document.getElementById('txnTotal').textContent = filteredTransactions.length;
      document.getElementById('dateRange').textContent = dateRange;
      document.getElementById('avgDaily').textContent = `Avg/day: ${formatCurrency(avgDaily)}`;

      // Comparison
      const comparison = getMonthComparison();
      if (comparison && (comparison.prevExpenses > 0 || comparison.currentExpenses > 0)) {
        document.getElementById('comparisonBox').classList.remove('hidden');
        document.getElementById('comparisonGrid').innerHTML = `
          <div class="comparison-item">
            <div class="comparison-label">üìÖ ${comparison.currentMonth} ${comparison.currentYear}</div>
            <div class="comparison-value" style="color: #fb7185;">${formatCurrency(comparison.currentExpenses)}</div>
            <div class="comparison-change ${comparison.expenseChange > 0 ? 'up' : comparison.expenseChange < 0 ? 'down' : 'neutral'}">
              ${comparison.expenseChange > 0 ? '‚Üë' : comparison.expenseChange < 0 ? '‚Üì' : '‚Üí'} ${Math.abs(comparison.expenseChange).toFixed(1)}%
            </div>
          </div>
          <div class="comparison-item">
            <div class="comparison-label">üìÖ ${comparison.prevMonth} ${comparison.prevYear}</div>
            <div class="comparison-value" style="color: #94a3b8;">${formatCurrency(comparison.prevExpenses)}</div>
            <div class="comparison-change neutral">Previous month</div>
          </div>
          <div class="comparison-item">
            <div class="comparison-label">üí∞ Income Change</div>
            <div class="comparison-value" style="color: ${comparison.incomeChange >= 0 ? '#34d399' : '#fb7185'};">
              ${comparison.incomeChange >= 0 ? '+' : ''}${comparison.incomeChange.toFixed(1)}%
            </div>
            <div class="comparison-change neutral">${formatCurrency(comparison.currentIncome)} vs ${formatCurrency(comparison.prevIncome)}</div>
          </div>
          <div class="comparison-item">
            <div class="comparison-label">üíµ Difference</div>
            <div class="comparison-value" style="color: ${comparison.currentExpenses <= comparison.prevExpenses ? '#34d399' : '#fb7185'};">
              ${comparison.currentExpenses <= comparison.prevExpenses ? '‚àí' : '+'}${formatCurrency(Math.abs(comparison.currentExpenses - comparison.prevExpenses))}
            </div>
            <div class="comparison-change ${comparison.currentExpenses <= comparison.prevExpenses ? 'down' : 'up'}">
              ${comparison.currentExpenses <= comparison.prevExpenses ? 'Saved!' : 'Spent more'}
            </div>
          </div>
        `;
      } else {
        document.getElementById('comparisonBox').classList.add('hidden');
      }

      // Weekday analysis
      renderWeekdayChart();
      
      // Recurring transactions
      renderRecurring();
      
      // Merchant rankings
      renderMerchants();

      // Categories
      const catTotals = {};
      filteredTransactions.filter(t => t.amount < 0).forEach(t => {
        catTotals[t.category] = (catTotals[t.category] || 0) + Math.abs(t.amount);
      });
      const sortedCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);

      document.getElementById('categoryList').innerHTML = sortedCats.map(([cat, amount]) => {
        const config = CATEGORIES[cat] || CATEGORIES.Other;
        const pct = expenses > 0 ? ((amount / expenses) * 100).toFixed(1) : '0';
        return `
          <div class="category-item ${selectedCategory === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">
            <div class="category-icon" style="background:${config.color}20">${config.icon}</div>
            <div class="category-info">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span class="category-name">${cat}</span>
                <span class="category-amount">${formatCurrency(amount)}</span>
              </div>
              <div class="category-bar"><div class="category-bar-fill" style="width:${pct}%;background:${config.color}"></div></div>
            </div>
            <span class="category-percent">${pct}%</span>
          </div>
        `;
      }).join('');

      renderTopExpenses();
      renderCharts(sortedCats);
      renderMonthlyChart();
      renderTransactions();
    }

    function renderWeekdayChart() {
      const weekdayData = getWeekdaySpending(filteredTransactions);
      const maxDay = weekdayData.reduce((max, d) => d.total > max.total ? d : max, weekdayData[0]);
      
      document.getElementById('weekdayBars').innerHTML = weekdayData.map((d, i) => `
        <div class="weekday-bar ${d.name === maxDay.name ? 'highlight' : ''}">
          <div class="weekday-bar-value">${formatCurrency(d.total)}</div>
          <div class="weekday-bar-fill" style="height: ${d.percent}%; background: ${WEEKDAY_COLORS[i]};"></div>
          <div class="weekday-bar-label">${d.name}</div>
        </div>
      `).join('');
    }

    function renderRecurring() {
      const recurring = detectRecurring(filteredTransactions);
      document.getElementById('recurringCount').textContent = recurring.length;
      
      if (recurring.length === 0) {
        document.getElementById('recurringList').innerHTML = `
          <div class="no-data">
            <div class="no-data-icon">üîç</div>
            <p>No recurring transactions detected</p>
          </div>
        `;
        return;
      }
      
      document.getElementById('recurringList').innerHTML = recurring.map(r => `
        <div class="recurring-item">
          <div class="recurring-icon">üîÑ</div>
          <div class="recurring-info">
            <div class="recurring-name">${r.merchant}</div>
            <div class="recurring-pattern">${r.pattern} ‚Ä¢ ${r.count} times</div>
          </div>
          <div class="recurring-amount">
            <div class="recurring-value">${formatCurrency(-r.amount)}</div>
            <div class="recurring-freq">Total: ${formatCurrency(-r.totalSpent)}</div>
          </div>
        </div>
      `).join('');
    }

    function renderMerchants() {
      const { byAmount, byFrequency } = getMerchantRankings(filteredTransactions);
      
      document.getElementById('merchantsByAmount').innerHTML = byAmount.length === 0 
        ? '<div class="no-data"><p>No merchant data</p></div>'
        : byAmount.map((m, i) => `
          <div class="merchant-item">
            <div class="merchant-rank">${i + 1}</div>
            <div class="merchant-info">
              <div class="merchant-name">${m.name}</div>
              <div class="merchant-stats">${m.count} transactions</div>
            </div>
            <div class="merchant-total">${formatCurrency(-m.total)}</div>
          </div>
        `).join('');

      document.getElementById('merchantsByFrequency').innerHTML = byFrequency.length === 0
        ? '<div class="no-data"><p>No merchant data</p></div>'
        : byFrequency.map((m, i) => `
          <div class="merchant-item">
            <div class="merchant-rank">${i + 1}</div>
            <div class="merchant-info">
              <div class="merchant-name">${m.name}</div>
              <div class="merchant-stats">${formatCurrency(-m.total)} total</div>
            </div>
            <div style="text-align: right;">
              <div class="merchant-total" style="color: #22d3ee;">${m.count}√ó</div>
              <div class="merchant-count">visits</div>
            </div>
          </div>
        `).join('');
    }

    function renderTopExpenses() {
      const topExpenses = filteredTransactions
        .filter(t => t.amount < 0)
        .sort((a, b) => a.amount - b.amount)
        .slice(0, 10);

      document.getElementById('topExpensesList').innerHTML = topExpenses.map((t, i) => {
        const config = CATEGORIES[t.category] || CATEGORIES.Other;
        return `
          <div class="top-expense-item">
            <div class="top-expense-rank ${i === 0 ? '' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'silver'}">${i + 1}</div>
            <div class="category-icon" style="background:${config.color}20; width:32px; height:32px; font-size:14px;">${config.icon}</div>
            <div class="top-expense-details">
              <div class="top-expense-desc">${t.description}</div>
              <div class="top-expense-meta">${t.date} ‚Ä¢ ${t.category}</div>
            </div>
            <div class="top-expense-amount">${formatCurrency(t.amount)}</div>
          </div>
        `;
      }).join('');
    }

    function renderCharts(sortedCats) {
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      
      if (sortedCats.length > 0) {
        pieChart = new Chart(pieCtx, {
          type: 'doughnut',
          data: {
            labels: sortedCats.map(([c]) => c),
            datasets: [{
              data: sortedCats.map(([, v]) => v),
              backgroundColor: sortedCats.map(([c]) => (CATEGORIES[c] || CATEGORIES.Other).color),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}` } }
            },
            onClick: (e, elements) => {
              if (elements.length) filterByCategory(sortedCats[elements[0].index][0]);
            }
          }
        });
      }

      const lineCtx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();

      const dailyBal = [];
      filteredTransactions.forEach(t => {
        if (!dailyBal.find(d => d.date === t.date)) {
          dailyBal.push({ date: t.date, balance: t.balance });
        } else {
          dailyBal.find(d => d.date === t.date).balance = t.balance;
        }
      });

      if (dailyBal.length > 0) {
        lineChart = new Chart(lineCtx, {
          type: 'line',
          data: {
            labels: dailyBal.map(d => d.date),
            datasets: [{
              data: dailyBal.map(d => d.balance),
              borderColor: '#22d3ee',
              backgroundColor: 'rgba(34, 211, 238, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { color: '#334155' }, ticks: { color: '#64748b', maxTicksLimit: 8 } },
              y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => (v/1000).toFixed(0) + 'k' } }
            }
          }
        });
      }
    }

    function renderMonthlyChart() {
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if (monthlyChart) monthlyChart.destroy();

      const monthlyData = {};
      allTransactions.forEach(t => {
        if (!t.year || t.month === undefined) return;
        const key = `${t.year}-${String(t.month + 1).padStart(2, '0')}`;
        if (!monthlyData[key]) monthlyData[key] = { income: 0, expenses: 0 };
        if (t.amount > 0) monthlyData[key].income += t.amount;
        else monthlyData[key].expenses += Math.abs(t.amount);
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      if (sortedMonths.length > 0) {
        monthlyChart = new Chart(monthlyCtx, {
          type: 'bar',
          data: {
            labels: sortedMonths.map(k => `${MONTHS[parseInt(k.split('-')[1]) - 1]} ${k.split('-')[0].slice(2)}`),
            datasets: [
              { label: 'Income', data: sortedMonths.map(k => monthlyData[k].income), backgroundColor: '#22C55E' },
              { label: 'Expenses', data: sortedMonths.map(k => monthlyData[k].expenses), backgroundColor: '#fb7185' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true, position: 'top', labels: { color: '#94a3b8', usePointStyle: true } },
              tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } }
            },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#64748b' } },
              y: { grid: { color: '#334155' }, ticks: { color: '#64748b', callback: v => (v/1000).toFixed(0) + 'k' } }
            }
          }
        });
      }
    }

    function renderTransactions() {
      const displayed = showAll ? filteredTransactions.slice().reverse() : filteredTransactions.slice(-15).reverse();

      document.getElementById('txnTitle').textContent = selectedCategory || 'Transactions';
      document.getElementById('clearCatFilter').classList.toggle('hidden', !selectedCategory);
      document.getElementById('txnListCount').textContent = `${filteredTransactions.length} items`;

      document.getElementById('transactionList').innerHTML = displayed.map(t => {
        const config = CATEGORIES[t.category] || CATEGORIES.Other;
        const isPositive = t.amount > 0;
        return `
          <div class="transaction">
            <div class="transaction-icon" style="background:${config.color}20">${config.icon}</div>
            <div class="transaction-details">
              <div class="transaction-desc">${t.description}</div>
              <div class="transaction-meta">${t.date} ‚Ä¢ ${WEEKDAYS[t.weekday]}<span class="transaction-cat" style="background:${config.color}20;color:${config.color}">${t.category}</span></div>
            </div>
            <div class="transaction-amount">
              <div class="transaction-amount-value ${isPositive ? 'positive' : ''}">${isPositive ? '+' : ''}${formatCurrency(t.amount)}</div>
              <div class="transaction-balance">Bal: ${formatCurrency(t.balance)}</div>
            </div>
          </div>
        `;
      }).join('');

      const showBtn = document.getElementById('showMoreBtn');
      if (filteredTransactions.length > 15) {
        showBtn.classList.remove('hidden');
        showBtn.textContent = showAll ? '‚ñ≤ Show less' : `‚ñº Show all ${filteredTransactions.length}`;
      } else {
        showBtn.classList.add('hidden');
      }
    }

    // Event listeners
    document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));
    
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragging'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
    uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragging'); handleFiles(e.dataTransfer.files); });

    loadData();
    applyFilters();
    console.log('Bank Analyzer v4 loaded!');
  </script>
</body>
</html>
