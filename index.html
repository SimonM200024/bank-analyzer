<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer v9</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
:root{--bg:#0f172a;--bg2:#1e293b;--card:rgba(30,41,59,0.5);--item:rgba(51,65,85,0.3);--border:#334155;--text:#f8fafc;--text2:#94a3b8;--muted:#64748b;--accent:#22d3ee;--green:#34d399;--red:#fb7185}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);min-height:100vh;padding:20px}
.container{max-width:500px;margin:0 auto}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;margin-top:60px}
.auth-box h1{font-size:28px;margin-bottom:8px}
.auth-box p{color:var(--muted);margin-bottom:24px}
.auth-input{width:100%;padding:14px;background:var(--item);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
.auth-input:focus{outline:none;border-color:var(--accent)}
.btn{width:100%;padding:14px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;border:none}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a}
.auth-toggle{color:var(--accent);cursor:pointer;margin-top:20px;font-size:13px}
.auth-error{color:var(--red);font-size:13px;margin-top:12px;display:none}
.hidden{display:none!important}
.loading{text-align:center;padding:60px;color:var(--muted)}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.app{display:none}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.logo{font-size:24px;font-weight:700}
.user-info{font-size:13px;color:var(--muted)}
.signout{color:var(--red);cursor:pointer;font-size:13px}
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;margin-bottom:24px;cursor:pointer}
.upload-zone:hover{border-color:var(--accent)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.stat{background:var(--card);padding:16px;border-radius:12px;text-align:center}
.stat-value{font-size:20px;font-weight:700;font-family:monospace}
.stat-label{font-size:11px;color:var(--muted);margin-top:4px}
.green{color:var(--green)}.red{color:var(--red)}.blue{color:var(--accent)}
</style>
</head>
<body>
<div class="container">
  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Connecting...</p>
  </div>

  <!-- Auth -->
  <div class="auth-box hidden" id="authBox">
    <div style="font-size:48px;margin-bottom:16px">ðŸ’³</div>
    <h1>Bank Analyzer</h1>
    <p id="authSubtitle">Sign in to continue</p>
    <input type="email" class="auth-input" id="email" placeholder="Email">
    <input type="password" class="auth-input" id="password" placeholder="Password">
    <input type="text" class="auth-input hidden" id="name" placeholder="Your name">
    <button class="btn btn-primary" id="authBtn">Sign In</button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-toggle" id="authToggle">Don't have an account? Sign up</div>
  </div>

  <!-- App -->
  <div class="app" id="app">
    <div class="header">
      <div class="logo">ðŸ’³ Bank Analyzer</div>
      <div>
        <span class="user-info" id="userEmail"></span>
        <span class="signout" onclick="signOut()"> (Sign out)</span>
      </div>
    </div>
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf" multiple style="display:none">
      <div style="font-size:36px;margin-bottom:12px">ðŸ“„</div>
      <div>Drop NLB statements here</div>
    </div>
    <div class="stats">
      <div class="stat"><div class="stat-value green" id="income">â‚¬0</div><div class="stat-label">Income</div></div>
      <div class="stat"><div class="stat-value red" id="expenses">â‚¬0</div><div class="stat-label">Expenses</div></div>
      <div class="stat"><div class="stat-value blue" id="balance">â‚¬0</div><div class="stat-label">Balance</div></div>
    </div>
    <div id="txnList"></div>
  </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCs0G1y1OriQMXF-E9ittB2WCsbKNnZLSw",
  authDomain: "bank-analyzer-65413.firebaseapp.com",
  databaseURL: "https://bank-analyzer-65413-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bank-analyzer-65413",
  storageBucket: "bank-analyzer-65413.firebasestorage.app",
  messagingSenderId: "987901453174",
  appId: "1:987901453174:web:040f6c6970a71c1bd65057"
};

// Init Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// Elements
const $ = id => document.getElementById(id);
let isSignUp = false;
let currentUser = null;
let transactions = [];

// Auth state
auth.onAuthStateChanged(user => {
  $('loading').classList.add('hidden');
  if (user) {
    currentUser = user;
    $('authBox').classList.add('hidden');
    $('app').classList.remove('hidden');
    $('app').style.display = 'block';
    $('userEmail').textContent = user.email;
    loadData();
  } else {
    $('authBox').classList.remove('hidden');
    $('app').style.display = 'none';
  }
});

// Auth toggle
$('authToggle').onclick = () => {
  isSignUp = !isSignUp;
  $('name').classList.toggle('hidden', !isSignUp);
  $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  $('authSubtitle').textContent = isSignUp ? 'Create your account' : 'Sign in to continue';
  $('authToggle').textContent = isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up";
  $('authError').style.display = 'none';
};

// Auth submit
$('authBtn').onclick = async () => {
  const email = $('email').value;
  const password = $('password').value;
  const name = $('name').value;
  
  try {
    $('authBtn').textContent = 'Please wait...';
    if (isSignUp) {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      await db.ref('users/' + cred.user.uid).set({ email, name, role: 'user', createdAt: Date.now() });
    } else {
      await auth.signInWithEmailAndPassword(email, password);
    }
  } catch (e) {
    $('authError').textContent = e.message;
    $('authError').style.display = 'block';
    $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  }
};

// Sign out
window.signOut = () => auth.signOut();

// Load data
async function loadData() {
  const snap = await db.ref('data/' + currentUser.uid).once('value');
  const data = snap.val() || {};
  transactions = data.transactions || [];
  render();
}

// Save data
async function saveData() {
  await db.ref('data/' + currentUser.uid).set({ transactions, updatedAt: Date.now() });
}

// Render
function render() {
  const income = transactions.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(transactions.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  $('income').textContent = 'â‚¬' + income.toFixed(2);
  $('expenses').textContent = 'â‚¬' + expenses.toFixed(2);
  $('balance').textContent = 'â‚¬' + (income - expenses).toFixed(2);
  
  $('txnList').innerHTML = transactions.slice(-10).reverse().map(t => 
    `<div style="padding:12px;background:var(--card);border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between">
      <div><div style="font-weight:500">${t.description.slice(0,30)}</div><div style="font-size:11px;color:var(--muted)">${t.date}</div></div>
      <div style="font-family:monospace;color:${t.amount>0?'var(--green)':'var(--red)'}">${t.amount>0?'+':''}â‚¬${t.amount.toFixed(2)}</div>
    </div>`
  ).join('');
}

// File upload
$('uploadZone').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => handleFiles(e.target.files);

async function handleFiles(files) {
  for (const file of files) {
    if (!file.name.endsWith('.pdf')) continue;
    const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(item => item.str).join(' ') + '\n';
    }
    const parsed = parseStatement(text);
    transactions = [...transactions, ...parsed];
  }
  await saveData();
  render();
  alert('Imported ' + transactions.length + ' transactions');
}

function parseStatement(txt) {
  const txns = [];
  const dateRegex = /(\d{2}\.\d{2}\.\d{2})/g;
  const matches = [...txt.matchAll(dateRegex)];
  
  for (let i = 0; i < matches.length; i++) {
    const seg = txt.substring(matches[i].index, matches[i+1]?.index || txt.length);
    if (/STANJE|SKUPNI/i.test(seg)) continue;
    
    const amtMatch = seg.match(/([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g);
    if (amtMatch && amtMatch.length >= 2) {
      const amt = parseFloat(amtMatch[amtMatch.length-2].replace(/\./g,'').replace(',','.'));
      const desc = seg.slice(8, seg.indexOf(amtMatch[0])).trim();
      if (desc) txns.push({ date: matches[i][1], description: desc, amount: amt });
    }
  }
  return txns;
}
</script>
</body>
</html>
