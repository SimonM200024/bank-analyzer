<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer v9</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’³</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
:root{--bg:#0f172a;--bg2:#1e293b;--card:rgba(30,41,59,0.5);--item:rgba(51,65,85,0.3);--border:#334155;--text:#f8fafc;--text2:#94a3b8;--muted:#64748b;--accent:#22d3ee;--green:#34d399;--red:#fb7185}
.light{--bg:#f1f5f9;--bg2:#e2e8f0;--card:rgba(255,255,255,0.8);--item:rgba(241,245,249,0.8);--border:#cbd5e1;--text:#0f172a;--text2:#475569;--muted:#64748b}
.midnight{--bg:#0a0a1a;--bg2:#12122a;--card:rgba(20,20,40,0.7);--item:rgba(30,30,60,0.5);--border:#2a2a4a;--accent:#8b5cf6;--green:#a78bfa;--red:#f472b6}
.nature{--bg:#1a2f1a;--bg2:#243524;--card:rgba(30,50,30,0.6);--item:rgba(40,60,40,0.4);--border:#3a5a3a;--accent:#86efac;--green:#4ade80;--red:#fca5a5}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);min-height:100vh;transition:all .3s ease}

/* Animations */
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes countUp{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes drawLine{from{stroke-dashoffset:283}to{stroke-dashoffset:0}}
.animate-in{animation:fadeInUp 0.5s ease forwards;opacity:0}
.pulse{animation:pulse 2s ease infinite}

/* Widget System */
.widget{margin-bottom:20px;transition:all .3s ease}
.widget.hidden-widget{display:none!important}
.widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.widget-header h3{margin:0;font-size:15px;display:flex;align-items:center;gap:8px}
.widget-badge{font-size:10px;padding:3px 8px;background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;border-radius:12px;font-weight:600}

/* Dashboard Controls */
.dashboard-controls{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:24px;padding:16px;background:var(--card);border-radius:14px;border:1px solid var(--border)}
.dashboard-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}

/* Radial Progress */
.radial-box{text-align:center;padding:24px}
.radial-container{width:140px;height:140px;margin:0 auto}
.radial-progress{width:100%;height:100%;transform:rotate(-90deg)}
.radial-bg{fill:none;stroke:var(--border);stroke-width:8}
.radial-fill{fill:none;stroke:var(--accent);stroke-width:8;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1.5s ease}
.radial-fill.savings{stroke:var(--green)}
.radial-fill.month{stroke:#a78bfa}
.radial-text{fill:var(--text);font-size:18px;font-weight:700;text-anchor:middle;dominant-baseline:middle;transform:rotate(90deg);transform-origin:50% 50%}
.radial-label{fill:var(--muted);font-size:6px;text-anchor:middle;transform:rotate(90deg);transform-origin:50% 50%}

/* Sankey Chart */
.sankey-box{overflow:hidden}
.sankey-box .link{fill:none;stroke-opacity:0.4;transition:stroke-opacity .2s}
.sankey-box .link:hover{stroke-opacity:0.7}
.sankey-box .node rect{fill-opacity:0.9;transition:fill-opacity .2s}
.sankey-box .node rect:hover{fill-opacity:1}
.sankey-box .node text{font-size:11px;fill:var(--text)}

/* Treemap */
#treemapChart{border-radius:8px;overflow:hidden}
.treemap-cell{transition:all .2s}
.treemap-cell:hover{filter:brightness(1.2)}
.treemap-label{font-size:11px;font-weight:600;fill:#fff;text-shadow:1px 1px 2px rgba(0,0,0,0.5);pointer-events:none}
.treemap-value{font-size:9px;fill:rgba(255,255,255,0.8);pointer-events:none}

/* Race Chart */
.race-controls{display:flex;align-items:center;gap:12px}
.race-month{font-size:14px;font-weight:600;color:var(--accent);min-width:80px}
.race-bar{height:28px;margin-bottom:6px;border-radius:4px;display:flex;align-items:center;transition:width 0.5s ease}
.race-bar-inner{height:100%;border-radius:4px;display:flex;align-items:center;padding:0 10px;min-width:60px}
.race-bar-label{font-size:11px;font-weight:600;color:#fff;white-space:nowrap;margin-right:8px}
.race-bar-value{font-size:10px;color:rgba(255,255,255,0.8);font-family:monospace}

/* Customize Modal */
.customize-section{margin-bottom:24px}
.customize-section h4{font-size:14px;margin-bottom:12px;color:var(--text)}
.theme-options{display:flex;gap:12px;flex-wrap:wrap}
.theme-opt{cursor:pointer;text-align:center;padding:8px;border-radius:10px;border:2px solid transparent;transition:all .2s}
.theme-opt:hover{border-color:var(--border)}
.theme-opt.selected{border-color:var(--accent)}
.theme-preview{width:60px;height:40px;border-radius:6px;margin-bottom:6px}
.theme-preview.dark{background:linear-gradient(135deg,#0f172a,#1e293b)}
.theme-preview.light{background:linear-gradient(135deg,#f1f5f9,#e2e8f0)}
.theme-preview.midnight{background:linear-gradient(135deg,#0a0a1a,#12122a)}
.theme-preview.nature{background:linear-gradient(135deg,#1a2f1a,#243524)}
.theme-opt span{font-size:11px;color:var(--text2)}

.widget-toggles{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px}
.widget-toggle{display:flex;align-items:center;gap:8px;padding:10px;background:var(--item);border-radius:8px;cursor:pointer;transition:all .2s}
.widget-toggle:hover{background:var(--card)}
.widget-toggle input{width:18px;height:18px;accent-color:var(--accent)}
.widget-toggle span{font-size:13px}

.size-options{display:flex;gap:20px}
.size-options label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px}
.size-options input{accent-color:var(--accent)}

/* Card sizes */
.card-size-small .card{padding:12px}
.card-size-small .card-value{font-size:18px}
.card-size-large .card{padding:24px}
.card-size-large .card-value{font-size:28px}

/* Layout variations */
.layout-compact .widget{margin-bottom:12px}
.layout-compact .chart-box{padding:14px}
.layout-compact .grid-2{gap:12px}
.layout-minimal .widget[data-widget="insights"],.layout-minimal .widget[data-widget="quickstats"],.layout-minimal .widget[data-widget="radials"]{display:none}
.layout-detailed .chart-container{height:320px}

/* AI Chat Panel */
.ai-chat-panel{position:fixed;right:20px;bottom:20px;width:400px;max-width:calc(100vw - 40px);height:600px;max-height:calc(100vh - 100px);background:var(--bg);border:1px solid var(--border);border-radius:20px;display:flex;flex-direction:column;z-index:1000;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

.ai-chat-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(139,92,246,0.1));border-radius:20px 20px 0 0}
.ai-chat-title{display:flex;align-items:center;gap:12px}
.ai-avatar{font-size:32px;animation:bounce 2s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.ai-chat-title h3{font-size:16px;margin:0}
.ai-status{font-size:11px;color:var(--green)}
.ai-chat-close{background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:8px;border-radius:8px}
.ai-chat-close:hover{background:var(--item)}

.ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
.ai-message{display:flex;gap:10px;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.ai-message.user{flex-direction:row-reverse}
.ai-message-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.ai-message.bot .ai-message-avatar{background:linear-gradient(135deg,var(--accent),#8b5cf6)}
.ai-message.user .ai-message-avatar{background:var(--green)}
.ai-message-content{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5}
.ai-message.bot .ai-message-content{background:var(--card);border:1px solid var(--border);border-radius:16px 16px 16px 4px}
.ai-message.user .ai-message-content{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;border-radius:16px 16px 4px 16px}

.ai-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.ai-suggestions button{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:20px;color:var(--text);font-size:12px;cursor:pointer;transition:all .2s}
.ai-suggestions button:hover{background:var(--accent);color:#0f172a;border-color:var(--accent)}

.ai-chat-input{padding:16px;border-top:1px solid var(--border);display:flex;gap:10px}
.ai-chat-input input{flex:1;padding:12px 16px;background:var(--item);border:1px solid var(--border);border-radius:25px;color:var(--text);font-size:14px}
.ai-chat-input input:focus{outline:none;border-color:var(--accent)}
.ai-chat-input button{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--green));border:none;color:#0f172a;font-size:18px;cursor:pointer;transition:transform .2s}
.ai-chat-input button:hover{transform:scale(1.1)}

.ai-typing{display:flex;gap:4px;padding:8px 0}
.ai-typing span{width:8px;height:8px;background:var(--muted);border-radius:50%;animation:typing 1.4s infinite}
.ai-typing span:nth-child(2){animation-delay:0.2s}
.ai-typing span:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,100%{opacity:0.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-4px)}}

.ai-data-card{background:var(--item);border-radius:12px;padding:14px;margin-top:10px}
.ai-data-card h4{font-size:13px;margin-bottom:10px;color:var(--accent)}
.ai-data-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
.ai-data-row:last-child{border:none}
.ai-data-row .label{color:var(--text2)}
.ai-data-row .value{font-weight:600;font-family:monospace}
.ai-highlight{color:var(--accent);font-weight:600}

/* Financial Tools */
.tool-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.tool-tab{padding:12px 24px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text2);font-size:14px;font-weight:500;cursor:pointer;transition:all .2s}
.tool-tab:hover{border-color:var(--accent);color:var(--text)}
.tool-tab.active{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;border-color:transparent}

.tool-panel{animation:fadeIn .3s ease}
.tool-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.tool-grid{grid-template-columns:1fr}}

.tool-input-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.tool-input-section h3{font-size:18px;margin-bottom:4px}
.tool-desc{color:var(--muted);font-size:13px;margin-bottom:20px}

.tool-form{display:flex;flex-direction:column;gap:16px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:12px;color:var(--text2);text-transform:uppercase;font-weight:500}
.input-with-icon{display:flex;align-items:center;background:var(--item);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.input-with-icon span{padding:12px;color:var(--muted);font-size:14px;min-width:40px;text-align:center}
.input-with-icon input{flex:1;padding:12px;background:transparent;border:none;color:var(--text);font-size:16px;font-family:monospace}
.input-with-icon input:focus{outline:none}
.input-with-icon:focus-within{border-color:var(--accent)}

.debt-strategies,.return-presets{margin-top:24px}
.debt-strategies h4,.return-presets h4{font-size:13px;margin-bottom:12px;color:var(--text2)}
.strategy-btn{padding:10px 16px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;cursor:pointer;margin:4px;transition:all .2s}
.strategy-btn:hover{background:var(--accent);color:#0f172a;border-color:var(--accent)}

.tool-result-section{display:flex;flex-direction:column;gap:16px}
.result-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;text-align:center}
.result-card.highlight{background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(139,92,246,0.1));border-color:var(--accent)}
.result-card.green-glow{background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(34,211,238,0.1));border-color:var(--green)}
.result-label{font-size:12px;color:var(--muted);text-transform:uppercase;margin-bottom:8px}
.result-value{font-size:32px;font-weight:700;font-family:monospace}
.result-sub{font-size:13px;color:var(--text2);margin-top:4px}

.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.savings-card{display:flex;align-items:center;gap:16px;text-align:left;background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(34,211,238,0.1));border-color:var(--green)}
.savings-card.hidden{display:none}
.savings-icon{font-size:40px}
.savings-title{font-size:13px;color:var(--text2)}
.savings-value{font-size:24px;font-weight:700;color:var(--green);font-family:monospace}
.savings-time{font-size:13px;color:var(--accent)}

.compound-visual{margin:16px 0}
.compound-bar{display:flex;height:40px;border-radius:10px;overflow:hidden}
.compound-part{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:#fff;transition:width .5s ease}
.compound-part.contributions{background:var(--accent)}
.compound-part.interest{background:var(--green)}

.milestone-list{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
.milestone-list h4{font-size:13px;margin-bottom:12px}
.milestone-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
.milestone-item:last-child{border:none}
.milestone-icon{margin-right:8px}

/* What If Scenarios */
.whatif-scenarios{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.scenario-card{background:var(--item);border:2px solid var(--border);border-radius:14px;padding:20px;text-align:center;cursor:pointer;transition:all .2s}
.scenario-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.scenario-card.selected{border-color:var(--accent);background:rgba(34,211,238,0.1)}
.scenario-icon{font-size:32px;margin-bottom:8px}
.scenario-title{font-weight:600;font-size:14px;margin-bottom:4px}
.scenario-desc{font-size:11px;color:var(--muted)}

.scenario-inputs{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
.scenario-inputs h4{margin-bottom:16px}
.scenario-form select{width:100%;padding:12px;background:var(--item);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px}

.whatif-comparison{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.comparison-header{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;margin-bottom:20px;text-align:center}
.comparison-header h4{font-size:14px;color:var(--text2)}
.comparison-arrow{font-size:20px;color:var(--accent)}

.comparison-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
.comparison-row:last-child{border:none}
.comparison-label{font-size:13px;color:var(--text2)}
.comparison-values{display:flex;align-items:center;gap:12px;font-family:monospace;font-weight:600}
.comparison-values .arrow{color:var(--muted);font-size:12px}

.impact-card{background:var(--item);border-radius:12px;padding:16px;margin-top:20px}
.impact-card h4{margin-bottom:12px;font-size:14px}
.impact-item{display:flex;justify-content:space-between;padding:8px 0;font-size:13px}
.impact-label{color:var(--text2)}
.impact-value{font-family:monospace;font-weight:600}

.whatif-tip{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(34,211,238,0.1);border-radius:12px;margin-top:16px}
.tip-icon{font-size:24px}
.tip-text{font-size:13px;color:var(--text2)}

/* Tool tabs scrollable */
.tool-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:8px}
.tool-tabs::-webkit-scrollbar{height:4px}
.tool-tabs::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* Term/frequency buttons */
.term-buttons,.freq-buttons,.target-buttons{display:flex;gap:8px;margin-top:4px}
.term-btn{flex:1;padding:10px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;cursor:pointer;transition:all .2s}
.term-btn:hover{border-color:var(--accent)}
.term-btn.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}
.input-hint{font-size:11px;color:var(--muted);margin-top:4px}

/* Amortization table */
.amortization-preview{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
.amortization-preview h4{margin-bottom:12px;font-size:14px}
.amort-table{max-height:200px;overflow-y:auto}
.amort-row{display:grid;grid-template-columns:60px 1fr 1fr 1fr 1fr;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.amort-row.header{font-weight:600;color:var(--text2);position:sticky;top:0;background:var(--card)}
.amort-row span{text-align:right}
.amort-row span:first-child{text-align:left}

/* Loan comparison */
.loan-compare-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
@media(max-width:900px){.loan-compare-grid{grid-template-columns:1fr}}
.loan-card{background:var(--item);border:2px solid var(--border);border-radius:14px;padding:20px;transition:all .2s}
.loan-card.winner{border-color:var(--green);box-shadow:0 0 20px rgba(52,211,153,0.2)}
.loan-card h4{margin-bottom:16px;text-align:center}
.loan-results{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.loan-result-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
.loan-result-row .label{color:var(--text2)}
.loan-result-row .value{font-weight:600;font-family:monospace}
.loan-winner{margin-top:24px;padding:20px;background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(34,211,238,0.1));border:2px solid var(--green);border-radius:14px;text-align:center}
.loan-winner h4{margin-bottom:8px;color:var(--green)}
.loan-winner p{color:var(--text2);font-size:14px}

/* Emergency fund */
.emergency-auto{background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(139,92,246,0.1));border:1px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:20px}
.auto-badge{font-size:11px;color:var(--accent);margin-bottom:8px}
.auto-stat{display:flex;justify-content:space-between;align-items:center}
.auto-label{font-size:13px;color:var(--text2)}
.auto-value{font-size:18px;font-weight:700;font-family:monospace;color:var(--text)}
.emergency-tips{margin-top:24px;padding:16px;background:var(--item);border-radius:12px}
.emergency-tips h4{margin-bottom:12px;font-size:13px}
.emergency-tips ul{list-style:none;display:grid;grid-template-columns:1fr 1fr;gap:6px}
.emergency-tips li{font-size:12px;color:var(--text2)}

.emergency-progress-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;text-align:center}
.emergency-ring-container{position:relative;width:160px;height:160px;margin:0 auto}
.emergency-ring{width:100%;height:100%;transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:var(--border);stroke-width:10}
.ring-fill{fill:none;stroke:var(--green);stroke-width:10;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1s ease}
.emergency-ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ring-percent{font-size:28px;font-weight:700;color:var(--green)}
.ring-label{font-size:12px;color:var(--muted)}

.emergency-scenarios{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
.emergency-scenarios h4{margin-bottom:12px;font-size:14px}
.scenario-list{display:flex;flex-direction:column;gap:8px}
.scenario-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--item);border-radius:8px;font-size:13px}
.scenario-item .icon{font-size:18px;margin-right:10px}
.scenario-item .covered{color:var(--green);font-weight:600}
.scenario-item .partial{color:#fbbf24;font-weight:600}
.scenario-item .not-covered{color:var(--red);font-weight:600}

/* Compound interest */
.range-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}
input[type="range"]{width:100%;height:8px;background:var(--border);border-radius:4px;outline:none;-webkit-appearance:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--accent);border-radius:50%;cursor:pointer}

.compound-breakdown{margin:16px 0}
.breakdown-bar{display:flex;height:40px;border-radius:10px;overflow:hidden}
.breakdown-part{display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:#fff;transition:width .5s ease;min-width:40px}
.breakdown-part.initial{background:#8b5cf6}
.breakdown-part.contributions{background:var(--accent)}
.breakdown-part.interest{background:var(--green)}
.breakdown-legend{display:flex;justify-content:center;gap:20px;margin-top:12px;font-size:12px}
.legend-item{display:flex;align-items:center;gap:6px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.initial{background:#8b5cf6}
.dot.contributions{background:var(--accent)}
.dot.interest{background:var(--green)}

.compound-power{margin-top:24px;padding:16px;background:var(--item);border-radius:12px}
.compound-power h4{margin-bottom:12px;font-size:13px}
.power-comparison{display:flex;flex-direction:column;gap:8px}
.power-row{display:flex;justify-content:space-between;font-size:13px;padding:8px;background:var(--card);border-radius:8px}
.power-row .label{color:var(--text2)}
.power-row .value{font-weight:600;font-family:monospace}
.power-row.highlight{background:rgba(52,211,153,0.1);border:1px solid var(--green)}

.compound-table{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
.compound-table h4{margin-bottom:12px;font-size:14px}
.year-table{max-height:250px;overflow-y:auto}
.year-row{display:grid;grid-template-columns:50px 1fr 1fr 1fr;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.year-row.header{font-weight:600;color:var(--text2);position:sticky;top:0;background:var(--card)}
.year-row span{text-align:right;font-family:monospace}
.year-row span:first-child{text-align:left;font-family:inherit}

/* Merchants Page */
.merchant-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}
.merchant-stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;text-align:center}
.merchant-stat .stat-value{font-size:28px;font-weight:700;color:var(--accent);font-family:monospace}
.merchant-stat .stat-label{font-size:12px;color:var(--muted);margin-top:4px}

.merchant-filters{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.merchant-filters .filter-input{flex:1;min-width:150px}

.unknown-alert{display:flex;align-items:center;gap:16px;padding:16px 20px;background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(251,113,133,0.1));border:1px solid rgba(251,191,36,0.3);border-radius:14px;margin-bottom:20px}
.unknown-alert .alert-icon{font-size:32px}
.unknown-alert .alert-content{flex:1}
.unknown-alert .alert-content strong{display:block;margin-bottom:2px}
.unknown-alert .alert-content p{font-size:13px;color:var(--muted)}

.merchant-list{display:flex;flex-direction:column;gap:8px}
.merchant-item{display:flex;align-items:center;gap:16px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;transition:all .2s}
.merchant-item:hover{border-color:var(--accent)}
.merchant-item.uncategorized{border-left:3px solid #fbbf24}
.merchant-item.custom-rule{border-left:3px solid var(--green)}

.merchant-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.merchant-info{flex:1;min-width:0}
.merchant-name{font-weight:600;font-size:14px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.merchant-meta{font-size:12px;color:var(--muted)}
.merchant-meta span{margin-right:12px}

.merchant-category{display:flex;align-items:center;gap:8px}
.merchant-cat-badge{padding:6px 12px;border-radius:8px;font-size:12px;font-weight:500;display:flex;align-items:center;gap:6px}
.merchant-actions{display:flex;gap:8px}

.cat-grid-small{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;max-height:250px;overflow-y:auto;padding:4px}
.cat-opt-small{display:flex;align-items:center;gap:8px;padding:10px;background:var(--item);border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;font-size:13px}
.cat-opt-small:hover{border-color:var(--accent)}
.cat-opt-small.selected{border-color:var(--accent);background:rgba(34,211,238,0.1)}
.cat-opt-small .cat-icon{font-size:16px}

/* Quick category dropdown */
.quick-cat-dropdown{position:relative}
.quick-cat-btn{padding:6px 12px;background:var(--item);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px}
.quick-cat-btn:hover{border-color:var(--accent)}
.quick-cat-menu{position:absolute;top:100%;right:0;margin-top:4px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px;min-width:180px;max-height:300px;overflow-y:auto;z-index:100;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.quick-cat-menu.show{display:block}
.quick-cat-option{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px;transition:background .15s}
.quick-cat-option:hover{background:var(--item)}
.container{max-width:1200px;margin:0 auto;padding:20px}
.hidden{display:none!important}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}

/* Auth */
.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;max-width:400px;width:100%}
.auth-box h1{font-size:28px;margin-bottom:8px}
.auth-box p{color:var(--muted);margin-bottom:24px}
.auth-input{width:100%;padding:14px;background:var(--item);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
.auth-input:focus{outline:none;border-color:var(--accent)}
.btn{padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;width:100%}
.btn-small{padding:8px 14px;font-size:12px}
.btn-red{background:rgba(251,113,133,0.15);border:1px solid rgba(251,113,133,0.3);color:var(--red)}
.btn-green{background:rgba(52,211,153,0.15);border:1px solid rgba(52,211,153,0.3);color:var(--green)}
.btn-blue{background:rgba(34,211,238,0.15);border:1px solid rgba(34,211,238,0.3);color:var(--accent)}
.auth-toggle{color:var(--accent);cursor:pointer;margin-top:20px;font-size:13px}
.auth-error{color:var(--red);font-size:13px;margin-top:12px;display:none}

/* Nav */
.nav{display:flex;background:var(--card);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100;overflow-x:auto}
.nav::-webkit-scrollbar{height:0}
.nav-tab{padding:16px 20px;font-size:14px;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;flex-shrink:0}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{border-color:var(--accent)}

/* NEW SIDEBAR LAYOUT */
.app-layout{display:flex;min-height:100vh}

.sidebar{width:260px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:200;transition:transform .3s ease}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.sidebar-logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--green));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.sidebar-title{font-size:18px;font-weight:700}
.sidebar-subtitle{font-size:11px;color:var(--muted)}

.sidebar-nav{flex:1;padding:12px;overflow-y:auto}
.sidebar-section{margin-bottom:20px}
.sidebar-section-title{font-size:10px;text-transform:uppercase;color:var(--muted);padding:8px 12px;font-weight:600;letter-spacing:1px}

.sidebar-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;cursor:pointer;transition:all .15s;color:var(--text2);font-size:14px;margin-bottom:4px}
.sidebar-item:hover{background:var(--item);color:var(--text)}
.sidebar-item.active{background:linear-gradient(135deg,rgba(34,211,238,0.15),rgba(52,211,153,0.1));color:var(--accent);font-weight:500}
.sidebar-item .icon{font-size:18px;width:24px;text-align:center}
.sidebar-item .badge{margin-left:auto;background:var(--accent);color:#0f172a;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}

.sidebar-footer{padding:16px;border-top:1px solid var(--border)}
.sidebar-user{display:flex;align-items:center;gap:12px;padding:12px;background:var(--item);border-radius:12px;cursor:pointer;transition:all .15s}
.sidebar-user:hover{background:var(--border)}
.sidebar-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--green));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
.sidebar-user-info{flex:1;min-width:0}
.sidebar-user-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sidebar-user-email{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sidebar-user-menu{position:absolute;bottom:80px;left:16px;right:16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:8px;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.sidebar-user-menu.show{display:block}
.sidebar-menu-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13px;transition:background .15s}
.sidebar-menu-item:hover{background:var(--item)}
.sidebar-menu-item.danger{color:var(--red)}

.main-content{flex:1;margin-left:260px;min-height:100vh}

.top-bar{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.top-bar-title{font-size:20px;font-weight:600;display:flex;align-items:center;gap:10px}
.top-bar-title .icon{font-size:24px}
.top-bar-actions{display:flex;gap:8px;align-items:center}

.page-content{padding:24px}

/* Mobile sidebar toggle */
.sidebar-toggle{display:none;position:fixed;top:16px;left:16px;z-index:300;width:44px;height:44px;background:var(--card);border:1px solid var(--border);border-radius:12px;cursor:pointer;font-size:20px;align-items:center;justify-content:center}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:150}

@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .sidebar-toggle{display:flex}
  .sidebar-overlay.show{display:block}
  .main-content{margin-left:0}
}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--green),var(--accent));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.logo h1{font-size:22px}
.logo p{font-size:12px;color:var(--muted)}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative;overflow:hidden}
.card.glow-green{border-color:rgba(52,211,153,0.3);box-shadow:0 0 20px rgba(52,211,153,0.1)}
.card.glow-red{border-color:rgba(251,113,133,0.3);box-shadow:0 0 20px rgba(251,113,133,0.1)}
.card.glow-blue{border-color:rgba(34,211,238,0.3);box-shadow:0 0 20px rgba(34,211,238,0.1)}
.card-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.card-value{font-size:22px;font-weight:700;font-family:monospace}
.card-sub{font-size:11px;color:var(--muted);margin-top:4px}
.card-trend{font-size:11px;margin-top:6px;padding:3px 8px;border-radius:12px;display:inline-block}
.card-trend.up{background:rgba(52,211,153,0.15);color:var(--green)}
.card-trend.down{background:rgba(251,113,133,0.15);color:var(--red)}
.green{color:var(--green)}.red{color:var(--red)}.blue{color:var(--accent)}.purple{color:#a78bfa}.yellow{color:#fbbf24}

/* Insights Banner */
.insights-banner{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:24px}
.insight-card{background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(52,211,153,0.1));border:1px solid rgba(34,211,238,0.2);border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px}
.insight-card.warning{background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(251,113,133,0.1));border-color:rgba(251,191,36,0.3)}
.insight-card.success{background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(34,211,238,0.1));border-color:rgba(52,211,153,0.3)}
.insight-icon{font-size:28px}
.insight-text{flex:1}
.insight-title{font-weight:600;font-size:14px;margin-bottom:2px}
.insight-desc{font-size:12px;color:var(--text2)}

/* Prediction Box */
.prediction-box{background:linear-gradient(135deg,var(--card),rgba(99,102,241,0.1))}
.prediction-content{display:flex;gap:24px;flex-wrap:wrap}
.prediction-main{flex:1;min-width:200px}
.prediction-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.prediction-value{font-size:32px;font-weight:700;font-family:monospace;color:var(--accent)}
.prediction-sub{font-size:11px;color:var(--muted);margin-top:4px}
.prediction-breakdown{flex:1;min-width:200px;display:flex;flex-direction:column;gap:8px}
.prediction-item{display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid var(--border)}
.prediction-item:last-child{border:none}

/* Comparison */
.comparison-grid{display:flex;flex-direction:column;gap:16px}
.comparison-item{background:var(--item);border-radius:10px;padding:14px}
.comparison-label{font-size:12px;color:var(--muted);margin-bottom:8px}
.comparison-values{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:600;font-family:monospace}
.comparison-vs{font-size:11px;color:var(--muted);font-weight:400}
.comparison-current{color:var(--text)}
.comparison-prev{color:var(--muted)}
.comparison-change{font-size:12px;margin-top:6px;font-weight:500}

/* Quick Stats */
.quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.quick-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px}
.quick-icon{font-size:24px}
.quick-value{font-size:16px;font-weight:600;font-family:monospace}
.quick-label{font-size:11px;color:var(--muted)}

/* Alert dot */
.icon-btn{position:relative}
.alert-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* Transactions Page */
.txn-filters{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.filter-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
.filter-row:last-child{margin-bottom:0}
.filter-group{display:flex;flex-direction:column;gap:6px}
.filter-group label{font-size:11px;color:var(--muted);text-transform:uppercase}
.filter-input{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;min-width:120px}
.filter-input:focus{outline:none;border-color:var(--accent)}

.selection-bar{background:var(--accent);color:#0f172a;padding:12px 20px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;gap:16px}

.txn-table{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px}
.txn-table-header{display:grid;grid-template-columns:40px 90px 1fr 120px 100px 100px 60px;padding:12px 16px;background:var(--item);font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border)}
.txn-table-row{display:grid;grid-template-columns:40px 90px 1fr 120px 100px 100px 60px;padding:12px 16px;border-bottom:1px solid var(--bg2);align-items:center;transition:background .15s}
.txn-table-row:hover{background:var(--item)}
.txn-table-row.selected{background:rgba(34,211,238,0.1)}
.txn-col-check{display:flex;align-items:center;justify-content:center}
.txn-col-date{font-size:13px;color:var(--text2)}
.txn-col-desc{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:12px}
.txn-col-cat{font-size:12px}
.txn-col-cat span{padding:4px 8px;border-radius:6px;display:inline-block}
.txn-col-amount{font-family:monospace;font-weight:600;text-align:right}
.txn-col-balance{font-family:monospace;font-size:12px;color:var(--muted);text-align:right}
.txn-col-actions{display:flex;justify-content:center}

.pagination{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
.page-btn{padding:8px 14px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-size:13px}
.page-btn:hover{background:var(--card);border-color:var(--accent)}
.page-btn.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}
.page-btn:disabled{opacity:0.5;cursor:not-allowed}

.txn-summary{display:flex;justify-content:center;gap:32px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.summary-item{display:flex;align-items:center;gap:8px}
.summary-label{font-size:13px;color:var(--muted)}
.summary-value{font-size:16px;font-weight:600;font-family:monospace}

/* Alerts */
.alert-settings{background:var(--item);border-radius:10px;padding:16px;margin-bottom:16px}
.alert-setting{display:flex;align-items:center;gap:8px;padding:8px 0;font-size:14px;cursor:pointer}
.alert-setting input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
.inline-input{width:60px;padding:4px 8px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;text-align:center}

.alert-item{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:8px}
.alert-item.warning{border-left:3px solid #fbbf24}
.alert-item.danger{border-left:3px solid var(--red)}
.alert-item.info{border-left:3px solid var(--accent)}
.alert-item.success{border-left:3px solid var(--green)}
.alert-icon{font-size:20px}
.alert-content{flex:1}
.alert-title{font-weight:600;font-size:14px;margin-bottom:2px}
.alert-desc{font-size:12px;color:var(--muted)}
.alert-time{font-size:11px;color:var(--muted)}

/* Chart Box */
.chart-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.chart-box h3{font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.badge{font-size:10px;padding:2px 8px;background:var(--accent);color:#0f172a;border-radius:10px}
.chart-container{position:relative;height:260px}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}

/* Lists */
.list-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:8px}
.list-item:hover{background:var(--card)}
.list-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.list-info{flex:1;min-width:0}
.list-title{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.list-sub{font-size:12px;color:var(--muted)}
.list-value{font-family:monospace;font-weight:600;font-size:14px}
.rank{width:24px;height:24px;background:var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}

/* Transactions */
.txn-box{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px}
.txn-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.txn-item{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--bg2);cursor:pointer}
.txn-item:hover{background:var(--item)}
.txn-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.txn-details{flex:1;min-width:0}
.txn-desc{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txn-meta{font-size:11px;color:var(--muted)}
.txn-cat{padding:2px 6px;border-radius:6px;font-size:10px;margin-left:6px}
.txn-amount{text-align:right}
.txn-amt{font-weight:600;font-family:monospace}
.txn-bal{font-size:10px;color:var(--muted)}
.search-box{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;width:200px}
.show-more{width:100%;padding:12px;background:transparent;border:none;color:var(--text2);cursor:pointer}

/* Filters */
.filters{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.filter-select{padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
.month-pills{display:flex;gap:6px;flex-wrap:wrap}
.month-pill{padding:6px 12px;background:var(--item);border:1px solid var(--border);border-radius:20px;color:var(--text2);font-size:12px;cursor:pointer}
.month-pill.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}

/* Upload */
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;margin-bottom:24px;cursor:pointer}
.upload-zone:hover{border-color:var(--accent)}
.upload-zone input{display:none}
.upload-icon{font-size:48px;margin-bottom:12px}

/* Import Cards */
.import-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.import-card.inactive{opacity:0.5}
.import-icon{width:48px;height:48px;background:var(--item);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
.import-info{flex:1}
.import-name{font-weight:600;margin-bottom:4px}
.import-meta{font-size:12px;color:var(--muted)}
.import-toggle{width:48px;height:26px;background:var(--border);border-radius:13px;position:relative;cursor:pointer}
.import-toggle.active{background:var(--green)}
.import-toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
.import-toggle.active::after{transform:translateX(22px)}

/* Stats */
.import-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:24px}
.import-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.import-stat-value{font-size:24px;font-weight:700;color:var(--accent);font-family:monospace}
.import-stat-label{font-size:11px;color:var(--muted);margin-top:4px}

/* YoY */
.yoy-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
.yoy-item{padding:14px;background:var(--item);border-radius:10px;text-align:center}
.yoy-label{font-size:11px;color:var(--muted);margin-bottom:6px}
.yoy-values{display:flex;justify-content:center;gap:16px;margin-bottom:6px}
.yoy-year{text-align:center}
.yoy-year-label{font-size:10px;color:var(--muted)}
.yoy-year-value{font-size:15px;font-weight:600;font-family:monospace}
.yoy-change{font-size:12px;font-weight:500}
.yoy-change.up{color:var(--red)}.yoy-change.down{color:var(--green)}

/* Heatmap */
.heatmap{display:flex;gap:3px;overflow-x:auto;padding:10px 0}
.heatmap-week{display:flex;flex-direction:column;gap:3px}
.heatmap-cell{width:12px;height:12px;border-radius:2px;background:var(--item)}
.heatmap-cell.l1{background:rgba(34,197,94,0.3)}.heatmap-cell.l2{background:rgba(250,204,21,0.5)}.heatmap-cell.l3{background:rgba(249,115,22,0.6)}.heatmap-cell.l4{background:rgba(239,68,68,0.7)}

/* Weekday */
.weekday-bars{display:flex;gap:8px;align-items:flex-end;height:150px;padding:10px 0}
.weekday-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.weekday-fill{width:100%;border-radius:4px 4px 0 0;min-height:4px}
.weekday-label{font-size:11px;color:var(--text2)}
.weekday-value{font-size:9px;color:var(--muted);font-family:monospace}

/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-box{background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal-box h2{margin-bottom:16px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px}
.cat-opt{padding:10px;background:var(--item);border:2px solid transparent;border-radius:8px;cursor:pointer;text-align:center}
.cat-opt:hover{background:var(--card)}
.cat-opt.selected{border-color:var(--accent)}
.cat-opt-icon{font-size:20px}
.cat-opt-name{font-size:10px;color:var(--text2);margin-top:4px}
.note-input{width:100%;padding:10px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);margin-bottom:12px}

/* Notifications */
.notif-container{position:fixed;top:20px;right:20px;z-index:9999}
.notif{padding:14px 18px;background:var(--bg);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px;animation:slideIn .3s}
.notif.success{border-color:rgba(52,211,153,0.5)}
.notif.warning{border-color:rgba(251,191,36,0.5)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* User dropdown */
.user-menu{position:relative}
.user-dropdown{position:absolute;top:48px;right:0;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:200px;display:none}
.user-dropdown.show{display:block}
.user-item{padding:10px 12px;border-radius:8px;cursor:pointer}
.user-item:hover{background:var(--item)}

/* Empty */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:56px;margin-bottom:16px}

/* Savings gauge */
.savings-gauge{height:6px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden}
.savings-fill{height:100%;border-radius:3px}
.savings-fill.good{background:var(--green)}.savings-fill.ok{background:#fbbf24}.savings-fill.bad{background:var(--red)}

.page{display:none}.page.active{display:block}

/* AI Insights Page */
.insights-header{display:grid;grid-template-columns:auto 1fr;gap:24px;margin-bottom:24px}
@media(max-width:800px){.insights-header{grid-template-columns:1fr}}

.insights-score-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;display:flex;align-items:center;gap:24px}
.score-ring{position:relative;width:140px;height:140px;flex-shrink:0}
.score-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.score-bg{fill:none;stroke:var(--border);stroke-width:10}
.score-fill{fill:none;stroke:var(--green);stroke-width:10;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1s ease,stroke .3s}
.score-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.score-value{font-size:36px;font-weight:700;color:var(--green)}
.score-label{font-size:11px;color:var(--muted)}
.score-breakdown{flex:1}
.score-factor{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.score-factor:last-child{border:none}
.score-factor span:last-child{font-weight:600;font-family:monospace}

.insights-summary{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.insights-summary h2{margin-bottom:16px;font-size:16px}
.summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.summary-item{display:flex;flex-direction:column;gap:4px}
.summary-item .label{font-size:12px;color:var(--muted)}
.summary-item .value{font-size:20px;font-weight:700;font-family:monospace}

.insights-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px}
@media(max-width:800px){.insights-grid{grid-template-columns:1fr}}

.insight-card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.insight-card.full-width{grid-column:1/-1}
.insight-header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.insight-header.red{background:linear-gradient(135deg,rgba(251,113,133,0.15),rgba(251,113,133,0.05))}
.insight-header.green{background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(52,211,153,0.05))}
.insight-header.blue{background:linear-gradient(135deg,rgba(34,211,238,0.15),rgba(34,211,238,0.05))}
.insight-header.purple{background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(139,92,246,0.05))}
.insight-header.yellow{background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05))}
.insight-header.cyan{background:linear-gradient(135deg,rgba(34,211,238,0.15),rgba(34,211,238,0.05))}
.insight-header.orange{background:linear-gradient(135deg,rgba(249,115,22,0.15),rgba(249,115,22,0.05))}
.insight-icon{font-size:24px}
.insight-header h3{font-size:14px;font-weight:600;margin:0}
.insight-content{padding:20px;min-height:150px}
.insight-loading{display:flex;justify-content:center;align-items:center;height:100px}

.suggestion-item{display:flex;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:10px}
.suggestion-item:last-child{margin-bottom:0}
.suggestion-icon{font-size:20px;flex-shrink:0}
.suggestion-content{flex:1}
.suggestion-title{font-weight:600;font-size:13px;margin-bottom:4px}
.suggestion-desc{font-size:12px;color:var(--muted);line-height:1.5}
.suggestion-impact{display:inline-flex;align-items:center;gap:4px;margin-top:8px;padding:4px 10px;background:rgba(52,211,153,0.15);color:var(--green);border-radius:20px;font-size:11px;font-weight:600}
.suggestion-impact.warning{background:rgba(251,191,36,0.15);color:#fbbf24}
.suggestion-impact.danger{background:rgba(251,113,133,0.15);color:var(--red)}

.pattern-item{padding:12px;border-left:3px solid var(--accent);background:var(--item);border-radius:0 10px 10px 0;margin-bottom:10px}
.pattern-item:last-child{margin-bottom:0}
.pattern-title{font-weight:600;font-size:13px;margin-bottom:4px}
.pattern-desc{font-size:12px;color:var(--muted)}

.quick-win{display:flex;align-items:center;gap:16px;padding:16px;background:var(--item);border-radius:12px;margin-bottom:10px}
.quick-win:last-child{margin-bottom:0}
.quick-win-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(249,115,22,0.1))}
.quick-win-content{flex:1}
.quick-win-title{font-weight:600;font-size:14px;margin-bottom:4px}
.quick-win-desc{font-size:12px;color:var(--muted)}
.quick-win-savings{text-align:right}
.quick-win-amount{font-size:18px;font-weight:700;color:var(--green);font-family:monospace}
.quick-win-period{font-size:11px;color:var(--muted)}

.goal-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:10px}
.goal-item:last-child{margin-bottom:0}
.goal-checkbox{width:24px;height:24px;border:2px solid var(--accent);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.goal-checkbox:hover{background:rgba(34,211,238,0.1)}
.goal-checkbox.checked{background:var(--green);border-color:var(--green)}
.goal-text{flex:1;font-size:13px}
.goal-target{font-size:12px;color:var(--accent);font-family:monospace}

.alert-item{display:flex;gap:12px;padding:12px;border-radius:10px;margin-bottom:10px;border-left:3px solid}
.alert-item:last-child{margin-bottom:0}
.alert-item.warning{background:rgba(251,191,36,0.1);border-color:#fbbf24}
.alert-item.danger{background:rgba(251,113,133,0.1);border-color:var(--red)}
.alert-item.info{background:rgba(34,211,238,0.1);border-color:var(--accent)}
.alert-icon{font-size:18px}
.alert-text{flex:1;font-size:13px}

.insight-actions{display:flex;gap:12px;justify-content:center}

.no-data-message{text-align:center;padding:40px;color:var(--muted)}
.no-data-message .icon{font-size:48px;margin-bottom:12px}

/* User cards */
.user-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.user-card:hover{border-color:var(--accent)}
.user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--green));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:#0f172a}
.user-info{flex:1}
.user-name{font-weight:600;margin-bottom:2px}
.user-email{font-size:12px;color:var(--muted)}
.role-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;margin-left:8px}
.role-badge.admin{background:rgba(251,191,36,0.2);color:#fbbf24}
.role-badge.user{background:rgba(34,211,238,0.2);color:#22d3ee}

/* Stock cards */
.stock-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.stock-card:hover{border-color:var(--accent)}
.stock-card.profit{border-left:4px solid var(--green)}
.stock-card.loss{border-left:4px solid var(--red)}
.stock-symbol{width:60px;height:60px;background:var(--item);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--accent)}
.stock-info{flex:1}
.stock-name{font-weight:600;font-size:16px;margin-bottom:4px}
.stock-meta{font-size:12px;color:var(--muted)}
.stock-values{text-align:right}
.stock-current{font-size:18px;font-weight:700;font-family:monospace}
.stock-gain{font-size:14px;font-weight:600}
.stock-gain.profit{color:var(--green)}
.stock-gain.loss{color:var(--red)}

/* Print styles */
@media print {
  body{background:#fff!important;color:#000!important}
  .sidebar,.top-bar,.sidebar-toggle,.upload-zone,.filters,.btn,.icon-btn,.search-box,.show-more,.modal,.notif-container,.ai-chat-panel{display:none!important}
  .main-content{margin-left:0!important}
  .page-content{padding:0!important}
  .page{display:block!important}
  #pageImports,#pageUsers,#pageTransactions,#pageTools,#pageMerchants,#pageStocks{display:none!important}
  #pageOverview{display:block!important}
  .card,.chart-box,.txn-box,.list-item{background:#fff!important;border:1px solid #ddd!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .card-value,.list-value{color:#000!important}
  .green{color:#059669!important}.red{color:#dc2626!important}.blue{color:#0891b2!important}
}

@media(max-width:600px){.cards{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body class="light">
<div class="notif-container" id="notifBox"></div>

<!-- Loading -->
<div class="auth-screen" id="loading"><div class="spinner"></div></div>

<!-- Auth -->
<div class="auth-screen hidden" id="authScreen">
  <div class="auth-box">
    <div style="font-size:48px;margin-bottom:16px">ðŸ’³</div>
    <h1>Bank Analyzer</h1>
    <p id="authSubtitle">Sign in to continue</p>
    <input type="email" class="auth-input" id="authEmail" placeholder="Email">
    <input type="password" class="auth-input" id="authPassword" placeholder="Password">
    <input type="text" class="auth-input hidden" id="authName" placeholder="Your name">
    <button class="btn btn-primary" id="authBtn">Sign In</button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-toggle" id="authToggle">Don't have an account? Sign up</div>
  </div>
</div>

<!-- Main App -->
<div class="hidden" id="mainApp">
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">ðŸ’³</div>
        <div>
          <div class="sidebar-title">Bank Analyzer</div>
          <div class="sidebar-subtitle">Personal Finance</div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Dashboard</div>
          <div class="sidebar-item active" onclick="switchPage('overview')" data-page="overview">
            <span class="icon">ðŸ“Š</span>
            <span>Overview</span>
          </div>
          <div class="sidebar-item" onclick="switchPage('transactions')" data-page="transactions">
            <span class="icon">ðŸ“</span>
            <span>Transactions</span>
          </div>
          <div class="sidebar-item" onclick="switchPage('insights')" data-page="insights">
            <span class="icon">ðŸ’¡</span>
            <span>AI Insights</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-section-title">Tools</div>
          <div class="sidebar-item" onclick="switchPage('tools')" data-page="tools">
            <span class="icon">ðŸ§®</span>
            <span>Calculators</span>
          </div>
          <div class="sidebar-item" onclick="switchPage('merchants')" data-page="merchants">
            <span class="icon">ðŸª</span>
            <span>Merchants</span>
          </div>
          <div class="sidebar-item" onclick="toggleAIChat()">
            <span class="icon">ðŸ¤–</span>
            <span>AI Assistant</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-section-title">Data</div>
          <div class="sidebar-item" onclick="switchPage('imports')" data-page="imports">
            <span class="icon">ðŸ“</span>
            <span>Imports</span>
            <span class="badge" id="importsBadge2">0</span>
          </div>
          <div class="sidebar-item" onclick="switchPage('stocks')" data-page="stocks">
            <span class="icon">ðŸ“ˆ</span>
            <span>Stocks</span>
            <span class="badge" id="stocksBadge2">0</span>
          </div>
        </div>
        
        <div class="sidebar-section hidden" id="adminSection">
          <div class="sidebar-section-title">Admin</div>
          <div class="sidebar-item" onclick="switchPage('users')" data-page="users">
            <span class="icon">ðŸ‘¥</span>
            <span>Users</span>
            <span class="badge" id="usersBadge2">0</span>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="sidebar-user" onclick="toggleSidebarUserMenu()">
          <div class="sidebar-avatar">ðŸ‘¤</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="sidebarUserName">User</div>
            <div class="sidebar-user-email" id="sidebarUserEmail">user</div>
          </div>
          <span>â‹®</span>
        </div>
        <div class="sidebar-user-menu" id="sidebarUserMenu">
          <div class="sidebar-menu-item" onclick="showAlertsModal()">ðŸ”” Alerts</div>
          <div class="sidebar-menu-item" onclick="toggleTheme()">ðŸŒ™ Toggle Theme</div>
          <div class="sidebar-menu-item" onclick="showCustomizeModal()">âš™ï¸ Customize</div>
          <div class="sidebar-menu-item" onclick="showRulesModal()">ðŸ“‹ Rules</div>
          <div class="sidebar-menu-item" onclick="exportCSV()">ðŸ“¥ Export CSV</div>
          <div class="sidebar-menu-item" onclick="printReport()">ðŸ–¨ï¸ Print Report</div>
          <div class="sidebar-menu-item danger" onclick="signOut()">ðŸšª Sign Out</div>
        </div>
      </div>
    </aside>
    
    <!-- Mobile toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="top-bar-title">
          <span class="icon" id="pageIcon">ðŸ“Š</span>
          <span id="pageTitle">Overview</span>
        </div>
        <div class="top-bar-actions">
          <button class="icon-btn" onclick="toggleAIChat()" title="AI Assistant">ðŸ¤–</button>
          <button class="icon-btn" onclick="showAlertsModal()" title="Alerts">ðŸ””<span class="alert-dot hidden" id="alertDot"></span></button>
          <button class="icon-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle Theme">â˜€ï¸</button>
        </div>
      </div>
      
      <!-- Page Content -->
      <div class="page-content">

  <!-- Overview Page -->
  <div class="page active" id="pageOverview">
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">ðŸ“Š</div>
        <h2>No transactions</h2>
        <p>Go to Imports to add bank statements</p>
        <button class="btn btn-blue" onclick="switchPage('imports')" style="margin-top:16px">ðŸ“ Import PDFs</button>
      </div>

      <div id="dashboard" class="hidden">
        <!-- Dashboard Controls -->
        <div class="dashboard-controls">
          <div class="filters">
            <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
            <div class="month-pills" id="monthPills"></div>
          </div>
          <div class="dashboard-actions">
            <button class="btn btn-small btn-blue" onclick="resetFilters()">â†º Reset</button>
            <button class="btn btn-small btn-green" onclick="showCustomizeModal()">âš™ï¸ Customize</button>
            <select class="filter-select" id="layoutSelect" onchange="changeLayout()">
              <option value="default">Default Layout</option>
              <option value="compact">Compact</option>
              <option value="detailed">Detailed</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>
        </div>

        <!-- Smart Insights Banner -->
        <div class="widget insights-banner" data-widget="insights" id="insightsBanner">
          <div class="insight-card" id="insight1"></div>
          <div class="insight-card" id="insight2"></div>
          <div class="insight-card" id="insight3"></div>
        </div>

        <!-- Main Stats Cards with Animated Counters -->
        <div class="widget cards" data-widget="stats">
          <div class="card glow-green animate-in"><div class="card-label">ðŸ’° Income</div><div class="card-value green counter" id="totalIncome" data-target="0">â‚¬0</div><div class="card-sub" id="incomeCount">0 txns</div><div class="card-trend" id="incomeTrend"></div></div>
          <div class="card glow-red animate-in" style="animation-delay:0.1s"><div class="card-label">ðŸ’¸ Expenses</div><div class="card-value red counter" id="totalExpenses" data-target="0">â‚¬0</div><div class="card-sub" id="expenseCount">0 txns</div><div class="card-trend" id="expenseTrend"></div></div>
          <div class="card glow-blue animate-in" style="animation-delay:0.2s"><div class="card-label">ðŸ“ˆ Net</div><div class="card-value blue counter" id="netBalance" data-target="0">â‚¬0</div><div class="card-sub" id="avgDaily">â‚¬0/day</div></div>
          <div class="card animate-in" style="animation-delay:0.3s"><div class="card-label">ðŸŽ¯ Savings Rate</div><div class="card-value purple" id="savingsRate">0%</div><div class="savings-gauge"><div class="savings-fill" id="savingsGauge"></div></div></div>
          <div class="card animate-in" style="animation-delay:0.4s"><div class="card-label">ðŸ“Š Transactions</div><div class="card-value yellow" id="txnCount">0</div><div class="card-sub" id="dateRange">-</div></div>
        </div>

        <!-- Money Flow Sankey Diagram -->
        <div class="widget chart-box sankey-box animate-in" data-widget="sankey">
          <div class="widget-header">
            <h3>ðŸ’¸ Money Flow</h3>
            <span class="widget-badge">Interactive</span>
          </div>
          <div id="sankeyChart" style="height:350px;width:100%"></div>
        </div>

        <!-- Spending Treemap -->
        <div class="widget chart-box animate-in" data-widget="treemap">
          <div class="widget-header">
            <h3>ðŸ“¦ Spending Treemap</h3>
            <span class="widget-badge">Click to explore</span>
          </div>
          <div id="treemapChart" style="height:300px;width:100%"></div>
        </div>

        <!-- Animated Radial Progress -->
        <div class="widget grid-3 animate-in" data-widget="radials">
          <div class="chart-box radial-box">
            <h3>ðŸŽ¯ Budget Used</h3>
            <div class="radial-container">
              <svg class="radial-progress" viewBox="0 0 100 100" id="budgetRadial">
                <circle class="radial-bg" cx="50" cy="50" r="45"/>
                <circle class="radial-fill" cx="50" cy="50" r="45" id="budgetRadialFill"/>
                <text x="50" y="50" class="radial-text" id="budgetRadialText">0%</text>
                <text x="50" y="62" class="radial-label">of monthly budget</text>
              </svg>
            </div>
          </div>
          <div class="chart-box radial-box">
            <h3>ðŸ’° Savings Goal</h3>
            <div class="radial-container">
              <svg class="radial-progress" viewBox="0 0 100 100" id="savingsRadial">
                <circle class="radial-bg" cx="50" cy="50" r="45"/>
                <circle class="radial-fill savings" cx="50" cy="50" r="45" id="savingsRadialFill"/>
                <text x="50" y="50" class="radial-text" id="savingsRadialText">0%</text>
                <text x="50" y="62" class="radial-label">savings rate</text>
              </svg>
            </div>
          </div>
          <div class="chart-box radial-box">
            <h3>ðŸ“… Month Progress</h3>
            <div class="radial-container">
              <svg class="radial-progress" viewBox="0 0 100 100" id="monthRadial">
                <circle class="radial-bg" cx="50" cy="50" r="45"/>
                <circle class="radial-fill month" cx="50" cy="50" r="45" id="monthRadialFill"/>
                <text x="50" y="50" class="radial-text" id="monthRadialText">0%</text>
                <text x="50" y="62" class="radial-label">of month passed</text>
              </svg>
            </div>
          </div>
        </div>

        <!-- Prediction & Comparison -->
        <div class="widget grid-2 animate-in" data-widget="prediction">
          <div class="chart-box prediction-box">
            <h3>ðŸ”® End of Month Prediction</h3>
            <div class="prediction-content">
              <div class="prediction-main">
                <div class="prediction-label">Predicted Balance</div>
                <div class="prediction-value" id="predictedBalance">â‚¬0</div>
                <div class="prediction-sub" id="predictionNote">Based on your spending patterns</div>
              </div>
              <div class="prediction-breakdown">
                <div class="prediction-item"><span>Current Balance</span><span id="currentBal">â‚¬0</span></div>
                <div class="prediction-item"><span>Expected Income</span><span class="green" id="expectedIncome">+â‚¬0</span></div>
                <div class="prediction-item"><span>Projected Spending</span><span class="red" id="projectedSpending">-â‚¬0</span></div>
                <div class="prediction-item"><span>Days Remaining</span><span id="daysRemaining">0</span></div>
              </div>
            </div>
          </div>
          <div class="chart-box">
            <h3>ðŸ“Š This Month vs Last Month</h3>
            <div class="comparison-grid">
              <div class="comparison-item"><div class="comparison-label">Income</div><div class="comparison-values"><span class="comparison-current" id="compIncomeThis">â‚¬0</span><span class="comparison-vs">vs</span><span class="comparison-prev" id="compIncomeLast">â‚¬0</span></div><div class="comparison-change" id="compIncomeChange"></div></div>
              <div class="comparison-item"><div class="comparison-label">Expenses</div><div class="comparison-values"><span class="comparison-current" id="compExpenseThis">â‚¬0</span><span class="comparison-vs">vs</span><span class="comparison-prev" id="compExpenseLast">â‚¬0</span></div><div class="comparison-change" id="compExpenseChange"></div></div>
              <div class="comparison-item"><div class="comparison-label">Biggest Category</div><div class="comparison-values"><span id="biggestCatThis">-</span><span class="comparison-vs">vs</span><span id="biggestCatLast">-</span></div></div>
            </div>
          </div>
        </div>

        <!-- Quick Stats Row -->
        <div class="widget quick-stats animate-in" data-widget="quickstats">
          <div class="quick-stat"><div class="quick-icon">ðŸ“…</div><div class="quick-info"><div class="quick-value" id="avgDailySpend">â‚¬0</div><div class="quick-label">Daily Average</div></div></div>
          <div class="quick-stat"><div class="quick-icon">ðŸ†</div><div class="quick-info"><div class="quick-value" id="bestDay">-</div><div class="quick-label">Lowest Spend Day</div></div></div>
          <div class="quick-stat"><div class="quick-icon">âš ï¸</div><div class="quick-info"><div class="quick-value" id="worstDay">-</div><div class="quick-label">Highest Spend Day</div></div></div>
          <div class="quick-stat"><div class="quick-icon">ðŸ”„</div><div class="quick-info"><div class="quick-value" id="subscriptionTotal">â‚¬0</div><div class="quick-label">Monthly Subscriptions</div></div></div>
        </div>

        <!-- Spending Race Chart (Animated Bar Race) -->
        <div class="widget chart-box animate-in" data-widget="race">
          <div class="widget-header">
            <h3>ðŸ Category Spending Race</h3>
            <div class="race-controls">
              <button class="btn btn-small btn-blue" onclick="playSpendingRace()" id="racePlayBtn">â–¶ Play</button>
              <span class="race-month" id="raceMonth">-</span>
            </div>
          </div>
          <div id="raceChart" style="height:280px"></div>
        </div>

        <!-- Charts Row -->
        <div class="widget grid-2 animate-in" data-widget="charts">
          <div class="chart-box"><h3>ðŸ“Š Spending by Category</h3><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
          <div class="chart-box"><h3>ðŸ“ˆ Balance Trend</h3><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
        </div>

        <!-- Monthly Chart -->
        <div class="widget chart-box animate-in" data-widget="monthly">
          <h3>ðŸ“† Monthly Income vs Expenses</h3>
          <div class="chart-container" style="height:300px"><canvas id="barChart"></canvas></div>
        </div>

        <!-- Heatmap & Weekday -->
        <div class="widget grid-2 animate-in" data-widget="patterns">
          <div class="chart-box"><h3>ðŸ“… Spending by Weekday</h3><div class="weekday-bars" id="weekdayBars"></div></div>
          <div class="chart-box"><h3>ðŸ—“ï¸ Spending Heatmap</h3><div class="heatmap" id="heatmap"></div></div>
        </div>

        <!-- YoY -->
        <div class="widget chart-box animate-in" id="yoyBox" data-widget="yoy"><h3>ðŸ“… Year-over-Year Comparison <span class="badge" id="yoyYears"></span></h3><div class="yoy-grid" id="yoyGrid"></div></div>

        <!-- Rankings -->
        <div class="widget grid-2 animate-in" data-widget="merchants">
          <div class="chart-box"><h3>ðŸª Top Merchants by Spend</h3><div id="merchantsAmt"></div></div>
          <div class="chart-box"><h3>ðŸ”¢ Most Frequent Merchants</h3><div id="merchantsFreq"></div></div>
        </div>

        <!-- Recurring & Top Expenses -->
        <div class="widget grid-2 animate-in" data-widget="recurring">
          <div class="chart-box"><h3>ðŸ”„ Recurring Payments <span class="badge" id="recurringCount">0</span></h3><div id="recurringList"></div></div>
          <div class="chart-box"><h3>ðŸ”¥ Largest Expenses</h3><div id="topExpenses"></div></div>
        </div>

        <!-- All Categories -->
        <div class="widget chart-box animate-in" data-widget="categories"><h3>ðŸ“‹ All Categories Breakdown</h3><div id="categoryList"></div></div>

        <!-- Recent Transactions -->
        <div class="widget txn-box animate-in" data-widget="transactions">
          <div class="txn-header"><h3>ðŸ“ <span id="txnTitle">Recent Transactions</span></h3><input type="text" class="search-box" id="searchBox" placeholder="ðŸ” Search..." oninput="applyFilters()"></div>
          <div id="txnList"></div>
          <button class="show-more" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
        </div>
      </div>
    </div>

  <!-- AI Insights Page -->
  <div class="page" id="pageInsights">
    <div class="insights-header">
      <div class="insights-score-card">
        <div class="score-ring">
          <svg viewBox="0 0 100 100">
            <circle class="score-bg" cx="50" cy="50" r="45"/>
            <circle class="score-fill" cx="50" cy="50" r="45" id="healthScoreRing"/>
          </svg>
          <div class="score-text">
            <div class="score-value" id="healthScore">--</div>
            <div class="score-label">Health Score</div>
          </div>
        </div>
        <div class="score-breakdown">
          <div class="score-factor"><span>ðŸ’° Savings Rate</span><span id="scoreSavings">--</span></div>
          <div class="score-factor"><span>ðŸ“Š Budget Adherence</span><span id="scoreBudget">--</span></div>
          <div class="score-factor"><span>ðŸ“ˆ Income Stability</span><span id="scoreStability">--</span></div>
          <div class="score-factor"><span>ðŸŽ¯ Spending Efficiency</span><span id="scoreEfficiency">--</span></div>
        </div>
      </div>
      <div class="insights-summary">
        <h2>ðŸ“‹ Financial Summary</h2>
        <div class="summary-grid">
          <div class="summary-item"><span class="label">Monthly Income</span><span class="value green" id="insightIncome">â‚¬0</span></div>
          <div class="summary-item"><span class="label">Monthly Expenses</span><span class="value red" id="insightExpenses">â‚¬0</span></div>
          <div class="summary-item"><span class="label">Monthly Savings</span><span class="value blue" id="insightSavings">â‚¬0</span></div>
          <div class="summary-item"><span class="label">Savings Rate</span><span class="value" id="insightRate">0%</span></div>
        </div>
      </div>
    </div>

    <div class="insights-grid">
      <!-- Cut Back Suggestions -->
      <div class="insight-card">
        <div class="insight-header red">
          <span class="insight-icon">âœ‚ï¸</span>
          <h3>Where to Cut Back</h3>
        </div>
        <div class="insight-content" id="cutbackSuggestions">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Growth Opportunities -->
      <div class="insight-card">
        <div class="insight-header green">
          <span class="insight-icon">ðŸ“ˆ</span>
          <h3>Growth Opportunities</h3>
        </div>
        <div class="insight-content" id="growthSuggestions">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Investment Suggestions -->
      <div class="insight-card">
        <div class="insight-header blue">
          <span class="insight-icon">ðŸ’Ž</span>
          <h3>Investment Ideas</h3>
        </div>
        <div class="insight-content" id="investmentSuggestions">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Spending Patterns -->
      <div class="insight-card">
        <div class="insight-header purple">
          <span class="insight-icon">ðŸ”</span>
          <h3>Spending Patterns</h3>
        </div>
        <div class="insight-content" id="patternInsights">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Quick Wins -->
      <div class="insight-card full-width">
        <div class="insight-header yellow">
          <span class="insight-icon">âš¡</span>
          <h3>Quick Wins - Easy Changes for Big Impact</h3>
        </div>
        <div class="insight-content" id="quickWins">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Monthly Goals -->
      <div class="insight-card">
        <div class="insight-header cyan">
          <span class="insight-icon">ðŸŽ¯</span>
          <h3>Suggested Monthly Goals</h3>
        </div>
        <div class="insight-content" id="monthlyGoals">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Alerts & Warnings -->
      <div class="insight-card">
        <div class="insight-header orange">
          <span class="insight-icon">âš ï¸</span>
          <h3>Alerts & Warnings</h3>
        </div>
        <div class="insight-content" id="alertsWarnings">
          <div class="insight-loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <div class="insight-actions">
      <button class="btn btn-blue" onclick="generateInsights()">ðŸ”„ Refresh Analysis</button>
      <button class="btn btn-green" onclick="exportInsightsReport()">ðŸ“¥ Export Report</button>
    </div>
  </div>

  <!-- Transactions Page -->
  <div class="page" id="pageTransactions">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <div style="font-size:14px;color:var(--muted)" id="txnPageCount">0 transactions</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-small btn-blue" onclick="exportCSV()">ðŸ“¥ Export</button>
          <button class="btn btn-small btn-green" onclick="bulkCategorize()">ðŸ“ Bulk Edit</button>
        </div>
      </div>

      <!-- Advanced Filters -->
      <div class="txn-filters">
        <div class="filter-row">
          <div class="filter-group">
            <label>Date Range</label>
            <div style="display:flex;gap:8px">
              <input type="date" class="filter-input" id="dateFrom" onchange="applyTxnFilters()">
              <span style="color:var(--muted)">to</span>
              <input type="date" class="filter-input" id="dateTo" onchange="applyTxnFilters()">
            </div>
          </div>
          <div class="filter-group">
            <label>Amount Range</label>
            <div style="display:flex;gap:8px">
              <input type="number" class="filter-input" id="amountMin" placeholder="Min â‚¬" onchange="applyTxnFilters()">
              <input type="number" class="filter-input" id="amountMax" placeholder="Max â‚¬" onchange="applyTxnFilters()">
            </div>
          </div>
          <div class="filter-group">
            <label>Type</label>
            <select class="filter-input" id="txnType" onchange="applyTxnFilters()">
              <option value="all">All</option>
              <option value="expense">Expenses</option>
              <option value="income">Income</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label>Category</label>
            <select class="filter-input" id="txnCategory" onchange="applyTxnFilters()">
              <option value="all">All Categories</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Search</label>
            <input type="text" class="filter-input" id="txnSearch" placeholder="Search description..." oninput="applyTxnFilters()">
          </div>
          <div class="filter-group">
            <label>Sort By</label>
            <select class="filter-input" id="txnSort" onchange="applyTxnFilters()">
              <option value="date-desc">Date (Newest)</option>
              <option value="date-asc">Date (Oldest)</option>
              <option value="amount-desc">Amount (High to Low)</option>
              <option value="amount-asc">Amount (Low to High)</option>
              <option value="category">Category</option>
            </select>
          </div>
          <button class="btn btn-small btn-red" onclick="clearTxnFilters()">âœ• Clear</button>
        </div>
      </div>

      <!-- Selection Bar -->
      <div class="selection-bar hidden" id="selectionBar">
        <span id="selectedCount">0 selected</span>
        <button class="btn btn-small btn-blue" onclick="bulkChangeCategory()">ðŸ“ Change Category</button>
        <button class="btn btn-small btn-red" onclick="clearSelection()">âœ• Clear Selection</button>
      </div>

      <!-- Transactions Table -->
      <div class="txn-table">
        <div class="txn-table-header">
          <div class="txn-col-check"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></div>
          <div class="txn-col-date">Date</div>
          <div class="txn-col-desc">Description</div>
          <div class="txn-col-cat">Category</div>
          <div class="txn-col-amount">Amount</div>
          <div class="txn-col-balance">Balance</div>
          <div class="txn-col-actions"></div>
        </div>
        <div id="txnTableBody"></div>
      </div>

      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>

      <!-- Summary -->
      <div class="txn-summary">
        <div class="summary-item"><span class="summary-label">Filtered Income:</span><span class="summary-value green" id="filteredIncome">â‚¬0</span></div>
        <div class="summary-item"><span class="summary-label">Filtered Expenses:</span><span class="summary-value red" id="filteredExpenses">â‚¬0</span></div>
        <div class="summary-item"><span class="summary-label">Net:</span><span class="summary-value" id="filteredNet">â‚¬0</span></div>
      </div>
  </div>

  <!-- Financial Tools Page -->
  <div class="page" id="pageTools">
      <!-- Tool Tabs -->
      <div class="tool-tabs">
        <button class="tool-tab active" onclick="switchToolTab('debt')">ðŸ’³ Debt Payoff</button>
        <button class="tool-tab" onclick="switchToolTab('investment')">ðŸ“ˆ Investment</button>
        <button class="tool-tab" onclick="switchToolTab('mortgage')">ðŸ  Mortgage</button>
        <button class="tool-tab" onclick="switchToolTab('loancompare')">âš–ï¸ Loan Compare</button>
        <button class="tool-tab" onclick="switchToolTab('emergency')">ðŸ›¡ï¸ Emergency Fund</button>
        <button class="tool-tab" onclick="switchToolTab('compound')">ðŸ“Š Compound Interest</button>
        <button class="tool-tab" onclick="switchToolTab('whatif')">ðŸ”® What If?</button>
      </div>

      <!-- Debt Payoff Simulator -->
      <div class="tool-panel" id="toolDebt">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>ðŸ’³ Debt Payoff Calculator</h3>
            <p class="tool-desc">See how fast you can become debt-free</p>
            
            <div class="tool-form">
              <div class="form-group">
                <label>Total Debt Amount</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="debtAmount" value="10000" onchange="calculateDebt()">
                </div>
              </div>
              <div class="form-group">
                <label>Interest Rate (APR %)</label>
                <div class="input-with-icon">
                  <input type="number" id="debtInterest" value="18" step="0.1" onchange="calculateDebt()">
                  <span>%</span>
                </div>
              </div>
              <div class="form-group">
                <label>Minimum Monthly Payment</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="debtMinPayment" value="200" onchange="calculateDebt()">
                </div>
              </div>
              <div class="form-group">
                <label>Extra Monthly Payment</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="debtExtraPayment" value="0" onchange="calculateDebt()">
                </div>
              </div>
            </div>

            <div class="debt-strategies">
              <h4>Try Different Strategies</h4>
              <button class="strategy-btn" onclick="setDebtExtra(50)">+â‚¬50/mo</button>
              <button class="strategy-btn" onclick="setDebtExtra(100)">+â‚¬100/mo</button>
              <button class="strategy-btn" onclick="setDebtExtra(200)">+â‚¬200/mo</button>
              <button class="strategy-btn" onclick="setDebtExtra(500)">+â‚¬500/mo</button>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="result-card highlight">
              <div class="result-label">Time to Debt-Free</div>
              <div class="result-value" id="debtPayoffTime">-</div>
              <div class="result-sub" id="debtPayoffDate">-</div>
            </div>
            
            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Total Interest Paid</div>
                <div class="result-value red" id="debtTotalInterest">â‚¬0</div>
              </div>
              <div class="result-card">
                <div class="result-label">Total Amount Paid</div>
                <div class="result-value" id="debtTotalPaid">â‚¬0</div>
              </div>
            </div>

            <div class="result-card savings-card" id="debtSavingsCard">
              <div class="savings-icon">ðŸŽ‰</div>
              <div class="savings-content">
                <div class="savings-title">With extra payments you save:</div>
                <div class="savings-value" id="debtSavings">â‚¬0</div>
                <div class="savings-time" id="debtTimeSaved">0 months faster</div>
              </div>
            </div>

            <div class="chart-box" style="margin-top:20px">
              <h4>ðŸ“‰ Debt Payoff Timeline</h4>
              <div class="chart-container"><canvas id="debtChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Investment Growth Simulator -->
      <div class="tool-panel hidden" id="toolInvestment">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>ðŸ“ˆ Investment Growth Calculator</h3>
            <p class="tool-desc">See how your money can grow over time</p>
            
            <div class="tool-form">
              <div class="form-group">
                <label>Initial Investment</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="investInitial" value="5000" onchange="calculateInvestment()">
                </div>
              </div>
              <div class="form-group">
                <label>Monthly Contribution</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="investMonthly" value="500" onchange="calculateInvestment()">
                </div>
              </div>
              <div class="form-group">
                <label>Expected Annual Return</label>
                <div class="input-with-icon">
                  <input type="number" id="investReturn" value="7" step="0.1" onchange="calculateInvestment()">
                  <span>%</span>
                </div>
              </div>
              <div class="form-group">
                <label>Time Period (Years)</label>
                <div class="input-with-icon">
                  <input type="number" id="investYears" value="20" onchange="calculateInvestment()">
                  <span>yrs</span>
                </div>
              </div>
            </div>

            <div class="return-presets">
              <h4>Common Return Rates</h4>
              <button class="strategy-btn" onclick="setInvestReturn(4)">Conservative (4%)</button>
              <button class="strategy-btn" onclick="setInvestReturn(7)">Moderate (7%)</button>
              <button class="strategy-btn" onclick="setInvestReturn(10)">Aggressive (10%)</button>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="result-card highlight green-glow">
              <div class="result-label">Future Value</div>
              <div class="result-value green" id="investFutureValue">â‚¬0</div>
              <div class="result-sub" id="investYearsLabel">in 20 years</div>
            </div>
            
            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Total Contributions</div>
                <div class="result-value blue" id="investContributions">â‚¬0</div>
              </div>
              <div class="result-card">
                <div class="result-label">Interest Earned</div>
                <div class="result-value green" id="investInterestEarned">â‚¬0</div>
              </div>
            </div>

            <div class="compound-visual">
              <div class="compound-bar">
                <div class="compound-part contributions" id="compoundContrib" style="width:50%">
                  <span>Contributions</span>
                </div>
                <div class="compound-part interest" id="compoundInterest" style="width:50%">
                  <span>Interest</span>
                </div>
              </div>
            </div>

            <div class="chart-box" style="margin-top:20px">
              <h4>ðŸ“ˆ Growth Over Time</h4>
              <div class="chart-container"><canvas id="investChart"></canvas></div>
            </div>

            <div class="milestone-list" id="investMilestones"></div>
          </div>
        </div>
      </div>

      <!-- What If Scenarios -->
      <div class="tool-panel hidden" id="toolWhatif">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>ðŸ”® What If Scenarios</h3>
            <p class="tool-desc">Explore how changes affect your finances</p>
            
            <div class="whatif-scenarios">
              <div class="scenario-card" onclick="selectScenario('raise')">
                <div class="scenario-icon">ðŸ’°</div>
                <div class="scenario-title">I Get a Raise</div>
                <div class="scenario-desc">See impact of higher income</div>
              </div>
              <div class="scenario-card" onclick="selectScenario('cut')">
                <div class="scenario-icon">âœ‚ï¸</div>
                <div class="scenario-title">I Cut Spending</div>
                <div class="scenario-desc">Reduce a category</div>
              </div>
              <div class="scenario-card" onclick="selectScenario('save')">
                <div class="scenario-icon">ðŸŽ¯</div>
                <div class="scenario-title">I Save More</div>
                <div class="scenario-desc">Increase savings rate</div>
              </div>
              <div class="scenario-card" onclick="selectScenario('invest')">
                <div class="scenario-icon">ðŸ“ˆ</div>
                <div class="scenario-title">I Start Investing</div>
                <div class="scenario-desc">Put savings to work</div>
              </div>
            </div>

            <div class="scenario-inputs hidden" id="scenarioInputs">
              <h4 id="scenarioTitle">Scenario Settings</h4>
              
              <div id="raiseInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Monthly Raise Amount</label>
                  <div class="input-with-icon">
                    <span>â‚¬</span>
                    <input type="number" id="raiseAmount" value="500" onchange="calculateWhatIf()">
                  </div>
                </div>
              </div>

              <div id="cutInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Category to Cut</label>
                  <select id="cutCategory" onchange="calculateWhatIf()"></select>
                </div>
                <div class="form-group">
                  <label>Reduce by (%)</label>
                  <div class="input-with-icon">
                    <input type="number" id="cutPercent" value="30" onchange="calculateWhatIf()">
                    <span>%</span>
                  </div>
                </div>
              </div>

              <div id="saveInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Target Savings Rate</label>
                  <div class="input-with-icon">
                    <input type="number" id="targetSavingsRate" value="25" onchange="calculateWhatIf()">
                    <span>%</span>
                  </div>
                </div>
              </div>

              <div id="investInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Monthly Investment</label>
                  <div class="input-with-icon">
                    <span>â‚¬</span>
                    <input type="number" id="monthlyInvest" value="300" onchange="calculateWhatIf()">
                  </div>
                </div>
                <div class="form-group">
                  <label>Expected Return (%)</label>
                  <div class="input-with-icon">
                    <input type="number" id="expectedReturn" value="7" onchange="calculateWhatIf()">
                    <span>%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="whatif-comparison" id="whatifResults">
              <div class="comparison-header">
                <div class="comparison-col">
                  <h4>ðŸ“Š Current</h4>
                </div>
                <div class="comparison-arrow">â†’</div>
                <div class="comparison-col">
                  <h4>ðŸ”® After Change</h4>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Monthly Income</div>
                <div class="comparison-values">
                  <span id="currentIncome">â‚¬0</span>
                  <span class="arrow">â†’</span>
                  <span id="newIncome" class="green">â‚¬0</span>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Monthly Expenses</div>
                <div class="comparison-values">
                  <span id="currentExpenses">â‚¬0</span>
                  <span class="arrow">â†’</span>
                  <span id="newExpenses">â‚¬0</span>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Monthly Savings</div>
                <div class="comparison-values">
                  <span id="currentSavings">â‚¬0</span>
                  <span class="arrow">â†’</span>
                  <span id="newSavings" class="green">â‚¬0</span>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Savings Rate</div>
                <div class="comparison-values">
                  <span id="currentRate">0%</span>
                  <span class="arrow">â†’</span>
                  <span id="newRate" class="green">0%</span>
                </div>
              </div>

              <div class="impact-card" id="impactCard">
                <h4>ðŸ’¡ Impact Analysis</h4>
                <div class="impact-item">
                  <span class="impact-label">Extra Yearly Savings</span>
                  <span class="impact-value green" id="extraYearlySavings">â‚¬0</span>
                </div>
                <div class="impact-item">
                  <span class="impact-label">In 5 Years (with 7% return)</span>
                  <span class="impact-value green" id="impact5Years">â‚¬0</span>
                </div>
                <div class="impact-item">
                  <span class="impact-label">In 10 Years (with 7% return)</span>
                  <span class="impact-value green" id="impact10Years">â‚¬0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mortgage Calculator -->
      <div class="tool-panel hidden" id="toolMortgage">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>ðŸ  Mortgage Calculator</h3>
            <p class="tool-desc">Plan your home purchase</p>
            
            <div class="tool-form">
              <div class="form-group">
                <label>Home Price</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="mortgagePrice" value="300000" onchange="calculateMortgage()">
                </div>
              </div>
              <div class="form-group">
                <label>Down Payment</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="mortgageDown" value="60000" onchange="calculateMortgage()">
                </div>
                <small class="input-hint" id="mortgageDownPercent">20% down</small>
              </div>
              <div class="form-group">
                <label>Interest Rate (%)</label>
                <div class="input-with-icon">
                  <input type="number" id="mortgageRate" value="4.5" step="0.1" onchange="calculateMortgage()">
                  <span>%</span>
                </div>
              </div>
              <div class="form-group">
                <label>Loan Term</label>
                <div class="term-buttons">
                  <button class="term-btn" onclick="setMortgageTerm(15)">15 yrs</button>
                  <button class="term-btn active" onclick="setMortgageTerm(20)">20 yrs</button>
                  <button class="term-btn" onclick="setMortgageTerm(25)">25 yrs</button>
                  <button class="term-btn" onclick="setMortgageTerm(30)">30 yrs</button>
                </div>
                <input type="hidden" id="mortgageTerm" value="20">
              </div>
              <div class="form-group">
                <label>Extra Monthly Payment (Optional)</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="mortgageExtra" value="0" onchange="calculateMortgage()">
                </div>
              </div>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="result-card highlight">
              <div class="result-label">Monthly Payment</div>
              <div class="result-value blue" id="mortgagePayment">â‚¬0</div>
              <div class="result-sub">Principal + Interest</div>
            </div>
            
            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Loan Amount</div>
                <div class="result-value" id="mortgageLoan">â‚¬0</div>
              </div>
              <div class="result-card">
                <div class="result-label">Total Interest</div>
                <div class="result-value red" id="mortgageTotalInterest">â‚¬0</div>
              </div>
            </div>

            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Total Cost</div>
                <div class="result-value" id="mortgageTotalCost">â‚¬0</div>
              </div>
              <div class="result-card">
                <div class="result-label">Payoff Date</div>
                <div class="result-value" id="mortgagePayoffDate">-</div>
              </div>
            </div>

            <div class="result-card savings-card" id="mortgageSavingsCard" style="display:none">
              <div class="savings-icon">ðŸŽ‰</div>
              <div class="savings-content">
                <div class="savings-title">With extra payments:</div>
                <div class="savings-value" id="mortgageSavings">â‚¬0 saved</div>
                <div class="savings-time" id="mortgageTimeSaved">0 years faster</div>
              </div>
            </div>

            <div class="chart-box" style="margin-top:20px">
              <h4>ðŸ“Š Payment Breakdown Over Time</h4>
              <div class="chart-container"><canvas id="mortgageChart"></canvas></div>
            </div>

            <div class="amortization-preview">
              <h4>ðŸ“‹ Amortization Preview</h4>
              <div class="amort-table" id="amortTable"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loan Comparison Tool -->
      <div class="tool-panel hidden" id="toolLoancompare">
        <div class="tool-input-section" style="max-width:100%">
          <h3>âš–ï¸ Loan Comparison</h3>
          <p class="tool-desc">Compare up to 3 loan offers side by side</p>
          
          <div class="loan-compare-grid">
            <div class="loan-card">
              <h4>ðŸ“‹ Loan A</h4>
              <div class="tool-form">
                <div class="form-group">
                  <label>Loan Amount</label>
                  <div class="input-with-icon"><span>â‚¬</span><input type="number" id="loanA_amount" value="20000" onchange="compareLoan()"></div>
                </div>
                <div class="form-group">
                  <label>Interest Rate</label>
                  <div class="input-with-icon"><input type="number" id="loanA_rate" value="5.9" step="0.1" onchange="compareLoan()"><span>%</span></div>
                </div>
                <div class="form-group">
                  <label>Term (months)</label>
                  <div class="input-with-icon"><input type="number" id="loanA_term" value="48" onchange="compareLoan()"><span>mo</span></div>
                </div>
                <div class="form-group">
                  <label>Fees</label>
                  <div class="input-with-icon"><span>â‚¬</span><input type="number" id="loanA_fees" value="0" onchange="compareLoan()"></div>
                </div>
              </div>
              <div class="loan-results" id="loanA_results"></div>
            </div>

            <div class="loan-card">
              <h4>ðŸ“‹ Loan B</h4>
              <div class="tool-form">
                <div class="form-group">
                  <label>Loan Amount</label>
                  <div class="input-with-icon"><span>â‚¬</span><input type="number" id="loanB_amount" value="20000" onchange="compareLoan()"></div>
                </div>
                <div class="form-group">
                  <label>Interest Rate</label>
                  <div class="input-with-icon"><input type="number" id="loanB_rate" value="6.9" step="0.1" onchange="compareLoan()"><span>%</span></div>
                </div>
                <div class="form-group">
                  <label>Term (months)</label>
                  <div class="input-with-icon"><input type="number" id="loanB_term" value="60" onchange="compareLoan()"><span>mo</span></div>
                </div>
                <div class="form-group">
                  <label>Fees</label>
                  <div class="input-with-icon"><span>â‚¬</span><input type="number" id="loanB_fees" value="200" onchange="compareLoan()"></div>
                </div>
              </div>
              <div class="loan-results" id="loanB_results"></div>
            </div>

            <div class="loan-card">
              <h4>ðŸ“‹ Loan C</h4>
              <div class="tool-form">
                <div class="form-group">
                  <label>Loan Amount</label>
                  <div class="input-with-icon"><span>â‚¬</span><input type="number" id="loanC_amount" value="20000" onchange="compareLoan()"></div>
                </div>
                <div class="form-group">
                  <label>Interest Rate</label>
                  <div class="input-with-icon"><input type="number" id="loanC_rate" value="4.9" step="0.1" onchange="compareLoan()"><span>%</span></div>
                </div>
                <div class="form-group">
                  <label>Term (months)</label>
                  <div class="input-with-icon"><input type="number" id="loanC_term" value="36" onchange="compareLoan()"><span>mo</span></div>
                </div>
                <div class="form-group">
                  <label>Fees</label>
                  <div class="input-with-icon"><span>â‚¬</span><input type="number" id="loanC_fees" value="500" onchange="compareLoan()"></div>
                </div>
              </div>
              <div class="loan-results" id="loanC_results"></div>
            </div>
          </div>

          <div class="loan-winner" id="loanWinner"></div>
        </div>
      </div>

      <!-- Emergency Fund Calculator -->
      <div class="tool-panel hidden" id="toolEmergency">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>ðŸ›¡ï¸ Emergency Fund Calculator</h3>
            <p class="tool-desc">Based on YOUR actual spending data</p>
            
            <div class="emergency-auto" id="emergencyAuto">
              <div class="auto-badge">âœ¨ Auto-calculated from your data</div>
              <div class="auto-stat">
                <span class="auto-label">Your Monthly Expenses</span>
                <span class="auto-value" id="emergencyMonthlyExp">â‚¬0</span>
              </div>
            </div>

            <div class="tool-form">
              <div class="form-group">
                <label>Monthly Essential Expenses</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="emergencyExpenses" value="2000" onchange="calculateEmergency()">
                </div>
                <small class="input-hint">Rent, utilities, food, insurance, minimum debt payments</small>
              </div>
              <div class="form-group">
                <label>Current Emergency Savings</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="emergencyCurrent" value="3000" onchange="calculateEmergency()">
                </div>
              </div>
              <div class="form-group">
                <label>Monthly Contribution</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="emergencyContribution" value="300" onchange="calculateEmergency()">
                </div>
              </div>
              <div class="form-group">
                <label>Target (months of expenses)</label>
                <div class="target-buttons">
                  <button class="term-btn" onclick="setEmergencyTarget(3)">3 mo</button>
                  <button class="term-btn active" onclick="setEmergencyTarget(6)">6 mo</button>
                  <button class="term-btn" onclick="setEmergencyTarget(9)">9 mo</button>
                  <button class="term-btn" onclick="setEmergencyTarget(12)">12 mo</button>
                </div>
                <input type="hidden" id="emergencyTarget" value="6">
              </div>
            </div>

            <div class="emergency-tips">
              <h4>ðŸ’¡ What counts as essential?</h4>
              <ul>
                <li>ðŸ  Rent/Mortgage</li>
                <li>âš¡ Utilities (electric, water, gas)</li>
                <li>ðŸ›’ Groceries</li>
                <li>ðŸš— Transportation</li>
                <li>ðŸ¥ Insurance & Healthcare</li>
                <li>ðŸ’³ Minimum debt payments</li>
              </ul>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="emergency-progress-card">
              <div class="emergency-ring-container">
                <svg class="emergency-ring" viewBox="0 0 100 100">
                  <circle class="ring-bg" cx="50" cy="50" r="45"/>
                  <circle class="ring-fill" cx="50" cy="50" r="45" id="emergencyRing"/>
                </svg>
                <div class="emergency-ring-text">
                  <div class="ring-percent" id="emergencyPercent">0%</div>
                  <div class="ring-label">funded</div>
                </div>
              </div>
            </div>

            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Target Amount</div>
                <div class="result-value blue" id="emergencyTargetAmount">â‚¬0</div>
                <div class="result-sub" id="emergencyTargetMonths">6 months expenses</div>
              </div>
              <div class="result-card">
                <div class="result-label">Still Needed</div>
                <div class="result-value red" id="emergencyNeeded">â‚¬0</div>
              </div>
            </div>

            <div class="result-card highlight">
              <div class="result-label">Time to Fully Funded</div>
              <div class="result-value green" id="emergencyTime">-</div>
              <div class="result-sub" id="emergencyDate">-</div>
            </div>

            <div class="emergency-scenarios">
              <h4>ðŸ›¡ï¸ What Your Fund Covers</h4>
              <div class="scenario-list" id="emergencyScenarios"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Compound Interest Visualizer -->
      <div class="tool-panel hidden" id="toolCompound">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>ðŸ“Š Compound Interest Visualizer</h3>
            <p class="tool-desc">See the magic of compounding</p>
            
            <div class="tool-form">
              <div class="form-group">
                <label>Initial Amount</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="compoundInitial" value="1000" onchange="calculateCompound()">
                </div>
              </div>
              <div class="form-group">
                <label>Monthly Contribution</label>
                <div class="input-with-icon">
                  <span>â‚¬</span>
                  <input type="number" id="compoundMonthly" value="200" onchange="calculateCompound()">
                </div>
              </div>
              <div class="form-group">
                <label>Annual Interest Rate (%)</label>
                <div class="input-with-icon">
                  <input type="number" id="compoundRate" value="7" step="0.1" onchange="calculateCompound()">
                  <span>%</span>
                </div>
              </div>
              <div class="form-group">
                <label>Time Period (Years)</label>
                <input type="range" id="compoundYears" min="1" max="50" value="30" oninput="calculateCompound()">
                <div class="range-labels">
                  <span>1 yr</span>
                  <span id="compoundYearsLabel">30 years</span>
                  <span>50 yrs</span>
                </div>
              </div>
              <div class="form-group">
                <label>Compound Frequency</label>
                <div class="freq-buttons">
                  <button class="term-btn" onclick="setCompoundFreq(1)">Annually</button>
                  <button class="term-btn" onclick="setCompoundFreq(4)">Quarterly</button>
                  <button class="term-btn active" onclick="setCompoundFreq(12)">Monthly</button>
                  <button class="term-btn" onclick="setCompoundFreq(365)">Daily</button>
                </div>
                <input type="hidden" id="compoundFreq" value="12">
              </div>
            </div>

            <div class="compound-power">
              <h4>ðŸ’ª The Power of Starting Early</h4>
              <div class="power-comparison" id="powerComparison"></div>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="result-card highlight green-glow">
              <div class="result-label">Final Amount</div>
              <div class="result-value green" id="compoundFinal">â‚¬0</div>
              <div class="result-sub" id="compoundYearsResult">in 30 years</div>
            </div>
            
            <div class="compound-breakdown">
              <div class="breakdown-bar">
                <div class="breakdown-part initial" id="breakdownInitial" style="width:10%">
                  <span>Initial</span>
                </div>
                <div class="breakdown-part contributions" id="breakdownContrib" style="width:30%">
                  <span>Contributions</span>
                </div>
                <div class="breakdown-part interest" id="breakdownInterest" style="width:60%">
                  <span>Interest</span>
                </div>
              </div>
              <div class="breakdown-legend">
                <div class="legend-item"><span class="dot initial"></span>Initial: <span id="legendInitial">â‚¬0</span></div>
                <div class="legend-item"><span class="dot contributions"></span>Contributions: <span id="legendContrib">â‚¬0</span></div>
                <div class="legend-item"><span class="dot interest"></span>Interest: <span id="legendInterest">â‚¬0</span></div>
              </div>
            </div>

            <div class="chart-box">
              <h4>ðŸ“ˆ Growth Over Time</h4>
              <div class="chart-container" style="height:300px"><canvas id="compoundChart"></canvas></div>
            </div>

            <div class="compound-table">
              <h4>ðŸ“‹ Year by Year Breakdown</h4>
              <div class="year-table" id="compoundTable"></div>
            </div>
          </div>
        </div>
      </div>
  </div>

  <!-- Merchants Page -->
  <div class="page" id="pageMerchants">
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:20px">
        <button class="btn btn-small btn-green" onclick="showAddMerchantModal()">+ Add Rule</button>
        <button class="btn btn-small btn-blue" onclick="applyMerchantRules()">ðŸ”„ Apply Rules</button>
      </div>

      <!-- Stats -->
      <div class="merchant-stats">
        <div class="merchant-stat">
          <div class="stat-value" id="statKnownMerchants">0</div>
          <div class="stat-label">Known Merchants</div>
        </div>
        <div class="merchant-stat">
          <div class="stat-value" id="statCustomRules">0</div>
          <div class="stat-label">Custom Rules</div>
        </div>
        <div class="merchant-stat">
          <div class="stat-value" id="statUnknownMerchants">0</div>
          <div class="stat-label">Uncategorized</div>
        </div>
      </div>

      <!-- Search & Filter -->
      <div class="merchant-filters">
        <input type="text" class="filter-input" id="merchantSearch" placeholder="ðŸ” Search merchants..." oninput="filterMerchants()">
        <select class="filter-input" id="merchantFilter" onchange="filterMerchants()">
          <option value="all">All Merchants</option>
          <option value="uncategorized">â“ Uncategorized Only</option>
          <option value="custom">âœï¸ Custom Rules Only</option>
          <option value="auto">ðŸ¤– Auto-detected Only</option>
        </select>
        <select class="filter-input" id="merchantCatFilter" onchange="filterMerchants()">
          <option value="all">All Categories</option>
        </select>
      </div>

      <!-- Unknown Merchants Alert -->
      <div class="unknown-alert hidden" id="unknownAlert">
        <div class="alert-icon">â“</div>
        <div class="alert-content">
          <strong>Uncategorized Merchants Found</strong>
          <p><span id="unknownCount">0</span> merchants need categorization</p>
        </div>
        <button class="btn btn-small btn-green" onclick="scrollToUnknown()">Review Now</button>
      </div>

      <!-- Merchant List -->
      <div class="merchant-list" id="merchantList"></div>
  </div>

  <!-- Imports Page -->
  <div class="page" id="pageImports">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".pdf" multiple>
        <div id="uploadContent"><div class="upload-icon">ðŸ“„</div><h3>Drop NLB statements here</h3><p>PDF files supported</p></div>
        <div id="uploadLoading" class="hidden"><div class="spinner"></div><p id="uploadStatus">Processing...</p></div>
      </div>

      <div class="import-stats">
        <div class="import-stat"><div class="import-stat-value" id="statFiles">0</div><div class="import-stat-label">Files</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statTxns">0</div><div class="import-stat-label">Transactions</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statActive">0</div><div class="import-stat-label">Active</div></div>
      </div>

      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <button class="btn btn-small btn-green" onclick="activateAll()">âœ“ Load All</button>
        <button class="btn btn-small btn-blue" onclick="deactivateAll()">â—‹ Unload All</button>
        <button class="btn btn-small btn-red" onclick="deleteAllImports()">ðŸ—‘ï¸ Delete All</button>
      </div>

      <div id="importsList"></div>
      <div id="noImports" class="empty-state"><div class="empty-icon">ðŸ“</div><h2>No imports</h2><p>Upload PDFs above</p></div>
  </div>

  <!-- Users Page (Admin) -->
  <div class="page" id="pageUsers">
      <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
        <button class="btn btn-small btn-green" onclick="showInviteModal()">+ Invite User</button>
      </div>

      <div class="import-stats">
        <div class="import-stat"><div class="import-stat-value" id="statUsers">0</div><div class="import-stat-label">Total Users</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statAdmins">0</div><div class="import-stat-label">Admins</div></div>
      </div>

      <div id="usersList"></div>
  </div>

  <!-- Stocks Page -->
  <div class="page" id="pageStocks">
      <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
        <button class="btn btn-small btn-green" onclick="showAddStockModal()">+ Add Stock</button>
      </div>

      <!-- Portfolio Summary -->
      <div class="cards" id="portfolioSummary">
        <div class="card"><div class="card-label">ðŸ’° Invested</div><div class="card-value blue" id="totalInvested">â‚¬0</div></div>
        <div class="card"><div class="card-label">ðŸ“Š Current Value</div><div class="card-value" id="totalValue">â‚¬0</div></div>
        <div class="card"><div class="card-label">ðŸ“ˆ Gain/Loss</div><div class="card-value" id="totalGain">â‚¬0</div><div class="card-sub" id="totalGainPct">0%</div></div>
        <div class="card"><div class="card-label">ðŸ† Holdings</div><div class="card-value yellow" id="holdingsCount">0</div></div>
      </div>

      <!-- Email Notifications -->
      <div class="chart-box">
        <h3>ðŸ“§ Daily Email Notifications</h3>
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="emailEnabled" onchange="toggleEmailNotifications()">
            <span>Enable daily portfolio summary</span>
          </label>
          <input type="email" class="search-box" id="notificationEmail" placeholder="Enter your email" style="width:250px">
          <button class="btn btn-small btn-green" onclick="saveEmailSettings()">Save</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-top:8px">You'll receive daily updates at 8:00 AM with your portfolio performance</p>
      </div>

      <!-- Stock List -->
      <div class="chart-box">
        <h3>ðŸ“‹ Your Holdings</h3>
        <div id="stocksList"></div>
        <div id="noStocks" class="empty-state"><div class="empty-icon">ðŸ“ˆ</div><h2>No stocks yet</h2><p>Add your first stock above</p></div>
      </div>

      <!-- Market Overview -->
      <div class="chart-box">
        <h3>ðŸŒ Market Overview</h3>
        <div id="marketOverview" class="cards"></div>
      </div>
  </div>

      </div><!-- end page-content -->
    </main><!-- end main-content -->
  </div><!-- end app-layout -->
</div><!-- end mainApp -->

<!-- Add Merchant Rule Modal -->
<div class="modal hidden" id="merchantModal">
  <div class="modal-box">
    <h2 id="merchantModalTitle">âž• Add Merchant Rule</h2>
    <p style="color:var(--muted);margin-bottom:16px">Create a rule to auto-categorize transactions</p>
    
    <div class="form-group" style="margin-bottom:16px">
      <label>Merchant Name Contains</label>
      <input type="text" class="note-input" id="merchantKeyword" placeholder="e.g., HOFER, SPAR, LIDL">
      <small class="input-hint">Transactions containing this text will be categorized</small>
    </div>
    
    <div class="form-group" style="margin-bottom:16px">
      <label>Assign Category</label>
      <div class="cat-grid-small" id="merchantCatGrid"></div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideMerchantModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveMerchantRule()">Save Rule</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal hidden" id="editModal">
  <div class="modal-box">
    <h2>Edit Transaction</h2>
    <p id="editDesc" style="color:var(--muted);margin-bottom:16px"></p>
    <label style="font-size:12px;color:var(--muted)">Note</label>
    <input type="text" class="note-input" id="editNote" placeholder="Add a note...">
    <label style="font-size:12px;color:var(--muted)">Category</label>
    <div class="cat-grid" id="catGrid"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideEditModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- Rules Modal -->
<div class="modal hidden" id="rulesModal">
  <div class="modal-box">
    <h2>ðŸ“‹ Category Rules</h2>
    <p style="color:var(--muted);margin-bottom:16px">Auto-categorize by description</p>
    <div id="rulesList"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="clearAllRules()">Clear All</button>
      <button class="btn btn-blue" onclick="hideRulesModal()">Close</button>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal hidden" id="inviteModal">
  <div class="modal-box">
    <h2>ðŸ‘¤ Invite User</h2>
    <p style="color:var(--muted);margin-bottom:16px">Create a new account</p>
    <input type="email" class="note-input" id="inviteEmail" placeholder="Email address">
    <input type="text" class="note-input" id="inviteName" placeholder="Name">
    <input type="password" class="note-input" id="invitePassword" placeholder="Temporary password (min 6 chars)">
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideInviteModal()">Cancel</button>
      <button class="btn btn-green" onclick="createUser()">Create User</button>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal hidden" id="stockModal">
  <div class="modal-box">
    <h2 id="stockModalTitle">ðŸ“ˆ Add Stock</h2>
    <p style="color:var(--muted);margin-bottom:16px">Enter your investment details</p>
    <input type="text" class="note-input" id="stockSymbol" placeholder="Symbol (e.g., AAPL, MSFT, GOOGL)" style="text-transform:uppercase">
    <input type="number" class="note-input" id="stockShares" placeholder="Number of shares" step="0.0001">
    <input type="number" class="note-input" id="stockPrice" placeholder="Purchase price per share (â‚¬)" step="0.01">
    <input type="date" class="note-input" id="stockDate">
    <input type="text" class="note-input" id="stockNotes" placeholder="Notes (optional)">
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideStockModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveStock()">Save</button>
    </div>
  </div>
</div>

<!-- Alerts Modal -->
<div class="modal hidden" id="alertsModal">
  <div class="modal-box" style="max-width:600px">
    <h2>ðŸ”” Smart Alerts</h2>
    <p style="color:var(--muted);margin-bottom:16px">Notifications about your spending</p>
    
    <div class="alert-settings">
      <h4 style="margin-bottom:12px">Alert Settings</h4>
      <label class="alert-setting">
        <input type="checkbox" id="alertLargeTxn" checked> Large transactions (over â‚¬<input type="number" class="inline-input" id="alertLargeAmount" value="100">)
      </label>
      <label class="alert-setting">
        <input type="checkbox" id="alertBudgetExceed" checked> Budget exceeded warnings
      </label>
      <label class="alert-setting">
        <input type="checkbox" id="alertUnusualSpending" checked> Unusual spending patterns
      </label>
      <label class="alert-setting">
        <input type="checkbox" id="alertRecurringDue" checked> Recurring payment reminders
      </label>
    </div>
    
    <h4 style="margin:20px 0 12px">Recent Alerts</h4>
    <div id="alertsList"></div>
    
    <div class="modal-actions">
      <button class="btn btn-blue" onclick="hideAlertsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Bulk Category Modal -->
<div class="modal hidden" id="bulkCatModal">
  <div class="modal-box">
    <h2>ðŸ“ Bulk Change Category</h2>
    <p style="color:var(--muted);margin-bottom:16px">Change category for <span id="bulkCount">0</span> selected transactions</p>
    <div class="cat-grid" id="bulkCatGrid"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideBulkCatModal()">Cancel</button>
      <button class="btn btn-green" onclick="applyBulkCategory()">Apply</button>
    </div>
  </div>
</div>

<!-- Customize Dashboard Modal -->
<div class="modal hidden" id="customizeModal">
  <div class="modal-box" style="max-width:600px">
    <h2>âš™ï¸ Customize Dashboard</h2>
    <p style="color:var(--muted);margin-bottom:20px">Show or hide widgets, change theme</p>
    
    <div class="customize-section">
      <h4>ðŸŽ¨ Theme</h4>
      <div class="theme-options">
        <div class="theme-opt" onclick="setTheme('dark')" id="themeDark">
          <div class="theme-preview dark"></div>
          <span>Dark</span>
        </div>
        <div class="theme-opt" onclick="setTheme('light')" id="themeLight">
          <div class="theme-preview light"></div>
          <span>Light</span>
        </div>
        <div class="theme-opt" onclick="setTheme('midnight')" id="themeMidnight">
          <div class="theme-preview midnight"></div>
          <span>Midnight</span>
        </div>
        <div class="theme-opt" onclick="setTheme('nature')" id="themeNature">
          <div class="theme-preview nature"></div>
          <span>Nature</span>
        </div>
      </div>
    </div>
    
    <div class="customize-section">
      <h4>ðŸ“Š Widgets</h4>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Toggle widgets on/off</p>
      <div class="widget-toggles" id="widgetToggles"></div>
    </div>
    
    <div class="customize-section">
      <h4>ðŸ“ Card Size</h4>
      <div class="size-options">
        <label><input type="radio" name="cardSize" value="small" onchange="setCardSize('small')"> Compact</label>
        <label><input type="radio" name="cardSize" value="medium" onchange="setCardSize('medium')" checked> Normal</label>
        <label><input type="radio" name="cardSize" value="large" onchange="setCardSize('large')"> Large</label>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-red" onclick="resetDashboardSettings()">Reset to Default</button>
      <button class="btn btn-green" onclick="hideCustomizeModal()">Done</button>
    </div>
  </div>
</div>

<!-- AI Chat Panel -->
<div class="ai-chat-panel hidden" id="aiChatPanel">
  <div class="ai-chat-header">
    <div class="ai-chat-title">
      <span class="ai-avatar">ðŸ¤–</span>
      <div>
        <h3>Financial Assistant</h3>
        <span class="ai-status">Ask me anything about your finances</span>
      </div>
    </div>
    <button class="ai-chat-close" onclick="toggleAIChat()">âœ•</button>
  </div>
  
  <div class="ai-chat-messages" id="aiChatMessages">
    <div class="ai-message bot">
      <div class="ai-message-avatar">ðŸ¤–</div>
      <div class="ai-message-content">
        <p>Hi! I'm your financial assistant. I can help you understand your spending patterns. Try asking:</p>
        <div class="ai-suggestions">
          <button onclick="askAI('How much did I spend this month?')">ðŸ’° Spending this month</button>
          <button onclick="askAI('What is my biggest expense category?')">ðŸ“Š Top category</button>
          <button onclick="askAI('Compare this month to last month')">ðŸ“ˆ Month comparison</button>
          <button onclick="askAI('How much did I spend on groceries?')">ðŸ›’ Groceries total</button>
          <button onclick="askAI('What are my recurring payments?')">ðŸ”„ Recurring bills</button>
          <button onclick="askAI('Give me a financial summary')">ðŸ“‹ Full summary</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="ai-chat-input">
    <input type="text" id="aiInput" placeholder="Ask about your finances..." onkeypress="if(event.key==='Enter')sendAIMessage()">
    <button onclick="sendAIMessage()">âž¤</button>
  </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAifLv-J1WahMz0DERGXJSt9qDF0z6F5oA",
  authDomain: "bank-app-b907a.firebaseapp.com",
  databaseURL: "https://bank-app-b907a-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bank-app-b907a",
  storageBucket: "bank-app-b907a.firebasestorage.app",
  messagingSenderId: "834229293620",
  appId: "1:834229293620:web:8ac5d5fdb4a0d635597061"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// State
let currentUser = null;
let imports = {};
let catOverrides = {};
let txnNotes = {};
let activeTxns = [];
let filteredTxns = [];
let selYear = 'all', selMonth = 'all', selCat = null, searchQ = '', showAll = false;
let editingTxn = null, selNewCat = null;
let pieChart = null, lineChart = null, barChart = null;
let isDark = false;
let isSignUp = false;
let isAdmin = false;
let allUsers = {};
let viewingUserId = null;
let stocks = {};
let stockPrices = {};
let editingStockId = null;
let emailSettings = { enabled: false, email: '' };

// Transactions page state
let txnPageData = [];
let txnCurrentPage = 1;
let txnPerPage = 25;
let selectedTxns = new Set();
let bulkSelectedCat = null;
let alerts = [];

// Dashboard customization state
let dashboardSettings = {
  theme: 'dark',
  layout: 'default',
  cardSize: 'medium',
  widgets: {
    insights: true, stats: true, sankey: true, treemap: true, radials: true,
    prediction: true, quickstats: true, race: true, charts: true, monthly: true,
    patterns: true, yoy: true, merchants: true, recurring: true, categories: true, transactions: true
  }
};
let raceInterval = null;
let aiChatOpen = false;
let debtChart = null;
let investChart = null;
let currentScenario = null;
let mortgageChart = null;
let compoundChart = null;

const $ = id => document.getElementById(id);
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const WDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const COLORS = ['#f87171','#fb923c','#fbbf24','#a3e635','#34d399','#22d3ee','#a78bfa'];
const CATS = {
  Groceries:{kw:['LIDL','HOFER','SPAR','MERCATOR','TUS','EUROSPIN','LECLERC','ALDI','BILLA','KAUFLAND','KONZUM','PLODINE','TOMMY','STUDENAC','INTERSPAR','MAXIMARKET','FRESH','MARKET'],c:'#10B981',i:'ðŸ›’'},
  Fuel:{kw:['MOL','PETROL','OMV','SHELL','BP ','INA ','LUKOIL','TOTAL','CIRCLE K','GAZPROM','REPSOL'],c:'#F59E0B',i:'â›½'},
  Restaurants:{kw:['MCDONALDS','MCDONALD','RESTAVRACIJA','PIZZA','GOSTILNA','SUSHI','BURGER','KFC','SUBWAY','STARBUCKS','COSTA COFFEE','CAFE','CAFFE','BAR ','BISTRO','KEBAB','WOLT','GLOVO','BOLT FOOD','FOODPANDA'],c:'#EC4899',i:'ðŸ”'},
  Travel:{kw:['BOOKING','HOTEL','AIRBNB','HOSTEL','RYANAIR','EASYJET','WIZZ','LUFTHANSA','EMIRATES','TURKISH','FLIXBUS','AIRWAYS','AIRLINES','EXPEDIA','TRIPADVISOR'],c:'#3B82F6',i:'âœˆï¸'},
  Shopping:{kw:['AMAZON','IKEA','MERKUR','BAUHAUS','OBI','HORNBACH','JYSK','PEPCO','ACTION','TEDi','KIKA','MOMAX','EMMEZETA','MEDIA MARKT','EURONICS','BIG BANG','HARVEY NORMAN'],c:'#8B5CF6',i:'ðŸ›ï¸'},
  Clothing:{kw:['ZARA','H&M','ABOUTYOU','C&A','MANGO','RESERVED','PULL&BEAR','BERSHKA','MASSIMO','STRADIVARIUS','NEW YORKER','TAKKO','KIK','DEICHMANN','HUMANIC','NIKE','ADIDAS','PUMA','ZALANDO','ASOS','SHEIN'],c:'#F97316',i:'ðŸ‘•'},
  Jewelry:{kw:['ZLATARNA','PANDORA','SWAROVSKI','APART','CHRIST','BIJOU'],c:'#FBBF24',i:'ðŸ’'},
  Sports:{kw:['INTERSPORT','DECATHLON','SPORTINA','HERVIS','FITNESS','GYM','TELOVADNICA','SPORT VISION','STADION','XXL SPORT'],c:'#22D3EE',i:'ðŸƒ'},
  Parties:{kw:['CLUB','DISCO','NIGHT','LOUNGE','COCKTAIL','PUB','KOKTAJL'],c:'#E879F9',i:'ðŸŽ‰'},
  Entertainment:{kw:['NETFLIX','SPOTIFY','STEAM','KINO','CINEMA','HBO','DISNEY','APPLE.COM','YOUTUBE','TWITCH','PLAYSTATION','XBOX','NINTENDO','CINESTAR','KOLOSEJ'],c:'#06B6D4',i:'ðŸŽ¬'},
  Transportation:{kw:['PSTOP','PARK','TAXI','UBER','BOLT','AVANT2GO','PREVOZI','LPP','TRAIN','VLAK','BUS','AVTOBUS','GORENC'],c:'#EF4444',i:'ðŸš—'},
  Transfers:{kw:['REVOLUT','FLIK','PAYPAL','WISE','WESTERN UNION','MONEYGRAM','PRENOS','TRANSFER'],c:'#6366F1',i:'ðŸ’¸'},
  Education:{kw:['UL EF','FAKULT','UNIV','UDEMY','COURSERA','SKILLSHARE','KNJIGARNA','MLADINSKA'],c:'#F472B6',i:'ðŸŽ“'},
  Health:{kw:['LEKARNA','APOTEKA','DOCTOR','ZDRAVNIK','ZOBOZDRAV','OPTIKA','DM ','MULLER','ROSSMANN','DOUGLAS'],c:'#84CC16',i:'ðŸ¥'},
  Services:{kw:['POSTA','TELEKOM','PROVIZIJA','A1 ','T-2','TELEMACH','ELEKTRO','KOMUNAL','VODOVOD','ZAVAROVAL'],c:'#64748B',i:'ðŸ“‹'},
  Income:{kw:['PLACA','REDNO DELO','VRACILO','SICOD','SALARY','STIPEND','REFUND'],c:'#22C55E',i:'ðŸ’°'},
  ATM:{kw:['BANKOMAT','ATM','DVIG','WITHDRAW'],c:'#A855F7',i:'ðŸ§'},
  Personal:{kw:[],c:'#14B8A6',i:'ðŸ‘¤'},
  Other:{kw:[],c:'#94A3B8',i:'ðŸ’³'}
};

// Custom merchant rules (user-defined, saved to Firebase)
let merchantRules = {};

// Helpers
function fmt(n) { return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n); }
function notify(msg, type='success') {
  const n = document.createElement('div');
  n.className = 'notif ' + type;
  n.innerHTML = `<span>${type==='success'?'âœ…':'âš ï¸'}</span><span>${msg}</span>`;
  $('notifBox').appendChild(n);
  setTimeout(() => n.remove(), 3000);
}
function categorize(desc) {
  // First check manual overrides (per-transaction)
  if (catOverrides[desc]) return catOverrides[desc];
  
  const u = desc.toUpperCase();
  
  // Then check custom merchant rules
  for (const [keyword, cat] of Object.entries(merchantRules)) {
    if (u.includes(keyword.toUpperCase())) return cat;
  }
  
  // Finally check built-in category keywords
  for (const [cat, cfg] of Object.entries(CATS)) {
    if (cat === 'Other') continue;
    if (cfg.kw.some(k => u.includes(k))) return cat;
  }
  return 'Other';
}

// Auth
auth.onAuthStateChanged(async user => {
  $('loading').classList.add('hidden');
  if (user) {
    currentUser = user;
    $('authScreen').classList.add('hidden');
    $('mainApp').classList.remove('hidden');
    
    // Update sidebar user info
    const displayName = user.displayName || 'User';
    $('sidebarUserName').textContent = displayName;
    $('sidebarUserEmail').textContent = user.email;
    
    // Check if admin
    const userSnap = await db.ref('users/' + user.uid).once('value');
    const userData = userSnap.val() || {};
    isAdmin = userData.role === 'admin';
    $('adminSection').classList.toggle('hidden', !isAdmin);
    
    if (isAdmin) {
      await loadAllUsers();
    }
    
    loadData();
  } else {
    $('authScreen').classList.remove('hidden');
    $('mainApp').classList.add('hidden');
  }
});

$('authToggle').onclick = () => {
  isSignUp = !isSignUp;
  $('authName').classList.toggle('hidden', !isSignUp);
  $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  $('authSubtitle').textContent = isSignUp ? 'Create your account' : 'Sign in to continue';
  $('authToggle').textContent = isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up";
  $('authError').style.display = 'none';
};

$('authBtn').onclick = async () => {
  const email = $('authEmail').value;
  const pass = $('authPassword').value;
  const name = $('authName').value;
  try {
    $('authBtn').textContent = 'Please wait...';
    if (isSignUp) {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      // First user becomes admin
      const usersSnap = await db.ref('users').once('value');
      const isFirstUser = !usersSnap.exists();
      await db.ref('users/' + cred.user.uid).set({ email, name, role: isFirstUser ? 'admin' : 'user', createdAt: Date.now() });
    } else {
      await auth.signInWithEmailAndPassword(email, pass);
    }
  } catch (e) {
    $('authError').textContent = e.message;
    $('authError').style.display = 'block';
    $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  }
};

function signOut() { 
  if ($('sidebarUserMenu')) $('sidebarUserMenu').classList.remove('show');
  auth.signOut(); 
}
function toggleUserMenu() { 
  // Legacy function - now using sidebar
  if ($('sidebarUserMenu')) $('sidebarUserMenu').classList.toggle('show');
}

// Data
async function loadData() {
  const snap = await db.ref('data/' + currentUser.uid).once('value');
  const data = snap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  stocks = data.stocks || {};
  merchantRules = data.merchantRules || {};
  emailSettings = data.emailSettings || { enabled: false, email: currentUser.email };
  renderImports();
  loadActiveTxns();
  loadStocks();
  setTimeout(generateAlerts, 500); // Generate alerts after data loads
}

async function saveData() {
  await db.ref('data/' + currentUser.uid).set({
    imports, overrides: catOverrides, notes: txnNotes, stocks, merchantRules, emailSettings, updatedAt: Date.now()
  });
}

// Pages
const PAGE_TITLES = {
  overview: { icon: 'ðŸ“Š', title: 'Overview' },
  transactions: { icon: 'ðŸ“', title: 'Transactions' },
  insights: { icon: 'ðŸ’¡', title: 'AI Insights & Suggestions' },
  tools: { icon: 'ðŸ§®', title: 'Financial Tools' },
  merchants: { icon: 'ðŸª', title: 'Merchants' },
  imports: { icon: 'ðŸ“', title: 'Imports' },
  stocks: { icon: 'ðŸ“ˆ', title: 'Stock Portfolio' },
  users: { icon: 'ðŸ‘¥', title: 'User Management' }
};

function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sidebar-item').forEach(t => t.classList.remove('active'));
  
  const pageEl = $('page' + page.charAt(0).toUpperCase() + page.slice(1));
  if (pageEl) pageEl.classList.add('active');
  
  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(item => {
    if (item.dataset.page === page) {
      item.classList.add('active');
    }
  });
  
  // Update top bar title
  const pageInfo = PAGE_TITLES[page] || { icon: 'ðŸ“„', title: 'Page' };
  $('pageIcon').textContent = pageInfo.icon;
  $('pageTitle').textContent = pageInfo.title;
  
  // Close sidebar on mobile
  if (window.innerWidth <= 900) {
    $('sidebar').classList.remove('open');
    $('sidebarOverlay').classList.remove('show');
  }
  
  if (page === 'users' && isAdmin) renderUsers();
  if (page === 'stocks') loadStocks();
  if (page === 'transactions') initTransactionsPage();
  if (page === 'tools') initToolsPage();
  if (page === 'merchants') renderMerchantsPage();
  if (page === 'insights') generateInsights();
}

function toggleSidebar() {
  $('sidebar').classList.toggle('open');
  $('sidebarOverlay').classList.toggle('show');
}

function toggleSidebarUserMenu() {
  $('sidebarUserMenu').classList.toggle('show');
}

// Theme
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  const themeBtn = $('themeBtn');
  if (themeBtn) themeBtn.textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
  render();
}

// Imports
function loadActiveTxns() {
  activeTxns = [];
  Object.values(imports).filter(i => i.active).forEach(imp => {
    (imp.txns || []).forEach(t => {
      const pd = new Date(t.parsedDate);
      const cat = catOverrides[t.description] || categorize(t.description);
      activeTxns.push({...t, parsedDate: pd, year: pd.getFullYear(), month: pd.getMonth(), weekday: pd.getDay(), category: cat});
    });
  });
  activeTxns.sort((a,b) => a.parsedDate - b.parsedDate);
  applyFilters();
}

function renderImports() {
  const keys = Object.keys(imports).sort((a,b) => (imports[b].importedAt||0) - (imports[a].importedAt||0));
  if ($('importsBadge2')) $('importsBadge2').textContent = keys.length;
  $('noImports').classList.toggle('hidden', keys.length > 0);
  
  const total = Object.values(imports).reduce((s,i) => s + (i.txns?.length||0), 0);
  const active = Object.values(imports).filter(i => i.active).length;
  $('statFiles').textContent = keys.length;
  $('statTxns').textContent = total;
  $('statActive').textContent = active;
  
  $('importsList').innerHTML = keys.map(id => {
    const imp = imports[id];
    const dates = (imp.txns||[]).map(t => new Date(t.parsedDate)).sort((a,b)=>a-b);
    const range = dates.length ? dates[0].toLocaleDateString('sl') + ' - ' + dates[dates.length-1].toLocaleDateString('sl') : '';
    return `<div class="import-card ${imp.active?'':'inactive'}">
      <div class="import-icon">ðŸ“„</div>
      <div class="import-info">
        <div class="import-name">${imp.filename}</div>
        <div class="import-meta">${imp.txns?.length||0} txns â€¢ ${range}</div>
      </div>
      <div class="import-toggle ${imp.active?'active':''}" onclick="toggleImport('${id}')"></div>
      <button class="btn btn-small btn-red" onclick="deleteImport('${id}')">ðŸ—‘ï¸</button>
    </div>`;
  }).join('');
}

async function toggleImport(id) {
  imports[id].active = !imports[id].active;
  await saveData();
  renderImports();
  loadActiveTxns();
  notify(imports[id].active ? 'Loaded' : 'Unloaded');
}

async function deleteImport(id) {
  if (!confirm('Delete this import?')) return;
  delete imports[id];
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('Deleted');
}

async function activateAll() {
  Object.keys(imports).forEach(id => imports[id].active = true);
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All loaded');
}

async function deactivateAll() {
  Object.keys(imports).forEach(id => imports[id].active = false);
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All unloaded');
}

async function deleteAllImports() {
  if (!confirm('Delete ALL imports?')) return;
  imports = {};
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All deleted');
}

// Upload
$('uploadZone').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => handleFiles(e.target.files);
$('uploadZone').ondragover = e => { e.preventDefault(); $('uploadZone').style.borderColor = 'var(--accent)'; };
$('uploadZone').ondragleave = () => $('uploadZone').style.borderColor = '';
$('uploadZone').ondrop = e => { e.preventDefault(); $('uploadZone').style.borderColor = ''; handleFiles(e.dataTransfer.files); };

async function handleFiles(files) {
  const pdfs = [...files].filter(f => f.name.endsWith('.pdf'));
  if (!pdfs.length) return;
  
  $('uploadContent').classList.add('hidden');
  $('uploadLoading').classList.remove('hidden');
  let total = 0;
  
  for (let i = 0; i < pdfs.length; i++) {
    const f = pdfs[i];
    if (Object.values(imports).some(imp => imp.filename === f.name)) {
      notify(f.name + ' already imported', 'warning');
      continue;
    }
    $('uploadStatus').textContent = `${i+1}/${pdfs.length}: ${f.name}`;
    
    try {
      const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
      let text = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      const txns = parseStatement(text);
      if (txns.length) {
        const id = 'imp_' + Date.now() + '_' + i;
        imports[id] = { filename: f.name, importedAt: Date.now(), txns, active: true };
        total += txns.length;
      }
    } catch (e) {
      notify('Error: ' + f.name, 'warning');
    }
  }
  
  await saveData();
  renderImports();
  loadActiveTxns();
  if (total) notify(`Imported ${total} transactions`);
  
  $('uploadContent').classList.remove('hidden');
  $('uploadLoading').classList.add('hidden');
}

function parseStatement(txt) {
  const txns = [];
  const dateRegex = /(\d{2}\.\d{2}\.\d{2})/g;
  const matches = [...txt.matchAll(dateRegex)];
  
  for (let i = 0; i < matches.length; i++) {
    const seg = txt.substring(matches[i].index, matches[i+1]?.index || txt.length);
    if (/STANJE|SKUPNI|Datum izpiska/i.test(seg)) continue;
    
    const amtMatch = seg.match(/([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g);
    if (amtMatch && amtMatch.length >= 2) {
      const amtStr = amtMatch[amtMatch.length-2];
      const balStr = amtMatch[amtMatch.length-1];
      let amt = parseFloat(amtStr.replace(/\./g,'').replace(',','.'));
      const bal = parseFloat(balStr.replace(/\./g,'').replace(',','.'));
      const desc = seg.slice(8, seg.indexOf(amtMatch[0])).trim().replace(/^[\.,]\s*/,'');
      if (!desc || desc.length < 2) continue;
      
      const isInc = amtStr.startsWith('+') || /PLACA|REDNO DELO|VRACILO/i.test(desc);
      if (!amtStr.startsWith('+') && !amtStr.startsWith('-') && !isInc) amt = -Math.abs(amt);
      
      const dateParts = matches[i][1].split('.');
      const pd = new Date(2000 + parseInt(dateParts[2]), parseInt(dateParts[1])-1, parseInt(dateParts[0]));
      if (isNaN(pd.getTime())) continue;
      
      txns.push({
        id: matches[i][1] + '_' + txns.length + '_' + Math.random().toString(36).slice(2,8),
        date: matches[i][1],
        parsedDate: pd.toISOString(),
        description: desc,
        amount: amt,
        balance: bal,
        category: categorize(desc)
      });
    }
  }
  return txns;
}

// Filters
function applyFilters() {
  selYear = $('yearFilter')?.value || 'all';
  searchQ = $('searchBox')?.value?.toLowerCase() || '';
  
  filteredTxns = activeTxns.filter(t => {
    if (selYear !== 'all' && t.year !== parseInt(selYear)) return false;
    if (selMonth !== 'all' && t.month !== parseInt(selMonth)) return false;
    if (selCat && t.category !== selCat) return false;
    if (searchQ && !t.description.toLowerCase().includes(searchQ)) return false;
    return true;
  });
  showAll = false;
  render();
}

function resetFilters() {
  selYear = 'all'; selMonth = 'all'; selCat = null; searchQ = '';
  if ($('yearFilter')) $('yearFilter').value = 'all';
  if ($('searchBox')) $('searchBox').value = '';
  applyFilters();
}

function selectMonth(m) {
  selMonth = selMonth === m ? 'all' : m;
  applyFilters();
}

function filterByCat(c) {
  selCat = selCat === c ? null : c;
  applyFilters();
}

function toggleShowAll() {
  showAll = !showAll;
  renderTxns();
}

// Render
function render() {
  if (!activeTxns.length) {
    $('emptyState').classList.remove('hidden');
    $('dashboard').classList.add('hidden');
    return;
  }
  $('emptyState').classList.add('hidden');
  $('dashboard').classList.remove('hidden');
  
  // Apply saved settings
  loadDashboardSettings();
  
  // Filters
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  $('yearFilter').innerHTML = '<option value="all">All Years</option>' + years.map(y => `<option value="${y}" ${selYear==y?'selected':''}>${y}</option>`).join('');
  $('monthPills').innerHTML = `<div class="month-pill ${selMonth==='all'?'active':''}" onclick="selectMonth('all')">All</div>` + MONTHS.map((m,i) => `<div class="month-pill ${selMonth===i?'active':''}" onclick="selectMonth(${i})">${m}</div>`).join('');
  
  // Stats
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const net = income - expenses;
  const sr = income > 0 ? (net / income) * 100 : 0;
  const days = filteredTxns.length > 1 ? Math.max(1, Math.ceil((filteredTxns[filteredTxns.length-1].parsedDate - filteredTxns[0].parsedDate) / 864e5)) : 1;
  
  // Animated counter update
  animateCounter('totalIncome', income);
  animateCounter('totalExpenses', expenses);
  animateCounter('netBalance', net);
  
  $('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
  $('incomeCount').textContent = filteredTxns.filter(t => t.amount > 0).length + ' txns';
  $('expenseCount').textContent = filteredTxns.filter(t => t.amount < 0).length + ' txns';
  $('savingsRate').textContent = sr.toFixed(1) + '%';
  $('savingsGauge').style.width = Math.min(100, Math.max(0, sr)) + '%';
  $('savingsGauge').className = 'savings-fill ' + (sr >= 20 ? 'good' : sr >= 10 ? 'ok' : 'bad');
  $('txnCount').textContent = filteredTxns.length;
  $('avgDaily').textContent = fmt(expenses/days) + '/day';
  $('dateRange').textContent = filteredTxns.length ? filteredTxns[0].date + ' - ' + filteredTxns[filteredTxns.length-1].date : '-';
  
  // New visualizations
  renderRadialProgress(sr, expenses);
  renderSankeyChart();
  renderTreemap();
  
  // Existing renders
  renderInsights(income, expenses, sr);
  renderPrediction(income, expenses);
  renderComparison();
  renderQuickStats(expenses, days);
  
  renderYoY();
  renderHeatmap();
  renderWeekday();
  renderRecurring();
  renderMerchants();
  renderCategories();
  renderTopExpenses();
  renderCharts();
  renderTxns();
  
  // Trigger animations
  setTimeout(() => {
    document.querySelectorAll('.animate-in').forEach((el, i) => {
      el.style.animationDelay = (i * 0.05) + 's';
    });
  }, 100);
}

// Animated Counter
function animateCounter(id, target) {
  const el = $(id);
  const duration = 1000;
  const start = parseFloat(el.dataset.current) || 0;
  const startTime = performance.now();
  
  el.dataset.current = target;
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3); // ease out cubic
    const current = start + (target - start) * eased;
    el.textContent = fmt(current);
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// Radial Progress Charts
function renderRadialProgress(savingsRate, totalExpenses) {
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const daysPassed = now.getDate();
  const monthProgress = (daysPassed / daysInMonth) * 100;
  
  // Assume budget is 2x average monthly expense (can be customized later)
  const avgMonthlyExpense = totalExpenses / Math.max(1, filteredTxns.length > 30 ? Math.ceil(filteredTxns.length / 30) : 1);
  const budgetUsed = Math.min(100, (totalExpenses / (avgMonthlyExpense * 1.2)) * 100) || 0;
  
  // Update radials with animation
  updateRadial('budgetRadialFill', 'budgetRadialText', budgetUsed, budgetUsed > 80 ? 'var(--red)' : budgetUsed > 60 ? '#fbbf24' : 'var(--accent)');
  updateRadial('savingsRadialFill', 'savingsRadialText', Math.max(0, savingsRate), savingsRate >= 20 ? 'var(--green)' : savingsRate >= 10 ? '#fbbf24' : 'var(--red)');
  updateRadial('monthRadialFill', 'monthRadialText', monthProgress, '#a78bfa');
}

function updateRadial(fillId, textId, percentage, color) {
  const circumference = 283; // 2 * PI * 45
  const offset = circumference - (percentage / 100) * circumference;
  const fill = $(fillId);
  const text = $(textId);
  
  if (fill) {
    fill.style.stroke = color;
    setTimeout(() => { fill.style.strokeDashoffset = offset; }, 100);
  }
  if (text) text.textContent = Math.round(percentage) + '%';
}

// Sankey Diagram
function renderSankeyChart() {
  const container = $('sankeyChart');
  if (!container || !filteredTxns.length) return;
  container.innerHTML = '';
  
  const width = container.offsetWidth;
  const height = 350;
  
  // Build nodes and links
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  
  const nodes = [{ name: 'Income' }, { name: 'Available' }];
  const links = [{ source: 0, target: 1, value: income }];
  
  // Add category nodes
  Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 8).forEach(([cat, val], i) => {
    nodes.push({ name: cat, color: CATS[cat]?.c || '#94a3b8' });
    links.push({ source: 1, target: i + 2, value: val });
  });
  
  // Savings node if positive
  const savings = income - Object.values(categories).reduce((s, v) => s + v, 0);
  if (savings > 0) {
    nodes.push({ name: 'Savings', color: '#22c55e' });
    links.push({ source: 1, target: nodes.length - 1, value: savings });
  }
  
  const svg = d3.select(container)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(12)
    .extent([[20, 20], [width - 20, height - 20]]);
  
  const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
    nodes: nodes.map(d => Object.assign({}, d)),
    links: links.map(d => Object.assign({}, d))
  });
  
  // Draw links
  svg.append('g')
    .selectAll('path')
    .data(sankeyLinks)
    .join('path')
    .attr('class', 'link')
    .attr('d', d3.sankeyLinkHorizontal())
    .attr('stroke', d => d.target.color || 'var(--accent)')
    .attr('stroke-width', d => Math.max(2, d.width))
    .append('title')
    .text(d => `${d.source.name} â†’ ${d.target.name}: ${fmt(d.value)}`);
  
  // Draw nodes
  const node = svg.append('g')
    .selectAll('g')
    .data(sankeyNodes)
    .join('g')
    .attr('class', 'node');
  
  node.append('rect')
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('height', d => d.y1 - d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('fill', d => d.color || 'var(--accent)')
    .attr('rx', 4);
  
  node.append('text')
    .attr('x', d => d.x0 < width / 2 ? d.x1 + 8 : d.x0 - 8)
    .attr('y', d => (d.y1 + d.y0) / 2)
    .attr('dy', '0.35em')
    .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
    .text(d => `${d.name} ${fmt(d.value || 0)}`);
}

// Treemap
function renderTreemap() {
  const container = $('treemapChart');
  if (!container || !filteredTxns.length) return;
  container.innerHTML = '';
  
  const width = container.offsetWidth;
  const height = 300;
  
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  
  const data = {
    name: 'Spending',
    children: Object.entries(categories).map(([name, value]) => ({
      name, value, color: CATS[name]?.c || '#94a3b8', icon: CATS[name]?.i || 'ðŸ’³'
    }))
  };
  
  const root = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value);
  d3.treemap().size([width, height]).padding(3)(root);
  
  const svg = d3.select(container)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  const cell = svg.selectAll('g')
    .data(root.leaves())
    .join('g')
    .attr('transform', d => `translate(${d.x0},${d.y0})`);
  
  cell.append('rect')
    .attr('class', 'treemap-cell')
    .attr('width', d => d.x1 - d.x0)
    .attr('height', d => d.y1 - d.y0)
    .attr('fill', d => d.data.color)
    .attr('rx', 4)
    .style('cursor', 'pointer')
    .on('click', (e, d) => filterByCat(d.data.name));
  
  cell.filter(d => (d.x1 - d.x0) > 50 && (d.y1 - d.y0) > 35)
    .append('text')
    .attr('class', 'treemap-label')
    .attr('x', 8)
    .attr('y', 20)
    .text(d => `${d.data.icon} ${d.data.name}`);
  
  cell.filter(d => (d.x1 - d.x0) > 50 && (d.y1 - d.y0) > 50)
    .append('text')
    .attr('class', 'treemap-value')
    .attr('x', 8)
    .attr('y', 36)
    .text(d => fmt(d.data.value));
}

// Spending Race Animation
let raceData = [];
function prepareRaceData() {
  const months = {};
  activeTxns.filter(t => t.amount < 0).forEach(t => {
    const key = t.year + '-' + String(t.month + 1).padStart(2, '0');
    if (!months[key]) months[key] = {};
    months[key][t.category] = (months[key][t.category] || 0) + Math.abs(t.amount);
  });
  raceData = Object.entries(months).sort((a, b) => a[0].localeCompare(b[0]));
}

function playSpendingRace() {
  if (raceInterval) {
    clearInterval(raceInterval);
    raceInterval = null;
    $('racePlayBtn').textContent = 'â–¶ Play';
    return;
  }
  
  prepareRaceData();
  if (!raceData.length) return;
  
  $('racePlayBtn').textContent = 'â¸ Pause';
  let idx = 0;
  
  function showMonth() {
    if (idx >= raceData.length) {
      clearInterval(raceInterval);
      raceInterval = null;
      $('racePlayBtn').textContent = 'â–¶ Play';
      return;
    }
    
    const [month, cats] = raceData[idx];
    const sorted = Object.entries(cats).sort((a, b) => b[1] - a[1]).slice(0, 6);
    const max = sorted[0]?.[1] || 1;
    
    $('raceMonth').textContent = MONTHS[parseInt(month.split('-')[1]) - 1] + ' ' + month.split('-')[0];
    $('raceChart').innerHTML = sorted.map(([cat, val]) => {
      const pct = (val / max) * 100;
      const cfg = CATS[cat] || CATS.Other;
      return `<div class="race-bar"><div class="race-bar-inner" style="width:${pct}%;background:${cfg.c}"><span class="race-bar-label">${cfg.i} ${cat}</span><span class="race-bar-value">${fmt(val)}</span></div></div>`;
    }).join('');
    
    idx++;
  }
  
  showMonth();
  raceInterval = setInterval(showMonth, 1200);
}

// Smart Insights
function renderInsights(income, expenses, savingsRate) {
  const insights = [];
  const now = new Date();
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const lastMonth = activeTxns.filter(t => {
    const lm = new Date(now.getFullYear(), now.getMonth() - 1);
    return t.parsedDate.getMonth() === lm.getMonth() && t.parsedDate.getFullYear() === lm.getFullYear();
  });
  
  const thisExp = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const lastExp = Math.abs(lastMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  
  // Spending comparison
  if (lastExp > 0) {
    const change = ((thisExp - lastExp) / lastExp * 100);
    if (change > 20) {
      insights.push({ icon: 'âš ï¸', title: 'Spending Alert', desc: `You've spent ${change.toFixed(0)}% more than last month`, type: 'warning' });
    } else if (change < -10) {
      insights.push({ icon: 'ðŸŽ‰', title: 'Great Job!', desc: `You've reduced spending by ${Math.abs(change).toFixed(0)}% vs last month`, type: 'success' });
    }
  }
  
  // Savings rate
  if (savingsRate >= 30) {
    insights.push({ icon: 'ðŸ†', title: 'Excellent Saver!', desc: `${savingsRate.toFixed(0)}% savings rate - you're crushing it!`, type: 'success' });
  } else if (savingsRate < 10 && savingsRate >= 0) {
    insights.push({ icon: 'ðŸ’¡', title: 'Savings Tip', desc: `Try to save at least 20% of your income`, type: 'warning' });
  }
  
  // Top spending category
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const topCat = Object.entries(cats).sort((a,b) => b[1] - a[1])[0];
  if (topCat) {
    const pct = (topCat[1] / expenses * 100).toFixed(0);
    insights.push({ icon: CATS[topCat[0]]?.i || 'ðŸ’³', title: `${topCat[0]} is your top expense`, desc: `${pct}% of total spending (${fmt(topCat[1])})`, type: '' });
  }
  
  // Large recent transaction
  const recent = filteredTxns.slice(-10).filter(t => t.amount < -500);
  if (recent.length) {
    const big = recent.sort((a,b) => a.amount - b.amount)[0];
    insights.push({ icon: 'ðŸ’¸', title: 'Large Transaction', desc: `${big.description.slice(0,25)} - ${fmt(big.amount)}`, type: 'warning' });
  }
  
  // Fill with defaults if needed
  while (insights.length < 3) {
    if (insights.length === 0) insights.push({ icon: 'ðŸ“Š', title: 'Track Your Spending', desc: 'Import more statements for better insights', type: '' });
    else if (insights.length === 1) insights.push({ icon: 'ðŸ’°', title: `${filteredTxns.length} Transactions`, desc: `Across ${Object.keys(cats).length} categories`, type: '' });
    else insights.push({ icon: 'ðŸ“…', title: 'Keep Going!', desc: 'The more data, the better insights', type: '' });
  }
  
  insights.slice(0, 3).forEach((ins, i) => {
    $('insight' + (i+1)).className = 'insight-card ' + ins.type;
    $('insight' + (i+1)).innerHTML = `<div class="insight-icon">${ins.icon}</div><div class="insight-text"><div class="insight-title">${ins.title}</div><div class="insight-desc">${ins.desc}</div></div>`;
  });
}

// Predicted Balance
function renderPrediction(income, expenses) {
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const daysPassed = now.getDate();
  const daysRemaining = daysInMonth - daysPassed;
  
  // Get current balance from latest transaction
  const currentBal = filteredTxns.length ? filteredTxns[filteredTxns.length - 1].balance : 0;
  
  // Calculate daily averages from this month's data
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const monthIncome = thisMonth.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const monthExpenses = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  
  const avgDailyIncome = daysPassed > 0 ? monthIncome / daysPassed : 0;
  const avgDailyExpense = daysPassed > 0 ? monthExpenses / daysPassed : 0;
  
  const expectedIncome = avgDailyIncome * daysRemaining;
  const projectedSpending = avgDailyExpense * daysRemaining;
  const predictedBalance = currentBal + expectedIncome - projectedSpending;
  
  $('currentBal').textContent = fmt(currentBal);
  $('expectedIncome').textContent = '+' + fmt(expectedIncome);
  $('projectedSpending').textContent = '-' + fmt(projectedSpending);
  $('daysRemaining').textContent = daysRemaining + ' days';
  $('predictedBalance').textContent = fmt(predictedBalance);
  $('predictedBalance').style.color = predictedBalance >= currentBal ? 'var(--green)' : 'var(--red)';
  $('predictionNote').textContent = predictedBalance >= currentBal ? 'ðŸ“ˆ Looking good!' : 'ðŸ“‰ Consider reducing spending';
}

// Month Comparison
function renderComparison() {
  const now = new Date();
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const lastMonth = activeTxns.filter(t => {
    const lm = new Date(now.getFullYear(), now.getMonth() - 1);
    return t.parsedDate.getMonth() === lm.getMonth() && t.parsedDate.getFullYear() === lm.getFullYear();
  });
  
  const thisInc = thisMonth.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const lastInc = lastMonth.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const thisExp = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const lastExp = Math.abs(lastMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  
  $('compIncomeThis').textContent = fmt(thisInc);
  $('compIncomeLast').textContent = fmt(lastInc);
  $('compExpenseThis').textContent = fmt(thisExp);
  $('compExpenseLast').textContent = fmt(lastExp);
  
  const incChange = lastInc > 0 ? ((thisInc - lastInc) / lastInc * 100) : 0;
  const expChange = lastExp > 0 ? ((thisExp - lastExp) / lastExp * 100) : 0;
  
  $('compIncomeChange').innerHTML = incChange !== 0 ? `<span class="${incChange > 0 ? 'green' : 'red'}">${incChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(incChange).toFixed(1)}%</span>` : '';
  $('compExpenseChange').innerHTML = expChange !== 0 ? `<span class="${expChange < 0 ? 'green' : 'red'}">${expChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(expChange).toFixed(1)}%</span>` : '';
  
  // Top category comparison
  const getCatTop = (txns) => {
    const cats = {};
    txns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
    const top = Object.entries(cats).sort((a,b) => b[1] - a[1])[0];
    return top ? `${CATS[top[0]]?.i || 'ðŸ’³'} ${top[0]}` : '-';
  };
  $('biggestCatThis').textContent = getCatTop(thisMonth);
  $('biggestCatLast').textContent = getCatTop(lastMonth);
}

// Quick Stats
function renderQuickStats(expenses, days) {
  $('avgDailySpend').textContent = fmt(expenses / days);
  
  // Best and worst days
  const dailySpend = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const d = t.parsedDate.toISOString().split('T')[0];
    dailySpend[d] = (dailySpend[d] || 0) + Math.abs(t.amount);
  });
  
  const sorted = Object.entries(dailySpend).sort((a,b) => a[1] - b[1]);
  if (sorted.length) {
    const best = sorted[0];
    const worst = sorted[sorted.length - 1];
    const bestDate = new Date(best[0]);
    const worstDate = new Date(worst[0]);
    $('bestDay').textContent = WDAYS[bestDate.getDay()] + ' ' + fmt(best[1]);
    $('worstDay').textContent = WDAYS[worstDate.getDay()] + ' ' + fmt(worst[1]);
  }
  
  // Subscription estimate (recurring payments)
  const recurring = detectRecurring();
  const monthlyTotal = recurring.filter(r => r.pat === 'Monthly').reduce((s,r) => s + r.a, 0);
  $('subscriptionTotal').textContent = fmt(monthlyTotal) + '/mo';
}

function detectRecurring() {
  const g = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const m = t.description.split(/\s+/).slice(0,2).join(' ').toUpperCase();
    const a = Math.abs(t.amount).toFixed(2);
    const k = m + '|' + a;
    if (!g[k]) g[k] = { m, a: Math.abs(t.amount), dates: [] };
    g[k].dates.push(t.parsedDate);
  });
  
  const r = [];
  for (const gr of Object.values(g)) {
    if (gr.dates.length >= 2) {
      gr.dates.sort((a,b) => a-b);
      const diffs = [];
      for (let i = 1; i < gr.dates.length; i++) diffs.push((gr.dates[i] - gr.dates[i-1]) / 864e5);
      const avg = diffs.reduce((a,b) => a+b, 0) / diffs.length;
      if (avg >= 25 && avg <= 35) r.push({ ...gr, pat: 'Monthly' });
      else if (avg >= 5 && avg <= 9) r.push({ ...gr, pat: 'Weekly' });
    }
  }
  return r;
}

function renderYoY() {
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  if (years.length < 2) { $('yoyBox').classList.add('hidden'); return; }
  $('yoyBox').classList.remove('hidden');
  const y1 = years[years.length-2], y2 = years[years.length-1];
  $('yoyYears').textContent = y1 + ' vs ' + y2;
  
  const t1 = activeTxns.filter(t => t.year === y1), t2 = activeTxns.filter(t => t.year === y2);
  const inc1 = t1.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const inc2 = t2.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const exp1 = Math.abs(t1.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  const exp2 = Math.abs(t2.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  
  const pct = (a,b) => b > 0 ? ((a-b)/b*100).toFixed(1) : '0';
  $('yoyGrid').innerHTML = `
    <div class="yoy-item"><div class="yoy-label">ðŸ’° Income</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(inc1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(inc2)}</div></div></div><div class="yoy-change ${inc2>inc1?'down':'up'}">${inc2>inc1?'â†‘':'â†“'} ${Math.abs(pct(inc2,inc1))}%</div></div>
    <div class="yoy-item"><div class="yoy-label">ðŸ’¸ Expenses</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(exp1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(exp2)}</div></div></div><div class="yoy-change ${exp2>exp1?'up':'down'}">${exp2>exp1?'â†‘':'â†“'} ${Math.abs(pct(exp2,exp1))}%</div></div>
  `;
}

function renderHeatmap() {
  const ds = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const k = t.parsedDate.toISOString().split('T')[0];
    ds[k] = (ds[k]||0) + Math.abs(t.amount);
  });
  const vals = Object.values(ds), max = Math.max(...vals, 1);
  const th = [0, max*.2, max*.4, max*.6, max*.8];
  
  if (!filteredTxns.length) { $('heatmap').innerHTML = '<div style="color:var(--muted)">No data</div>'; return; }
  
  const start = new Date(filteredTxns[0].parsedDate);
  const end = new Date(filteredTxns[filteredTxns.length-1].parsedDate);
  start.setDate(start.getDate() - start.getDay());
  
  const weeks = [];
  let cur = new Date(start);
  while (cur <= end) {
    const wk = [];
    for (let d = 0; d < 7; d++) {
      const k = cur.toISOString().split('T')[0];
      const v = ds[k] || 0;
      let lv = 0;
      for (let i = th.length-1; i >= 0; i--) if (v >= th[i]) { lv = i; break; }
      wk.push({ k, v, lv });
      cur.setDate(cur.getDate() + 1);
    }
    weeks.push(wk);
  }
  
  $('heatmap').innerHTML = weeks.map(wk => '<div class="heatmap-week">' + wk.map(d => `<div class="heatmap-cell ${d.lv?'l'+d.lv:''}" title="${d.k}: ${fmt(d.v)}"></div>`).join('') + '</div>').join('');
}

function renderWeekday() {
  const w = [0,0,0,0,0,0,0];
  filteredTxns.filter(t => t.amount < 0).forEach(t => w[t.weekday] += Math.abs(t.amount));
  const max = Math.max(...w, 1);
  $('weekdayBars').innerHTML = WDAYS.map((d,i) => `<div class="weekday-bar"><div class="weekday-value">${fmt(w[i])}</div><div class="weekday-fill" style="height:${(w[i]/max)*100}%;background:${COLORS[i]}"></div><div class="weekday-label">${d}</div></div>`).join('');
}

function renderRecurring() {
  const r = detectRecurring();
  $('recurringCount').textContent = r.length;
  $('recurringList').innerHTML = r.length ? r.sort((a,b) => b.a - a.a).slice(0,5).map(x => `<div class="list-item"><div class="list-icon" style="background:rgba(99,102,241,0.2)">ðŸ”„</div><div class="list-info"><div class="list-title">${x.m}</div><div class="list-sub">${x.pat} â€¢ ${x.dates.length}Ã—</div></div><div class="list-value blue">${fmt(-x.a)}</div></div>`).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">None found</div>';
}

function renderMerchants() {
  const m = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const n = t.description.split(/\s+/).slice(0,2).join(' ').toUpperCase();
    if (!m[n]) m[n] = { n, tot: 0, cnt: 0 };
    m[n].tot += Math.abs(t.amount);
    m[n].cnt++;
  });
  const list = Object.values(m);
  const byAmt = [...list].sort((a,b) => b.tot - a.tot).slice(0,6);
  const byFreq = [...list].sort((a,b) => b.cnt - a.cnt).slice(0,6);
  
  $('merchantsAmt').innerHTML = byAmt.map((x,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${x.n}</div><div class="list-sub">${x.cnt} visits</div></div><div class="list-value red">${fmt(-x.tot)}</div></div>`).join('');
  $('merchantsFreq').innerHTML = byFreq.map((x,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${x.n}</div><div class="list-sub">${fmt(-x.tot)}</div></div><div class="list-value blue">${x.cnt}Ã—</div></div>`).join('');
}

function renderCategories() {
  const cats = {};
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  $('categoryList').innerHTML = sorted.map(([cat, amt]) => {
    const cfg = CATS[cat] || CATS.Other;
    const pct = expenses > 0 ? (amt/expenses*100).toFixed(1) : 0;
    return `<div class="list-item" style="cursor:pointer" onclick="filterByCat('${cat}')"><div class="list-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="list-info"><div class="list-title">${cat}</div><div style="height:4px;background:var(--border);border-radius:2px;margin-top:4px"><div style="height:100%;width:${pct}%;background:${cfg.c};border-radius:2px"></div></div></div><div style="text-align:right"><div class="list-value red">${fmt(-amt)}</div><div class="list-sub">${pct}%</div></div></div>`;
  }).join('');
}

function renderTopExpenses() {
  const top = filteredTxns.filter(t => t.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10);
  $('topExpenses').innerHTML = top.map((t,i) => {
    const cfg = CATS[t.category] || CATS.Other;
    const note = txnNotes[t.description];
    return `<div class="list-item" style="cursor:pointer" onclick="editTxn('${t.id}')"><div class="rank" style="${i<3?'background:linear-gradient(135deg,#f59e0b,#f97316);color:#000':''}">${i+1}</div><div class="list-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="list-info"><div class="list-title">${t.description}${note?' ðŸ“':''}</div><div class="list-sub">${t.date} â€¢ ${t.category}</div></div><div class="list-value red">${fmt(t.amount)}</div></div>`;
  }).join('');
}

function renderCharts() {
  const tc = isDark ? '#94a3b8' : '#64748b';
  const gc = isDark ? '#334155' : '#e2e8f0';
  
  // Pie
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  if (pieChart) pieChart.destroy();
  if (sorted.length) {
    pieChart = new Chart($('pieChart'), {
      type: 'doughnut',
      data: { labels: sorted.map(([c]) => c), datasets: [{ data: sorted.map(([,v]) => v), backgroundColor: sorted.map(([c]) => (CATS[c]||CATS.Other).c), borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false } } }
    });
  }
  
  // Line
  const balances = [];
  filteredTxns.forEach(t => {
    const ex = balances.find(b => b.date === t.date);
    if (ex) ex.bal = t.balance;
    else balances.push({ date: t.date, bal: t.balance });
  });
  
  if (lineChart) lineChart.destroy();
  if (balances.length) {
    lineChart = new Chart($('lineChart'), {
      type: 'line',
      data: { labels: balances.map(b => b.date), datasets: [{ data: balances.map(b => b.bal), borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.3, pointRadius: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gc }, ticks: { color: tc, maxTicksLimit: 6 } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0)+'k' } } } }
    });
  }
  
  // Bar
  const monthly = {};
  activeTxns.forEach(t => {
    const k = t.year + '-' + String(t.month+1).padStart(2,'0');
    if (!monthly[k]) monthly[k] = { inc: 0, exp: 0 };
    if (t.amount > 0) monthly[k].inc += t.amount;
    else monthly[k].exp += Math.abs(t.amount);
  });
  const mKeys = Object.keys(monthly).sort();
  
  if (barChart) barChart.destroy();
  if (mKeys.length) {
    barChart = new Chart($('barChart'), {
      type: 'bar',
      data: { labels: mKeys.map(k => MONTHS[parseInt(k.split('-')[1])-1] + ' ' + k.split('-')[0].slice(2)), datasets: [{ label: 'Income', data: mKeys.map(k => monthly[k].inc), backgroundColor: '#22c55e' }, { label: 'Expenses', data: mKeys.map(k => monthly[k].exp), backgroundColor: '#fb7185' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: tc } } }, scales: { x: { grid: { display: false }, ticks: { color: tc } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0)+'k' } } } }
    });
  }
}

function renderTxns() {
  const list = showAll ? filteredTxns.slice().reverse() : filteredTxns.slice(-15).reverse();
  $('txnTitle').textContent = selCat || 'Transactions';
  
  $('txnList').innerHTML = list.map(t => {
    const cfg = CATS[t.category] || CATS.Other;
    const pos = t.amount > 0;
    const note = txnNotes[t.description];
    return `<div class="txn-item" onclick="editTxn('${t.id}')"><div class="txn-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="txn-details"><div class="txn-desc">${t.description}${note?' ðŸ“':''}</div><div class="txn-meta">${t.date} â€¢ ${WDAYS[t.weekday]}<span class="txn-cat" style="background:${cfg.c}30;color:${cfg.c}">${t.category}</span></div></div><div class="txn-amount"><div class="txn-amt ${pos?'green':'red'}">${pos?'+':''}${fmt(t.amount)}</div><div class="txn-bal">Bal: ${fmt(t.balance)}</div></div></div>`;
  }).join('');
  
  $('showMoreBtn').textContent = showAll ? 'â–² Show less' : `â–¼ Show all ${filteredTxns.length}`;
  $('showMoreBtn').classList.toggle('hidden', filteredTxns.length <= 15);
}

// Edit Transaction
function editTxn(id) {
  const t = activeTxns.find(x => x.id === id);
  if (!t) return;
  editingTxn = t;
  selNewCat = t.category;
  $('editDesc').textContent = t.description;
  $('editNote').value = txnNotes[t.description] || '';
  renderCatGrid();
  $('editModal').classList.remove('hidden');
}

function renderCatGrid() {
  const grid = $('catGrid');
  grid.innerHTML = Object.entries(CATS).map(([name, cfg]) => 
    `<div class="cat-opt ${selNewCat===name?'selected':''}" data-cat="${name}">
      <div class="cat-opt-icon">${cfg.i}</div>
      <div class="cat-opt-name">${name}</div>
    </div>`
  ).join('');
  
  // Add click handlers
  grid.querySelectorAll('.cat-opt').forEach(el => {
    el.onclick = () => {
      selNewCat = el.dataset.cat;
      renderCatGrid();
    };
  });
}

function hideEditModal() { $('editModal').classList.add('hidden'); editingTxn = null; }

async function saveEdit() {
  if (!editingTxn) return;
  catOverrides[editingTxn.description] = selNewCat;
  const note = $('editNote').value.trim();
  if (note) txnNotes[editingTxn.description] = note;
  else delete txnNotes[editingTxn.description];
  await saveData();
  loadActiveTxns();
  hideEditModal();
  notify('Saved');
}

// Rules
function showRulesModal() {
  $('rulesList').innerHTML = Object.entries(catOverrides).length ? Object.entries(catOverrides).map(([desc, cat]) => {
    const cfg = CATS[cat] || CATS.Other;
    return `<div class="list-item"><div class="list-info"><div class="list-title">${desc.slice(0,30)}${desc.length>30?'...':''}</div></div><div style="display:flex;align-items:center;gap:8px"><span>${cfg.i} ${cat}</span><span style="color:var(--red);cursor:pointer" onclick="deleteRule('${desc.replace(/'/g,"\\'")}')">Ã—</span></div></div>`;
  }).join('') : '<div style="text-align:center;padding:20px;color:var(--muted)">No rules yet</div>';
  $('rulesModal').classList.remove('hidden');
}

function hideRulesModal() { $('rulesModal').classList.add('hidden'); }

async function deleteRule(desc) {
  delete catOverrides[desc];
  await saveData();
  loadActiveTxns();
  showRulesModal();
  notify('Rule deleted');
}

async function clearAllRules() {
  if (!confirm('Clear all rules?')) return;
  catOverrides = {};
  await saveData();
  loadActiveTxns();
  showRulesModal();
  notify('All rules cleared');
}

// Export
function exportCSV() {
  const rows = [['Date','Day','Description','Amount','Balance','Category','Note']];
  filteredTxns.forEach(t => rows.push([t.date, WDAYS[t.weekday], `"${t.description}"`, t.amount.toFixed(2), t.balance.toFixed(2), t.category, `"${txnNotes[t.description]||''}"`]));
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bank-export-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  notify('Exported CSV');
}

// Close dropdowns on outside click
document.onclick = e => {
  if (!e.target.closest('.sidebar-user') && !e.target.closest('.sidebar-user-menu')) {
    const menu = $('sidebarUserMenu');
    if (menu) menu.classList.remove('show');
  }
};

// ==================== TRANSACTIONS PAGE ====================

function initTransactionsPage() {
  // Populate category filter
  $('txnCategory').innerHTML = '<option value="all">All Categories</option>' + 
    Object.entries(CATS).map(([name, cfg]) => `<option value="${name}">${cfg.i} ${name}</option>`).join('');
  
  applyTxnFilters();
  generateAlerts();
}

function applyTxnFilters() {
  const dateFrom = $('dateFrom')?.value;
  const dateTo = $('dateTo')?.value;
  const amountMin = parseFloat($('amountMin')?.value) || null;
  const amountMax = parseFloat($('amountMax')?.value) || null;
  const type = $('txnType')?.value || 'all';
  const category = $('txnCategory')?.value || 'all';
  const search = $('txnSearch')?.value?.toLowerCase() || '';
  const sort = $('txnSort')?.value || 'date-desc';
  
  txnPageData = activeTxns.filter(t => {
    if (dateFrom && t.parsedDate < new Date(dateFrom)) return false;
    if (dateTo && t.parsedDate > new Date(dateTo + 'T23:59:59')) return false;
    if (amountMin !== null && Math.abs(t.amount) < amountMin) return false;
    if (amountMax !== null && Math.abs(t.amount) > amountMax) return false;
    if (type === 'expense' && t.amount >= 0) return false;
    if (type === 'income' && t.amount < 0) return false;
    if (category !== 'all' && t.category !== category) return false;
    if (search && !t.description.toLowerCase().includes(search)) return false;
    return true;
  });
  
  // Sort
  txnPageData.sort((a, b) => {
    switch (sort) {
      case 'date-asc': return a.parsedDate - b.parsedDate;
      case 'date-desc': return b.parsedDate - a.parsedDate;
      case 'amount-asc': return a.amount - b.amount;
      case 'amount-desc': return b.amount - a.amount;
      case 'category': return a.category.localeCompare(b.category);
      default: return b.parsedDate - a.parsedDate;
    }
  });
  
  txnCurrentPage = 1;
  renderTxnTable();
  updateTxnSummary();
}

function clearTxnFilters() {
  $('dateFrom').value = '';
  $('dateTo').value = '';
  $('amountMin').value = '';
  $('amountMax').value = '';
  $('txnType').value = 'all';
  $('txnCategory').value = 'all';
  $('txnSearch').value = '';
  $('txnSort').value = 'date-desc';
  selectedTxns.clear();
  applyTxnFilters();
}

function renderTxnTable() {
  const start = (txnCurrentPage - 1) * txnPerPage;
  const end = start + txnPerPage;
  const pageData = txnPageData.slice(start, end);
  
  $('txnPageCount').textContent = txnPageData.length + ' transactions';
  
  $('txnTableBody').innerHTML = pageData.map(t => {
    const cfg = CATS[t.category] || CATS.Other;
    const isSelected = selectedTxns.has(t.id);
    return `<div class="txn-table-row ${isSelected ? 'selected' : ''}" data-id="${t.id}">
      <div class="txn-col-check"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTxnSelect('${t.id}')"></div>
      <div class="txn-col-date">${t.date}<br><span style="font-size:10px;color:var(--muted)">${WDAYS[t.weekday]}</span></div>
      <div class="txn-col-desc" title="${t.description}">${t.description}${txnNotes[t.description] ? ' ðŸ“' : ''}</div>
      <div class="txn-col-cat"><span style="background:${cfg.c}20;color:${cfg.c}">${cfg.i} ${t.category}</span></div>
      <div class="txn-col-amount ${t.amount >= 0 ? 'green' : 'red'}">${t.amount >= 0 ? '+' : ''}${fmt(t.amount)}</div>
      <div class="txn-col-balance">${fmt(t.balance)}</div>
      <div class="txn-col-actions"><button class="btn btn-small btn-blue" onclick="editTxn('${t.id}')" style="padding:4px 8px">âœï¸</button></div>
    </div>`;
  }).join('');
  
  renderPagination();
  updateSelectionBar();
}

function renderPagination() {
  const totalPages = Math.ceil(txnPageData.length / txnPerPage);
  if (totalPages <= 1) {
    $('pagination').innerHTML = '';
    return;
  }
  
  let html = `<button class="page-btn" onclick="goToPage(${txnCurrentPage - 1})" ${txnCurrentPage === 1 ? 'disabled' : ''}>â€¹</button>`;
  
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= txnCurrentPage - 2 && i <= txnCurrentPage + 2)) {
      html += `<button class="page-btn ${i === txnCurrentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    } else if (i === txnCurrentPage - 3 || i === txnCurrentPage + 3) {
      html += `<span style="color:var(--muted)">...</span>`;
    }
  }
  
  html += `<button class="page-btn" onclick="goToPage(${txnCurrentPage + 1})" ${txnCurrentPage === totalPages ? 'disabled' : ''}>â€º</button>`;
  $('pagination').innerHTML = html;
}

function goToPage(page) {
  const totalPages = Math.ceil(txnPageData.length / txnPerPage);
  if (page < 1 || page > totalPages) return;
  txnCurrentPage = page;
  renderTxnTable();
  $('pageTransactions').scrollTo({ top: 0, behavior: 'smooth' });
}

function updateTxnSummary() {
  const income = txnPageData.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const expenses = Math.abs(txnPageData.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const net = income - expenses;
  
  $('filteredIncome').textContent = fmt(income);
  $('filteredExpenses').textContent = fmt(expenses);
  $('filteredNet').textContent = fmt(net);
  $('filteredNet').className = 'summary-value ' + (net >= 0 ? 'green' : 'red');
}

// Selection
function toggleTxnSelect(id) {
  if (selectedTxns.has(id)) {
    selectedTxns.delete(id);
  } else {
    selectedTxns.add(id);
  }
  renderTxnTable();
}

function toggleSelectAll() {
  const allChecked = $('selectAll').checked;
  const start = (txnCurrentPage - 1) * txnPerPage;
  const end = start + txnPerPage;
  const pageData = txnPageData.slice(start, end);
  
  if (allChecked) {
    pageData.forEach(t => selectedTxns.add(t.id));
  } else {
    pageData.forEach(t => selectedTxns.delete(t.id));
  }
  renderTxnTable();
}

function clearSelection() {
  selectedTxns.clear();
  renderTxnTable();
}

function updateSelectionBar() {
  const count = selectedTxns.size;
  $('selectionBar').classList.toggle('hidden', count === 0);
  $('selectedCount').textContent = count + ' selected';
}

// Bulk operations
function bulkChangeCategory() {
  if (selectedTxns.size === 0) return;
  bulkSelectedCat = null;
  $('bulkCount').textContent = selectedTxns.size;
  $('bulkCatGrid').innerHTML = Object.entries(CATS).map(([name, cfg]) => 
    `<div class="cat-opt" onclick="selectBulkCat('${name}')" id="bulkCat_${name}"><div class="cat-opt-icon">${cfg.i}</div><div class="cat-opt-name">${name}</div></div>`
  ).join('');
  $('bulkCatModal').classList.remove('hidden');
}

function selectBulkCat(cat) {
  bulkSelectedCat = cat;
  document.querySelectorAll('#bulkCatGrid .cat-opt').forEach(el => el.classList.remove('selected'));
  $('bulkCat_' + cat).classList.add('selected');
}

function hideBulkCatModal() {
  $('bulkCatModal').classList.add('hidden');
}

async function applyBulkCategory() {
  if (!bulkSelectedCat || selectedTxns.size === 0) return;
  
  selectedTxns.forEach(id => {
    const txn = activeTxns.find(t => t.id === id);
    if (txn) {
      catOverrides[txn.description] = bulkSelectedCat;
    }
  });
  
  await saveData();
  loadActiveTxns();
  selectedTxns.clear();
  hideBulkCatModal();
  applyTxnFilters();
  notify(`Changed ${selectedTxns.size} transactions to ${bulkSelectedCat}`);
}

function bulkCategorize() {
  if (selectedTxns.size === 0) {
    notify('Select transactions first', 'warning');
    return;
  }
  bulkChangeCategory();
}

// ==================== SMART ALERTS ====================

function generateAlerts() {
  alerts = [];
  const now = new Date();
  const largeThreshold = parseFloat($('alertLargeAmount')?.value) || 100;
  
  // Large transactions in last 7 days
  const recentLarge = activeTxns.filter(t => {
    const daysDiff = (now - t.parsedDate) / 864e5;
    return daysDiff <= 7 && t.amount < -largeThreshold;
  });
  
  recentLarge.forEach(t => {
    alerts.push({
      type: 'warning',
      icon: 'ðŸ’¸',
      title: 'Large Transaction',
      desc: `${t.description.slice(0, 30)} - ${fmt(t.amount)}`,
      time: t.date
    });
  });
  
  // Unusual spending (compare this week to average)
  const thisWeek = activeTxns.filter(t => (now - t.parsedDate) / 864e5 <= 7 && t.amount < 0);
  const thisWeekTotal = Math.abs(thisWeek.reduce((s, t) => s + t.amount, 0));
  
  const allWeeks = {};
  activeTxns.filter(t => t.amount < 0).forEach(t => {
    const weekNum = Math.floor((now - t.parsedDate) / (7 * 864e5));
    if (weekNum > 0 && weekNum <= 8) {
      allWeeks[weekNum] = (allWeeks[weekNum] || 0) + Math.abs(t.amount);
    }
  });
  
  const avgWeekly = Object.values(allWeeks).length > 0 
    ? Object.values(allWeeks).reduce((a, b) => a + b, 0) / Object.values(allWeeks).length 
    : 0;
  
  if (avgWeekly > 0 && thisWeekTotal > avgWeekly * 1.5) {
    alerts.push({
      type: 'danger',
      icon: 'âš ï¸',
      title: 'Unusual Spending',
      desc: `This week: ${fmt(thisWeekTotal)} (${((thisWeekTotal / avgWeekly - 1) * 100).toFixed(0)}% above average)`,
      time: 'This week'
    });
  }
  
  // Low balance warning
  const lastBal = activeTxns.length ? activeTxns[activeTxns.length - 1].balance : 0;
  if (lastBal < 500 && lastBal > 0) {
    alerts.push({
      type: 'danger',
      icon: 'ðŸ”´',
      title: 'Low Balance',
      desc: `Current balance: ${fmt(lastBal)}`,
      time: 'Now'
    });
  }
  
  // Good savings rate
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const monthIncome = thisMonth.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const monthExpenses = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const savingsRate = monthIncome > 0 ? ((monthIncome - monthExpenses) / monthIncome * 100) : 0;
  
  if (savingsRate >= 30) {
    alerts.push({
      type: 'success',
      icon: 'ðŸ†',
      title: 'Great Savings!',
      desc: `${savingsRate.toFixed(0)}% savings rate this month`,
      time: 'This month'
    });
  }
  
  // Recurring payment reminder
  const recurring = detectRecurring();
  const today = now.getDate();
  recurring.forEach(r => {
    r.dates.sort((a, b) => b - a);
    const lastDate = r.dates[0];
    const dayOfMonth = lastDate.getDate();
    if (Math.abs(dayOfMonth - today) <= 3) {
      alerts.push({
        type: 'info',
        icon: 'ðŸ”„',
        title: 'Recurring Payment Due',
        desc: `${r.m} - ${fmt(r.a)} (usually around ${dayOfMonth}th)`,
        time: 'Soon'
      });
    }
  });
  
  // Update alert dot
  const hasImportant = alerts.some(a => a.type === 'danger' || a.type === 'warning');
  $('alertDot').classList.toggle('hidden', !hasImportant);
}

function showAlertsModal() {
  generateAlerts();
  
  $('alertsList').innerHTML = alerts.length ? alerts.map(a => `
    <div class="alert-item ${a.type}">
      <div class="alert-icon">${a.icon}</div>
      <div class="alert-content">
        <div class="alert-title">${a.title}</div>
        <div class="alert-desc">${a.desc}</div>
      </div>
      <div class="alert-time">${a.time}</div>
    </div>
  `).join('') : '<div style="text-align:center;padding:20px;color:var(--muted)">No alerts - you\'re doing great! ðŸŽ‰</div>';
  
  $('alertsModal').classList.remove('hidden');
}

function hideAlertsModal() {
  $('alertsModal').classList.add('hidden');
}

// ==================== FINANCIAL TOOLS ====================

function initToolsPage() {
  calculateDebt();
  calculateInvestment();
  calculateMortgage();
  compareLoan();
  calculateEmergency();
  calculateCompound();
  initWhatIf();
}

function switchToolTab(tab) {
  document.querySelectorAll('.tool-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tool-panel').forEach(p => p.classList.add('hidden'));
  event.target.classList.add('active');
  $('tool' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
}

// ========== DEBT PAYOFF CALCULATOR ==========

function setDebtExtra(amount) {
  $('debtExtraPayment').value = amount;
  calculateDebt();
}

function calculateDebt() {
  const principal = parseFloat($('debtAmount').value) || 0;
  const apr = parseFloat($('debtInterest').value) || 0;
  const minPayment = parseFloat($('debtMinPayment').value) || 0;
  const extraPayment = parseFloat($('debtExtraPayment').value) || 0;
  
  const monthlyRate = apr / 100 / 12;
  const totalPayment = minPayment + extraPayment;
  
  if (principal <= 0 || totalPayment <= 0) return;
  
  // Calculate with minimum payment only
  let balanceMin = principal;
  let monthsMin = 0;
  let interestMin = 0;
  const dataMin = [{ month: 0, balance: principal }];
  
  while (balanceMin > 0 && monthsMin < 600) {
    const interest = balanceMin * monthlyRate;
    interestMin += interest;
    balanceMin = Math.max(0, balanceMin + interest - minPayment);
    monthsMin++;
    dataMin.push({ month: monthsMin, balance: balanceMin });
  }
  
  // Calculate with extra payment
  let balance = principal;
  let months = 0;
  let totalInterest = 0;
  const data = [{ month: 0, balance: principal }];
  
  while (balance > 0 && months < 600) {
    const interest = balance * monthlyRate;
    totalInterest += interest;
    balance = Math.max(0, balance + interest - totalPayment);
    months++;
    data.push({ month: months, balance });
  }
  
  const totalPaid = principal + totalInterest;
  const payoffDate = new Date();
  payoffDate.setMonth(payoffDate.getMonth() + months);
  
  // Update UI
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;
  $('debtPayoffTime').textContent = years > 0 ? `${years}y ${remainingMonths}m` : `${months} months`;
  $('debtPayoffDate').textContent = `Debt-free by ${payoffDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
  $('debtTotalInterest').textContent = fmt(totalInterest);
  $('debtTotalPaid').textContent = fmt(totalPaid);
  
  // Show savings if extra payment
  if (extraPayment > 0) {
    const interestSaved = interestMin - totalInterest;
    const monthsSaved = monthsMin - months;
    $('debtSavingsCard').classList.remove('hidden');
    $('debtSavings').textContent = fmt(interestSaved) + ' in interest';
    $('debtTimeSaved').textContent = `${monthsSaved} months faster!`;
  } else {
    $('debtSavingsCard').classList.add('hidden');
  }
  
  // Draw chart
  renderDebtChart(data, dataMin, extraPayment > 0);
}

function renderDebtChart(data, dataMin, showComparison) {
  const ctx = $('debtChart').getContext('2d');
  if (debtChart) debtChart.destroy();
  
  const datasets = [{
    label: 'With Extra Payment',
    data: data.map(d => ({ x: d.month, y: d.balance })),
    borderColor: '#22d3ee',
    backgroundColor: 'rgba(34,211,238,0.1)',
    fill: true,
    tension: 0.3
  }];
  
  if (showComparison) {
    datasets.push({
      label: 'Minimum Only',
      data: dataMin.map(d => ({ x: d.month, y: d.balance })),
      borderColor: '#fb7185',
      backgroundColor: 'rgba(251,113,133,0.1)',
      fill: true,
      tension: 0.3,
      borderDash: [5, 5]
    });
  }
  
  debtChart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: showComparison, labels: { color: '#94a3b8' } } },
      scales: {
        x: { type: 'linear', title: { display: true, text: 'Months', color: '#94a3b8' }, ticks: { color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.1)' } },
        y: { title: { display: true, text: 'Balance (â‚¬)', color: '#94a3b8' }, ticks: { color: '#64748b', callback: v => 'â‚¬' + v.toLocaleString() }, grid: { color: 'rgba(148,163,184,0.1)' } }
      }
    }
  });
}

// ========== INVESTMENT GROWTH CALCULATOR ==========

function setInvestReturn(rate) {
  $('investReturn').value = rate;
  calculateInvestment();
}

function calculateInvestment() {
  const initial = parseFloat($('investInitial').value) || 0;
  const monthly = parseFloat($('investMonthly').value) || 0;
  const annualReturn = parseFloat($('investReturn').value) || 0;
  const years = parseInt($('investYears').value) || 0;
  
  const monthlyRate = annualReturn / 100 / 12;
  const months = years * 12;
  
  let balance = initial;
  let totalContributions = initial;
  const data = [{ month: 0, balance: initial, contributions: initial }];
  const milestones = [];
  
  for (let m = 1; m <= months; m++) {
    balance = balance * (1 + monthlyRate) + monthly;
    totalContributions += monthly;
    
    if (m % 12 === 0) {
      data.push({ month: m, balance, contributions: totalContributions });
    }
    
    // Check milestones
    if (balance >= 100000 && !milestones.find(x => x.amount === 100000)) {
      milestones.push({ amount: 100000, months: m });
    }
    if (balance >= 250000 && !milestones.find(x => x.amount === 250000)) {
      milestones.push({ amount: 250000, months: m });
    }
    if (balance >= 500000 && !milestones.find(x => x.amount === 500000)) {
      milestones.push({ amount: 500000, months: m });
    }
    if (balance >= 1000000 && !milestones.find(x => x.amount === 1000000)) {
      milestones.push({ amount: 1000000, months: m });
    }
  }
  
  const interestEarned = balance - totalContributions;
  const contribPercent = (totalContributions / balance * 100) || 0;
  const interestPercent = (interestEarned / balance * 100) || 0;
  
  // Update UI
  $('investFutureValue').textContent = fmt(balance);
  $('investYearsLabel').textContent = `in ${years} years`;
  $('investContributions').textContent = fmt(totalContributions);
  $('investInterestEarned').textContent = fmt(interestEarned);
  
  $('compoundContrib').style.width = contribPercent + '%';
  $('compoundInterest').style.width = interestPercent + '%';
  
  // Milestones
  $('investMilestones').innerHTML = milestones.length ? `
    <h4>ðŸ† Milestones</h4>
    ${milestones.map(m => {
      const y = Math.floor(m.months / 12);
      const mo = m.months % 12;
      return `<div class="milestone-item"><span><span class="milestone-icon">ðŸŽ¯</span>${fmt(m.amount)}</span><span>${y > 0 ? y + 'y ' : ''}${mo}m</span></div>`;
    }).join('')}
  ` : '';
  
  // Draw chart
  renderInvestChart(data);
}

function renderInvestChart(data) {
  const ctx = $('investChart').getContext('2d');
  if (investChart) investChart.destroy();
  
  investChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => `Year ${d.month / 12}`),
      datasets: [
        {
          label: 'Total Value',
          data: data.map(d => d.balance),
          borderColor: '#34d399',
          backgroundColor: 'rgba(52,211,153,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Contributions',
          data: data.map(d => d.contributions),
          borderColor: '#22d3ee',
          backgroundColor: 'rgba(34,211,238,0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#94a3b8' } } },
      scales: {
        x: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.1)' } },
        y: { ticks: { color: '#64748b', callback: v => 'â‚¬' + (v/1000).toFixed(0) + 'k' }, grid: { color: 'rgba(148,163,184,0.1)' } }
      }
    }
  });
}

// ========== MORTGAGE CALCULATOR ==========

function setMortgageTerm(years) {
  $('mortgageTerm').value = years;
  document.querySelectorAll('#toolMortgage .term-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  calculateMortgage();
}

function calculateMortgage() {
  const price = parseFloat($('mortgagePrice').value) || 0;
  const down = parseFloat($('mortgageDown').value) || 0;
  const rate = parseFloat($('mortgageRate').value) || 0;
  const years = parseInt($('mortgageTerm').value) || 20;
  const extra = parseFloat($('mortgageExtra').value) || 0;
  
  const principal = price - down;
  const monthlyRate = rate / 100 / 12;
  const numPayments = years * 12;
  
  // Update down payment percentage
  const downPercent = price > 0 ? (down / price * 100).toFixed(0) : 0;
  $('mortgageDownPercent').textContent = downPercent + '% down';
  
  // Calculate monthly payment (P&I)
  const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
  
  // Calculate with and without extra payments
  let balance = principal;
  let totalInterest = 0;
  let months = 0;
  const data = [];
  const dataNoExtra = [];
  
  // With extra payment
  let balanceExtra = principal;
  let totalInterestExtra = 0;
  let monthsExtra = 0;
  
  while (balanceExtra > 0 && monthsExtra < numPayments + 240) {
    const interest = balanceExtra * monthlyRate;
    totalInterestExtra += interest;
    const principalPaid = Math.min(balanceExtra, monthlyPayment + extra - interest);
    balanceExtra = Math.max(0, balanceExtra - principalPaid);
    monthsExtra++;
    if (monthsExtra % 12 === 0 || balanceExtra === 0) {
      data.push({ year: monthsExtra / 12, balance: balanceExtra, interest: totalInterestExtra });
    }
  }
  
  // Without extra (minimum only)
  while (balance > 0 && months < numPayments) {
    const interest = balance * monthlyRate;
    totalInterest += interest;
    const principalPaid = monthlyPayment - interest;
    balance = Math.max(0, balance - principalPaid);
    months++;
    if (months % 12 === 0 || balance === 0) {
      dataNoExtra.push({ year: months / 12, balance, interest: totalInterest });
    }
  }
  
  const totalCost = price + (extra > 0 ? totalInterestExtra : totalInterest);
  const payoffDate = new Date();
  payoffDate.setMonth(payoffDate.getMonth() + (extra > 0 ? monthsExtra : months));
  
  // Update UI
  $('mortgagePayment').textContent = fmt(monthlyPayment + extra);
  $('mortgageLoan').textContent = fmt(principal);
  $('mortgageTotalInterest').textContent = fmt(extra > 0 ? totalInterestExtra : totalInterest);
  $('mortgageTotalCost').textContent = fmt(totalCost);
  $('mortgagePayoffDate').textContent = payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  
  // Show savings if extra payment
  if (extra > 0) {
    const interestSaved = totalInterest - totalInterestExtra;
    const monthsSaved = months - monthsExtra;
    $('mortgageSavingsCard').style.display = 'flex';
    $('mortgageSavings').textContent = fmt(interestSaved) + ' saved';
    $('mortgageTimeSaved').textContent = Math.floor(monthsSaved / 12) + ' years ' + (monthsSaved % 12) + ' months faster!';
  } else {
    $('mortgageSavingsCard').style.display = 'none';
  }
  
  // Amortization table (first 5 years + last year)
  let amortHtml = '<div class="amort-row header"><span>Year</span><span>Payment</span><span>Principal</span><span>Interest</span><span>Balance</span></div>';
  const amortData = extra > 0 ? data : dataNoExtra;
  const showYears = amortData.slice(0, 5).concat(amortData.length > 6 ? [amortData[amortData.length - 1]] : []);
  
  let prevInterest = 0;
  showYears.forEach((d, i) => {
    const yearInterest = d.interest - prevInterest;
    const yearPayment = (monthlyPayment + extra) * 12;
    const yearPrincipal = yearPayment - yearInterest;
    prevInterest = d.interest;
    amortHtml += `<div class="amort-row"><span>Year ${Math.round(d.year)}</span><span>${fmt(yearPayment)}</span><span>${fmt(yearPrincipal)}</span><span>${fmt(yearInterest)}</span><span>${fmt(d.balance)}</span></div>`;
  });
  $('amortTable').innerHTML = amortHtml;
  
  // Render chart
  renderMortgageChart(data, dataNoExtra, extra > 0);
}

function renderMortgageChart(dataExtra, dataMin, showComparison) {
  const ctx = $('mortgageChart').getContext('2d');
  if (mortgageChart) mortgageChart.destroy();
  
  const datasets = [{
    label: showComparison ? 'With Extra Payment' : 'Balance',
    data: dataExtra.map(d => ({ x: d.year, y: d.balance })),
    borderColor: '#22d3ee',
    backgroundColor: 'rgba(34,211,238,0.1)',
    fill: true,
    tension: 0.3
  }];
  
  if (showComparison) {
    datasets.push({
      label: 'Minimum Only',
      data: dataMin.map(d => ({ x: d.year, y: d.balance })),
      borderColor: '#fb7185',
      borderDash: [5, 5],
      backgroundColor: 'transparent',
      tension: 0.3
    });
  }
  
  mortgageChart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: showComparison, labels: { color: '#94a3b8' } } },
      scales: {
        x: { type: 'linear', title: { display: true, text: 'Years', color: '#94a3b8' }, ticks: { color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.1)' } },
        y: { title: { display: true, text: 'Balance (â‚¬)', color: '#94a3b8' }, ticks: { color: '#64748b', callback: v => 'â‚¬' + (v/1000).toFixed(0) + 'k' }, grid: { color: 'rgba(148,163,184,0.1)' } }
      }
    }
  });
}

// ========== LOAN COMPARISON ==========

function compareLoan() {
  const loans = ['A', 'B', 'C'].map(id => {
    const amount = parseFloat($(`loan${id}_amount`).value) || 0;
    const rate = parseFloat($(`loan${id}_rate`).value) || 0;
    const term = parseInt($(`loan${id}_term`).value) || 0;
    const fees = parseFloat($(`loan${id}_fees`).value) || 0;
    
    if (amount <= 0 || term <= 0) return null;
    
    const monthlyRate = rate / 100 / 12;
    const monthlyPayment = monthlyRate > 0 
      ? amount * (monthlyRate * Math.pow(1 + monthlyRate, term)) / (Math.pow(1 + monthlyRate, term) - 1)
      : amount / term;
    
    const totalPaid = monthlyPayment * term;
    const totalInterest = totalPaid - amount;
    const totalCost = totalPaid + fees;
    
    return { id, amount, rate, term, fees, monthlyPayment, totalInterest, totalCost };
  }).filter(Boolean);
  
  // Find winner (lowest total cost)
  let winner = null;
  let lowestCost = Infinity;
  
  loans.forEach(loan => {
    if (loan.totalCost < lowestCost) {
      lowestCost = loan.totalCost;
      winner = loan.id;
    }
    
    // Update results
    $(`loan${loan.id}_results`).innerHTML = `
      <div class="loan-result-row"><span class="label">Monthly Payment</span><span class="value">${fmt(loan.monthlyPayment)}</span></div>
      <div class="loan-result-row"><span class="label">Total Interest</span><span class="value red">${fmt(loan.totalInterest)}</span></div>
      <div class="loan-result-row"><span class="label">Total Cost</span><span class="value" style="font-size:16px">${fmt(loan.totalCost)}</span></div>
    `;
  });
  
  // Highlight winner
  document.querySelectorAll('.loan-card').forEach(c => c.classList.remove('winner'));
  if (winner && loans.length > 1) {
    document.querySelectorAll('.loan-card')[['A','B','C'].indexOf(winner)].classList.add('winner');
    
    const winnerLoan = loans.find(l => l.id === winner);
    const savings = loans.filter(l => l.id !== winner).map(l => l.totalCost - winnerLoan.totalCost);
    const maxSavings = Math.max(...savings);
    
    $('loanWinner').innerHTML = `
      <h4>ðŸ† Loan ${winner} is the Best Deal!</h4>
      <p>You save up to <strong style="color:var(--green)">${fmt(maxSavings)}</strong> compared to other options</p>
    `;
    $('loanWinner').style.display = 'block';
  } else {
    $('loanWinner').style.display = 'none';
  }
}

// ========== EMERGENCY FUND CALCULATOR ==========

function setEmergencyTarget(months) {
  $('emergencyTarget').value = months;
  document.querySelectorAll('#toolEmergency .term-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  calculateEmergency();
}

function calculateEmergency() {
  // Auto-calculate from user's data
  const monthlyData = {};
  activeTxns.filter(t => t.amount < 0).forEach(t => {
    const key = t.year + '-' + t.month;
    monthlyData[key] = (monthlyData[key] || 0) + Math.abs(t.amount);
  });
  const avgMonthlyExp = Object.values(monthlyData).length > 0
    ? Object.values(monthlyData).reduce((a, b) => a + b, 0) / Object.values(monthlyData).length
    : 2000;
  
  $('emergencyMonthlyExp').textContent = fmt(avgMonthlyExp);
  if (!$('emergencyExpenses').dataset.userSet) {
    $('emergencyExpenses').value = Math.round(avgMonthlyExp);
  }
  
  const monthlyExpenses = parseFloat($('emergencyExpenses').value) || avgMonthlyExp;
  const currentSavings = parseFloat($('emergencyCurrent').value) || 0;
  const monthlyContrib = parseFloat($('emergencyContribution').value) || 0;
  const targetMonths = parseInt($('emergencyTarget').value) || 6;
  
  const targetAmount = monthlyExpenses * targetMonths;
  const needed = Math.max(0, targetAmount - currentSavings);
  const percentFunded = Math.min(100, (currentSavings / targetAmount) * 100);
  
  // Time to fully funded
  let monthsToGoal = 0;
  if (needed > 0 && monthlyContrib > 0) {
    monthsToGoal = Math.ceil(needed / monthlyContrib);
  }
  
  const goalDate = new Date();
  goalDate.setMonth(goalDate.getMonth() + monthsToGoal);
  
  // Update UI
  $('emergencyTargetAmount').textContent = fmt(targetAmount);
  $('emergencyTargetMonths').textContent = targetMonths + ' months expenses';
  $('emergencyNeeded').textContent = fmt(needed);
  $('emergencyPercent').textContent = Math.round(percentFunded) + '%';
  
  // Update ring
  const circumference = 283;
  const offset = circumference - (percentFunded / 100) * circumference;
  $('emergencyRing').style.strokeDashoffset = offset;
  $('emergencyRing').style.stroke = percentFunded >= 100 ? '#34d399' : percentFunded >= 50 ? '#22d3ee' : '#fbbf24';
  $('emergencyPercent').style.color = percentFunded >= 100 ? '#34d399' : percentFunded >= 50 ? '#22d3ee' : '#fbbf24';
  
  if (needed <= 0) {
    $('emergencyTime').textContent = 'âœ… Fully Funded!';
    $('emergencyDate').textContent = 'Congratulations!';
  } else if (monthlyContrib <= 0) {
    $('emergencyTime').textContent = 'âˆž';
    $('emergencyDate').textContent = 'Set a monthly contribution';
  } else {
    const years = Math.floor(monthsToGoal / 12);
    const months = monthsToGoal % 12;
    $('emergencyTime').textContent = years > 0 ? `${years}y ${months}m` : `${months} months`;
    $('emergencyDate').textContent = 'Fully funded by ' + goalDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  }
  
  // Scenarios
  const scenarios = [
    { icon: 'ðŸš—', name: 'Car repair', cost: 1500 },
    { icon: 'ðŸ¥', name: 'Medical emergency', cost: 3000 },
    { icon: 'ðŸ’¼', name: '1 month job loss', cost: monthlyExpenses },
    { icon: 'ðŸ’¼ðŸ’¼', name: '3 months job loss', cost: monthlyExpenses * 3 },
    { icon: 'ðŸ ', name: 'Major home repair', cost: 5000 }
  ];
  
  $('emergencyScenarios').innerHTML = scenarios.map(s => {
    const covered = currentSavings >= s.cost;
    const partial = currentSavings > 0 && currentSavings < s.cost;
    return `<div class="scenario-item">
      <span><span class="icon">${s.icon}</span>${s.name} (${fmt(s.cost)})</span>
      <span class="${covered ? 'covered' : partial ? 'partial' : 'not-covered'}">${covered ? 'âœ“ Covered' : partial ? Math.round(currentSavings / s.cost * 100) + '% covered' : 'âœ— Not covered'}</span>
    </div>`;
  }).join('');
}

// ========== COMPOUND INTEREST VISUALIZER ==========

function setCompoundFreq(freq) {
  $('compoundFreq').value = freq;
  document.querySelectorAll('#toolCompound .freq-buttons .term-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  calculateCompound();
}

function calculateCompound() {
  const initial = parseFloat($('compoundInitial').value) || 0;
  const monthly = parseFloat($('compoundMonthly').value) || 0;
  const rate = parseFloat($('compoundRate').value) || 0;
  const years = parseInt($('compoundYears').value) || 1;
  const freq = parseInt($('compoundFreq').value) || 12;
  
  $('compoundYearsLabel').textContent = years + ' years';
  
  const periodicRate = rate / 100 / freq;
  const totalPeriods = years * freq;
  const monthsPerPeriod = 12 / freq;
  
  // Calculate final amount with contributions
  let balance = initial;
  const data = [{ year: 0, balance: initial, contributions: initial, interest: 0 }];
  let totalContributions = initial;
  
  for (let period = 1; period <= totalPeriods; period++) {
    // Add interest
    balance *= (1 + periodicRate);
    // Add contributions for this period
    const periodContribs = monthly * monthsPerPeriod;
    balance += periodContribs;
    totalContributions += periodContribs;
    
    // Record yearly data
    if (period % freq === 0) {
      const year = period / freq;
      const interest = balance - totalContributions;
      data.push({ year, balance, contributions: totalContributions, interest });
    }
  }
  
  const finalBalance = balance;
  const totalInterest = finalBalance - totalContributions;
  
  // Calculate percentages
  const initialPct = (initial / finalBalance * 100) || 0;
  const contribPct = ((totalContributions - initial) / finalBalance * 100) || 0;
  const interestPct = (totalInterest / finalBalance * 100) || 0;
  
  // Update UI
  $('compoundFinal').textContent = fmt(finalBalance);
  $('compoundYearsResult').textContent = `in ${years} years`;
  
  // Breakdown bar
  $('breakdownInitial').style.width = Math.max(5, initialPct) + '%';
  $('breakdownContrib').style.width = Math.max(5, contribPct) + '%';
  $('breakdownInterest').style.width = Math.max(5, interestPct) + '%';
  
  $('legendInitial').textContent = fmt(initial);
  $('legendContrib').textContent = fmt(totalContributions - initial);
  $('legendInterest').textContent = fmt(totalInterest);
  
  // Power of starting early comparison
  const laterStart = calculateFV(initial, monthly, rate, freq, Math.max(1, years - 10));
  const difference = finalBalance - laterStart;
  
  $('powerComparison').innerHTML = `
    <div class="power-row highlight"><span class="label">Start now (${years} years)</span><span class="value green">${fmt(finalBalance)}</span></div>
    <div class="power-row"><span class="label">Start in 10 years (${Math.max(1, years - 10)} years)</span><span class="value">${fmt(laterStart)}</span></div>
    <div class="power-row"><span class="label">Cost of waiting</span><span class="value red">${fmt(difference)}</span></div>
  `;
  
  // Year table
  let tableHtml = '<div class="year-row header"><span>Year</span><span>Balance</span><span>Contributed</span><span>Interest</span></div>';
  data.forEach(d => {
    if (d.year > 0 && (d.year <= 10 || d.year % 5 === 0 || d.year === years)) {
      tableHtml += `<div class="year-row"><span>${d.year}</span><span>${fmt(d.balance)}</span><span>${fmt(d.contributions)}</span><span>${fmt(d.interest)}</span></div>`;
    }
  });
  $('compoundTable').innerHTML = tableHtml;
  
  // Render chart
  renderCompoundChart(data);
}

function calculateFV(initial, monthly, rate, freq, years) {
  const periodicRate = rate / 100 / freq;
  const totalPeriods = years * freq;
  const monthsPerPeriod = 12 / freq;
  
  let balance = initial;
  for (let period = 1; period <= totalPeriods; period++) {
    balance *= (1 + periodicRate);
    balance += monthly * monthsPerPeriod;
  }
  return balance;
}

function renderCompoundChart(data) {
  const ctx = $('compoundChart').getContext('2d');
  if (compoundChart) compoundChart.destroy();
  
  compoundChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => 'Year ' + d.year),
      datasets: [
        {
          label: 'Total Value',
          data: data.map(d => d.balance),
          borderColor: '#34d399',
          backgroundColor: 'rgba(52,211,153,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Contributions',
          data: data.map(d => d.contributions),
          borderColor: '#22d3ee',
          backgroundColor: 'rgba(34,211,238,0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#94a3b8' } } },
      scales: {
        x: { ticks: { color: '#64748b', maxTicksLimit: 10 }, grid: { color: 'rgba(148,163,184,0.1)' } },
        y: { ticks: { color: '#64748b', callback: v => v >= 1000000 ? 'â‚¬' + (v/1000000).toFixed(1) + 'M' : 'â‚¬' + (v/1000).toFixed(0) + 'k' }, grid: { color: 'rgba(148,163,184,0.1)' } }
      }
    }
  });
}

// ========== WHAT IF SCENARIOS ==========

function initWhatIf() {
  // Populate category dropdown
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  
  const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  $('cutCategory').innerHTML = sorted.map(([cat, amt]) => 
    `<option value="${cat}">${CATS[cat]?.i || 'ðŸ’³'} ${cat} (${fmt(amt)}/mo avg)</option>`
  ).join('');
  
  // Set current values
  updateWhatIfCurrent();
}

function updateWhatIfCurrent() {
  const now = new Date();
  const months = {};
  
  activeTxns.forEach(t => {
    const key = t.year + '-' + t.month;
    if (!months[key]) months[key] = { income: 0, expenses: 0 };
    if (t.amount > 0) months[key].income += t.amount;
    else months[key].expenses += Math.abs(t.amount);
  });
  
  const monthData = Object.values(months);
  const avgIncome = monthData.reduce((s, m) => s + m.income, 0) / Math.max(1, monthData.length);
  const avgExpenses = monthData.reduce((s, m) => s + m.expenses, 0) / Math.max(1, monthData.length);
  const avgSavings = avgIncome - avgExpenses;
  const savingsRate = avgIncome > 0 ? (avgSavings / avgIncome * 100) : 0;
  
  $('currentIncome').textContent = fmt(avgIncome);
  $('currentExpenses').textContent = fmt(avgExpenses);
  $('currentSavings').textContent = fmt(avgSavings);
  $('currentRate').textContent = savingsRate.toFixed(1) + '%';
  
  return { avgIncome, avgExpenses, avgSavings, savingsRate };
}

function selectScenario(scenario) {
  currentScenario = scenario;
  
  // Update UI
  document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
  event.target.closest('.scenario-card').classList.add('selected');
  
  $('scenarioInputs').classList.remove('hidden');
  document.querySelectorAll('.scenario-form').forEach(f => f.classList.add('hidden'));
  $(`${scenario}Inputs`).classList.remove('hidden');
  
  const titles = {
    raise: 'ðŸ’° Raise Scenario',
    cut: 'âœ‚ï¸ Spending Cut Scenario',
    save: 'ðŸŽ¯ Savings Goal Scenario',
    invest: 'ðŸ“ˆ Investment Scenario'
  };
  $('scenarioTitle').textContent = titles[scenario];
  
  $('whatifTip').classList.add('hidden');
  calculateWhatIf();
}

function calculateWhatIf() {
  if (!currentScenario) return;
  
  const current = updateWhatIfCurrent();
  let newIncome = current.avgIncome;
  let newExpenses = current.avgExpenses;
  
  switch (currentScenario) {
    case 'raise':
      const raiseAmount = parseFloat($('raiseAmount').value) || 0;
      newIncome = current.avgIncome + raiseAmount;
      break;
      
    case 'cut':
      const cutCategory = $('cutCategory').value;
      const cutPercent = parseFloat($('cutPercent').value) || 0;
      const categories = {};
      filteredTxns.filter(t => t.amount < 0).forEach(t => {
        categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
      });
      const monthCount = [...new Set(activeTxns.map(t => t.year + '-' + t.month))].length || 1;
      const catMonthly = (categories[cutCategory] || 0) / monthCount;
      const cutAmount = catMonthly * (cutPercent / 100);
      newExpenses = current.avgExpenses - cutAmount;
      break;
      
    case 'save':
      const targetRate = parseFloat($('targetSavingsRate').value) || 0;
      // To achieve target rate: savings = income * rate/100
      // savings = income - expenses
      // income - expenses = income * rate/100
      // expenses = income - income * rate/100 = income * (1 - rate/100)
      newExpenses = current.avgIncome * (1 - targetRate / 100);
      break;
      
    case 'invest':
      // For invest scenario, we show how monthly investment grows
      break;
  }
  
  const newSavings = newIncome - newExpenses;
  const newRate = newIncome > 0 ? (newSavings / newIncome * 100) : 0;
  
  // Update new values
  $('newIncome').textContent = fmt(newIncome);
  $('newIncome').className = newIncome > current.avgIncome ? 'green' : '';
  $('newExpenses').textContent = fmt(newExpenses);
  $('newExpenses').className = newExpenses < current.avgExpenses ? 'green' : '';
  $('newSavings').textContent = fmt(newSavings);
  $('newSavings').className = newSavings > current.avgSavings ? 'green' : '';
  $('newRate').textContent = newRate.toFixed(1) + '%';
  $('newRate').className = newRate > current.savingsRate ? 'green' : '';
  
  // Calculate impact
  const extraMonthlySavings = newSavings - current.avgSavings;
  const extraYearly = extraMonthlySavings * 12;
  
  // Future value with 7% return
  const monthlyRate = 0.07 / 12;
  const fv5 = extraMonthlySavings > 0 ? extraMonthlySavings * ((Math.pow(1 + monthlyRate, 60) - 1) / monthlyRate) : 0;
  const fv10 = extraMonthlySavings > 0 ? extraMonthlySavings * ((Math.pow(1 + monthlyRate, 120) - 1) / monthlyRate) : 0;
  
  // Handle invest scenario separately
  if (currentScenario === 'invest') {
    const monthlyInvest = parseFloat($('monthlyInvest').value) || 0;
    const expectedReturn = parseFloat($('expectedReturn').value) || 7;
    const mr = expectedReturn / 100 / 12;
    const fv5i = monthlyInvest * ((Math.pow(1 + mr, 60) - 1) / mr);
    const fv10i = monthlyInvest * ((Math.pow(1 + mr, 120) - 1) / mr);
    
    $('extraYearlySavings').textContent = fmt(monthlyInvest * 12) + ' invested';
    $('impact5Years').textContent = fmt(fv5i);
    $('impact10Years').textContent = fmt(fv10i);
  } else {
    $('extraYearlySavings').textContent = fmt(extraYearly);
    $('impact5Years').textContent = fmt(fv5);
    $('impact10Years').textContent = fmt(fv10);
  }
}

// ==================== AI CHAT ASSISTANT ====================

function toggleAIChat() {
  aiChatOpen = !aiChatOpen;
  $('aiChatPanel').classList.toggle('hidden', !aiChatOpen);
  if (aiChatOpen) {
    $('aiInput').focus();
  }
}

function sendAIMessage() {
  const input = $('aiInput');
  const message = input.value.trim();
  if (!message) return;
  
  addChatMessage(message, 'user');
  input.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  // Process the question
  setTimeout(() => {
    removeTypingIndicator();
    const response = processAIQuery(message);
    addChatMessage(response, 'bot');
  }, 800 + Math.random() * 500);
}

function askAI(question) {
  $('aiInput').value = question;
  sendAIMessage();
}

function addChatMessage(content, type) {
  const messages = $('aiChatMessages');
  const div = document.createElement('div');
  div.className = 'ai-message ' + type;
  div.innerHTML = `
    <div class="ai-message-avatar">${type === 'bot' ? 'ðŸ¤–' : 'ðŸ‘¤'}</div>
    <div class="ai-message-content">${content}</div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTypingIndicator() {
  const messages = $('aiChatMessages');
  const div = document.createElement('div');
  div.className = 'ai-message bot';
  div.id = 'typingIndicator';
  div.innerHTML = `
    <div class="ai-message-avatar">ðŸ¤–</div>
    <div class="ai-message-content"><div class="ai-typing"><span></span><span></span><span></span></div></div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function removeTypingIndicator() {
  const indicator = $('typingIndicator');
  if (indicator) indicator.remove();
}

function processAIQuery(query) {
  const q = query.toLowerCase();
  const now = new Date();
  
  // Get data
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const lastMonth = activeTxns.filter(t => {
    const lm = new Date(now.getFullYear(), now.getMonth() - 1);
    return t.parsedDate.getMonth() === lm.getMonth() && t.parsedDate.getFullYear() === lm.getFullYear();
  });
  
  const allIncome = filteredTxns.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const allExpenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const thisMonthExp = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const thisMonthInc = thisMonth.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const lastMonthExp = Math.abs(lastMonth.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const lastMonthInc = lastMonth.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  
  // Categories
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  const sortedCats = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  
  // Merchants
  const merchants = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const name = t.description.split(/\s+/).slice(0, 2).join(' ').toUpperCase();
    merchants[name] = (merchants[name] || 0) + Math.abs(t.amount);
  });
  const sortedMerchants = Object.entries(merchants).sort((a, b) => b[1] - a[1]);

  // Query matching
  
  // Spending this month
  if (q.includes('spend') && (q.includes('this month') || q.includes('month'))) {
    return `<p>This month you've spent <span class="ai-highlight">${fmt(thisMonthExp)}</span>.</p>
      <div class="ai-data-card">
        <h4>ðŸ“Š This Month Breakdown</h4>
        <div class="ai-data-row"><span class="label">Expenses</span><span class="value red">${fmt(thisMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Income</span><span class="value green">${fmt(thisMonthInc)}</span></div>
        <div class="ai-data-row"><span class="label">Net</span><span class="value ${thisMonthInc - thisMonthExp >= 0 ? 'green' : 'red'}">${fmt(thisMonthInc - thisMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Transactions</span><span class="value">${thisMonth.length}</span></div>
      </div>`;
  }
  
  // Total spending
  if (q.includes('total') && q.includes('spend')) {
    return `<p>Your total spending in the selected period is <span class="ai-highlight">${fmt(allExpenses)}</span> across ${filteredTxns.filter(t => t.amount < 0).length} transactions.</p>`;
  }
  
  // Biggest/top category
  if ((q.includes('biggest') || q.includes('top') || q.includes('most')) && q.includes('categor')) {
    const top5 = sortedCats.slice(0, 5);
    return `<p>Your biggest spending category is <span class="ai-highlight">${CATS[top5[0]?.[0]]?.i || 'ðŸ’³'} ${top5[0]?.[0] || 'N/A'}</span> at ${fmt(top5[0]?.[1] || 0)}.</p>
      <div class="ai-data-card">
        <h4>ðŸ† Top 5 Categories</h4>
        ${top5.map(([cat, amt], i) => `<div class="ai-data-row"><span class="label">${i + 1}. ${CATS[cat]?.i || 'ðŸ’³'} ${cat}</span><span class="value">${fmt(amt)}</span></div>`).join('')}
      </div>`;
  }
  
  // Compare months
  if (q.includes('compar') && (q.includes('month') || q.includes('last'))) {
    const diff = thisMonthExp - lastMonthExp;
    const pct = lastMonthExp > 0 ? ((diff / lastMonthExp) * 100).toFixed(1) : 0;
    const better = diff < 0;
    return `<p>Compared to last month, you've spent <span class="ai-highlight">${better ? fmt(Math.abs(diff)) + ' less' : fmt(diff) + ' more'}</span> (${better ? 'â†“' : 'â†‘'}${Math.abs(pct)}%).</p>
      <div class="ai-data-card">
        <h4>ðŸ“ˆ Month Comparison</h4>
        <div class="ai-data-row"><span class="label">This Month</span><span class="value">${fmt(thisMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Last Month</span><span class="value">${fmt(lastMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Difference</span><span class="value ${better ? 'green' : 'red'}">${better ? 'â†“' : 'â†‘'} ${fmt(Math.abs(diff))}</span></div>
      </div>
      <p style="margin-top:10px;font-size:13px">${better ? 'ðŸŽ‰ Great job reducing your spending!' : 'ðŸ’¡ Consider reviewing your expenses to find savings opportunities.'}</p>`;
  }
  
  // Specific category query
  for (const [catName, catConfig] of Object.entries(CATS)) {
    if (q.includes(catName.toLowerCase())) {
      const catTotal = categories[catName] || 0;
      const catTxns = filteredTxns.filter(t => t.category === catName && t.amount < 0);
      const pct = allExpenses > 0 ? ((catTotal / allExpenses) * 100).toFixed(1) : 0;
      return `<p>You've spent <span class="ai-highlight">${fmt(catTotal)}</span> on ${catConfig.i} ${catName} (${pct}% of total expenses).</p>
        <div class="ai-data-card">
          <h4>${catConfig.i} ${catName} Details</h4>
          <div class="ai-data-row"><span class="label">Total Spent</span><span class="value">${fmt(catTotal)}</span></div>
          <div class="ai-data-row"><span class="label">Transactions</span><span class="value">${catTxns.length}</span></div>
          <div class="ai-data-row"><span class="label">Average</span><span class="value">${fmt(catTotal / Math.max(1, catTxns.length))}</span></div>
          <div class="ai-data-row"><span class="label">% of Total</span><span class="value">${pct}%</span></div>
        </div>`;
    }
  }
  
  // Recurring payments
  if (q.includes('recurring') || q.includes('subscription') || q.includes('bills')) {
    const recurring = detectRecurring();
    const monthly = recurring.filter(r => r.pat === 'Monthly');
    const total = monthly.reduce((s, r) => s + r.a, 0);
    return `<p>I found <span class="ai-highlight">${monthly.length} recurring payments</span> totaling approximately <span class="ai-highlight">${fmt(total)}/month</span>.</p>
      <div class="ai-data-card">
        <h4>ðŸ”„ Recurring Payments</h4>
        ${monthly.slice(0, 6).map(r => `<div class="ai-data-row"><span class="label">${r.m}</span><span class="value">${fmt(r.a)}</span></div>`).join('') || '<div class="ai-data-row"><span class="label">No recurring payments found</span></div>'}
      </div>
      ${monthly.length > 6 ? `<p style="font-size:12px;color:var(--muted);margin-top:8px">And ${monthly.length - 6} more...</p>` : ''}`;
  }
  
  // Top merchants
  if (q.includes('merchant') || q.includes('store') || q.includes('where') && q.includes('spend')) {
    const top5 = sortedMerchants.slice(0, 5);
    return `<p>Here are the top places you've spent money:</p>
      <div class="ai-data-card">
        <h4>ðŸª Top Merchants</h4>
        ${top5.map(([name, amt], i) => `<div class="ai-data-row"><span class="label">${i + 1}. ${name}</span><span class="value">${fmt(amt)}</span></div>`).join('')}
      </div>`;
  }
  
  // Income
  if (q.includes('income') || q.includes('earn') || q.includes('salary')) {
    return `<p>Your total income in the selected period is <span class="ai-highlight">${fmt(allIncome)}</span>.</p>
      <div class="ai-data-card">
        <h4>ðŸ’° Income Breakdown</h4>
        <div class="ai-data-row"><span class="label">Total Income</span><span class="value green">${fmt(allIncome)}</span></div>
        <div class="ai-data-row"><span class="label">This Month</span><span class="value">${fmt(thisMonthInc)}</span></div>
        <div class="ai-data-row"><span class="label">Last Month</span><span class="value">${fmt(lastMonthInc)}</span></div>
        <div class="ai-data-row"><span class="label">Income Txns</span><span class="value">${filteredTxns.filter(t => t.amount > 0).length}</span></div>
      </div>`;
  }
  
  // Savings rate
  if (q.includes('saving') || q.includes('save')) {
    const savingsRate = allIncome > 0 ? ((allIncome - allExpenses) / allIncome * 100) : 0;
    const saved = allIncome - allExpenses;
    return `<p>Your savings rate is <span class="ai-highlight">${savingsRate.toFixed(1)}%</span>. You've saved <span class="ai-highlight">${fmt(saved)}</span> in the selected period.</p>
      <div class="ai-data-card">
        <h4>ðŸŽ¯ Savings Analysis</h4>
        <div class="ai-data-row"><span class="label">Income</span><span class="value green">${fmt(allIncome)}</span></div>
        <div class="ai-data-row"><span class="label">Expenses</span><span class="value red">${fmt(allExpenses)}</span></div>
        <div class="ai-data-row"><span class="label">Saved</span><span class="value ${saved >= 0 ? 'green' : 'red'}">${fmt(saved)}</span></div>
        <div class="ai-data-row"><span class="label">Savings Rate</span><span class="value">${savingsRate.toFixed(1)}%</span></div>
      </div>
      <p style="margin-top:10px;font-size:13px">${savingsRate >= 20 ? 'ðŸ† Excellent! You\'re saving more than the recommended 20%!' : savingsRate >= 10 ? 'ðŸ‘ Good progress! Try to reach 20% savings rate.' : 'ðŸ’¡ Tip: Aim to save at least 20% of your income.'}</p>`;
  }
  
  // Summary
  if (q.includes('summary') || q.includes('overview') || q.includes('how am i doing')) {
    const savingsRate = allIncome > 0 ? ((allIncome - allExpenses) / allIncome * 100) : 0;
    const topCat = sortedCats[0];
    return `<p>Here's your financial summary:</p>
      <div class="ai-data-card">
        <h4>ðŸ“‹ Financial Summary</h4>
        <div class="ai-data-row"><span class="label">ðŸ’° Total Income</span><span class="value green">${fmt(allIncome)}</span></div>
        <div class="ai-data-row"><span class="label">ðŸ’¸ Total Expenses</span><span class="value red">${fmt(allExpenses)}</span></div>
        <div class="ai-data-row"><span class="label">ðŸ“ˆ Net</span><span class="value ${allIncome - allExpenses >= 0 ? 'green' : 'red'}">${fmt(allIncome - allExpenses)}</span></div>
        <div class="ai-data-row"><span class="label">ðŸŽ¯ Savings Rate</span><span class="value">${savingsRate.toFixed(1)}%</span></div>
        <div class="ai-data-row"><span class="label">ðŸ“Š Top Category</span><span class="value">${topCat ? CATS[topCat[0]]?.i + ' ' + topCat[0] : 'N/A'}</span></div>
        <div class="ai-data-row"><span class="label">ðŸ“ Transactions</span><span class="value">${filteredTxns.length}</span></div>
      </div>
      <p style="margin-top:10px;font-size:13px">${savingsRate >= 20 ? 'ðŸŽ‰ You\'re doing great! Keep up the excellent financial habits.' : 'ðŸ’¡ Consider reducing spending on ' + (topCat?.[0] || 'your top category') + ' to improve savings.'}</p>`;
  }
  
  // Balance
  if (q.includes('balance')) {
    const lastBal = filteredTxns.length ? filteredTxns[filteredTxns.length - 1].balance : 0;
    return `<p>Your current balance is <span class="ai-highlight">${fmt(lastBal)}</span>.</p>`;
  }
  
  // Average daily
  if (q.includes('daily') || q.includes('per day') || q.includes('average')) {
    const days = filteredTxns.length > 1 ? Math.max(1, Math.ceil((filteredTxns[filteredTxns.length-1].parsedDate - filteredTxns[0].parsedDate) / 864e5)) : 1;
    const dailyAvg = allExpenses / days;
    return `<p>Your average daily spending is <span class="ai-highlight">${fmt(dailyAvg)}</span>.</p>
      <div class="ai-data-card">
        <h4>ðŸ“… Daily Stats</h4>
        <div class="ai-data-row"><span class="label">Daily Average</span><span class="value">${fmt(dailyAvg)}</span></div>
        <div class="ai-data-row"><span class="label">Weekly Estimate</span><span class="value">${fmt(dailyAvg * 7)}</span></div>
        <div class="ai-data-row"><span class="label">Monthly Estimate</span><span class="value">${fmt(dailyAvg * 30)}</span></div>
        <div class="ai-data-row"><span class="label">Days Analyzed</span><span class="value">${days}</span></div>
      </div>`;
  }
  
  // Largest transaction
  if (q.includes('largest') || q.includes('biggest') && (q.includes('transaction') || q.includes('purchase') || q.includes('expense'))) {
    const largest = [...filteredTxns].filter(t => t.amount < 0).sort((a, b) => a.amount - b.amount).slice(0, 5);
    return `<p>Your largest expense was <span class="ai-highlight">${fmt(largest[0]?.amount || 0)}</span> at ${largest[0]?.description?.slice(0, 30) || 'N/A'}.</p>
      <div class="ai-data-card">
        <h4>ðŸ”¥ Top 5 Largest Expenses</h4>
        ${largest.map((t, i) => `<div class="ai-data-row"><span class="label">${i + 1}. ${t.description.slice(0, 20)}</span><span class="value">${fmt(t.amount)}</span></div>`).join('')}
      </div>`;
  }
  
  // Default / help
  return `<p>I can help you with questions like:</p>
    <div class="ai-suggestions" style="margin-top:8px">
      <button onclick="askAI('How much did I spend this month?')">ðŸ’° Monthly spending</button>
      <button onclick="askAI('What is my biggest expense category?')">ðŸ“Š Top category</button>
      <button onclick="askAI('How much on groceries?')">ðŸ›’ Category totals</button>
      <button onclick="askAI('Compare this month to last')">ðŸ“ˆ Comparisons</button>
      <button onclick="askAI('What are my recurring payments?')">ðŸ”„ Subscriptions</button>
      <button onclick="askAI('What is my savings rate?')">ðŸŽ¯ Savings</button>
    </div>
    <p style="margin-top:12px;font-size:13px;color:var(--muted)">Try asking about specific categories like "groceries", "restaurants", or "fuel".</p>`;
}

// ==================== DASHBOARD CUSTOMIZATION ====================

const WIDGET_NAMES = {
  insights: 'ðŸ’¡ Smart Insights',
  stats: 'ðŸ“Š Stats Cards',
  sankey: 'ðŸ’¸ Money Flow',
  treemap: 'ðŸ“¦ Treemap',
  radials: 'ðŸŽ¯ Progress Rings',
  prediction: 'ðŸ”® Predictions',
  quickstats: 'âš¡ Quick Stats',
  race: 'ðŸ Spending Race',
  charts: 'ðŸ“ˆ Charts',
  monthly: 'ðŸ“† Monthly',
  patterns: 'ðŸ—“ï¸ Patterns',
  yoy: 'ðŸ“… Year-over-Year',
  merchants: 'ðŸª Merchants',
  recurring: 'ðŸ”„ Recurring',
  categories: 'ðŸ“‹ Categories',
  transactions: 'ðŸ“ Transactions'
};

function loadDashboardSettings() {
  const saved = localStorage.getItem('dashboardSettings');
  if (saved) {
    try {
      dashboardSettings = { ...dashboardSettings, ...JSON.parse(saved) };
    } catch (e) {}
  }
  applyDashboardSettings();
}

function saveDashboardSettings() {
  localStorage.setItem('dashboardSettings', JSON.stringify(dashboardSettings));
}

function applyDashboardSettings() {
  // Apply theme
  document.body.className = dashboardSettings.theme === 'dark' ? '' : dashboardSettings.theme;
  
  // Apply layout
  $('dashboard').className = $('dashboard').className.replace(/layout-\w+/g, '');
  if (dashboardSettings.layout !== 'default') {
    $('dashboard').classList.add('layout-' + dashboardSettings.layout);
  }
  
  // Apply card size
  $('dashboard').className = $('dashboard').className.replace(/card-size-\w+/g, '');
  if (dashboardSettings.cardSize !== 'medium') {
    $('dashboard').classList.add('card-size-' + dashboardSettings.cardSize);
  }
  
  // Apply widget visibility
  document.querySelectorAll('.widget').forEach(w => {
    const widgetId = w.dataset.widget;
    if (widgetId && dashboardSettings.widgets[widgetId] === false) {
      w.classList.add('hidden-widget');
    } else {
      w.classList.remove('hidden-widget');
    }
  });
  
  // Update layout select
  if ($('layoutSelect')) $('layoutSelect').value = dashboardSettings.layout;
}

function showCustomizeModal() {
  // Update theme selection
  document.querySelectorAll('.theme-opt').forEach(el => el.classList.remove('selected'));
  $('theme' + dashboardSettings.theme.charAt(0).toUpperCase() + dashboardSettings.theme.slice(1))?.classList.add('selected');
  
  // Render widget toggles
  $('widgetToggles').innerHTML = Object.entries(WIDGET_NAMES).map(([id, name]) => `
    <label class="widget-toggle">
      <input type="checkbox" ${dashboardSettings.widgets[id] !== false ? 'checked' : ''} onchange="toggleWidget('${id}')">
      <span>${name}</span>
    </label>
  `).join('');
  
  // Update card size
  document.querySelectorAll('input[name="cardSize"]').forEach(el => {
    el.checked = el.value === dashboardSettings.cardSize;
  });
  
  $('customizeModal').classList.remove('hidden');
}

function hideCustomizeModal() {
  $('customizeModal').classList.add('hidden');
  saveDashboardSettings();
}

function setTheme(theme) {
  dashboardSettings.theme = theme;
  document.querySelectorAll('.theme-opt').forEach(el => el.classList.remove('selected'));
  $('theme' + theme.charAt(0).toUpperCase() + theme.slice(1))?.classList.add('selected');
  applyDashboardSettings();
  saveDashboardSettings();
  
  // Re-render charts with new colors
  setTimeout(() => {
    renderCharts();
    renderSankeyChart();
    renderTreemap();
  }, 100);
}

function toggleWidget(id) {
  dashboardSettings.widgets[id] = !dashboardSettings.widgets[id];
  applyDashboardSettings();
  saveDashboardSettings();
}

function setCardSize(size) {
  dashboardSettings.cardSize = size;
  applyDashboardSettings();
  saveDashboardSettings();
}

function changeLayout() {
  dashboardSettings.layout = $('layoutSelect').value;
  applyDashboardSettings();
  saveDashboardSettings();
}

function resetDashboardSettings() {
  dashboardSettings = {
    theme: 'dark',
    layout: 'default',
    cardSize: 'medium',
    widgets: {
      insights: true, stats: true, sankey: true, treemap: true, radials: true,
      prediction: true, quickstats: true, race: true, charts: true, monthly: true,
      patterns: true, yoy: true, merchants: true, recurring: true, categories: true, transactions: true
    }
  };
  saveDashboardSettings();
  applyDashboardSettings();
  showCustomizeModal();
  notify('Dashboard reset to defaults');
}

// ==================== AI INSIGHTS ====================

function generateInsights() {
  // Clear spinners immediately
  const containers = ['cutbackSuggestions', 'growthSuggestions', 'investmentSuggestions', 'patternInsights', 'quickWins', 'monthlyGoals', 'alertsWarnings'];
  
  if (activeTxns.length === 0) {
    showNoDataMessage();
    return;
  }
  
  try {
    // Calculate financial metrics
    const metrics = calculateFinancialMetrics();
    
    // Update summary
    updateInsightsSummary(metrics);
    
    // Calculate and display health score
    calculateHealthScore(metrics);
    
    // Generate all suggestions
    generateCutbackSuggestions(metrics);
    generateGrowthSuggestions(metrics);
    generateInvestmentSuggestions(metrics);
    generatePatternInsights(metrics);
    generateQuickWins(metrics);
    generateMonthlyGoals(metrics);
    generateAlertsWarnings(metrics);
  } catch (error) {
    console.error('Error generating insights:', error);
    containers.forEach(id => {
      if ($(id)) $(id).innerHTML = '<div class="no-data-message"><div class="icon">âš ï¸</div>Error loading insights</div>';
    });
  }
}

function calculateFinancialMetrics() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Get monthly data
  const monthlyData = {};
  activeTxns.forEach(t => {
    const key = `${t.year}-${t.month}`;
    if (!monthlyData[key]) monthlyData[key] = { income: 0, expenses: 0, byCategory: {} };
    if (t.amount > 0) monthlyData[key].income += t.amount;
    else {
      monthlyData[key].expenses += Math.abs(t.amount);
      const cat = t.category || 'Other';
      monthlyData[key].byCategory[cat] = (monthlyData[key].byCategory[cat] || 0) + Math.abs(t.amount);
    }
  });
  
  const months = Object.keys(monthlyData).sort().slice(-6); // Last 6 months
  const monthCount = months.length || 1; // Prevent division by zero
  const avgIncome = months.reduce((s, m) => s + monthlyData[m].income, 0) / monthCount;
  const avgExpenses = months.reduce((s, m) => s + monthlyData[m].expenses, 0) / monthCount;
  const avgSavings = avgIncome - avgExpenses;
  const savingsRate = avgIncome > 0 ? (avgSavings / avgIncome * 100) : 0;
  
  // Category analysis
  const categoryTotals = {};
  const categoryMonthly = {};
  months.forEach(m => {
    Object.entries(monthlyData[m].byCategory).forEach(([cat, amt]) => {
      categoryTotals[cat] = (categoryTotals[cat] || 0) + amt;
      if (!categoryMonthly[cat]) categoryMonthly[cat] = [];
      categoryMonthly[cat].push(amt);
    });
  });
  
  // Sort categories by spending
  const sortedCategories = Object.entries(categoryTotals)
    .map(([cat, total]) => ({
      name: cat,
      total,
      monthly: total / monthCount,
      trend: calculateTrend(categoryMonthly[cat] || []),
      icon: CATS[cat]?.i || 'ðŸ’³',
      color: CATS[cat]?.c || '#94a3b8'
    }))
    .sort((a, b) => b.total - a.total);
  
  // Recurring expenses
  const recurringMerchants = {};
  activeTxns.filter(t => t.amount < 0).forEach(t => {
    const merchant = t.description.substring(0, 20).toUpperCase();
    if (!recurringMerchants[merchant]) recurringMerchants[merchant] = { count: 0, total: 0, amounts: [] };
    recurringMerchants[merchant].count++;
    recurringMerchants[merchant].total += Math.abs(t.amount);
    recurringMerchants[merchant].amounts.push(Math.abs(t.amount));
  });
  
  const recurring = Object.entries(recurringMerchants)
    .filter(([_, d]) => d.count >= 3)
    .map(([name, d]) => ({
      name,
      avgAmount: d.total / d.count,
      frequency: d.count / monthCount,
      total: d.total
    }))
    .sort((a, b) => b.total - a.total);
  
  // Income stability
  const incomeVariance = calculateVariance(months.map(m => monthlyData[m].income));
  const incomeStability = avgIncome > 0 ? Math.max(0, 100 - (incomeVariance / avgIncome * 100)) : 0;
  
  return {
    avgIncome,
    avgExpenses,
    avgSavings,
    savingsRate,
    sortedCategories,
    recurring,
    incomeStability,
    monthlyData,
    months,
    monthCount
  };
}

function calculateTrend(values) {
  if (values.length < 2) return 0;
  const recent = values.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, values.length);
  const older = values.slice(0, -3).reduce((a, b) => a + b, 0) / Math.max(1, values.length - 3);
  return older > 0 ? ((recent - older) / older * 100) : 0;
}

function calculateVariance(values) {
  if (values.length === 0) return 0;
  const mean = values.reduce((a, b) => a + b, 0) / values.length;
  return Math.sqrt(values.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / values.length);
}

function updateInsightsSummary(metrics) {
  $('insightIncome').textContent = fmt(metrics.avgIncome);
  $('insightExpenses').textContent = fmt(metrics.avgExpenses);
  $('insightSavings').textContent = fmt(metrics.avgSavings);
  $('insightRate').textContent = metrics.savingsRate.toFixed(1) + '%';
  $('insightRate').className = 'value ' + (metrics.savingsRate >= 20 ? 'green' : metrics.savingsRate >= 10 ? 'yellow' : 'red');
}

function calculateHealthScore(metrics) {
  // Score components (0-25 each, total 100)
  const savingsScore = Math.min(25, metrics.savingsRate * 1.25); // 20% savings = 25 points
  const budgetScore = metrics.avgExpenses < metrics.avgIncome * 0.8 ? 25 : Math.max(0, 25 - (metrics.avgExpenses - metrics.avgIncome * 0.8) / metrics.avgIncome * 100);
  const stabilityScore = metrics.incomeStability * 0.25;
  const efficiencyScore = Math.min(25, 25 - metrics.sortedCategories.filter(c => ['Parties', 'Entertainment', 'Restaurants'].includes(c.name)).reduce((s, c) => s + c.monthly, 0) / metrics.avgExpenses * 50);
  
  const totalScore = Math.round(savingsScore + budgetScore + stabilityScore + efficiencyScore);
  
  // Update UI
  $('healthScore').textContent = totalScore;
  const ring = $('healthScoreRing');
  const circumference = 283;
  ring.style.strokeDashoffset = circumference - (totalScore / 100) * circumference;
  
  const color = totalScore >= 75 ? 'var(--green)' : totalScore >= 50 ? '#fbbf24' : 'var(--red)';
  ring.style.stroke = color;
  $('healthScore').style.color = color;
  
  $('scoreSavings').textContent = Math.round(savingsScore) + '/25';
  $('scoreBudget').textContent = Math.round(budgetScore) + '/25';
  $('scoreStability').textContent = Math.round(stabilityScore) + '/25';
  $('scoreEfficiency').textContent = Math.round(efficiencyScore) + '/25';
}

function generateCutbackSuggestions(metrics) {
  const suggestions = [];
  
  // Find categories with high spending or increasing trends
  metrics.sortedCategories.slice(0, 8).forEach(cat => {
    if (['Income', 'Transfers'].includes(cat.name)) return;
    
    const percentOfExpenses = cat.monthly / metrics.avgExpenses * 100;
    
    // Discretionary categories to potentially cut
    if (['Restaurants', 'Parties', 'Entertainment', 'Shopping', 'Clothing'].includes(cat.name)) {
      const potentialSavings = cat.monthly * 0.3;
      if (potentialSavings > 20) {
        suggestions.push({
          icon: cat.icon,
          title: `Reduce ${cat.name} spending`,
          desc: `You spend ${fmt(cat.monthly)}/month (${percentOfExpenses.toFixed(0)}% of expenses). Cutting 30% would save ${fmt(potentialSavings)}/month.`,
          impact: fmt(potentialSavings * 12) + '/year',
          priority: potentialSavings
        });
      }
    }
    
    // Rising trend warning
    if (cat.trend > 20 && cat.monthly > 50) {
      suggestions.push({
        icon: 'ðŸ“ˆ',
        title: `${cat.name} spending is rising`,
        desc: `This category has increased ${cat.trend.toFixed(0)}% recently. Consider setting a budget cap.`,
        impact: 'Trending up ' + cat.trend.toFixed(0) + '%',
        impactClass: 'warning',
        priority: cat.trend
      });
    }
  });
  
  // Sort by priority and render
  suggestions.sort((a, b) => b.priority - a.priority);
  $('cutbackSuggestions').innerHTML = suggestions.length ? suggestions.slice(0, 5).map(s => `
    <div class="suggestion-item">
      <div class="suggestion-icon">${s.icon}</div>
      <div class="suggestion-content">
        <div class="suggestion-title">${s.title}</div>
        <div class="suggestion-desc">${s.desc}</div>
        <div class="suggestion-impact ${s.impactClass || ''}">${s.impactClass === 'warning' ? 'âš ï¸' : 'ðŸ’°'} ${s.impact}</div>
      </div>
    </div>
  `).join('') : '<div class="no-data-message"><div class="icon">âœ…</div>Your spending looks well-balanced!</div>';
}

function generateGrowthSuggestions(metrics) {
  const suggestions = [];
  
  if (metrics.savingsRate < 20) {
    const targetSavings = metrics.avgIncome * 0.2;
    const needed = targetSavings - metrics.avgSavings;
    suggestions.push({
      icon: 'ðŸŽ¯',
      title: 'Increase savings rate to 20%',
      desc: `Currently saving ${metrics.savingsRate.toFixed(1)}%. Find ${fmt(needed)}/month more to reach the recommended 20% rate.`,
      impact: fmt(needed * 12) + ' more/year'
    });
  }
  
  if (metrics.avgSavings > 200) {
    suggestions.push({
      icon: 'ðŸ“ˆ',
      title: 'Start investing your savings',
      desc: `You have ${fmt(metrics.avgSavings)}/month available. Investing at 7% returns could grow to ${fmt(metrics.avgSavings * 12 * 10 * 1.5)} in 10 years.`,
      impact: 'Potential ' + fmt(metrics.avgSavings * 12 * 10 * 0.5) + ' gains'
    });
  }
  
  // Side income suggestion
  if (metrics.incomeStability < 80) {
    suggestions.push({
      icon: 'ðŸ’¼',
      title: 'Diversify income sources',
      desc: 'Your income varies month to month. Consider a side hustle or passive income to stabilize cash flow.',
      impact: 'More stability'
    });
  }
  
  // Emergency fund
  const emergencyTarget = metrics.avgExpenses * 6;
  suggestions.push({
    icon: 'ðŸ›¡ï¸',
    title: 'Build emergency fund',
    desc: `Aim for ${fmt(emergencyTarget)} (6 months expenses) in easily accessible savings.`,
    impact: 'Financial security'
  });
  
  $('growthSuggestions').innerHTML = suggestions.slice(0, 4).map(s => `
    <div class="suggestion-item">
      <div class="suggestion-icon">${s.icon}</div>
      <div class="suggestion-content">
        <div class="suggestion-title">${s.title}</div>
        <div class="suggestion-desc">${s.desc}</div>
        <div class="suggestion-impact">ðŸš€ ${s.impact}</div>
      </div>
    </div>
  `).join('');
}

function generateInvestmentSuggestions(metrics) {
  const monthlySavings = Math.max(0, metrics.avgSavings);
  const suggestions = [];
  
  if (monthlySavings < 100) {
    suggestions.push({
      icon: 'ðŸ’¡',
      title: 'Start small with micro-investing',
      desc: 'Even â‚¬25-50/month can grow significantly over time. Apps like Revolut or Trade Republic let you start small.',
      allocation: 'Start with what you can'
    });
  } else {
    // Investment allocation suggestions
    const conservative = monthlySavings * 0.4;
    const moderate = monthlySavings * 0.35;
    const aggressive = monthlySavings * 0.25;
    
    suggestions.push({
      icon: 'ðŸ¦',
      title: 'Emergency Fund First',
      desc: `Keep ${fmt(conservative)}/month in high-yield savings until you have 6 months expenses saved.`,
      allocation: fmt(conservative) + '/month'
    });
    
    suggestions.push({
      icon: 'ðŸ“Š',
      title: 'Index Funds (ETFs)',
      desc: `Invest ${fmt(moderate)}/month in diversified ETFs like MSCI World or S&P 500 for long-term growth.`,
      allocation: fmt(moderate) + '/month'
    });
    
    if (monthlySavings > 300) {
      suggestions.push({
        icon: 'ðŸŽ²',
        title: 'Growth Stocks',
        desc: `Allocate ${fmt(aggressive)}/month to individual stocks or sector ETFs for higher potential returns.`,
        allocation: fmt(aggressive) + '/month'
      });
    }
    
    suggestions.push({
      icon: 'ðŸ“ˆ',
      title: '10-Year Projection',
      desc: `Investing ${fmt(monthlySavings)}/month at 7% avg return = ${fmt(monthlySavings * 12 * ((Math.pow(1.07, 10) - 1) / 0.07) * 1.035)} in 10 years.`,
      allocation: 'Compound growth'
    });
  }
  
  $('investmentSuggestions').innerHTML = suggestions.map(s => `
    <div class="suggestion-item">
      <div class="suggestion-icon">${s.icon}</div>
      <div class="suggestion-content">
        <div class="suggestion-title">${s.title}</div>
        <div class="suggestion-desc">${s.desc}</div>
        <div class="suggestion-impact">ðŸ’Ž ${s.allocation}</div>
      </div>
    </div>
  `).join('');
}

function generatePatternInsights(metrics) {
  const patterns = [];
  
  // Top spending categories
  const top3 = metrics.sortedCategories.slice(0, 3).filter(c => !['Income', 'Transfers'].includes(c.name));
  if (top3.length) {
    patterns.push({
      title: 'Top spending categories',
      desc: top3.map(c => `${c.icon} ${c.name}: ${fmt(c.monthly)}/mo`).join(', ')
    });
  }
  
  // Weekend vs weekday spending
  const weekendSpend = activeTxns.filter(t => {
    const d = new Date(t.parsedDate);
    return t.amount < 0 && (d.getDay() === 0 || d.getDay() === 6);
  }).reduce((s, t) => s + Math.abs(t.amount), 0);
  
  const weekdaySpend = activeTxns.filter(t => {
    const d = new Date(t.parsedDate);
    return t.amount < 0 && d.getDay() > 0 && d.getDay() < 6;
  }).reduce((s, t) => s + Math.abs(t.amount), 0);
  
  if (weekendSpend > 0 && weekdaySpend > 0) {
    const weekendAvg = weekendSpend / (metrics.monthCount * 8);
    const weekdayAvg = weekdaySpend / (metrics.monthCount * 22);
    if (weekendAvg > weekdayAvg * 1.5) {
      patterns.push({
        title: 'Weekend spending spike',
        desc: `You spend ${((weekendAvg / weekdayAvg - 1) * 100).toFixed(0)}% more on weekends than weekdays.`
      });
    }
  }
  
  // Recurring subscriptions
  const subscriptions = metrics.recurring.filter(r => r.avgAmount < 50 && r.frequency >= 0.8);
  if (subscriptions.length > 0) {
    const totalSubs = subscriptions.reduce((s, r) => s + r.avgAmount, 0);
    patterns.push({
      title: `${subscriptions.length} recurring subscriptions detected`,
      desc: `Total: ~${fmt(totalSubs)}/month. Review if all are still needed.`
    });
  }
  
  // Largest single expense
  const largest = activeTxns.filter(t => t.amount < 0).sort((a, b) => a.amount - b.amount)[0];
  if (largest) {
    patterns.push({
      title: 'Largest single expense',
      desc: `${fmt(Math.abs(largest.amount))} at ${largest.description.substring(0, 30)}`
    });
  }
  
  $('patternInsights').innerHTML = patterns.map(p => `
    <div class="pattern-item">
      <div class="pattern-title">${p.title}</div>
      <div class="pattern-desc">${p.desc}</div>
    </div>
  `).join('');
}

function generateQuickWins(metrics) {
  const wins = [];
  
  // Subscriptions to review
  const subscriptions = metrics.recurring.filter(r => r.avgAmount < 50 && r.avgAmount > 5);
  if (subscriptions.length > 2) {
    wins.push({
      icon: 'ðŸ“±',
      title: 'Audit your subscriptions',
      desc: `You have ${subscriptions.length} recurring charges. Cancel unused ones.`,
      savings: subscriptions.slice(0, 3).reduce((s, r) => s + r.avgAmount, 0),
      period: '/month potential'
    });
  }
  
  // Restaurants to groceries
  const restaurants = metrics.sortedCategories.find(c => c.name === 'Restaurants');
  if (restaurants && restaurants.monthly > 100) {
    wins.push({
      icon: 'ðŸ³',
      title: 'Cook more at home',
      desc: 'Replacing 2 restaurant meals/week with home cooking saves significantly.',
      savings: restaurants.monthly * 0.4,
      period: '/month'
    });
  }
  
  // Coffee shop savings
  const coffeeSpend = activeTxns.filter(t => 
    t.amount < 0 && 
    (t.description.toUpperCase().includes('CAFE') || 
     t.description.toUpperCase().includes('COFFEE') ||
     t.description.toUpperCase().includes('STARBUCKS'))
  ).reduce((s, t) => s + Math.abs(t.amount), 0) / metrics.monthCount;
  
  if (coffeeSpend > 30) {
    wins.push({
      icon: 'â˜•',
      title: 'Make coffee at home',
      desc: `You spend ~${fmt(coffeeSpend)}/month on coffee shops. A home setup pays for itself quickly.`,
      savings: coffeeSpend * 0.7,
      period: '/month'
    });
  }
  
  // Round up savings
  wins.push({
    icon: 'ðŸ”„',
    title: 'Enable round-up savings',
    desc: 'Round up purchases to the nearest euro and save the difference automatically.',
    savings: Math.round(activeTxns.filter(t => t.amount < 0).length / metrics.monthCount * 0.5),
    period: '/month avg'
  });
  
  $('quickWins').innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">` + 
    wins.slice(0, 4).map(w => `
    <div class="quick-win">
      <div class="quick-win-icon">${w.icon}</div>
      <div class="quick-win-content">
        <div class="quick-win-title">${w.title}</div>
        <div class="quick-win-desc">${w.desc}</div>
      </div>
      <div class="quick-win-savings">
        <div class="quick-win-amount">${fmt(w.savings)}</div>
        <div class="quick-win-period">${w.period}</div>
      </div>
    </div>
  `).join('') + '</div>';
}

function generateMonthlyGoals(metrics) {
  const goals = [];
  
  // Savings goal
  const savingsTarget = Math.round(metrics.avgIncome * 0.2 / 50) * 50;
  goals.push({
    text: `Save at least ${fmt(savingsTarget)} this month`,
    target: fmt(savingsTarget)
  });
  
  // Reduce top discretionary category
  const topDiscretionary = metrics.sortedCategories.find(c => 
    ['Restaurants', 'Shopping', 'Entertainment', 'Parties'].includes(c.name)
  );
  if (topDiscretionary) {
    const target = Math.round(topDiscretionary.monthly * 0.8);
    goals.push({
      text: `Keep ${topDiscretionary.name} under ${fmt(target)}`,
      target: fmt(target)
    });
  }
  
  // Track expenses daily
  goals.push({
    text: 'Review transactions every week',
    target: 'Weekly'
  });
  
  // No-spend days
  goals.push({
    text: 'Have at least 5 no-spend days',
    target: '5 days'
  });
  
  $('monthlyGoals').innerHTML = goals.map(g => `
    <div class="goal-item">
      <div class="goal-checkbox" onclick="this.classList.toggle('checked')"></div>
      <div class="goal-text">${g.text}</div>
      <div class="goal-target">${g.target}</div>
    </div>
  `).join('');
}

function generateAlertsWarnings(metrics) {
  const alerts = [];
  
  // Negative savings
  if (metrics.avgSavings < 0) {
    alerts.push({
      type: 'danger',
      icon: 'ðŸš¨',
      text: `You're spending ${fmt(Math.abs(metrics.avgSavings))}/month more than you earn!`
    });
  }
  
  // Low savings rate
  if (metrics.savingsRate < 10 && metrics.savingsRate >= 0) {
    alerts.push({
      type: 'warning',
      icon: 'âš ï¸',
      text: `Savings rate is only ${metrics.savingsRate.toFixed(1)}%. Aim for at least 20%.`
    });
  }
  
  // Rising expenses
  const recentExpenses = metrics.months.slice(-3).reduce((s, m) => s + metrics.monthlyData[m].expenses, 0) / 3;
  const olderExpenses = metrics.months.slice(0, 3).reduce((s, m) => s + metrics.monthlyData[m].expenses, 0) / 3;
  if (recentExpenses > olderExpenses * 1.15) {
    alerts.push({
      type: 'warning',
      icon: 'ðŸ“ˆ',
      text: `Expenses have increased ${((recentExpenses / olderExpenses - 1) * 100).toFixed(0)}% compared to 3 months ago.`
    });
  }
  
  // Large recurring charges
  const largRecurring = metrics.recurring.filter(r => r.avgAmount > 100);
  if (largRecurring.length > 0) {
    alerts.push({
      type: 'info',
      icon: 'â„¹ï¸',
      text: `${largRecurring.length} large recurring charges detected. Review them periodically.`
    });
  }
  
  if (alerts.length === 0) {
    alerts.push({
      type: 'info',
      icon: 'âœ…',
      text: 'No major alerts. Keep up the good work!'
    });
  }
  
  $('alertsWarnings').innerHTML = alerts.map(a => `
    <div class="alert-item ${a.type}">
      <div class="alert-icon">${a.icon}</div>
      <div class="alert-text">${a.text}</div>
    </div>
  `).join('');
}

function showNoDataMessage() {
  const containers = ['cutbackSuggestions', 'growthSuggestions', 'investmentSuggestions', 'patternInsights', 'quickWins', 'monthlyGoals', 'alertsWarnings'];
  containers.forEach(id => {
    $(id).innerHTML = '<div class="no-data-message"><div class="icon">ðŸ“Š</div>Import transactions to see insights</div>';
  });
  $('healthScore').textContent = '--';
  $('insightIncome').textContent = 'â‚¬0';
  $('insightExpenses').textContent = 'â‚¬0';
  $('insightSavings').textContent = 'â‚¬0';
  $('insightRate').textContent = '0%';
}

function exportInsightsReport() {
  // Generate PDF or text report
  const content = `
FINANCIAL INSIGHTS REPORT
Generated: ${new Date().toLocaleDateString()}

=== SUMMARY ===
Monthly Income: ${$('insightIncome').textContent}
Monthly Expenses: ${$('insightExpenses').textContent}
Monthly Savings: ${$('insightSavings').textContent}
Savings Rate: ${$('insightRate').textContent}
Health Score: ${$('healthScore').textContent}/100

=== KEY RECOMMENDATIONS ===
${$('cutbackSuggestions').innerText}

=== GROWTH OPPORTUNITIES ===
${$('growthSuggestions').innerText}

=== INVESTMENT IDEAS ===
${$('investmentSuggestions').innerText}
  `.trim();
  
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'financial-insights-' + new Date().toISOString().split('T')[0] + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  notify('Report exported!');
}

// ==================== MERCHANT MANAGEMENT ====================

let selectedMerchantCat = null;
let editingMerchantKeyword = null;

function renderMerchantsPage() {
  // Gather all unique merchants from transactions
  const merchantData = {};
  
  activeTxns.forEach(t => {
    // Extract merchant name (first 2-3 words, cleaned)
    const desc = t.description.toUpperCase();
    const words = desc.split(/[\s\/\-,]+/).filter(w => w.length > 1);
    const merchantKey = words.slice(0, 3).join(' ').substring(0, 30);
    
    if (!merchantKey) return;
    
    if (!merchantData[merchantKey]) {
      merchantData[merchantKey] = {
        name: merchantKey,
        count: 0,
        total: 0,
        category: null,
        source: null, // 'auto', 'custom', or null (uncategorized)
        sampleDesc: t.description
      };
    }
    
    merchantData[merchantKey].count++;
    merchantData[merchantKey].total += Math.abs(t.amount);
    
    // Determine how this merchant is categorized
    const cat = categorize(t.description);
    merchantData[merchantKey].category = cat;
    
    // Check if it's a custom rule or auto-detected
    const u = t.description.toUpperCase();
    let isCustom = false;
    for (const keyword of Object.keys(merchantRules)) {
      if (u.includes(keyword.toUpperCase())) {
        isCustom = true;
        break;
      }
    }
    
    if (isCustom) {
      merchantData[merchantKey].source = 'custom';
    } else if (cat !== 'Other') {
      merchantData[merchantKey].source = 'auto';
    }
  });
  
  const merchants = Object.values(merchantData).sort((a, b) => b.total - a.total);
  const knownCount = merchants.filter(m => m.source).length;
  const customCount = Object.keys(merchantRules).length;
  const unknownCount = merchants.filter(m => !m.source || m.category === 'Other').length;
  
  // Update stats
  $('statKnownMerchants').textContent = knownCount;
  $('statCustomRules').textContent = customCount;
  $('statUnknownMerchants').textContent = unknownCount;
  
  // Show unknown alert
  if (unknownCount > 0) {
    $('unknownAlert').classList.remove('hidden');
    $('unknownCount').textContent = unknownCount;
  } else {
    $('unknownAlert').classList.add('hidden');
  }
  
  // Populate category filter
  $('merchantCatFilter').innerHTML = '<option value="all">All Categories</option>' + 
    Object.entries(CATS).map(([cat, cfg]) => `<option value="${cat}">${cfg.i} ${cat}</option>`).join('');
  
  // Store for filtering
  window.allMerchants = merchants;
  filterMerchants();
}

function filterMerchants() {
  const search = $('merchantSearch').value.toLowerCase();
  const filter = $('merchantFilter').value;
  const catFilter = $('merchantCatFilter').value;
  
  let merchants = window.allMerchants || [];
  
  // Apply filters
  if (search) {
    merchants = merchants.filter(m => m.name.toLowerCase().includes(search) || m.sampleDesc.toLowerCase().includes(search));
  }
  
  if (filter === 'uncategorized') {
    merchants = merchants.filter(m => !m.source || m.category === 'Other');
  } else if (filter === 'custom') {
    merchants = merchants.filter(m => m.source === 'custom');
  } else if (filter === 'auto') {
    merchants = merchants.filter(m => m.source === 'auto');
  }
  
  if (catFilter !== 'all') {
    merchants = merchants.filter(m => m.category === catFilter);
  }
  
  // Render list
  $('merchantList').innerHTML = merchants.length ? merchants.map(m => {
    const cat = CATS[m.category] || CATS.Other;
    const isUncat = !m.source || m.category === 'Other';
    const isCustom = m.source === 'custom';
    
    return `
      <div class="merchant-item ${isUncat ? 'uncategorized' : ''} ${isCustom ? 'custom-rule' : ''}">
        <div class="merchant-icon" style="background:${cat.c}22">${cat.i}</div>
        <div class="merchant-info">
          <div class="merchant-name">${m.name}</div>
          <div class="merchant-meta">
            <span>ðŸ“Š ${m.count} txns</span>
            <span>ðŸ’° ${fmt(m.total)}</span>
            ${isCustom ? '<span style="color:var(--green)">âœï¸ Custom rule</span>' : ''}
            ${m.source === 'auto' ? '<span style="color:var(--accent)">ðŸ¤– Auto-detected</span>' : ''}
          </div>
        </div>
        <div class="merchant-category">
          <div class="quick-cat-dropdown">
            <button class="quick-cat-btn" onclick="toggleQuickCatMenu(this, '${m.name.replace(/'/g, "\\'")}')">
              <span>${cat.i}</span>
              <span>${m.category}</span>
              <span>â–¼</span>
            </button>
            <div class="quick-cat-menu" id="menu-${m.name.replace(/[^a-zA-Z0-9]/g, '_')}">
              ${Object.entries(CATS).map(([catName, cfg]) => `
                <div class="quick-cat-option" onclick="setMerchantCategory('${m.name.replace(/'/g, "\\'")}', '${catName}')">
                  <span>${cfg.i}</span>
                  <span>${catName}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('') : '<div class="empty-state"><div class="empty-icon">ðŸª</div><h2>No merchants found</h2><p>Adjust your filters</p></div>';
}

function toggleQuickCatMenu(btn, merchantName) {
  // Close all other menus
  document.querySelectorAll('.quick-cat-menu.show').forEach(m => m.classList.remove('show'));
  
  const menu = btn.nextElementSibling;
  menu.classList.toggle('show');
  
  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

function setMerchantCategory(merchantName, category) {
  // Add as custom rule
  merchantRules[merchantName] = category;
  saveData();
  
  // Re-categorize all transactions with this merchant
  recategorizeMerchant(merchantName, category);
  
  // Close menu and refresh
  document.querySelectorAll('.quick-cat-menu.show').forEach(m => m.classList.remove('show'));
  
  notify(`${merchantName} â†’ ${CATS[category].i} ${category}`);
  renderMerchantsPage();
}

function recategorizeMerchant(merchantName, category) {
  // Update catOverrides for all transactions matching this merchant
  activeTxns.forEach(t => {
    if (t.description.toUpperCase().includes(merchantName.toUpperCase())) {
      catOverrides[t.description] = category;
      t.category = category;
    }
  });
  
  saveData();
  applyFilters();
}

function showAddMerchantModal() {
  selectedMerchantCat = null;
  editingMerchantKeyword = null;
  $('merchantModalTitle').textContent = 'âž• Add Merchant Rule';
  $('merchantKeyword').value = '';
  
  // Render category grid
  $('merchantCatGrid').innerHTML = Object.entries(CATS).filter(([cat]) => cat !== 'Other').map(([cat, cfg]) => `
    <div class="cat-opt-small" onclick="selectMerchantCat('${cat}', this)">
      <span class="cat-icon">${cfg.i}</span>
      <span>${cat}</span>
    </div>
  `).join('');
  
  $('merchantModal').classList.remove('hidden');
}

function hideMerchantModal() {
  $('merchantModal').classList.add('hidden');
}

function selectMerchantCat(cat, el) {
  selectedMerchantCat = cat;
  document.querySelectorAll('.cat-opt-small').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

function saveMerchantRule() {
  const keyword = $('merchantKeyword').value.trim().toUpperCase();
  
  if (!keyword) {
    notify('Please enter a merchant keyword', 'error');
    return;
  }
  
  if (!selectedMerchantCat) {
    notify('Please select a category', 'error');
    return;
  }
  
  // Save rule
  merchantRules[keyword] = selectedMerchantCat;
  saveData();
  
  // Apply to existing transactions
  activeTxns.forEach(t => {
    if (t.description.toUpperCase().includes(keyword)) {
      catOverrides[t.description] = selectedMerchantCat;
      t.category = selectedMerchantCat;
    }
  });
  
  saveData();
  hideMerchantModal();
  notify(`Rule added: "${keyword}" â†’ ${CATS[selectedMerchantCat].i} ${selectedMerchantCat}`);
  renderMerchantsPage();
  applyFilters();
}

function applyMerchantRules() {
  let count = 0;
  
  activeTxns.forEach(t => {
    const oldCat = t.category;
    const newCat = categorize(t.description);
    
    if (newCat !== oldCat && newCat !== 'Other') {
      t.category = newCat;
      catOverrides[t.description] = newCat;
      count++;
    }
  });
  
  if (count > 0) {
    saveData();
    applyFilters();
    notify(`Updated ${count} transactions`);
  } else {
    notify('All transactions already categorized');
  }
  
  renderMerchantsPage();
}

function scrollToUnknown() {
  $('merchantFilter').value = 'uncategorized';
  filterMerchants();
  $('merchantList').scrollIntoView({ behavior: 'smooth' });
}

function deleteMerchantRule(keyword) {
  if (confirm(`Delete rule for "${keyword}"?`)) {
    delete merchantRules[keyword];
    saveData();
    notify('Rule deleted');
    renderMerchantsPage();
  }
}

// Admin Functions
async function loadAllUsers() {
  const snap = await db.ref('users').once('value');
  allUsers = snap.val() || {};
  if ($('usersBadge2')) $('usersBadge2').textContent = Object.keys(allUsers).length;
}

function renderUsers() {
  const users = Object.entries(allUsers);
  const admins = users.filter(([,u]) => u.role === 'admin').length;
  if ($('statUsers')) $('statUsers').textContent = users.length;
  if ($('statAdmins')) $('statAdmins').textContent = admins;
  
  $('usersList').innerHTML = users.map(([uid, u]) => {
    const initial = (u.name || u.email || '?')[0].toUpperCase();
    const isMe = uid === currentUser.uid;
    return `<div class="user-card">
      <div class="user-avatar">${initial}</div>
      <div class="user-info">
        <div class="user-name">${u.name || 'No name'}<span class="role-badge ${u.role}">${u.role}</span></div>
        <div class="user-email">${u.email}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">Joined ${new Date(u.createdAt).toLocaleDateString()}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${!isMe ? `<button class="btn btn-small btn-blue" onclick="viewUserData('${uid}')">ðŸ‘ï¸ View</button>` : ''}
        ${!isMe && u.role !== 'admin' ? `<button class="btn btn-small btn-green" onclick="makeAdmin('${uid}')">ðŸ‘‘ Admin</button>` : ''}
        ${!isMe ? `<button class="btn btn-small btn-red" onclick="deleteUser('${uid}')">ðŸ—‘ï¸</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function viewUserData(uid) {
  viewingUserId = uid;
  const snap = await db.ref('data/' + uid).once('value');
  const data = snap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  $('profileLabel').textContent = 'ðŸ‘ï¸ Viewing: ' + (allUsers[uid]?.name || allUsers[uid]?.email);
  renderImports();
  loadActiveTxns();
  switchPage('overview');
  notify('Viewing ' + (allUsers[uid]?.name || 'user') + "'s data");
}

async function makeAdmin(uid) {
  if (!confirm('Make this user an admin?')) return;
  await db.ref('users/' + uid + '/role').set('admin');
  allUsers[uid].role = 'admin';
  renderUsers();
  notify('User is now admin');
}

async function deleteUser(uid) {
  if (!confirm('Delete this user and ALL their data?')) return;
  await db.ref('users/' + uid).remove();
  await db.ref('data/' + uid).remove();
  delete allUsers[uid];
  renderUsers();
  notify('User deleted');
}

function showInviteModal() {
  $('inviteEmail').value = '';
  $('inviteName').value = '';
  $('invitePassword').value = '';
  $('inviteModal').classList.remove('hidden');
}

function hideInviteModal() {
  $('inviteModal').classList.add('hidden');
}

async function createUser() {
  const email = $('inviteEmail').value.trim();
  const name = $('inviteName').value.trim();
  const password = $('invitePassword').value;
  
  if (!email || !name || !password) {
    notify('Fill all fields', 'warning');
    return;
  }
  if (password.length < 6) {
    notify('Password must be 6+ characters', 'warning');
    return;
  }
  
  try {
    // Create with secondary auth to keep admin signed in
    const tempApp = firebase.initializeApp(firebaseConfig, 'temp' + Date.now());
    const tempAuth = tempApp.auth();
    const cred = await tempAuth.createUserWithEmailAndPassword(email, password);
    await cred.user.updateProfile({ displayName: name });
    await db.ref('users/' + cred.user.uid).set({ email, name, role: 'user', createdAt: Date.now() });
    await tempAuth.signOut();
    await tempApp.delete();
    
    allUsers[cred.user.uid] = { email, name, role: 'user', createdAt: Date.now() };
    $('usersBadge').textContent = Object.keys(allUsers).length;
    hideInviteModal();
    renderUsers();
    notify('User created! They can sign in with: ' + email);
  } catch (e) {
    notify(e.message, 'warning');
  }
}

// Print Report
function printReport() {
  // Generate summary for print
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const net = income - expenses;
  const sr = income > 0 ? (net / income * 100).toFixed(1) : 0;
  
  // Category breakdown
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { 
    cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); 
  });
  const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Bank Report - ${new Date().toLocaleDateString()}</title>
      <style>
        body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
        h1{color:#0f172a;border-bottom:2px solid #22d3ee;padding-bottom:10px}
        h2{color:#334155;margin-top:30px}
        .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:20px 0}
        .stat{background:#f8fafc;padding:15px;border-radius:8px;text-align:center}
        .stat-value{font-size:24px;font-weight:bold;color:#0f172a}
        .stat-label{font-size:12px;color:#64748b;margin-top:5px}
        .green{color:#059669}.red{color:#dc2626}.blue{color:#0891b2}
        table{width:100%;border-collapse:collapse;margin:20px 0}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #e2e8f0}
        th{background:#f8fafc;font-weight:600}
        .amount{text-align:right;font-family:monospace}
        .footer{margin-top:40px;text-align:center;color:#64748b;font-size:12px}
      </style>
    </head>
    <body>
      <h1>ðŸ’³ Bank Analyzer Report</h1>
      <p>Generated: ${new Date().toLocaleString()}</p>
      <p>Period: ${filteredTxns.length ? filteredTxns[0].date + ' - ' + filteredTxns[filteredTxns.length-1].date : 'N/A'}</p>
      
      <div class="summary">
        <div class="stat"><div class="stat-value green">â‚¬${income.toFixed(2)}</div><div class="stat-label">Income</div></div>
        <div class="stat"><div class="stat-value red">â‚¬${expenses.toFixed(2)}</div><div class="stat-label">Expenses</div></div>
        <div class="stat"><div class="stat-value blue">â‚¬${net.toFixed(2)}</div><div class="stat-label">Net</div></div>
        <div class="stat"><div class="stat-value">${sr}%</div><div class="stat-label">Savings Rate</div></div>
      </div>
      
      <h2>ðŸ“Š Spending by Category</h2>
      <table>
        <tr><th>Category</th><th class="amount">Amount</th><th class="amount">%</th></tr>
        ${sortedCats.map(([cat, amt]) => `<tr><td>${CATS[cat]?.i || 'ðŸ’³'} ${cat}</td><td class="amount">â‚¬${amt.toFixed(2)}</td><td class="amount">${(amt/expenses*100).toFixed(1)}%</td></tr>`).join('')}
      </table>
      
      <h2>ðŸ”¥ Top 10 Expenses</h2>
      <table>
        <tr><th>#</th><th>Description</th><th>Date</th><th>Category</th><th class="amount">Amount</th></tr>
        ${filteredTxns.filter(t => t.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10).map((t,i) => `<tr><td>${i+1}</td><td>${t.description.slice(0,40)}</td><td>${t.date}</td><td>${t.category}</td><td class="amount red">â‚¬${Math.abs(t.amount).toFixed(2)}</td></tr>`).join('')}
      </table>
      
      <h2>ðŸ“ All Transactions (${filteredTxns.length})</h2>
      <table>
        <tr><th>Date</th><th>Description</th><th>Category</th><th class="amount">Amount</th></tr>
        ${filteredTxns.slice().reverse().map(t => `<tr><td>${t.date}</td><td>${t.description.slice(0,40)}</td><td>${t.category}</td><td class="amount ${t.amount > 0 ? 'green' : 'red'}">${t.amount > 0 ? '+' : ''}â‚¬${t.amount.toFixed(2)}</td></tr>`).join('')}
      </table>
      
      <div class="footer">
        <p>Bank Analyzer v9 â€¢ Cloud Sync Edition</p>
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// ==================== STOCKS ====================

const STOCK_API = 'https://query1.finance.yahoo.com/v8/finance/chart/';
const MARKET_INDICES = [
  { symbol: '^GSPC', name: 'S&P 500' },
  { symbol: '^DJI', name: 'Dow Jones' },
  { symbol: '^IXIC', name: 'NASDAQ' },
  { symbol: '^FTSE', name: 'FTSE 100' }
];

async function fetchStockPrice(symbol) {
  try {
    // Try multiple CORS proxies
    const proxies = [
      'https://api.allorigins.win/raw?url=',
      'https://corsproxy.io/?',
      'https://api.codetabs.com/v1/proxy?quest='
    ];
    
    const targetUrl = STOCK_API + symbol + '?interval=1d&range=5d';
    
    for (const proxy of proxies) {
      try {
        const url = proxy + encodeURIComponent(targetUrl);
        const res = await fetch(url, { timeout: 5000 });
        if (!res.ok) continue;
        
        const data = await res.json();
        
        if (data.chart?.result?.[0]) {
          const result = data.chart.result[0];
          const meta = result.meta;
          
          return {
            symbol: meta.symbol,
            price: meta.regularMarketPrice,
            previousClose: meta.previousClose || meta.chartPreviousClose,
            currency: meta.currency,
            name: meta.shortName || meta.symbol,
            change: meta.regularMarketPrice - (meta.previousClose || meta.chartPreviousClose),
            changePercent: ((meta.regularMarketPrice - (meta.previousClose || meta.chartPreviousClose)) / (meta.previousClose || meta.chartPreviousClose) * 100)
          };
        }
      } catch (proxyError) {
        console.log('Proxy failed:', proxy, proxyError.message);
        continue;
      }
    }
    return null;
  } catch (e) {
    console.error('Error fetching stock:', symbol, e);
    return null;
  }
}

async function loadStocks() {
  if ($('stocksBadge2')) $('stocksBadge2').textContent = Object.keys(stocks).length;
  $('emailEnabled').checked = emailSettings.enabled;
  $('notificationEmail').value = emailSettings.email || currentUser.email;
  
  if (Object.keys(stocks).length === 0) {
    $('stocksList').innerHTML = '';
    $('noStocks').classList.remove('hidden');
    $('portfolioSummary').classList.add('hidden');
    renderMarketOverview();
    return;
  }
  
  $('noStocks').classList.add('hidden');
  $('portfolioSummary').classList.remove('hidden');
  
  // Fetch current prices
  $('stocksList').innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="color:var(--muted)">Loading prices...</p></div>';
  
  const symbols = [...new Set(Object.values(stocks).map(s => s.symbol))];
  for (const symbol of symbols) {
    const price = await fetchStockPrice(symbol);
    if (price) stockPrices[symbol] = price;
  }
  
  renderStocks();
  renderMarketOverview();
}

function renderStocks() {
  let totalInvested = 0;
  let totalValue = 0;
  
  const stockList = Object.entries(stocks).map(([id, stock]) => {
    const price = stockPrices[stock.symbol];
    const currentPrice = price?.price || stock.purchasePrice;
    const invested = stock.shares * stock.purchasePrice;
    const value = stock.shares * currentPrice;
    const gain = value - invested;
    const gainPct = invested > 0 ? (gain / invested * 100) : 0;
    
    totalInvested += invested;
    totalValue += value;
    
    return {
      id, ...stock,
      currentPrice,
      invested,
      value,
      gain,
      gainPct,
      priceData: price
    };
  }).sort((a, b) => b.value - a.value);
  
  const totalGain = totalValue - totalInvested;
  const totalGainPct = totalInvested > 0 ? (totalGain / totalInvested * 100) : 0;
  
  // Update summary
  $('totalInvested').textContent = fmt(totalInvested);
  $('totalValue').textContent = fmt(totalValue);
  $('totalValue').className = 'card-value ' + (totalGain >= 0 ? 'green' : 'red');
  $('totalGain').textContent = (totalGain >= 0 ? '+' : '') + fmt(totalGain);
  $('totalGain').className = 'card-value ' + (totalGain >= 0 ? 'green' : 'red');
  $('totalGainPct').textContent = (totalGain >= 0 ? '+' : '') + totalGainPct.toFixed(2) + '%';
  $('holdingsCount').textContent = stockList.length;
  
  // Render stock cards
  $('stocksList').innerHTML = stockList.map(s => `
    <div class="stock-card ${s.gain >= 0 ? 'profit' : 'loss'}">
      <div class="stock-symbol">${s.symbol}</div>
      <div class="stock-info">
        <div class="stock-name">${s.priceData?.name || s.symbol}</div>
        <div class="stock-meta">
          ${s.shares} shares @ ${fmt(s.purchasePrice)} â€¢ Invested: ${fmt(s.invested)}
        </div>
        <div class="stock-meta">
          Bought: ${new Date(s.purchaseDate).toLocaleDateString()} ${s.notes ? 'â€¢ ' + s.notes : ''}
        </div>
      </div>
      <div class="stock-values">
        <div class="stock-current">${fmt(s.value)}</div>
        <div class="stock-gain ${s.gain >= 0 ? 'profit' : 'loss'}">
          ${s.gain >= 0 ? '+' : ''}${fmt(s.gain)} (${s.gain >= 0 ? '+' : ''}${s.gainPct.toFixed(2)}%)
        </div>
        <div style="font-size:11px;color:var(--muted)">@ ${fmt(s.currentPrice)}/share</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-small btn-blue" onclick="editStock('${s.id}')">âœï¸</button>
        <button class="btn btn-small btn-red" onclick="deleteStock('${s.id}')">ðŸ—‘ï¸</button>
      </div>
    </div>
  `).join('');
}

async function renderMarketOverview() {
  $('marketOverview').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px"><div class="spinner"></div></div>';
  
  const indices = [];
  for (const index of MARKET_INDICES) {
    const data = await fetchStockPrice(index.symbol);
    if (data) indices.push({ ...index, ...data });
  }
  
  $('marketOverview').innerHTML = indices.map(idx => `
    <div class="card">
      <div class="card-label">${idx.name}</div>
      <div class="card-value" style="font-size:18px">${idx.price?.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) || 'N/A'}</div>
      <div class="card-sub ${idx.change >= 0 ? 'green' : 'red'}" style="color:${idx.change >= 0 ? 'var(--green)' : 'var(--red)'}">
        ${idx.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(idx.change || 0).toFixed(2)} (${(idx.changePercent || 0).toFixed(2)}%)
      </div>
    </div>
  `).join('') || '<div style="color:var(--muted);text-align:center;padding:20px">Unable to load market data</div>';
}

function showAddStockModal() {
  editingStockId = null;
  $('stockModalTitle').textContent = 'ðŸ“ˆ Add Stock';
  $('stockSymbol').value = '';
  $('stockShares').value = '';
  $('stockPrice').value = '';
  $('stockDate').value = new Date().toISOString().split('T')[0];
  $('stockNotes').value = '';
  $('stockModal').classList.remove('hidden');
}

function editStock(id) {
  const stock = stocks[id];
  if (!stock) return;
  
  editingStockId = id;
  $('stockModalTitle').textContent = 'âœï¸ Edit Stock';
  $('stockSymbol').value = stock.symbol;
  $('stockShares').value = stock.shares;
  $('stockPrice').value = stock.purchasePrice;
  $('stockDate').value = stock.purchaseDate;
  $('stockNotes').value = stock.notes || '';
  $('stockModal').classList.remove('hidden');
}

function hideStockModal() {
  $('stockModal').classList.add('hidden');
  editingStockId = null;
}

async function saveStock() {
  const symbol = $('stockSymbol').value.toUpperCase().trim();
  const shares = parseFloat($('stockShares').value);
  const price = parseFloat($('stockPrice').value);
  const date = $('stockDate').value;
  const notes = $('stockNotes').value.trim();
  
  if (!symbol || !shares || !price || !date) {
    notify('Please fill all required fields', 'warning');
    return;
  }
  
  // Try to verify symbol exists, but allow saving anyway
  const priceData = await fetchStockPrice(symbol);
  if (!priceData) {
    // Ask user if they want to save anyway
    if (!confirm(`Could not verify stock symbol "${symbol}" (API may be unavailable).\n\nSave anyway?`)) {
      return;
    }
  }
  
  const id = editingStockId || 'stock_' + Date.now();
  stocks[id] = {
    symbol,
    shares,
    purchasePrice: price,
    purchaseDate: date,
    notes,
    addedAt: stocks[id]?.addedAt || Date.now()
  };
  
  await saveData();
  hideStockModal();
  loadStocks();
  notify(editingStockId ? 'Stock updated' : 'Stock added');
}

async function deleteStock(id) {
  if (!confirm('Delete this stock from your portfolio?')) return;
  delete stocks[id];
  await saveData();
  loadStocks();
  notify('Stock removed');
}

// Email notification settings
function toggleEmailNotifications() {
  emailSettings.enabled = $('emailEnabled').checked;
}

async function saveEmailSettings() {
  emailSettings.enabled = $('emailEnabled').checked;
  emailSettings.email = $('notificationEmail').value.trim();
  
  if (emailSettings.enabled && !emailSettings.email) {
    notify('Please enter an email address', 'warning');
    return;
  }
  
  await saveData();
  
  // Save to a separate notifications collection for the cloud function to process
  if (emailSettings.enabled) {
    await db.ref('notifications/' + currentUser.uid).set({
      email: emailSettings.email,
      enabled: true,
      stocks: stocks,
      updatedAt: Date.now()
    });
    notify('Email notifications saved');
  } else {
    await db.ref('notifications/' + currentUser.uid).remove();
    notify('Email notifications disabled');
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Set up file upload
  const uploadZone = $('uploadZone');
  const fileInput = $('fileInput');
  
  if (uploadZone && fileInput) {
    uploadZone.onclick = () => fileInput.click();
    uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add('dragover'); };
    uploadZone.ondragleave = () => uploadZone.classList.remove('dragove