<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer v9</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
:root{--bg:#0f172a;--bg2:#1e293b;--card:rgba(30,41,59,0.5);--item:rgba(51,65,85,0.3);--border:#334155;--text:#f8fafc;--text2:#94a3b8;--muted:#64748b;--accent:#22d3ee;--green:#34d399;--red:#fb7185}
.light{--bg:#f1f5f9;--bg2:#e2e8f0;--card:rgba(255,255,255,0.8);--item:rgba(241,245,249,0.8);--border:#cbd5e1;--text:#0f172a;--text2:#475569;--muted:#64748b}
.midnight{--bg:#0a0a1a;--bg2:#12122a;--card:rgba(20,20,40,0.7);--item:rgba(30,30,60,0.5);--border:#2a2a4a;--accent:#8b5cf6;--green:#a78bfa;--red:#f472b6}
.nature{--bg:#1a2f1a;--bg2:#243524;--card:rgba(30,50,30,0.6);--item:rgba(40,60,40,0.4);--border:#3a5a3a;--accent:#86efac;--green:#4ade80;--red:#fca5a5}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);min-height:100vh;transition:all .3s ease}

/* Animations */
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes countUp{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes drawLine{from{stroke-dashoffset:283}to{stroke-dashoffset:0}}
.animate-in{animation:fadeInUp 0.5s ease forwards;opacity:0}
.pulse{animation:pulse 2s ease infinite}

/* Widget System */
.widget{margin-bottom:20px;transition:all .3s ease}
.widget.hidden-widget{display:none!important}
.widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.widget-header h3{margin:0;font-size:15px;display:flex;align-items:center;gap:8px}
.widget-badge{font-size:10px;padding:3px 8px;background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;border-radius:12px;font-weight:600}

/* Dashboard Controls */
.dashboard-controls{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:24px;padding:16px;background:var(--card);border-radius:14px;border:1px solid var(--border)}
.dashboard-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}

/* Radial Progress */
.radial-box{text-align:center;padding:24px}
.radial-container{width:140px;height:140px;margin:0 auto}
.radial-progress{width:100%;height:100%;transform:rotate(-90deg)}
.radial-bg{fill:none;stroke:var(--border);stroke-width:8}
.radial-fill{fill:none;stroke:var(--accent);stroke-width:8;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1.5s ease}
.radial-fill.savings{stroke:var(--green)}
.radial-fill.month{stroke:#a78bfa}
.radial-text{fill:var(--text);font-size:18px;font-weight:700;text-anchor:middle;dominant-baseline:middle;transform:rotate(90deg);transform-origin:50% 50%}
.radial-label{fill:var(--muted);font-size:6px;text-anchor:middle;transform:rotate(90deg);transform-origin:50% 50%}

/* Sankey Chart */
.sankey-box{overflow:hidden}
.sankey-box .link{fill:none;stroke-opacity:0.4;transition:stroke-opacity .2s}
.sankey-box .link:hover{stroke-opacity:0.7}
.sankey-box .node rect{fill-opacity:0.9;transition:fill-opacity .2s}
.sankey-box .node rect:hover{fill-opacity:1}
.sankey-box .node text{font-size:11px;fill:var(--text)}

/* Treemap */
#treemapChart{border-radius:8px;overflow:hidden}
.treemap-cell{transition:all .2s}
.treemap-cell:hover{filter:brightness(1.2)}
.treemap-label{font-size:11px;font-weight:600;fill:#fff;text-shadow:1px 1px 2px rgba(0,0,0,0.5);pointer-events:none}
.treemap-value{font-size:9px;fill:rgba(255,255,255,0.8);pointer-events:none}

/* Race Chart */
.race-controls{display:flex;align-items:center;gap:12px}
.race-month{font-size:14px;font-weight:600;color:var(--accent);min-width:80px}
.race-bar{height:28px;margin-bottom:6px;border-radius:4px;display:flex;align-items:center;transition:width 0.5s ease}
.race-bar-inner{height:100%;border-radius:4px;display:flex;align-items:center;padding:0 10px;min-width:60px}
.race-bar-label{font-size:11px;font-weight:600;color:#fff;white-space:nowrap;margin-right:8px}
.race-bar-value{font-size:10px;color:rgba(255,255,255,0.8);font-family:monospace}

/* Customize Modal */
.customize-section{margin-bottom:24px}
.customize-section h4{font-size:14px;margin-bottom:12px;color:var(--text)}
.theme-options{display:flex;gap:12px;flex-wrap:wrap}
.theme-opt{cursor:pointer;text-align:center;padding:8px;border-radius:10px;border:2px solid transparent;transition:all .2s}
.theme-opt:hover{border-color:var(--border)}
.theme-opt.selected{border-color:var(--accent)}
.theme-preview{width:60px;height:40px;border-radius:6px;margin-bottom:6px}
.theme-preview.dark{background:linear-gradient(135deg,#0f172a,#1e293b)}
.theme-preview.light{background:linear-gradient(135deg,#f1f5f9,#e2e8f0)}
.theme-preview.midnight{background:linear-gradient(135deg,#0a0a1a,#12122a)}
.theme-preview.nature{background:linear-gradient(135deg,#1a2f1a,#243524)}
.theme-opt span{font-size:11px;color:var(--text2)}

.widget-toggles{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px}
.widget-toggle{display:flex;align-items:center;gap:8px;padding:10px;background:var(--item);border-radius:8px;cursor:pointer;transition:all .2s}
.widget-toggle:hover{background:var(--card)}
.widget-toggle input{width:18px;height:18px;accent-color:var(--accent)}
.widget-toggle span{font-size:13px}

.size-options{display:flex;gap:20px}
.size-options label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px}
.size-options input{accent-color:var(--accent)}

/* Card sizes */
.card-size-small .card{padding:12px}
.card-size-small .card-value{font-size:18px}
.card-size-large .card{padding:24px}
.card-size-large .card-value{font-size:28px}

/* Layout variations */
.layout-compact .widget{margin-bottom:12px}
.layout-compact .chart-box{padding:14px}
.layout-compact .grid-2{gap:12px}
.layout-minimal .widget[data-widget="insights"],.layout-minimal .widget[data-widget="quickstats"],.layout-minimal .widget[data-widget="radials"]{display:none}
.layout-detailed .chart-container{height:320px}

/* AI Chat Panel */
.ai-chat-panel{position:fixed;right:20px;bottom:20px;width:400px;max-width:calc(100vw - 40px);height:600px;max-height:calc(100vh - 100px);background:var(--bg);border:1px solid var(--border);border-radius:20px;display:flex;flex-direction:column;z-index:1000;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

.ai-chat-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(139,92,246,0.1));border-radius:20px 20px 0 0}
.ai-chat-title{display:flex;align-items:center;gap:12px}
.ai-avatar{font-size:32px;animation:bounce 2s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.ai-chat-title h3{font-size:16px;margin:0}
.ai-status{font-size:11px;color:var(--green)}
.ai-chat-close{background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:8px;border-radius:8px}
.ai-chat-close:hover{background:var(--item)}

.ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
.ai-message{display:flex;gap:10px;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.ai-message.user{flex-direction:row-reverse}
.ai-message-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.ai-message.bot .ai-message-avatar{background:linear-gradient(135deg,var(--accent),#8b5cf6)}
.ai-message.user .ai-message-avatar{background:var(--green)}
.ai-message-content{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5}
.ai-message.bot .ai-message-content{background:var(--card);border:1px solid var(--border);border-radius:16px 16px 16px 4px}
.ai-message.user .ai-message-content{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;border-radius:16px 16px 4px 16px}

.ai-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.ai-suggestions button{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:20px;color:var(--text);font-size:12px;cursor:pointer;transition:all .2s}
.ai-suggestions button:hover{background:var(--accent);color:#0f172a;border-color:var(--accent)}

.ai-chat-input{padding:16px;border-top:1px solid var(--border);display:flex;gap:10px}
.ai-chat-input input{flex:1;padding:12px 16px;background:var(--item);border:1px solid var(--border);border-radius:25px;color:var(--text);font-size:14px}
.ai-chat-input input:focus{outline:none;border-color:var(--accent)}
.ai-chat-input button{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--green));border:none;color:#0f172a;font-size:18px;cursor:pointer;transition:transform .2s}
.ai-chat-input button:hover{transform:scale(1.1)}

.ai-typing{display:flex;gap:4px;padding:8px 0}
.ai-typing span{width:8px;height:8px;background:var(--muted);border-radius:50%;animation:typing 1.4s infinite}
.ai-typing span:nth-child(2){animation-delay:0.2s}
.ai-typing span:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,100%{opacity:0.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-4px)}}

.ai-data-card{background:var(--item);border-radius:12px;padding:14px;margin-top:10px}
.ai-data-card h4{font-size:13px;margin-bottom:10px;color:var(--accent)}
.ai-data-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
.ai-data-row:last-child{border:none}
.ai-data-row .label{color:var(--text2)}
.ai-data-row .value{font-weight:600;font-family:monospace}
.ai-highlight{color:var(--accent);font-weight:600}

/* Financial Tools */
.tool-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.tool-tab{padding:12px 24px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text2);font-size:14px;font-weight:500;cursor:pointer;transition:all .2s}
.tool-tab:hover{border-color:var(--accent);color:var(--text)}
.tool-tab.active{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;border-color:transparent}

.tool-panel{animation:fadeIn .3s ease}
.tool-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.tool-grid{grid-template-columns:1fr}}

.tool-input-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.tool-input-section h3{font-size:18px;margin-bottom:4px}
.tool-desc{color:var(--muted);font-size:13px;margin-bottom:20px}

.tool-form{display:flex;flex-direction:column;gap:16px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:12px;color:var(--text2);text-transform:uppercase;font-weight:500}
.input-with-icon{display:flex;align-items:center;background:var(--item);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.input-with-icon span{padding:12px;color:var(--muted);font-size:14px;min-width:40px;text-align:center}
.input-with-icon input{flex:1;padding:12px;background:transparent;border:none;color:var(--text);font-size:16px;font-family:monospace}
.input-with-icon input:focus{outline:none}
.input-with-icon:focus-within{border-color:var(--accent)}

.debt-strategies,.return-presets{margin-top:24px}
.debt-strategies h4,.return-presets h4{font-size:13px;margin-bottom:12px;color:var(--text2)}
.strategy-btn{padding:10px 16px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;cursor:pointer;margin:4px;transition:all .2s}
.strategy-btn:hover{background:var(--accent);color:#0f172a;border-color:var(--accent)}

.tool-result-section{display:flex;flex-direction:column;gap:16px}
.result-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;text-align:center}
.result-card.highlight{background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(139,92,246,0.1));border-color:var(--accent)}
.result-card.green-glow{background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(34,211,238,0.1));border-color:var(--green)}
.result-label{font-size:12px;color:var(--muted);text-transform:uppercase;margin-bottom:8px}
.result-value{font-size:32px;font-weight:700;font-family:monospace}
.result-sub{font-size:13px;color:var(--text2);margin-top:4px}

.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.savings-card{display:flex;align-items:center;gap:16px;text-align:left;background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(34,211,238,0.1));border-color:var(--green)}
.savings-card.hidden{display:none}
.savings-icon{font-size:40px}
.savings-title{font-size:13px;color:var(--text2)}
.savings-value{font-size:24px;font-weight:700;color:var(--green);font-family:monospace}
.savings-time{font-size:13px;color:var(--accent)}

.compound-visual{margin:16px 0}
.compound-bar{display:flex;height:40px;border-radius:10px;overflow:hidden}
.compound-part{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:#fff;transition:width .5s ease}
.compound-part.contributions{background:var(--accent)}
.compound-part.interest{background:var(--green)}

.milestone-list{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
.milestone-list h4{font-size:13px;margin-bottom:12px}
.milestone-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
.milestone-item:last-child{border:none}
.milestone-icon{margin-right:8px}

/* What If Scenarios */
.whatif-scenarios{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.scenario-card{background:var(--item);border:2px solid var(--border);border-radius:14px;padding:20px;text-align:center;cursor:pointer;transition:all .2s}
.scenario-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.scenario-card.selected{border-color:var(--accent);background:rgba(34,211,238,0.1)}
.scenario-icon{font-size:32px;margin-bottom:8px}
.scenario-title{font-weight:600;font-size:14px;margin-bottom:4px}
.scenario-desc{font-size:11px;color:var(--muted)}

.scenario-inputs{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
.scenario-inputs h4{margin-bottom:16px}
.scenario-form select{width:100%;padding:12px;background:var(--item);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px}

.whatif-comparison{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.comparison-header{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;margin-bottom:20px;text-align:center}
.comparison-header h4{font-size:14px;color:var(--text2)}
.comparison-arrow{font-size:20px;color:var(--accent)}

.comparison-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
.comparison-row:last-child{border:none}
.comparison-label{font-size:13px;color:var(--text2)}
.comparison-values{display:flex;align-items:center;gap:12px;font-family:monospace;font-weight:600}
.comparison-values .arrow{color:var(--muted);font-size:12px}

.impact-card{background:var(--item);border-radius:12px;padding:16px;margin-top:20px}
.impact-card h4{margin-bottom:12px;font-size:14px}
.impact-item{display:flex;justify-content:space-between;padding:8px 0;font-size:13px}
.impact-label{color:var(--text2)}
.impact-value{font-family:monospace;font-weight:600}

.whatif-tip{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(34,211,238,0.1);border-radius:12px;margin-top:16px}
.tip-icon{font-size:24px}
.tip-text{font-size:13px;color:var(--text2)}
.container{max-width:1200px;margin:0 auto;padding:20px}
.hidden{display:none!important}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}

/* Auth */
.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;max-width:400px;width:100%}
.auth-box h1{font-size:28px;margin-bottom:8px}
.auth-box p{color:var(--muted);margin-bottom:24px}
.auth-input{width:100%;padding:14px;background:var(--item);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
.auth-input:focus{outline:none;border-color:var(--accent)}
.btn{padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;width:100%}
.btn-small{padding:8px 14px;font-size:12px}
.btn-red{background:rgba(251,113,133,0.15);border:1px solid rgba(251,113,133,0.3);color:var(--red)}
.btn-green{background:rgba(52,211,153,0.15);border:1px solid rgba(52,211,153,0.3);color:var(--green)}
.btn-blue{background:rgba(34,211,238,0.15);border:1px solid rgba(34,211,238,0.3);color:var(--accent)}
.auth-toggle{color:var(--accent);cursor:pointer;margin-top:20px;font-size:13px}
.auth-error{color:var(--red);font-size:13px;margin-top:12px;display:none}

/* Nav */
.nav{display:flex;background:var(--card);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100}
.nav-tab{padding:16px 20px;font-size:14px;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{border-color:var(--accent)}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--green),var(--accent));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.logo h1{font-size:22px}
.logo p{font-size:12px;color:var(--muted)}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative;overflow:hidden}
.card.glow-green{border-color:rgba(52,211,153,0.3);box-shadow:0 0 20px rgba(52,211,153,0.1)}
.card.glow-red{border-color:rgba(251,113,133,0.3);box-shadow:0 0 20px rgba(251,113,133,0.1)}
.card.glow-blue{border-color:rgba(34,211,238,0.3);box-shadow:0 0 20px rgba(34,211,238,0.1)}
.card-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.card-value{font-size:22px;font-weight:700;font-family:monospace}
.card-sub{font-size:11px;color:var(--muted);margin-top:4px}
.card-trend{font-size:11px;margin-top:6px;padding:3px 8px;border-radius:12px;display:inline-block}
.card-trend.up{background:rgba(52,211,153,0.15);color:var(--green)}
.card-trend.down{background:rgba(251,113,133,0.15);color:var(--red)}
.green{color:var(--green)}.red{color:var(--red)}.blue{color:var(--accent)}.purple{color:#a78bfa}.yellow{color:#fbbf24}

/* Insights Banner */
.insights-banner{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:24px}
.insight-card{background:linear-gradient(135deg,rgba(34,211,238,0.1),rgba(52,211,153,0.1));border:1px solid rgba(34,211,238,0.2);border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px}
.insight-card.warning{background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(251,113,133,0.1));border-color:rgba(251,191,36,0.3)}
.insight-card.success{background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(34,211,238,0.1));border-color:rgba(52,211,153,0.3)}
.insight-icon{font-size:28px}
.insight-text{flex:1}
.insight-title{font-weight:600;font-size:14px;margin-bottom:2px}
.insight-desc{font-size:12px;color:var(--text2)}

/* Prediction Box */
.prediction-box{background:linear-gradient(135deg,var(--card),rgba(99,102,241,0.1))}
.prediction-content{display:flex;gap:24px;flex-wrap:wrap}
.prediction-main{flex:1;min-width:200px}
.prediction-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.prediction-value{font-size:32px;font-weight:700;font-family:monospace;color:var(--accent)}
.prediction-sub{font-size:11px;color:var(--muted);margin-top:4px}
.prediction-breakdown{flex:1;min-width:200px;display:flex;flex-direction:column;gap:8px}
.prediction-item{display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid var(--border)}
.prediction-item:last-child{border:none}

/* Comparison */
.comparison-grid{display:flex;flex-direction:column;gap:16px}
.comparison-item{background:var(--item);border-radius:10px;padding:14px}
.comparison-label{font-size:12px;color:var(--muted);margin-bottom:8px}
.comparison-values{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:600;font-family:monospace}
.comparison-vs{font-size:11px;color:var(--muted);font-weight:400}
.comparison-current{color:var(--text)}
.comparison-prev{color:var(--muted)}
.comparison-change{font-size:12px;margin-top:6px;font-weight:500}

/* Quick Stats */
.quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.quick-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px}
.quick-icon{font-size:24px}
.quick-value{font-size:16px;font-weight:600;font-family:monospace}
.quick-label{font-size:11px;color:var(--muted)}

/* Alert dot */
.icon-btn{position:relative}
.alert-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* Transactions Page */
.txn-filters{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.filter-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
.filter-row:last-child{margin-bottom:0}
.filter-group{display:flex;flex-direction:column;gap:6px}
.filter-group label{font-size:11px;color:var(--muted);text-transform:uppercase}
.filter-input{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;min-width:120px}
.filter-input:focus{outline:none;border-color:var(--accent)}

.selection-bar{background:var(--accent);color:#0f172a;padding:12px 20px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;gap:16px}

.txn-table{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px}
.txn-table-header{display:grid;grid-template-columns:40px 90px 1fr 120px 100px 100px 60px;padding:12px 16px;background:var(--item);font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border)}
.txn-table-row{display:grid;grid-template-columns:40px 90px 1fr 120px 100px 100px 60px;padding:12px 16px;border-bottom:1px solid var(--bg2);align-items:center;transition:background .15s}
.txn-table-row:hover{background:var(--item)}
.txn-table-row.selected{background:rgba(34,211,238,0.1)}
.txn-col-check{display:flex;align-items:center;justify-content:center}
.txn-col-date{font-size:13px;color:var(--text2)}
.txn-col-desc{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:12px}
.txn-col-cat{font-size:12px}
.txn-col-cat span{padding:4px 8px;border-radius:6px;display:inline-block}
.txn-col-amount{font-family:monospace;font-weight:600;text-align:right}
.txn-col-balance{font-family:monospace;font-size:12px;color:var(--muted);text-align:right}
.txn-col-actions{display:flex;justify-content:center}

.pagination{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
.page-btn{padding:8px 14px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-size:13px}
.page-btn:hover{background:var(--card);border-color:var(--accent)}
.page-btn.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}
.page-btn:disabled{opacity:0.5;cursor:not-allowed}

.txn-summary{display:flex;justify-content:center;gap:32px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.summary-item{display:flex;align-items:center;gap:8px}
.summary-label{font-size:13px;color:var(--muted)}
.summary-value{font-size:16px;font-weight:600;font-family:monospace}

/* Alerts */
.alert-settings{background:var(--item);border-radius:10px;padding:16px;margin-bottom:16px}
.alert-setting{display:flex;align-items:center;gap:8px;padding:8px 0;font-size:14px;cursor:pointer}
.alert-setting input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
.inline-input{width:60px;padding:4px 8px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;text-align:center}

.alert-item{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:8px}
.alert-item.warning{border-left:3px solid #fbbf24}
.alert-item.danger{border-left:3px solid var(--red)}
.alert-item.info{border-left:3px solid var(--accent)}
.alert-item.success{border-left:3px solid var(--green)}
.alert-icon{font-size:20px}
.alert-content{flex:1}
.alert-title{font-weight:600;font-size:14px;margin-bottom:2px}
.alert-desc{font-size:12px;color:var(--muted)}
.alert-time{font-size:11px;color:var(--muted)}

/* Chart Box */
.chart-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.chart-box h3{font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.badge{font-size:10px;padding:2px 8px;background:var(--accent);color:#0f172a;border-radius:10px}
.chart-container{position:relative;height:260px}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}

/* Lists */
.list-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:8px}
.list-item:hover{background:var(--card)}
.list-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.list-info{flex:1;min-width:0}
.list-title{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.list-sub{font-size:12px;color:var(--muted)}
.list-value{font-family:monospace;font-weight:600;font-size:14px}
.rank{width:24px;height:24px;background:var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}

/* Transactions */
.txn-box{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px}
.txn-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.txn-item{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--bg2);cursor:pointer}
.txn-item:hover{background:var(--item)}
.txn-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.txn-details{flex:1;min-width:0}
.txn-desc{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txn-meta{font-size:11px;color:var(--muted)}
.txn-cat{padding:2px 6px;border-radius:6px;font-size:10px;margin-left:6px}
.txn-amount{text-align:right}
.txn-amt{font-weight:600;font-family:monospace}
.txn-bal{font-size:10px;color:var(--muted)}
.search-box{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;width:200px}
.show-more{width:100%;padding:12px;background:transparent;border:none;color:var(--text2);cursor:pointer}

/* Filters */
.filters{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.filter-select{padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
.month-pills{display:flex;gap:6px;flex-wrap:wrap}
.month-pill{padding:6px 12px;background:var(--item);border:1px solid var(--border);border-radius:20px;color:var(--text2);font-size:12px;cursor:pointer}
.month-pill.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}

/* Upload */
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;margin-bottom:24px;cursor:pointer}
.upload-zone:hover{border-color:var(--accent)}
.upload-zone input{display:none}
.upload-icon{font-size:48px;margin-bottom:12px}

/* Import Cards */
.import-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.import-card.inactive{opacity:0.5}
.import-icon{width:48px;height:48px;background:var(--item);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
.import-info{flex:1}
.import-name{font-weight:600;margin-bottom:4px}
.import-meta{font-size:12px;color:var(--muted)}
.import-toggle{width:48px;height:26px;background:var(--border);border-radius:13px;position:relative;cursor:pointer}
.import-toggle.active{background:var(--green)}
.import-toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
.import-toggle.active::after{transform:translateX(22px)}

/* Stats */
.import-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:24px}
.import-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.import-stat-value{font-size:24px;font-weight:700;color:var(--accent);font-family:monospace}
.import-stat-label{font-size:11px;color:var(--muted);margin-top:4px}

/* YoY */
.yoy-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
.yoy-item{padding:14px;background:var(--item);border-radius:10px;text-align:center}
.yoy-label{font-size:11px;color:var(--muted);margin-bottom:6px}
.yoy-values{display:flex;justify-content:center;gap:16px;margin-bottom:6px}
.yoy-year{text-align:center}
.yoy-year-label{font-size:10px;color:var(--muted)}
.yoy-year-value{font-size:15px;font-weight:600;font-family:monospace}
.yoy-change{font-size:12px;font-weight:500}
.yoy-change.up{color:var(--red)}.yoy-change.down{color:var(--green)}

/* Heatmap */
.heatmap{display:flex;gap:3px;overflow-x:auto;padding:10px 0}
.heatmap-week{display:flex;flex-direction:column;gap:3px}
.heatmap-cell{width:12px;height:12px;border-radius:2px;background:var(--item)}
.heatmap-cell.l1{background:rgba(34,197,94,0.3)}.heatmap-cell.l2{background:rgba(250,204,21,0.5)}.heatmap-cell.l3{background:rgba(249,115,22,0.6)}.heatmap-cell.l4{background:rgba(239,68,68,0.7)}

/* Weekday */
.weekday-bars{display:flex;gap:8px;align-items:flex-end;height:150px;padding:10px 0}
.weekday-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.weekday-fill{width:100%;border-radius:4px 4px 0 0;min-height:4px}
.weekday-label{font-size:11px;color:var(--text2)}
.weekday-value{font-size:9px;color:var(--muted);font-family:monospace}

/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-box{background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal-box h2{margin-bottom:16px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px}
.cat-opt{padding:10px;background:var(--item);border:2px solid transparent;border-radius:8px;cursor:pointer;text-align:center}
.cat-opt:hover{background:var(--card)}
.cat-opt.selected{border-color:var(--accent)}
.cat-opt-icon{font-size:20px}
.cat-opt-name{font-size:10px;color:var(--text2);margin-top:4px}
.note-input{width:100%;padding:10px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);margin-bottom:12px}

/* Notifications */
.notif-container{position:fixed;top:20px;right:20px;z-index:9999}
.notif{padding:14px 18px;background:var(--bg);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px;animation:slideIn .3s}
.notif.success{border-color:rgba(52,211,153,0.5)}
.notif.warning{border-color:rgba(251,191,36,0.5)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* User dropdown */
.user-menu{position:relative}
.user-dropdown{position:absolute;top:48px;right:0;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:200px;display:none}
.user-dropdown.show{display:block}
.user-item{padding:10px 12px;border-radius:8px;cursor:pointer}
.user-item:hover{background:var(--item)}

/* Empty */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:56px;margin-bottom:16px}

/* Savings gauge */
.savings-gauge{height:6px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden}
.savings-fill{height:100%;border-radius:3px}
.savings-fill.good{background:var(--green)}.savings-fill.ok{background:#fbbf24}.savings-fill.bad{background:var(--red)}

.page{display:none}.page.active{display:block}

/* User cards */
.user-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.user-card:hover{border-color:var(--accent)}
.user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--green));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:#0f172a}
.user-info{flex:1}
.user-name{font-weight:600;margin-bottom:2px}
.user-email{font-size:12px;color:var(--muted)}
.role-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;margin-left:8px}
.role-badge.admin{background:rgba(251,191,36,0.2);color:#fbbf24}
.role-badge.user{background:rgba(34,211,238,0.2);color:#22d3ee}

/* Stock cards */
.stock-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.stock-card:hover{border-color:var(--accent)}
.stock-card.profit{border-left:4px solid var(--green)}
.stock-card.loss{border-left:4px solid var(--red)}
.stock-symbol{width:60px;height:60px;background:var(--item);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--accent)}
.stock-info{flex:1}
.stock-name{font-weight:600;font-size:16px;margin-bottom:4px}
.stock-meta{font-size:12px;color:var(--muted)}
.stock-values{text-align:right}
.stock-current{font-size:18px;font-weight:700;font-family:monospace}
.stock-gain{font-size:14px;font-weight:600}
.stock-gain.profit{color:var(--green)}
.stock-gain.loss{color:var(--red)}

/* Print styles */
@media print {
  body{background:#fff!important;color:#000!important}
  .nav,.upload-zone,.filters,.btn,.icon-btn,.search-box,.show-more,.modal,.notif-container{display:none!important}
  .page{display:block!important}
  #pageImports,#pageUsers{display:none!important}
  .card,.chart-box,.txn-box,.list-item{background:#fff!important;border:1px solid #ddd!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .card-value,.list-value{color:#000!important}
  .green{color:#059669!important}.red{color:#dc2626!important}.blue{color:#0891b2!important}
}

@media(max-width:600px){.cards{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="notif-container" id="notifBox"></div>

<!-- Loading -->
<div class="auth-screen" id="loading"><div class="spinner"></div></div>

<!-- Auth -->
<div class="auth-screen hidden" id="authScreen">
  <div class="auth-box">
    <div style="font-size:48px;margin-bottom:16px">üí≥</div>
    <h1>Bank Analyzer</h1>
    <p id="authSubtitle">Sign in to continue</p>
    <input type="email" class="auth-input" id="authEmail" placeholder="Email">
    <input type="password" class="auth-input" id="authPassword" placeholder="Password">
    <input type="text" class="auth-input hidden" id="authName" placeholder="Your name">
    <button class="btn btn-primary" id="authBtn">Sign In</button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-toggle" id="authToggle">Don't have an account? Sign up</div>
  </div>
</div>

<!-- Main App -->
<div class="hidden" id="mainApp">
  <nav class="nav">
    <div class="nav-tab active" onclick="switchPage('overview')">üìä Overview</div>
    <div class="nav-tab" onclick="switchPage('transactions')">üìù Transactions</div>
    <div class="nav-tab" onclick="switchPage('tools')">üßÆ Tools</div>
    <div class="nav-tab" onclick="switchPage('imports')">üìÅ Imports <span class="badge" id="importsBadge">0</span></div>
    <div class="nav-tab" onclick="switchPage('stocks')">üìà Stocks <span class="badge" id="stocksBadge">0</span></div>
    <div class="nav-tab hidden" id="usersTab" onclick="switchPage('users')">üë• Users <span class="badge" id="usersBadge">0</span></div>
    <div class="nav-right">
      <button class="icon-btn" onclick="toggleAIChat()" id="aiChatBtn" title="AI Assistant">ü§ñ</button>
      <button class="icon-btn" onclick="showAlertsModal()" id="alertsBtn" title="Alerts">üîî<span class="alert-dot hidden" id="alertDot"></span></button>
      <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
      <button class="icon-btn" onclick="showRulesModal()">üìã</button>
      <button class="icon-btn" onclick="exportCSV()">üì•</button>
      <button class="icon-btn" onclick="printReport()">üñ®Ô∏è</button>
      <div class="user-menu">
        <button class="icon-btn" onclick="toggleUserMenu()">üë§</button>
        <div class="user-dropdown" id="userDropdown">
          <div style="padding:12px;border-bottom:1px solid var(--border)">
            <div style="font-weight:600" id="userName">User</div>
            <div style="font-size:12px;color:var(--muted)" id="userEmail">email</div>
            <div style="font-size:11px;color:var(--accent);margin-top:4px" id="userRole"></div>
          </div>
          <div class="user-item" onclick="signOut()">üö™ Sign Out</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Overview Page -->
  <div class="page active" id="pageOverview">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">üí≥</div>
          <div><h1>Bank Analyzer</h1><p id="profileLabel">Cloud Sync</p></div>
        </div>
      </header>

      <div id="emptyState" class="empty-state">
        <div class="empty-icon">üìä</div>
        <h2>No transactions</h2>
        <p>Go to Imports to add bank statements</p>
        <button class="btn btn-blue" onclick="switchPage('imports')" style="margin-top:16px">üìÅ Import PDFs</button>
      </div>

      <div id="dashboard" class="hidden">
        <!-- Dashboard Controls -->
        <div class="dashboard-controls">
          <div class="filters">
            <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
            <div class="month-pills" id="monthPills"></div>
          </div>
          <div class="dashboard-actions">
            <button class="btn btn-small btn-blue" onclick="resetFilters()">‚Ü∫ Reset</button>
            <button class="btn btn-small btn-green" onclick="showCustomizeModal()">‚öôÔ∏è Customize</button>
            <select class="filter-select" id="layoutSelect" onchange="changeLayout()">
              <option value="default">Default Layout</option>
              <option value="compact">Compact</option>
              <option value="detailed">Detailed</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>
        </div>

        <!-- Smart Insights Banner -->
        <div class="widget insights-banner" data-widget="insights" id="insightsBanner">
          <div class="insight-card" id="insight1"></div>
          <div class="insight-card" id="insight2"></div>
          <div class="insight-card" id="insight3"></div>
        </div>

        <!-- Main Stats Cards with Animated Counters -->
        <div class="widget cards" data-widget="stats">
          <div class="card glow-green animate-in"><div class="card-label">üí∞ Income</div><div class="card-value green counter" id="totalIncome" data-target="0">‚Ç¨0</div><div class="card-sub" id="incomeCount">0 txns</div><div class="card-trend" id="incomeTrend"></div></div>
          <div class="card glow-red animate-in" style="animation-delay:0.1s"><div class="card-label">üí∏ Expenses</div><div class="card-value red counter" id="totalExpenses" data-target="0">‚Ç¨0</div><div class="card-sub" id="expenseCount">0 txns</div><div class="card-trend" id="expenseTrend"></div></div>
          <div class="card glow-blue animate-in" style="animation-delay:0.2s"><div class="card-label">üìà Net</div><div class="card-value blue counter" id="netBalance" data-target="0">‚Ç¨0</div><div class="card-sub" id="avgDaily">‚Ç¨0/day</div></div>
          <div class="card animate-in" style="animation-delay:0.3s"><div class="card-label">üéØ Savings Rate</div><div class="card-value purple" id="savingsRate">0%</div><div class="savings-gauge"><div class="savings-fill" id="savingsGauge"></div></div></div>
          <div class="card animate-in" style="animation-delay:0.4s"><div class="card-label">üìä Transactions</div><div class="card-value yellow" id="txnCount">0</div><div class="card-sub" id="dateRange">-</div></div>
        </div>

        <!-- Money Flow Sankey Diagram -->
        <div class="widget chart-box sankey-box animate-in" data-widget="sankey">
          <div class="widget-header">
            <h3>üí∏ Money Flow</h3>
            <span class="widget-badge">Interactive</span>
          </div>
          <div id="sankeyChart" style="height:350px;width:100%"></div>
        </div>

        <!-- Spending Treemap -->
        <div class="widget chart-box animate-in" data-widget="treemap">
          <div class="widget-header">
            <h3>üì¶ Spending Treemap</h3>
            <span class="widget-badge">Click to explore</span>
          </div>
          <div id="treemapChart" style="height:300px;width:100%"></div>
        </div>

        <!-- Animated Radial Progress -->
        <div class="widget grid-3 animate-in" data-widget="radials">
          <div class="chart-box radial-box">
            <h3>üéØ Budget Used</h3>
            <div class="radial-container">
              <svg class="radial-progress" viewBox="0 0 100 100" id="budgetRadial">
                <circle class="radial-bg" cx="50" cy="50" r="45"/>
                <circle class="radial-fill" cx="50" cy="50" r="45" id="budgetRadialFill"/>
                <text x="50" y="50" class="radial-text" id="budgetRadialText">0%</text>
                <text x="50" y="62" class="radial-label">of monthly budget</text>
              </svg>
            </div>
          </div>
          <div class="chart-box radial-box">
            <h3>üí∞ Savings Goal</h3>
            <div class="radial-container">
              <svg class="radial-progress" viewBox="0 0 100 100" id="savingsRadial">
                <circle class="radial-bg" cx="50" cy="50" r="45"/>
                <circle class="radial-fill savings" cx="50" cy="50" r="45" id="savingsRadialFill"/>
                <text x="50" y="50" class="radial-text" id="savingsRadialText">0%</text>
                <text x="50" y="62" class="radial-label">savings rate</text>
              </svg>
            </div>
          </div>
          <div class="chart-box radial-box">
            <h3>üìÖ Month Progress</h3>
            <div class="radial-container">
              <svg class="radial-progress" viewBox="0 0 100 100" id="monthRadial">
                <circle class="radial-bg" cx="50" cy="50" r="45"/>
                <circle class="radial-fill month" cx="50" cy="50" r="45" id="monthRadialFill"/>
                <text x="50" y="50" class="radial-text" id="monthRadialText">0%</text>
                <text x="50" y="62" class="radial-label">of month passed</text>
              </svg>
            </div>
          </div>
        </div>

        <!-- Prediction & Comparison -->
        <div class="widget grid-2 animate-in" data-widget="prediction">
          <div class="chart-box prediction-box">
            <h3>üîÆ End of Month Prediction</h3>
            <div class="prediction-content">
              <div class="prediction-main">
                <div class="prediction-label">Predicted Balance</div>
                <div class="prediction-value" id="predictedBalance">‚Ç¨0</div>
                <div class="prediction-sub" id="predictionNote">Based on your spending patterns</div>
              </div>
              <div class="prediction-breakdown">
                <div class="prediction-item"><span>Current Balance</span><span id="currentBal">‚Ç¨0</span></div>
                <div class="prediction-item"><span>Expected Income</span><span class="green" id="expectedIncome">+‚Ç¨0</span></div>
                <div class="prediction-item"><span>Projected Spending</span><span class="red" id="projectedSpending">-‚Ç¨0</span></div>
                <div class="prediction-item"><span>Days Remaining</span><span id="daysRemaining">0</span></div>
              </div>
            </div>
          </div>
          <div class="chart-box">
            <h3>üìä This Month vs Last Month</h3>
            <div class="comparison-grid">
              <div class="comparison-item"><div class="comparison-label">Income</div><div class="comparison-values"><span class="comparison-current" id="compIncomeThis">‚Ç¨0</span><span class="comparison-vs">vs</span><span class="comparison-prev" id="compIncomeLast">‚Ç¨0</span></div><div class="comparison-change" id="compIncomeChange"></div></div>
              <div class="comparison-item"><div class="comparison-label">Expenses</div><div class="comparison-values"><span class="comparison-current" id="compExpenseThis">‚Ç¨0</span><span class="comparison-vs">vs</span><span class="comparison-prev" id="compExpenseLast">‚Ç¨0</span></div><div class="comparison-change" id="compExpenseChange"></div></div>
              <div class="comparison-item"><div class="comparison-label">Biggest Category</div><div class="comparison-values"><span id="biggestCatThis">-</span><span class="comparison-vs">vs</span><span id="biggestCatLast">-</span></div></div>
            </div>
          </div>
        </div>

        <!-- Quick Stats Row -->
        <div class="widget quick-stats animate-in" data-widget="quickstats">
          <div class="quick-stat"><div class="quick-icon">üìÖ</div><div class="quick-info"><div class="quick-value" id="avgDailySpend">‚Ç¨0</div><div class="quick-label">Daily Average</div></div></div>
          <div class="quick-stat"><div class="quick-icon">üèÜ</div><div class="quick-info"><div class="quick-value" id="bestDay">-</div><div class="quick-label">Lowest Spend Day</div></div></div>
          <div class="quick-stat"><div class="quick-icon">‚ö†Ô∏è</div><div class="quick-info"><div class="quick-value" id="worstDay">-</div><div class="quick-label">Highest Spend Day</div></div></div>
          <div class="quick-stat"><div class="quick-icon">üîÑ</div><div class="quick-info"><div class="quick-value" id="subscriptionTotal">‚Ç¨0</div><div class="quick-label">Monthly Subscriptions</div></div></div>
        </div>

        <!-- Spending Race Chart (Animated Bar Race) -->
        <div class="widget chart-box animate-in" data-widget="race">
          <div class="widget-header">
            <h3>üèÅ Category Spending Race</h3>
            <div class="race-controls">
              <button class="btn btn-small btn-blue" onclick="playSpendingRace()" id="racePlayBtn">‚ñ∂ Play</button>
              <span class="race-month" id="raceMonth">-</span>
            </div>
          </div>
          <div id="raceChart" style="height:280px"></div>
        </div>

        <!-- Charts Row -->
        <div class="widget grid-2 animate-in" data-widget="charts">
          <div class="chart-box"><h3>üìä Spending by Category</h3><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
          <div class="chart-box"><h3>üìà Balance Trend</h3><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
        </div>

        <!-- Monthly Chart -->
        <div class="widget chart-box animate-in" data-widget="monthly">
          <h3>üìÜ Monthly Income vs Expenses</h3>
          <div class="chart-container" style="height:300px"><canvas id="barChart"></canvas></div>
        </div>

        <!-- Heatmap & Weekday -->
        <div class="widget grid-2 animate-in" data-widget="patterns">
          <div class="chart-box"><h3>üìÖ Spending by Weekday</h3><div class="weekday-bars" id="weekdayBars"></div></div>
          <div class="chart-box"><h3>üóìÔ∏è Spending Heatmap</h3><div class="heatmap" id="heatmap"></div></div>
        </div>

        <!-- YoY -->
        <div class="widget chart-box animate-in" id="yoyBox" data-widget="yoy"><h3>üìÖ Year-over-Year Comparison <span class="badge" id="yoyYears"></span></h3><div class="yoy-grid" id="yoyGrid"></div></div>

        <!-- Rankings -->
        <div class="widget grid-2 animate-in" data-widget="merchants">
          <div class="chart-box"><h3>üè™ Top Merchants by Spend</h3><div id="merchantsAmt"></div></div>
          <div class="chart-box"><h3>üî¢ Most Frequent Merchants</h3><div id="merchantsFreq"></div></div>
        </div>

        <!-- Recurring & Top Expenses -->
        <div class="widget grid-2 animate-in" data-widget="recurring">
          <div class="chart-box"><h3>üîÑ Recurring Payments <span class="badge" id="recurringCount">0</span></h3><div id="recurringList"></div></div>
          <div class="chart-box"><h3>üî• Largest Expenses</h3><div id="topExpenses"></div></div>
        </div>

        <!-- All Categories -->
        <div class="widget chart-box animate-in" data-widget="categories"><h3>üìã All Categories Breakdown</h3><div id="categoryList"></div></div>

        <!-- Recent Transactions -->
        <div class="widget txn-box animate-in" data-widget="transactions">
          <div class="txn-header"><h3>üìù <span id="txnTitle">Recent Transactions</span></h3><input type="text" class="search-box" id="searchBox" placeholder="üîç Search..." oninput="applyFilters()"></div>
          <div id="txnList"></div>
          <button class="show-more" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions Page -->
  <div class="page" id="pageTransactions">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">üìù</div>
          <div><h1>Transactions</h1><p id="txnPageCount">0 transactions</p></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-blue" onclick="exportCSV()">üì• Export CSV</button>
          <button class="btn btn-green" onclick="bulkCategorize()">üìÅ Bulk Edit</button>
        </div>
      </header>

      <!-- Advanced Filters -->
      <div class="txn-filters">
        <div class="filter-row">
          <div class="filter-group">
            <label>Date Range</label>
            <div style="display:flex;gap:8px">
              <input type="date" class="filter-input" id="dateFrom" onchange="applyTxnFilters()">
              <span style="color:var(--muted)">to</span>
              <input type="date" class="filter-input" id="dateTo" onchange="applyTxnFilters()">
            </div>
          </div>
          <div class="filter-group">
            <label>Amount Range</label>
            <div style="display:flex;gap:8px">
              <input type="number" class="filter-input" id="amountMin" placeholder="Min ‚Ç¨" onchange="applyTxnFilters()">
              <input type="number" class="filter-input" id="amountMax" placeholder="Max ‚Ç¨" onchange="applyTxnFilters()">
            </div>
          </div>
          <div class="filter-group">
            <label>Type</label>
            <select class="filter-input" id="txnType" onchange="applyTxnFilters()">
              <option value="all">All</option>
              <option value="expense">Expenses</option>
              <option value="income">Income</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label>Category</label>
            <select class="filter-input" id="txnCategory" onchange="applyTxnFilters()">
              <option value="all">All Categories</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Search</label>
            <input type="text" class="filter-input" id="txnSearch" placeholder="Search description..." oninput="applyTxnFilters()">
          </div>
          <div class="filter-group">
            <label>Sort By</label>
            <select class="filter-input" id="txnSort" onchange="applyTxnFilters()">
              <option value="date-desc">Date (Newest)</option>
              <option value="date-asc">Date (Oldest)</option>
              <option value="amount-desc">Amount (High to Low)</option>
              <option value="amount-asc">Amount (Low to High)</option>
              <option value="category">Category</option>
            </select>
          </div>
          <button class="btn btn-small btn-red" onclick="clearTxnFilters()">‚úï Clear</button>
        </div>
      </div>

      <!-- Selection Bar -->
      <div class="selection-bar hidden" id="selectionBar">
        <span id="selectedCount">0 selected</span>
        <button class="btn btn-small btn-blue" onclick="bulkChangeCategory()">üìÅ Change Category</button>
        <button class="btn btn-small btn-red" onclick="clearSelection()">‚úï Clear Selection</button>
      </div>

      <!-- Transactions Table -->
      <div class="txn-table">
        <div class="txn-table-header">
          <div class="txn-col-check"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></div>
          <div class="txn-col-date">Date</div>
          <div class="txn-col-desc">Description</div>
          <div class="txn-col-cat">Category</div>
          <div class="txn-col-amount">Amount</div>
          <div class="txn-col-balance">Balance</div>
          <div class="txn-col-actions"></div>
        </div>
        <div id="txnTableBody"></div>
      </div>

      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>

      <!-- Summary -->
      <div class="txn-summary">
        <div class="summary-item"><span class="summary-label">Filtered Income:</span><span class="summary-value green" id="filteredIncome">‚Ç¨0</span></div>
        <div class="summary-item"><span class="summary-label">Filtered Expenses:</span><span class="summary-value red" id="filteredExpenses">‚Ç¨0</span></div>
        <div class="summary-item"><span class="summary-label">Net:</span><span class="summary-value" id="filteredNet">‚Ç¨0</span></div>
      </div>
    </div>
  </div>

  <!-- Financial Tools Page -->
  <div class="page" id="pageTools">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">üßÆ</div>
          <div><h1>Financial Tools</h1><p>Plan your financial future</p></div>
        </div>
      </header>

      <!-- Tool Tabs -->
      <div class="tool-tabs">
        <button class="tool-tab active" onclick="switchToolTab('debt')">üí≥ Debt Payoff</button>
        <button class="tool-tab" onclick="switchToolTab('investment')">üìà Investment Growth</button>
        <button class="tool-tab" onclick="switchToolTab('whatif')">üîÆ What If?</button>
      </div>

      <!-- Debt Payoff Simulator -->
      <div class="tool-panel" id="toolDebt">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>üí≥ Debt Payoff Calculator</h3>
            <p class="tool-desc">See how fast you can become debt-free</p>
            
            <div class="tool-form">
              <div class="form-group">
                <label>Total Debt Amount</label>
                <div class="input-with-icon">
                  <span>‚Ç¨</span>
                  <input type="number" id="debtAmount" value="10000" onchange="calculateDebt()">
                </div>
              </div>
              <div class="form-group">
                <label>Interest Rate (APR %)</label>
                <div class="input-with-icon">
                  <input type="number" id="debtInterest" value="18" step="0.1" onchange="calculateDebt()">
                  <span>%</span>
                </div>
              </div>
              <div class="form-group">
                <label>Minimum Monthly Payment</label>
                <div class="input-with-icon">
                  <span>‚Ç¨</span>
                  <input type="number" id="debtMinPayment" value="200" onchange="calculateDebt()">
                </div>
              </div>
              <div class="form-group">
                <label>Extra Monthly Payment</label>
                <div class="input-with-icon">
                  <span>‚Ç¨</span>
                  <input type="number" id="debtExtraPayment" value="0" onchange="calculateDebt()">
                </div>
              </div>
            </div>

            <div class="debt-strategies">
              <h4>Try Different Strategies</h4>
              <button class="strategy-btn" onclick="setDebtExtra(50)">+‚Ç¨50/mo</button>
              <button class="strategy-btn" onclick="setDebtExtra(100)">+‚Ç¨100/mo</button>
              <button class="strategy-btn" onclick="setDebtExtra(200)">+‚Ç¨200/mo</button>
              <button class="strategy-btn" onclick="setDebtExtra(500)">+‚Ç¨500/mo</button>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="result-card highlight">
              <div class="result-label">Time to Debt-Free</div>
              <div class="result-value" id="debtPayoffTime">-</div>
              <div class="result-sub" id="debtPayoffDate">-</div>
            </div>
            
            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Total Interest Paid</div>
                <div class="result-value red" id="debtTotalInterest">‚Ç¨0</div>
              </div>
              <div class="result-card">
                <div class="result-label">Total Amount Paid</div>
                <div class="result-value" id="debtTotalPaid">‚Ç¨0</div>
              </div>
            </div>

            <div class="result-card savings-card" id="debtSavingsCard">
              <div class="savings-icon">üéâ</div>
              <div class="savings-content">
                <div class="savings-title">With extra payments you save:</div>
                <div class="savings-value" id="debtSavings">‚Ç¨0</div>
                <div class="savings-time" id="debtTimeSaved">0 months faster</div>
              </div>
            </div>

            <div class="chart-box" style="margin-top:20px">
              <h4>üìâ Debt Payoff Timeline</h4>
              <div class="chart-container"><canvas id="debtChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Investment Growth Simulator -->
      <div class="tool-panel hidden" id="toolInvestment">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>üìà Investment Growth Calculator</h3>
            <p class="tool-desc">See how your money can grow over time</p>
            
            <div class="tool-form">
              <div class="form-group">
                <label>Initial Investment</label>
                <div class="input-with-icon">
                  <span>‚Ç¨</span>
                  <input type="number" id="investInitial" value="5000" onchange="calculateInvestment()">
                </div>
              </div>
              <div class="form-group">
                <label>Monthly Contribution</label>
                <div class="input-with-icon">
                  <span>‚Ç¨</span>
                  <input type="number" id="investMonthly" value="500" onchange="calculateInvestment()">
                </div>
              </div>
              <div class="form-group">
                <label>Expected Annual Return</label>
                <div class="input-with-icon">
                  <input type="number" id="investReturn" value="7" step="0.1" onchange="calculateInvestment()">
                  <span>%</span>
                </div>
              </div>
              <div class="form-group">
                <label>Time Period (Years)</label>
                <div class="input-with-icon">
                  <input type="number" id="investYears" value="20" onchange="calculateInvestment()">
                  <span>yrs</span>
                </div>
              </div>
            </div>

            <div class="return-presets">
              <h4>Common Return Rates</h4>
              <button class="strategy-btn" onclick="setInvestReturn(4)">Conservative (4%)</button>
              <button class="strategy-btn" onclick="setInvestReturn(7)">Moderate (7%)</button>
              <button class="strategy-btn" onclick="setInvestReturn(10)">Aggressive (10%)</button>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="result-card highlight green-glow">
              <div class="result-label">Future Value</div>
              <div class="result-value green" id="investFutureValue">‚Ç¨0</div>
              <div class="result-sub" id="investYearsLabel">in 20 years</div>
            </div>
            
            <div class="result-grid">
              <div class="result-card">
                <div class="result-label">Total Contributions</div>
                <div class="result-value blue" id="investContributions">‚Ç¨0</div>
              </div>
              <div class="result-card">
                <div class="result-label">Interest Earned</div>
                <div class="result-value green" id="investInterestEarned">‚Ç¨0</div>
              </div>
            </div>

            <div class="compound-visual">
              <div class="compound-bar">
                <div class="compound-part contributions" id="compoundContrib" style="width:50%">
                  <span>Contributions</span>
                </div>
                <div class="compound-part interest" id="compoundInterest" style="width:50%">
                  <span>Interest</span>
                </div>
              </div>
            </div>

            <div class="chart-box" style="margin-top:20px">
              <h4>üìà Growth Over Time</h4>
              <div class="chart-container"><canvas id="investChart"></canvas></div>
            </div>

            <div class="milestone-list" id="investMilestones"></div>
          </div>
        </div>
      </div>

      <!-- What If Scenarios -->
      <div class="tool-panel hidden" id="toolWhatif">
        <div class="tool-grid">
          <div class="tool-input-section">
            <h3>üîÆ What If Scenarios</h3>
            <p class="tool-desc">Explore how changes affect your finances</p>
            
            <div class="whatif-scenarios">
              <div class="scenario-card" onclick="selectScenario('raise')">
                <div class="scenario-icon">üí∞</div>
                <div class="scenario-title">I Get a Raise</div>
                <div class="scenario-desc">See impact of higher income</div>
              </div>
              <div class="scenario-card" onclick="selectScenario('cut')">
                <div class="scenario-icon">‚úÇÔ∏è</div>
                <div class="scenario-title">I Cut Spending</div>
                <div class="scenario-desc">Reduce a category</div>
              </div>
              <div class="scenario-card" onclick="selectScenario('save')">
                <div class="scenario-icon">üéØ</div>
                <div class="scenario-title">I Save More</div>
                <div class="scenario-desc">Increase savings rate</div>
              </div>
              <div class="scenario-card" onclick="selectScenario('invest')">
                <div class="scenario-icon">üìà</div>
                <div class="scenario-title">I Start Investing</div>
                <div class="scenario-desc">Put savings to work</div>
              </div>
            </div>

            <div class="scenario-inputs hidden" id="scenarioInputs">
              <h4 id="scenarioTitle">Scenario Settings</h4>
              
              <div id="raiseInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Monthly Raise Amount</label>
                  <div class="input-with-icon">
                    <span>‚Ç¨</span>
                    <input type="number" id="raiseAmount" value="500" onchange="calculateWhatIf()">
                  </div>
                </div>
              </div>

              <div id="cutInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Category to Cut</label>
                  <select id="cutCategory" onchange="calculateWhatIf()"></select>
                </div>
                <div class="form-group">
                  <label>Reduce by (%)</label>
                  <div class="input-with-icon">
                    <input type="number" id="cutPercent" value="30" onchange="calculateWhatIf()">
                    <span>%</span>
                  </div>
                </div>
              </div>

              <div id="saveInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Target Savings Rate</label>
                  <div class="input-with-icon">
                    <input type="number" id="targetSavingsRate" value="25" onchange="calculateWhatIf()">
                    <span>%</span>
                  </div>
                </div>
              </div>

              <div id="investInputs" class="scenario-form hidden">
                <div class="form-group">
                  <label>Monthly Investment</label>
                  <div class="input-with-icon">
                    <span>‚Ç¨</span>
                    <input type="number" id="monthlyInvest" value="300" onchange="calculateWhatIf()">
                  </div>
                </div>
                <div class="form-group">
                  <label>Expected Return (%)</label>
                  <div class="input-with-icon">
                    <input type="number" id="expectedReturn" value="7" onchange="calculateWhatIf()">
                    <span>%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tool-result-section">
            <div class="whatif-comparison" id="whatifResults">
              <div class="comparison-header">
                <div class="comparison-col">
                  <h4>üìä Current</h4>
                </div>
                <div class="comparison-arrow">‚Üí</div>
                <div class="comparison-col">
                  <h4>üîÆ After Change</h4>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Monthly Income</div>
                <div class="comparison-values">
                  <span id="currentIncome">‚Ç¨0</span>
                  <span class="arrow">‚Üí</span>
                  <span id="newIncome" class="green">‚Ç¨0</span>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Monthly Expenses</div>
                <div class="comparison-values">
                  <span id="currentExpenses">‚Ç¨0</span>
                  <span class="arrow">‚Üí</span>
                  <span id="newExpenses">‚Ç¨0</span>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Monthly Savings</div>
                <div class="comparison-values">
                  <span id="currentSavings">‚Ç¨0</span>
                  <span class="arrow">‚Üí</span>
                  <span id="newSavings" class="green">‚Ç¨0</span>
                </div>
              </div>
              
              <div class="comparison-row">
                <div class="comparison-label">Savings Rate</div>
                <div class="comparison-values">
                  <span id="currentRate">0%</span>
                  <span class="arrow">‚Üí</span>
                  <span id="newRate" class="green">0%</span>
                </div>
              </div>

              <div class="impact-card" id="impactCard">
                <h4>üí° Impact Analysis</h4>
                <div class="impact-item">
                  <span class="impact-label">Extra Yearly Savings</span>
                  <span class="impact-value green" id="extraYearlySavings">‚Ç¨0</span>
                </div>
                <div class="impact-item">
                  <span class="impact-label">In 5 Years (with 7% return)</span>
                  <span class="impact-value green" id="impact5Years">‚Ç¨0</span>
                </div>
                <div class="impact-item">
                  <span class="impact-label">In 10 Years (with 7% return)</span>
                  <span class="impact-value green" id="impact10Years">‚Ç¨0</span>
                </div>
              </div>

              <div class="whatif-tip" id="whatifTip">
                <span class="tip-icon">üí°</span>
                <span class="tip-text">Select a scenario to see how changes could impact your finances!</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Imports Page -->
  <div class="page" id="pageImports">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">üìÅ</div>
          <div><h1>Imports</h1><p>Manage bank statements</p></div>
        </div>
      </header>

      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".pdf" multiple>
        <div id="uploadContent"><div class="upload-icon">üìÑ</div><h3>Drop NLB statements here</h3><p>PDF files supported</p></div>
        <div id="uploadLoading" class="hidden"><div class="spinner"></div><p id="uploadStatus">Processing...</p></div>
      </div>

      <div class="import-stats">
        <div class="import-stat"><div class="import-stat-value" id="statFiles">0</div><div class="import-stat-label">Files</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statTxns">0</div><div class="import-stat-label">Transactions</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statActive">0</div><div class="import-stat-label">Active</div></div>
      </div>

      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <button class="btn btn-green" onclick="activateAll()">‚úì Load All</button>
        <button class="btn btn-blue" onclick="deactivateAll()">‚óã Unload All</button>
        <button class="btn btn-red" onclick="deleteAllImports()">üóëÔ∏è Delete All</button>
      </div>

      <div id="importsList"></div>
      <div id="noImports" class="empty-state"><div class="empty-icon">üìÅ</div><h2>No imports</h2><p>Upload PDFs above</p></div>
    </div>
  </div>

  <!-- Users Page (Admin) -->
  <div class="page" id="pageUsers">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">üë•</div>
          <div><h1>User Management</h1><p>Manage accounts</p></div>
        </div>
        <button class="btn btn-primary" onclick="showInviteModal()">+ Invite User</button>
      </header>

      <div class="import-stats">
        <div class="import-stat"><div class="import-stat-value" id="statUsers">0</div><div class="import-stat-label">Total Users</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statAdmins">0</div><div class="import-stat-label">Admins</div></div>
      </div>

      <div id="usersList"></div>
    </div>
  </div>

  <!-- Stocks Page -->
  <div class="page" id="pageStocks">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">üìà</div>
          <div><h1>Stock Portfolio</h1><p>Track your investments</p></div>
        </div>
        <button class="btn btn-primary" onclick="showAddStockModal()">+ Add Stock</button>
      </header>

      <!-- Portfolio Summary -->
      <div class="cards" id="portfolioSummary">
        <div class="card"><div class="card-label">üí∞ Invested</div><div class="card-value blue" id="totalInvested">‚Ç¨0</div></div>
        <div class="card"><div class="card-label">üìä Current Value</div><div class="card-value" id="totalValue">‚Ç¨0</div></div>
        <div class="card"><div class="card-label">üìà Gain/Loss</div><div class="card-value" id="totalGain">‚Ç¨0</div><div class="card-sub" id="totalGainPct">0%</div></div>
        <div class="card"><div class="card-label">üèÜ Holdings</div><div class="card-value yellow" id="holdingsCount">0</div></div>
      </div>

      <!-- Email Notifications -->
      <div class="chart-box">
        <h3>üìß Daily Email Notifications</h3>
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="emailEnabled" onchange="toggleEmailNotifications()">
            <span>Enable daily portfolio summary</span>
          </label>
          <input type="email" class="search-box" id="notificationEmail" placeholder="your@email.com" style="width:250px">
          <button class="btn btn-small btn-green" onclick="saveEmailSettings()">Save</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-top:8px">You'll receive daily updates at 8:00 AM with your portfolio performance</p>
      </div>

      <!-- Stock List -->
      <div class="chart-box">
        <h3>üìã Your Holdings</h3>
        <div id="stocksList"></div>
        <div id="noStocks" class="empty-state"><div class="empty-icon">üìà</div><h2>No stocks yet</h2><p>Add your first stock above</p></div>
      </div>

      <!-- Market Overview -->
      <div class="chart-box">
        <h3>üåç Market Overview</h3>
        <div id="marketOverview" class="cards"></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal hidden" id="editModal">
  <div class="modal-box">
    <h2>Edit Transaction</h2>
    <p id="editDesc" style="color:var(--muted);margin-bottom:16px"></p>
    <label style="font-size:12px;color:var(--muted)">Note</label>
    <input type="text" class="note-input" id="editNote" placeholder="Add a note...">
    <label style="font-size:12px;color:var(--muted)">Category</label>
    <div class="cat-grid" id="catGrid"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideEditModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- Rules Modal -->
<div class="modal hidden" id="rulesModal">
  <div class="modal-box">
    <h2>üìã Category Rules</h2>
    <p style="color:var(--muted);margin-bottom:16px">Auto-categorize by description</p>
    <div id="rulesList"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="clearAllRules()">Clear All</button>
      <button class="btn btn-blue" onclick="hideRulesModal()">Close</button>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal hidden" id="inviteModal">
  <div class="modal-box">
    <h2>üë§ Invite User</h2>
    <p style="color:var(--muted);margin-bottom:16px">Create a new account</p>
    <input type="email" class="note-input" id="inviteEmail" placeholder="Email address">
    <input type="text" class="note-input" id="inviteName" placeholder="Name">
    <input type="password" class="note-input" id="invitePassword" placeholder="Temporary password (min 6 chars)">
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideInviteModal()">Cancel</button>
      <button class="btn btn-green" onclick="createUser()">Create User</button>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal hidden" id="stockModal">
  <div class="modal-box">
    <h2 id="stockModalTitle">üìà Add Stock</h2>
    <p style="color:var(--muted);margin-bottom:16px">Enter your investment details</p>
    <input type="text" class="note-input" id="stockSymbol" placeholder="Symbol (e.g., AAPL, MSFT, GOOGL)" style="text-transform:uppercase">
    <input type="number" class="note-input" id="stockShares" placeholder="Number of shares" step="0.0001">
    <input type="number" class="note-input" id="stockPrice" placeholder="Purchase price per share (‚Ç¨)" step="0.01">
    <input type="date" class="note-input" id="stockDate">
    <input type="text" class="note-input" id="stockNotes" placeholder="Notes (optional)">
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideStockModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveStock()">Save</button>
    </div>
  </div>
</div>

<!-- Alerts Modal -->
<div class="modal hidden" id="alertsModal">
  <div class="modal-box" style="max-width:600px">
    <h2>üîî Smart Alerts</h2>
    <p style="color:var(--muted);margin-bottom:16px">Notifications about your spending</p>
    
    <div class="alert-settings">
      <h4 style="margin-bottom:12px">Alert Settings</h4>
      <label class="alert-setting">
        <input type="checkbox" id="alertLargeTxn" checked> Large transactions (over ‚Ç¨<input type="number" class="inline-input" id="alertLargeAmount" value="100">)
      </label>
      <label class="alert-setting">
        <input type="checkbox" id="alertBudgetExceed" checked> Budget exceeded warnings
      </label>
      <label class="alert-setting">
        <input type="checkbox" id="alertUnusualSpending" checked> Unusual spending patterns
      </label>
      <label class="alert-setting">
        <input type="checkbox" id="alertRecurringDue" checked> Recurring payment reminders
      </label>
    </div>
    
    <h4 style="margin:20px 0 12px">Recent Alerts</h4>
    <div id="alertsList"></div>
    
    <div class="modal-actions">
      <button class="btn btn-blue" onclick="hideAlertsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Bulk Category Modal -->
<div class="modal hidden" id="bulkCatModal">
  <div class="modal-box">
    <h2>üìÅ Bulk Change Category</h2>
    <p style="color:var(--muted);margin-bottom:16px">Change category for <span id="bulkCount">0</span> selected transactions</p>
    <div class="cat-grid" id="bulkCatGrid"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideBulkCatModal()">Cancel</button>
      <button class="btn btn-green" onclick="applyBulkCategory()">Apply</button>
    </div>
  </div>
</div>

<!-- Customize Dashboard Modal -->
<div class="modal hidden" id="customizeModal">
  <div class="modal-box" style="max-width:600px">
    <h2>‚öôÔ∏è Customize Dashboard</h2>
    <p style="color:var(--muted);margin-bottom:20px">Show or hide widgets, change theme</p>
    
    <div class="customize-section">
      <h4>üé® Theme</h4>
      <div class="theme-options">
        <div class="theme-opt" onclick="setTheme('dark')" id="themeDark">
          <div class="theme-preview dark"></div>
          <span>Dark</span>
        </div>
        <div class="theme-opt" onclick="setTheme('light')" id="themeLight">
          <div class="theme-preview light"></div>
          <span>Light</span>
        </div>
        <div class="theme-opt" onclick="setTheme('midnight')" id="themeMidnight">
          <div class="theme-preview midnight"></div>
          <span>Midnight</span>
        </div>
        <div class="theme-opt" onclick="setTheme('nature')" id="themeNature">
          <div class="theme-preview nature"></div>
          <span>Nature</span>
        </div>
      </div>
    </div>
    
    <div class="customize-section">
      <h4>üìä Widgets</h4>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Toggle widgets on/off</p>
      <div class="widget-toggles" id="widgetToggles"></div>
    </div>
    
    <div class="customize-section">
      <h4>üìè Card Size</h4>
      <div class="size-options">
        <label><input type="radio" name="cardSize" value="small" onchange="setCardSize('small')"> Compact</label>
        <label><input type="radio" name="cardSize" value="medium" onchange="setCardSize('medium')" checked> Normal</label>
        <label><input type="radio" name="cardSize" value="large" onchange="setCardSize('large')"> Large</label>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-red" onclick="resetDashboardSettings()">Reset to Default</button>
      <button class="btn btn-green" onclick="hideCustomizeModal()">Done</button>
    </div>
  </div>
</div>

<!-- AI Chat Panel -->
<div class="ai-chat-panel hidden" id="aiChatPanel">
  <div class="ai-chat-header">
    <div class="ai-chat-title">
      <span class="ai-avatar">ü§ñ</span>
      <div>
        <h3>Financial Assistant</h3>
        <span class="ai-status">Ask me anything about your finances</span>
      </div>
    </div>
    <button class="ai-chat-close" onclick="toggleAIChat()">‚úï</button>
  </div>
  
  <div class="ai-chat-messages" id="aiChatMessages">
    <div class="ai-message bot">
      <div class="ai-message-avatar">ü§ñ</div>
      <div class="ai-message-content">
        <p>Hi! I'm your financial assistant. I can help you understand your spending patterns. Try asking:</p>
        <div class="ai-suggestions">
          <button onclick="askAI('How much did I spend this month?')">üí∞ Spending this month</button>
          <button onclick="askAI('What is my biggest expense category?')">üìä Top category</button>
          <button onclick="askAI('Compare this month to last month')">üìà Month comparison</button>
          <button onclick="askAI('How much did I spend on groceries?')">üõí Groceries total</button>
          <button onclick="askAI('What are my recurring payments?')">üîÑ Recurring bills</button>
          <button onclick="askAI('Give me a financial summary')">üìã Full summary</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="ai-chat-input">
    <input type="text" id="aiInput" placeholder="Ask about your finances..." onkeypress="if(event.key==='Enter')sendAIMessage()">
    <button onclick="sendAIMessage()">‚û§</button>
  </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAifLv-J1WahMz0DERGXJSt9qDF0z6F5oA",
  authDomain: "bank-app-b907a.firebaseapp.com",
  databaseURL: "https://bank-app-b907a-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bank-app-b907a",
  storageBucket: "bank-app-b907a.firebasestorage.app",
  messagingSenderId: "834229293620",
  appId: "1:834229293620:web:8ac5d5fdb4a0d635597061"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// State
let currentUser = null;
let imports = {};
let catOverrides = {};
let txnNotes = {};
let activeTxns = [];
let filteredTxns = [];
let selYear = 'all', selMonth = 'all', selCat = null, searchQ = '', showAll = false;
let editingTxn = null, selNewCat = null;
let pieChart = null, lineChart = null, barChart = null;
let isDark = true;
let isSignUp = false;
let isAdmin = false;
let allUsers = {};
let viewingUserId = null;
let stocks = {};
let stockPrices = {};
let editingStockId = null;
let emailSettings = { enabled: false, email: '' };

// Transactions page state
let txnPageData = [];
let txnCurrentPage = 1;
let txnPerPage = 25;
let selectedTxns = new Set();
let bulkSelectedCat = null;
let alerts = [];

// Dashboard customization state
let dashboardSettings = {
  theme: 'dark',
  layout: 'default',
  cardSize: 'medium',
  widgets: {
    insights: true, stats: true, sankey: true, treemap: true, radials: true,
    prediction: true, quickstats: true, race: true, charts: true, monthly: true,
    patterns: true, yoy: true, merchants: true, recurring: true, categories: true, transactions: true
  }
};
let raceInterval = null;
let aiChatOpen = false;
let debtChart = null;
let investChart = null;
let currentScenario = null;

const $ = id => document.getElementById(id);
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const WDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const COLORS = ['#f87171','#fb923c','#fbbf24','#a3e635','#34d399','#22d3ee','#a78bfa'];
const CATS = {
  Groceries:{kw:['LIDL','HOFER','SPAR','MERCATOR','TUS','EUROSPIN'],c:'#10B981',i:'üõí'},
  Fuel:{kw:['MOL','PETROL','OMV'],c:'#F59E0B',i:'‚õΩ'},
  Restaurants:{kw:['MCDONALDS','RESTAVRACIJA','PIZZA','GOSTILNA','SUSHI'],c:'#EC4899',i:'üçî'},
  Travel:{kw:['BOOKING','HOTEL','AIRBNB','BANKOMAT'],c:'#3B82F6',i:'‚úàÔ∏è'},
  Shopping:{kw:['AMAZON','IKEA','MERKUR'],c:'#8B5CF6',i:'üõçÔ∏è'},
  Clothing:{kw:['ZARA','H&M','ABOUTYOU','C&A','MANGO','RESERVED'],c:'#F97316',i:'üëï'},
  Jewelry:{kw:['ZLATARNA','PANDORA','SWAROVSKI'],c:'#FBBF24',i:'üíç'},
  Sports:{kw:['INTERSPORT','DECATHLON','SPORTINA','HERVIS','FITNESS','GYM'],c:'#22D3EE',i:'üèÉ'},
  Parties:{kw:['CLUB','DISCO','NIGHT','LOUNGE','COCKTAIL'],c:'#E879F9',i:'üéâ'},
  Entertainment:{kw:['NETFLIX','SPOTIFY','STEAM','KINO','CINEMA'],c:'#06B6D4',i:'üé¨'},
  Transportation:{kw:['PSTOP','PARK','TAXI','UBER','BOLT'],c:'#EF4444',i:'üöó'},
  Transfers:{kw:['REVOLUT','FLIK','PAYPAL'],c:'#6366F1',i:'üí∏'},
  Education:{kw:['UL EF','FAKULT','UNIV'],c:'#F472B6',i:'üéì'},
  Health:{kw:['LEKARNA','APOTEKA','DOCTOR','ZDRAVNIK'],c:'#84CC16',i:'üè•'},
  Services:{kw:['POSTA','TELEKOM','PROVIZIJA','A1 '],c:'#64748B',i:'üìã'},
  Income:{kw:['PLACA','REDNO DELO','VRACILO','SICOD'],c:'#22C55E',i:'üí∞'},
  Personal:{kw:[],c:'#14B8A6',i:'üë§'},
  Other:{kw:[],c:'#94A3B8',i:'üí≥'}
};

// Helpers
function fmt(n) { return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n); }
function notify(msg, type='success') {
  const n = document.createElement('div');
  n.className = 'notif ' + type;
  n.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span><span>${msg}</span>`;
  $('notifBox').appendChild(n);
  setTimeout(() => n.remove(), 3000);
}
function categorize(desc) {
  if (catOverrides[desc]) return catOverrides[desc];
  const u = desc.toUpperCase();
  for (const [cat, cfg] of Object.entries(CATS)) {
    if (cat === 'Other') continue;
    if (cfg.kw.some(k => u.includes(k))) return cat;
  }
  return 'Other';
}

// Auth
auth.onAuthStateChanged(async user => {
  $('loading').classList.add('hidden');
  if (user) {
    currentUser = user;
    $('authScreen').classList.add('hidden');
    $('mainApp').classList.remove('hidden');
    $('userName').textContent = user.displayName || 'User';
    $('userEmail').textContent = user.email;
    
    // Check if admin
    const userSnap = await db.ref('users/' + user.uid).once('value');
    const userData = userSnap.val() || {};
    isAdmin = userData.role === 'admin';
    $('userRole').textContent = isAdmin ? 'üëë Admin' : '';
    $('usersTab').classList.toggle('hidden', !isAdmin);
    
    if (isAdmin) {
      await loadAllUsers();
    }
    
    loadData();
  } else {
    $('authScreen').classList.remove('hidden');
    $('mainApp').classList.add('hidden');
  }
});

$('authToggle').onclick = () => {
  isSignUp = !isSignUp;
  $('authName').classList.toggle('hidden', !isSignUp);
  $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  $('authSubtitle').textContent = isSignUp ? 'Create your account' : 'Sign in to continue';
  $('authToggle').textContent = isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up";
  $('authError').style.display = 'none';
};

$('authBtn').onclick = async () => {
  const email = $('authEmail').value;
  const pass = $('authPassword').value;
  const name = $('authName').value;
  try {
    $('authBtn').textContent = 'Please wait...';
    if (isSignUp) {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      // First user becomes admin
      const usersSnap = await db.ref('users').once('value');
      const isFirstUser = !usersSnap.exists();
      await db.ref('users/' + cred.user.uid).set({ email, name, role: isFirstUser ? 'admin' : 'user', createdAt: Date.now() });
    } else {
      await auth.signInWithEmailAndPassword(email, pass);
    }
  } catch (e) {
    $('authError').textContent = e.message;
    $('authError').style.display = 'block';
    $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  }
};

function signOut() { auth.signOut(); toggleUserMenu(); }
function toggleUserMenu() { $('userDropdown').classList.toggle('show'); }

// Data
async function loadData() {
  const snap = await db.ref('data/' + currentUser.uid).once('value');
  const data = snap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  stocks = data.stocks || {};
  emailSettings = data.emailSettings || { enabled: false, email: currentUser.email };
  renderImports();
  loadActiveTxns();
  loadStocks();
  setTimeout(generateAlerts, 500); // Generate alerts after data loads
}

async function saveData() {
  await db.ref('data/' + currentUser.uid).set({
    imports, overrides: catOverrides, notes: txnNotes, stocks, emailSettings, updatedAt: Date.now()
  });
}

// Pages
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  $('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
  const tabs = { overview: 0, transactions: 1, tools: 2, imports: 3, stocks: 4, users: 5 };
  document.querySelectorAll('.nav-tab')[tabs[page] || 0].classList.add('active');
  if (page === 'users' && isAdmin) renderUsers();
  if (page === 'stocks') loadStocks();
  if (page === 'transactions') initTransactionsPage();
  if (page === 'tools') initToolsPage();
}

// Theme
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  $('themeBtn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  render();
}

// Imports
function loadActiveTxns() {
  activeTxns = [];
  Object.values(imports).filter(i => i.active).forEach(imp => {
    (imp.txns || []).forEach(t => {
      const pd = new Date(t.parsedDate);
      const cat = catOverrides[t.description] || categorize(t.description);
      activeTxns.push({...t, parsedDate: pd, year: pd.getFullYear(), month: pd.getMonth(), weekday: pd.getDay(), category: cat});
    });
  });
  activeTxns.sort((a,b) => a.parsedDate - b.parsedDate);
  applyFilters();
}

function renderImports() {
  const keys = Object.keys(imports).sort((a,b) => (imports[b].importedAt||0) - (imports[a].importedAt||0));
  $('importsBadge').textContent = keys.length;
  $('noImports').classList.toggle('hidden', keys.length > 0);
  
  const total = Object.values(imports).reduce((s,i) => s + (i.txns?.length||0), 0);
  const active = Object.values(imports).filter(i => i.active).length;
  $('statFiles').textContent = keys.length;
  $('statTxns').textContent = total;
  $('statActive').textContent = active;
  
  $('importsList').innerHTML = keys.map(id => {
    const imp = imports[id];
    const dates = (imp.txns||[]).map(t => new Date(t.parsedDate)).sort((a,b)=>a-b);
    const range = dates.length ? dates[0].toLocaleDateString('sl') + ' - ' + dates[dates.length-1].toLocaleDateString('sl') : '';
    return `<div class="import-card ${imp.active?'':'inactive'}">
      <div class="import-icon">üìÑ</div>
      <div class="import-info">
        <div class="import-name">${imp.filename}</div>
        <div class="import-meta">${imp.txns?.length||0} txns ‚Ä¢ ${range}</div>
      </div>
      <div class="import-toggle ${imp.active?'active':''}" onclick="toggleImport('${id}')"></div>
      <button class="btn btn-small btn-red" onclick="deleteImport('${id}')">üóëÔ∏è</button>
    </div>`;
  }).join('');
}

async function toggleImport(id) {
  imports[id].active = !imports[id].active;
  await saveData();
  renderImports();
  loadActiveTxns();
  notify(imports[id].active ? 'Loaded' : 'Unloaded');
}

async function deleteImport(id) {
  if (!confirm('Delete this import?')) return;
  delete imports[id];
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('Deleted');
}

async function activateAll() {
  Object.keys(imports).forEach(id => imports[id].active = true);
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All loaded');
}

async function deactivateAll() {
  Object.keys(imports).forEach(id => imports[id].active = false);
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All unloaded');
}

async function deleteAllImports() {
  if (!confirm('Delete ALL imports?')) return;
  imports = {};
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All deleted');
}

// Upload
$('uploadZone').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => handleFiles(e.target.files);
$('uploadZone').ondragover = e => { e.preventDefault(); $('uploadZone').style.borderColor = 'var(--accent)'; };
$('uploadZone').ondragleave = () => $('uploadZone').style.borderColor = '';
$('uploadZone').ondrop = e => { e.preventDefault(); $('uploadZone').style.borderColor = ''; handleFiles(e.dataTransfer.files); };

async function handleFiles(files) {
  const pdfs = [...files].filter(f => f.name.endsWith('.pdf'));
  if (!pdfs.length) return;
  
  $('uploadContent').classList.add('hidden');
  $('uploadLoading').classList.remove('hidden');
  let total = 0;
  
  for (let i = 0; i < pdfs.length; i++) {
    const f = pdfs[i];
    if (Object.values(imports).some(imp => imp.filename === f.name)) {
      notify(f.name + ' already imported', 'warning');
      continue;
    }
    $('uploadStatus').textContent = `${i+1}/${pdfs.length}: ${f.name}`;
    
    try {
      const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
      let text = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      const txns = parseStatement(text);
      if (txns.length) {
        const id = 'imp_' + Date.now() + '_' + i;
        imports[id] = { filename: f.name, importedAt: Date.now(), txns, active: true };
        total += txns.length;
      }
    } catch (e) {
      notify('Error: ' + f.name, 'warning');
    }
  }
  
  await saveData();
  renderImports();
  loadActiveTxns();
  if (total) notify(`Imported ${total} transactions`);
  
  $('uploadContent').classList.remove('hidden');
  $('uploadLoading').classList.add('hidden');
}

function parseStatement(txt) {
  const txns = [];
  const dateRegex = /(\d{2}\.\d{2}\.\d{2})/g;
  const matches = [...txt.matchAll(dateRegex)];
  
  for (let i = 0; i < matches.length; i++) {
    const seg = txt.substring(matches[i].index, matches[i+1]?.index || txt.length);
    if (/STANJE|SKUPNI|Datum izpiska/i.test(seg)) continue;
    
    const amtMatch = seg.match(/([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g);
    if (amtMatch && amtMatch.length >= 2) {
      const amtStr = amtMatch[amtMatch.length-2];
      const balStr = amtMatch[amtMatch.length-1];
      let amt = parseFloat(amtStr.replace(/\./g,'').replace(',','.'));
      const bal = parseFloat(balStr.replace(/\./g,'').replace(',','.'));
      const desc = seg.slice(8, seg.indexOf(amtMatch[0])).trim().replace(/^[\.,]\s*/,'');
      if (!desc || desc.length < 2) continue;
      
      const isInc = amtStr.startsWith('+') || /PLACA|REDNO DELO|VRACILO/i.test(desc);
      if (!amtStr.startsWith('+') && !amtStr.startsWith('-') && !isInc) amt = -Math.abs(amt);
      
      const dateParts = matches[i][1].split('.');
      const pd = new Date(2000 + parseInt(dateParts[2]), parseInt(dateParts[1])-1, parseInt(dateParts[0]));
      if (isNaN(pd.getTime())) continue;
      
      txns.push({
        id: matches[i][1] + '_' + txns.length + '_' + Math.random().toString(36).slice(2,8),
        date: matches[i][1],
        parsedDate: pd.toISOString(),
        description: desc,
        amount: amt,
        balance: bal,
        category: categorize(desc)
      });
    }
  }
  return txns;
}

// Filters
function applyFilters() {
  selYear = $('yearFilter')?.value || 'all';
  searchQ = $('searchBox')?.value?.toLowerCase() || '';
  
  filteredTxns = activeTxns.filter(t => {
    if (selYear !== 'all' && t.year !== parseInt(selYear)) return false;
    if (selMonth !== 'all' && t.month !== parseInt(selMonth)) return false;
    if (selCat && t.category !== selCat) return false;
    if (searchQ && !t.description.toLowerCase().includes(searchQ)) return false;
    return true;
  });
  showAll = false;
  render();
}

function resetFilters() {
  selYear = 'all'; selMonth = 'all'; selCat = null; searchQ = '';
  if ($('yearFilter')) $('yearFilter').value = 'all';
  if ($('searchBox')) $('searchBox').value = '';
  applyFilters();
}

function selectMonth(m) {
  selMonth = selMonth === m ? 'all' : m;
  applyFilters();
}

function filterByCat(c) {
  selCat = selCat === c ? null : c;
  applyFilters();
}

function toggleShowAll() {
  showAll = !showAll;
  renderTxns();
}

// Render
function render() {
  if (!activeTxns.length) {
    $('emptyState').classList.remove('hidden');
    $('dashboard').classList.add('hidden');
    return;
  }
  $('emptyState').classList.add('hidden');
  $('dashboard').classList.remove('hidden');
  
  // Apply saved settings
  loadDashboardSettings();
  
  // Filters
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  $('yearFilter').innerHTML = '<option value="all">All Years</option>' + years.map(y => `<option value="${y}" ${selYear==y?'selected':''}>${y}</option>`).join('');
  $('monthPills').innerHTML = `<div class="month-pill ${selMonth==='all'?'active':''}" onclick="selectMonth('all')">All</div>` + MONTHS.map((m,i) => `<div class="month-pill ${selMonth===i?'active':''}" onclick="selectMonth(${i})">${m}</div>`).join('');
  
  // Stats
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const net = income - expenses;
  const sr = income > 0 ? (net / income) * 100 : 0;
  const days = filteredTxns.length > 1 ? Math.max(1, Math.ceil((filteredTxns[filteredTxns.length-1].parsedDate - filteredTxns[0].parsedDate) / 864e5)) : 1;
  
  // Animated counter update
  animateCounter('totalIncome', income);
  animateCounter('totalExpenses', expenses);
  animateCounter('netBalance', net);
  
  $('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
  $('incomeCount').textContent = filteredTxns.filter(t => t.amount > 0).length + ' txns';
  $('expenseCount').textContent = filteredTxns.filter(t => t.amount < 0).length + ' txns';
  $('savingsRate').textContent = sr.toFixed(1) + '%';
  $('savingsGauge').style.width = Math.min(100, Math.max(0, sr)) + '%';
  $('savingsGauge').className = 'savings-fill ' + (sr >= 20 ? 'good' : sr >= 10 ? 'ok' : 'bad');
  $('txnCount').textContent = filteredTxns.length;
  $('avgDaily').textContent = fmt(expenses/days) + '/day';
  $('dateRange').textContent = filteredTxns.length ? filteredTxns[0].date + ' - ' + filteredTxns[filteredTxns.length-1].date : '-';
  
  // New visualizations
  renderRadialProgress(sr, expenses);
  renderSankeyChart();
  renderTreemap();
  
  // Existing renders
  renderInsights(income, expenses, sr);
  renderPrediction(income, expenses);
  renderComparison();
  renderQuickStats(expenses, days);
  
  renderYoY();
  renderHeatmap();
  renderWeekday();
  renderRecurring();
  renderMerchants();
  renderCategories();
  renderTopExpenses();
  renderCharts();
  renderTxns();
  
  // Trigger animations
  setTimeout(() => {
    document.querySelectorAll('.animate-in').forEach((el, i) => {
      el.style.animationDelay = (i * 0.05) + 's';
    });
  }, 100);
}

// Animated Counter
function animateCounter(id, target) {
  const el = $(id);
  const duration = 1000;
  const start = parseFloat(el.dataset.current) || 0;
  const startTime = performance.now();
  
  el.dataset.current = target;
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3); // ease out cubic
    const current = start + (target - start) * eased;
    el.textContent = fmt(current);
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// Radial Progress Charts
function renderRadialProgress(savingsRate, totalExpenses) {
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const daysPassed = now.getDate();
  const monthProgress = (daysPassed / daysInMonth) * 100;
  
  // Assume budget is 2x average monthly expense (can be customized later)
  const avgMonthlyExpense = totalExpenses / Math.max(1, filteredTxns.length > 30 ? Math.ceil(filteredTxns.length / 30) : 1);
  const budgetUsed = Math.min(100, (totalExpenses / (avgMonthlyExpense * 1.2)) * 100) || 0;
  
  // Update radials with animation
  updateRadial('budgetRadialFill', 'budgetRadialText', budgetUsed, budgetUsed > 80 ? 'var(--red)' : budgetUsed > 60 ? '#fbbf24' : 'var(--accent)');
  updateRadial('savingsRadialFill', 'savingsRadialText', Math.max(0, savingsRate), savingsRate >= 20 ? 'var(--green)' : savingsRate >= 10 ? '#fbbf24' : 'var(--red)');
  updateRadial('monthRadialFill', 'monthRadialText', monthProgress, '#a78bfa');
}

function updateRadial(fillId, textId, percentage, color) {
  const circumference = 283; // 2 * PI * 45
  const offset = circumference - (percentage / 100) * circumference;
  const fill = $(fillId);
  const text = $(textId);
  
  if (fill) {
    fill.style.stroke = color;
    setTimeout(() => { fill.style.strokeDashoffset = offset; }, 100);
  }
  if (text) text.textContent = Math.round(percentage) + '%';
}

// Sankey Diagram
function renderSankeyChart() {
  const container = $('sankeyChart');
  if (!container || !filteredTxns.length) return;
  container.innerHTML = '';
  
  const width = container.offsetWidth;
  const height = 350;
  
  // Build nodes and links
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  
  const nodes = [{ name: 'Income' }, { name: 'Available' }];
  const links = [{ source: 0, target: 1, value: income }];
  
  // Add category nodes
  Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 8).forEach(([cat, val], i) => {
    nodes.push({ name: cat, color: CATS[cat]?.c || '#94a3b8' });
    links.push({ source: 1, target: i + 2, value: val });
  });
  
  // Savings node if positive
  const savings = income - Object.values(categories).reduce((s, v) => s + v, 0);
  if (savings > 0) {
    nodes.push({ name: 'Savings', color: '#22c55e' });
    links.push({ source: 1, target: nodes.length - 1, value: savings });
  }
  
  const svg = d3.select(container)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(12)
    .extent([[20, 20], [width - 20, height - 20]]);
  
  const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
    nodes: nodes.map(d => Object.assign({}, d)),
    links: links.map(d => Object.assign({}, d))
  });
  
  // Draw links
  svg.append('g')
    .selectAll('path')
    .data(sankeyLinks)
    .join('path')
    .attr('class', 'link')
    .attr('d', d3.sankeyLinkHorizontal())
    .attr('stroke', d => d.target.color || 'var(--accent)')
    .attr('stroke-width', d => Math.max(2, d.width))
    .append('title')
    .text(d => `${d.source.name} ‚Üí ${d.target.name}: ${fmt(d.value)}`);
  
  // Draw nodes
  const node = svg.append('g')
    .selectAll('g')
    .data(sankeyNodes)
    .join('g')
    .attr('class', 'node');
  
  node.append('rect')
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('height', d => d.y1 - d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('fill', d => d.color || 'var(--accent)')
    .attr('rx', 4);
  
  node.append('text')
    .attr('x', d => d.x0 < width / 2 ? d.x1 + 8 : d.x0 - 8)
    .attr('y', d => (d.y1 + d.y0) / 2)
    .attr('dy', '0.35em')
    .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
    .text(d => `${d.name} ${fmt(d.value || 0)}`);
}

// Treemap
function renderTreemap() {
  const container = $('treemapChart');
  if (!container || !filteredTxns.length) return;
  container.innerHTML = '';
  
  const width = container.offsetWidth;
  const height = 300;
  
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  
  const data = {
    name: 'Spending',
    children: Object.entries(categories).map(([name, value]) => ({
      name, value, color: CATS[name]?.c || '#94a3b8', icon: CATS[name]?.i || 'üí≥'
    }))
  };
  
  const root = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value);
  d3.treemap().size([width, height]).padding(3)(root);
  
  const svg = d3.select(container)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  const cell = svg.selectAll('g')
    .data(root.leaves())
    .join('g')
    .attr('transform', d => `translate(${d.x0},${d.y0})`);
  
  cell.append('rect')
    .attr('class', 'treemap-cell')
    .attr('width', d => d.x1 - d.x0)
    .attr('height', d => d.y1 - d.y0)
    .attr('fill', d => d.data.color)
    .attr('rx', 4)
    .style('cursor', 'pointer')
    .on('click', (e, d) => filterByCat(d.data.name));
  
  cell.filter(d => (d.x1 - d.x0) > 50 && (d.y1 - d.y0) > 35)
    .append('text')
    .attr('class', 'treemap-label')
    .attr('x', 8)
    .attr('y', 20)
    .text(d => `${d.data.icon} ${d.data.name}`);
  
  cell.filter(d => (d.x1 - d.x0) > 50 && (d.y1 - d.y0) > 50)
    .append('text')
    .attr('class', 'treemap-value')
    .attr('x', 8)
    .attr('y', 36)
    .text(d => fmt(d.data.value));
}

// Spending Race Animation
let raceData = [];
function prepareRaceData() {
  const months = {};
  activeTxns.filter(t => t.amount < 0).forEach(t => {
    const key = t.year + '-' + String(t.month + 1).padStart(2, '0');
    if (!months[key]) months[key] = {};
    months[key][t.category] = (months[key][t.category] || 0) + Math.abs(t.amount);
  });
  raceData = Object.entries(months).sort((a, b) => a[0].localeCompare(b[0]));
}

function playSpendingRace() {
  if (raceInterval) {
    clearInterval(raceInterval);
    raceInterval = null;
    $('racePlayBtn').textContent = '‚ñ∂ Play';
    return;
  }
  
  prepareRaceData();
  if (!raceData.length) return;
  
  $('racePlayBtn').textContent = '‚è∏ Pause';
  let idx = 0;
  
  function showMonth() {
    if (idx >= raceData.length) {
      clearInterval(raceInterval);
      raceInterval = null;
      $('racePlayBtn').textContent = '‚ñ∂ Play';
      return;
    }
    
    const [month, cats] = raceData[idx];
    const sorted = Object.entries(cats).sort((a, b) => b[1] - a[1]).slice(0, 6);
    const max = sorted[0]?.[1] || 1;
    
    $('raceMonth').textContent = MONTHS[parseInt(month.split('-')[1]) - 1] + ' ' + month.split('-')[0];
    $('raceChart').innerHTML = sorted.map(([cat, val]) => {
      const pct = (val / max) * 100;
      const cfg = CATS[cat] || CATS.Other;
      return `<div class="race-bar"><div class="race-bar-inner" style="width:${pct}%;background:${cfg.c}"><span class="race-bar-label">${cfg.i} ${cat}</span><span class="race-bar-value">${fmt(val)}</span></div></div>`;
    }).join('');
    
    idx++;
  }
  
  showMonth();
  raceInterval = setInterval(showMonth, 1200);
}

// Smart Insights
function renderInsights(income, expenses, savingsRate) {
  const insights = [];
  const now = new Date();
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const lastMonth = activeTxns.filter(t => {
    const lm = new Date(now.getFullYear(), now.getMonth() - 1);
    return t.parsedDate.getMonth() === lm.getMonth() && t.parsedDate.getFullYear() === lm.getFullYear();
  });
  
  const thisExp = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const lastExp = Math.abs(lastMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  
  // Spending comparison
  if (lastExp > 0) {
    const change = ((thisExp - lastExp) / lastExp * 100);
    if (change > 20) {
      insights.push({ icon: '‚ö†Ô∏è', title: 'Spending Alert', desc: `You've spent ${change.toFixed(0)}% more than last month`, type: 'warning' });
    } else if (change < -10) {
      insights.push({ icon: 'üéâ', title: 'Great Job!', desc: `You've reduced spending by ${Math.abs(change).toFixed(0)}% vs last month`, type: 'success' });
    }
  }
  
  // Savings rate
  if (savingsRate >= 30) {
    insights.push({ icon: 'üèÜ', title: 'Excellent Saver!', desc: `${savingsRate.toFixed(0)}% savings rate - you're crushing it!`, type: 'success' });
  } else if (savingsRate < 10 && savingsRate >= 0) {
    insights.push({ icon: 'üí°', title: 'Savings Tip', desc: `Try to save at least 20% of your income`, type: 'warning' });
  }
  
  // Top spending category
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const topCat = Object.entries(cats).sort((a,b) => b[1] - a[1])[0];
  if (topCat) {
    const pct = (topCat[1] / expenses * 100).toFixed(0);
    insights.push({ icon: CATS[topCat[0]]?.i || 'üí≥', title: `${topCat[0]} is your top expense`, desc: `${pct}% of total spending (${fmt(topCat[1])})`, type: '' });
  }
  
  // Large recent transaction
  const recent = filteredTxns.slice(-10).filter(t => t.amount < -500);
  if (recent.length) {
    const big = recent.sort((a,b) => a.amount - b.amount)[0];
    insights.push({ icon: 'üí∏', title: 'Large Transaction', desc: `${big.description.slice(0,25)} - ${fmt(big.amount)}`, type: 'warning' });
  }
  
  // Fill with defaults if needed
  while (insights.length < 3) {
    if (insights.length === 0) insights.push({ icon: 'üìä', title: 'Track Your Spending', desc: 'Import more statements for better insights', type: '' });
    else if (insights.length === 1) insights.push({ icon: 'üí∞', title: `${filteredTxns.length} Transactions`, desc: `Across ${Object.keys(cats).length} categories`, type: '' });
    else insights.push({ icon: 'üìÖ', title: 'Keep Going!', desc: 'The more data, the better insights', type: '' });
  }
  
  insights.slice(0, 3).forEach((ins, i) => {
    $('insight' + (i+1)).className = 'insight-card ' + ins.type;
    $('insight' + (i+1)).innerHTML = `<div class="insight-icon">${ins.icon}</div><div class="insight-text"><div class="insight-title">${ins.title}</div><div class="insight-desc">${ins.desc}</div></div>`;
  });
}

// Predicted Balance
function renderPrediction(income, expenses) {
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const daysPassed = now.getDate();
  const daysRemaining = daysInMonth - daysPassed;
  
  // Get current balance from latest transaction
  const currentBal = filteredTxns.length ? filteredTxns[filteredTxns.length - 1].balance : 0;
  
  // Calculate daily averages from this month's data
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const monthIncome = thisMonth.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const monthExpenses = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  
  const avgDailyIncome = daysPassed > 0 ? monthIncome / daysPassed : 0;
  const avgDailyExpense = daysPassed > 0 ? monthExpenses / daysPassed : 0;
  
  const expectedIncome = avgDailyIncome * daysRemaining;
  const projectedSpending = avgDailyExpense * daysRemaining;
  const predictedBalance = currentBal + expectedIncome - projectedSpending;
  
  $('currentBal').textContent = fmt(currentBal);
  $('expectedIncome').textContent = '+' + fmt(expectedIncome);
  $('projectedSpending').textContent = '-' + fmt(projectedSpending);
  $('daysRemaining').textContent = daysRemaining + ' days';
  $('predictedBalance').textContent = fmt(predictedBalance);
  $('predictedBalance').style.color = predictedBalance >= currentBal ? 'var(--green)' : 'var(--red)';
  $('predictionNote').textContent = predictedBalance >= currentBal ? 'üìà Looking good!' : 'üìâ Consider reducing spending';
}

// Month Comparison
function renderComparison() {
  const now = new Date();
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const lastMonth = activeTxns.filter(t => {
    const lm = new Date(now.getFullYear(), now.getMonth() - 1);
    return t.parsedDate.getMonth() === lm.getMonth() && t.parsedDate.getFullYear() === lm.getFullYear();
  });
  
  const thisInc = thisMonth.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const lastInc = lastMonth.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const thisExp = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const lastExp = Math.abs(lastMonth.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  
  $('compIncomeThis').textContent = fmt(thisInc);
  $('compIncomeLast').textContent = fmt(lastInc);
  $('compExpenseThis').textContent = fmt(thisExp);
  $('compExpenseLast').textContent = fmt(lastExp);
  
  const incChange = lastInc > 0 ? ((thisInc - lastInc) / lastInc * 100) : 0;
  const expChange = lastExp > 0 ? ((thisExp - lastExp) / lastExp * 100) : 0;
  
  $('compIncomeChange').innerHTML = incChange !== 0 ? `<span class="${incChange > 0 ? 'green' : 'red'}">${incChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(incChange).toFixed(1)}%</span>` : '';
  $('compExpenseChange').innerHTML = expChange !== 0 ? `<span class="${expChange < 0 ? 'green' : 'red'}">${expChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(expChange).toFixed(1)}%</span>` : '';
  
  // Top category comparison
  const getCatTop = (txns) => {
    const cats = {};
    txns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
    const top = Object.entries(cats).sort((a,b) => b[1] - a[1])[0];
    return top ? `${CATS[top[0]]?.i || 'üí≥'} ${top[0]}` : '-';
  };
  $('biggestCatThis').textContent = getCatTop(thisMonth);
  $('biggestCatLast').textContent = getCatTop(lastMonth);
}

// Quick Stats
function renderQuickStats(expenses, days) {
  $('avgDailySpend').textContent = fmt(expenses / days);
  
  // Best and worst days
  const dailySpend = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const d = t.parsedDate.toISOString().split('T')[0];
    dailySpend[d] = (dailySpend[d] || 0) + Math.abs(t.amount);
  });
  
  const sorted = Object.entries(dailySpend).sort((a,b) => a[1] - b[1]);
  if (sorted.length) {
    const best = sorted[0];
    const worst = sorted[sorted.length - 1];
    const bestDate = new Date(best[0]);
    const worstDate = new Date(worst[0]);
    $('bestDay').textContent = WDAYS[bestDate.getDay()] + ' ' + fmt(best[1]);
    $('worstDay').textContent = WDAYS[worstDate.getDay()] + ' ' + fmt(worst[1]);
  }
  
  // Subscription estimate (recurring payments)
  const recurring = detectRecurring();
  const monthlyTotal = recurring.filter(r => r.pat === 'Monthly').reduce((s,r) => s + r.a, 0);
  $('subscriptionTotal').textContent = fmt(monthlyTotal) + '/mo';
}

function detectRecurring() {
  const g = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const m = t.description.split(/\s+/).slice(0,2).join(' ').toUpperCase();
    const a = Math.abs(t.amount).toFixed(2);
    const k = m + '|' + a;
    if (!g[k]) g[k] = { m, a: Math.abs(t.amount), dates: [] };
    g[k].dates.push(t.parsedDate);
  });
  
  const r = [];
  for (const gr of Object.values(g)) {
    if (gr.dates.length >= 2) {
      gr.dates.sort((a,b) => a-b);
      const diffs = [];
      for (let i = 1; i < gr.dates.length; i++) diffs.push((gr.dates[i] - gr.dates[i-1]) / 864e5);
      const avg = diffs.reduce((a,b) => a+b, 0) / diffs.length;
      if (avg >= 25 && avg <= 35) r.push({ ...gr, pat: 'Monthly' });
      else if (avg >= 5 && avg <= 9) r.push({ ...gr, pat: 'Weekly' });
    }
  }
  return r;
}

function renderYoY() {
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  if (years.length < 2) { $('yoyBox').classList.add('hidden'); return; }
  $('yoyBox').classList.remove('hidden');
  const y1 = years[years.length-2], y2 = years[years.length-1];
  $('yoyYears').textContent = y1 + ' vs ' + y2;
  
  const t1 = activeTxns.filter(t => t.year === y1), t2 = activeTxns.filter(t => t.year === y2);
  const inc1 = t1.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const inc2 = t2.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const exp1 = Math.abs(t1.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  const exp2 = Math.abs(t2.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  
  const pct = (a,b) => b > 0 ? ((a-b)/b*100).toFixed(1) : '0';
  $('yoyGrid').innerHTML = `
    <div class="yoy-item"><div class="yoy-label">üí∞ Income</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(inc1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(inc2)}</div></div></div><div class="yoy-change ${inc2>inc1?'down':'up'}">${inc2>inc1?'‚Üë':'‚Üì'} ${Math.abs(pct(inc2,inc1))}%</div></div>
    <div class="yoy-item"><div class="yoy-label">üí∏ Expenses</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(exp1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(exp2)}</div></div></div><div class="yoy-change ${exp2>exp1?'up':'down'}">${exp2>exp1?'‚Üë':'‚Üì'} ${Math.abs(pct(exp2,exp1))}%</div></div>
  `;
}

function renderHeatmap() {
  const ds = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const k = t.parsedDate.toISOString().split('T')[0];
    ds[k] = (ds[k]||0) + Math.abs(t.amount);
  });
  const vals = Object.values(ds), max = Math.max(...vals, 1);
  const th = [0, max*.2, max*.4, max*.6, max*.8];
  
  if (!filteredTxns.length) { $('heatmap').innerHTML = '<div style="color:var(--muted)">No data</div>'; return; }
  
  const start = new Date(filteredTxns[0].parsedDate);
  const end = new Date(filteredTxns[filteredTxns.length-1].parsedDate);
  start.setDate(start.getDate() - start.getDay());
  
  const weeks = [];
  let cur = new Date(start);
  while (cur <= end) {
    const wk = [];
    for (let d = 0; d < 7; d++) {
      const k = cur.toISOString().split('T')[0];
      const v = ds[k] || 0;
      let lv = 0;
      for (let i = th.length-1; i >= 0; i--) if (v >= th[i]) { lv = i; break; }
      wk.push({ k, v, lv });
      cur.setDate(cur.getDate() + 1);
    }
    weeks.push(wk);
  }
  
  $('heatmap').innerHTML = weeks.map(wk => '<div class="heatmap-week">' + wk.map(d => `<div class="heatmap-cell ${d.lv?'l'+d.lv:''}" title="${d.k}: ${fmt(d.v)}"></div>`).join('') + '</div>').join('');
}

function renderWeekday() {
  const w = [0,0,0,0,0,0,0];
  filteredTxns.filter(t => t.amount < 0).forEach(t => w[t.weekday] += Math.abs(t.amount));
  const max = Math.max(...w, 1);
  $('weekdayBars').innerHTML = WDAYS.map((d,i) => `<div class="weekday-bar"><div class="weekday-value">${fmt(w[i])}</div><div class="weekday-fill" style="height:${(w[i]/max)*100}%;background:${COLORS[i]}"></div><div class="weekday-label">${d}</div></div>`).join('');
}

function renderRecurring() {
  const r = detectRecurring();
  $('recurringCount').textContent = r.length;
  $('recurringList').innerHTML = r.length ? r.sort((a,b) => b.a - a.a).slice(0,5).map(x => `<div class="list-item"><div class="list-icon" style="background:rgba(99,102,241,0.2)">üîÑ</div><div class="list-info"><div class="list-title">${x.m}</div><div class="list-sub">${x.pat} ‚Ä¢ ${x.dates.length}√ó</div></div><div class="list-value blue">${fmt(-x.a)}</div></div>`).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">None found</div>';
}

function renderMerchants() {
  const m = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const n = t.description.split(/\s+/).slice(0,2).join(' ').toUpperCase();
    if (!m[n]) m[n] = { n, tot: 0, cnt: 0 };
    m[n].tot += Math.abs(t.amount);
    m[n].cnt++;
  });
  const list = Object.values(m);
  const byAmt = [...list].sort((a,b) => b.tot - a.tot).slice(0,6);
  const byFreq = [...list].sort((a,b) => b.cnt - a.cnt).slice(0,6);
  
  $('merchantsAmt').innerHTML = byAmt.map((x,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${x.n}</div><div class="list-sub">${x.cnt} visits</div></div><div class="list-value red">${fmt(-x.tot)}</div></div>`).join('');
  $('merchantsFreq').innerHTML = byFreq.map((x,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${x.n}</div><div class="list-sub">${fmt(-x.tot)}</div></div><div class="list-value blue">${x.cnt}√ó</div></div>`).join('');
}

function renderCategories() {
  const cats = {};
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  $('categoryList').innerHTML = sorted.map(([cat, amt]) => {
    const cfg = CATS[cat] || CATS.Other;
    const pct = expenses > 0 ? (amt/expenses*100).toFixed(1) : 0;
    return `<div class="list-item" style="cursor:pointer" onclick="filterByCat('${cat}')"><div class="list-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="list-info"><div class="list-title">${cat}</div><div style="height:4px;background:var(--border);border-radius:2px;margin-top:4px"><div style="height:100%;width:${pct}%;background:${cfg.c};border-radius:2px"></div></div></div><div style="text-align:right"><div class="list-value red">${fmt(-amt)}</div><div class="list-sub">${pct}%</div></div></div>`;
  }).join('');
}

function renderTopExpenses() {
  const top = filteredTxns.filter(t => t.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10);
  $('topExpenses').innerHTML = top.map((t,i) => {
    const cfg = CATS[t.category] || CATS.Other;
    const note = txnNotes[t.description];
    return `<div class="list-item" style="cursor:pointer" onclick="editTxn('${t.id}')"><div class="rank" style="${i<3?'background:linear-gradient(135deg,#f59e0b,#f97316);color:#000':''}">${i+1}</div><div class="list-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="list-info"><div class="list-title">${t.description}${note?' üìù':''}</div><div class="list-sub">${t.date} ‚Ä¢ ${t.category}</div></div><div class="list-value red">${fmt(t.amount)}</div></div>`;
  }).join('');
}

function renderCharts() {
  const tc = isDark ? '#94a3b8' : '#64748b';
  const gc = isDark ? '#334155' : '#e2e8f0';
  
  // Pie
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  if (pieChart) pieChart.destroy();
  if (sorted.length) {
    pieChart = new Chart($('pieChart'), {
      type: 'doughnut',
      data: { labels: sorted.map(([c]) => c), datasets: [{ data: sorted.map(([,v]) => v), backgroundColor: sorted.map(([c]) => (CATS[c]||CATS.Other).c), borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false } } }
    });
  }
  
  // Line
  const balances = [];
  filteredTxns.forEach(t => {
    const ex = balances.find(b => b.date === t.date);
    if (ex) ex.bal = t.balance;
    else balances.push({ date: t.date, bal: t.balance });
  });
  
  if (lineChart) lineChart.destroy();
  if (balances.length) {
    lineChart = new Chart($('lineChart'), {
      type: 'line',
      data: { labels: balances.map(b => b.date), datasets: [{ data: balances.map(b => b.bal), borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.3, pointRadius: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gc }, ticks: { color: tc, maxTicksLimit: 6 } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0)+'k' } } } }
    });
  }
  
  // Bar
  const monthly = {};
  activeTxns.forEach(t => {
    const k = t.year + '-' + String(t.month+1).padStart(2,'0');
    if (!monthly[k]) monthly[k] = { inc: 0, exp: 0 };
    if (t.amount > 0) monthly[k].inc += t.amount;
    else monthly[k].exp += Math.abs(t.amount);
  });
  const mKeys = Object.keys(monthly).sort();
  
  if (barChart) barChart.destroy();
  if (mKeys.length) {
    barChart = new Chart($('barChart'), {
      type: 'bar',
      data: { labels: mKeys.map(k => MONTHS[parseInt(k.split('-')[1])-1] + ' ' + k.split('-')[0].slice(2)), datasets: [{ label: 'Income', data: mKeys.map(k => monthly[k].inc), backgroundColor: '#22c55e' }, { label: 'Expenses', data: mKeys.map(k => monthly[k].exp), backgroundColor: '#fb7185' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: tc } } }, scales: { x: { grid: { display: false }, ticks: { color: tc } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0)+'k' } } } }
    });
  }
}

function renderTxns() {
  const list = showAll ? filteredTxns.slice().reverse() : filteredTxns.slice(-15).reverse();
  $('txnTitle').textContent = selCat || 'Transactions';
  
  $('txnList').innerHTML = list.map(t => {
    const cfg = CATS[t.category] || CATS.Other;
    const pos = t.amount > 0;
    const note = txnNotes[t.description];
    return `<div class="txn-item" onclick="editTxn('${t.id}')"><div class="txn-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="txn-details"><div class="txn-desc">${t.description}${note?' üìù':''}</div><div class="txn-meta">${t.date} ‚Ä¢ ${WDAYS[t.weekday]}<span class="txn-cat" style="background:${cfg.c}30;color:${cfg.c}">${t.category}</span></div></div><div class="txn-amount"><div class="txn-amt ${pos?'green':'red'}">${pos?'+':''}${fmt(t.amount)}</div><div class="txn-bal">Bal: ${fmt(t.balance)}</div></div></div>`;
  }).join('');
  
  $('showMoreBtn').textContent = showAll ? '‚ñ≤ Show less' : `‚ñº Show all ${filteredTxns.length}`;
  $('showMoreBtn').classList.toggle('hidden', filteredTxns.length <= 15);
}

// Edit Transaction
function editTxn(id) {
  const t = activeTxns.find(x => x.id === id);
  if (!t) return;
  editingTxn = t;
  selNewCat = t.category;
  $('editDesc').textContent = t.description;
  $('editNote').value = txnNotes[t.description] || '';
  renderCatGrid();
  $('editModal').classList.remove('hidden');
}

function renderCatGrid() {
  $('catGrid').innerHTML = Object.entries(CATS).map(([name, cfg]) => `<div class="cat-opt ${selNewCat===name?'selected':''}" onclick="selNewCat='${name}';renderCatGrid()"><div class="cat-opt-icon">${cfg.i}</div><div class="cat-opt-name">${name}</div></div>`).join('');
}

function hideEditModal() { $('editModal').classList.add('hidden'); editingTxn = null; }

async function saveEdit() {
  if (!editingTxn) return;
  catOverrides[editingTxn.description] = selNewCat;
  const note = $('editNote').value.trim();
  if (note) txnNotes[editingTxn.description] = note;
  else delete txnNotes[editingTxn.description];
  await saveData();
  loadActiveTxns();
  hideEditModal();
  notify('Saved');
}

// Rules
function showRulesModal() {
  $('rulesList').innerHTML = Object.entries(catOverrides).length ? Object.entries(catOverrides).map(([desc, cat]) => {
    const cfg = CATS[cat] || CATS.Other;
    return `<div class="list-item"><div class="list-info"><div class="list-title">${desc.slice(0,30)}${desc.length>30?'...':''}</div></div><div style="display:flex;align-items:center;gap:8px"><span>${cfg.i} ${cat}</span><span style="color:var(--red);cursor:pointer" onclick="deleteRule('${desc.replace(/'/g,"\\'")}')">√ó</span></div></div>`;
  }).join('') : '<div style="text-align:center;padding:20px;color:var(--muted)">No rules yet</div>';
  $('rulesModal').classList.remove('hidden');
}

function hideRulesModal() { $('rulesModal').classList.add('hidden'); }

async function deleteRule(desc) {
  delete catOverrides[desc];
  await saveData();
  loadActiveTxns();
  showRulesModal();
  notify('Rule deleted');
}

async function clearAllRules() {
  if (!confirm('Clear all rules?')) return;
  catOverrides = {};
  await saveData();
  loadActiveTxns();
  showRulesModal();
  notify('All rules cleared');
}

// Export
function exportCSV() {
  const rows = [['Date','Day','Description','Amount','Balance','Category','Note']];
  filteredTxns.forEach(t => rows.push([t.date, WDAYS[t.weekday], `"${t.description}"`, t.amount.toFixed(2), t.balance.toFixed(2), t.category, `"${txnNotes[t.description]||''}"`]));
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bank-export-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  notify('Exported CSV');
}

// Close dropdowns on outside click
document.onclick = e => {
  if (!e.target.closest('.user-menu')) $('userDropdown').classList.remove('show');
};

// ==================== TRANSACTIONS PAGE ====================

function initTransactionsPage() {
  // Populate category filter
  $('txnCategory').innerHTML = '<option value="all">All Categories</option>' + 
    Object.entries(CATS).map(([name, cfg]) => `<option value="${name}">${cfg.i} ${name}</option>`).join('');
  
  applyTxnFilters();
  generateAlerts();
}

function applyTxnFilters() {
  const dateFrom = $('dateFrom')?.value;
  const dateTo = $('dateTo')?.value;
  const amountMin = parseFloat($('amountMin')?.value) || null;
  const amountMax = parseFloat($('amountMax')?.value) || null;
  const type = $('txnType')?.value || 'all';
  const category = $('txnCategory')?.value || 'all';
  const search = $('txnSearch')?.value?.toLowerCase() || '';
  const sort = $('txnSort')?.value || 'date-desc';
  
  txnPageData = activeTxns.filter(t => {
    if (dateFrom && t.parsedDate < new Date(dateFrom)) return false;
    if (dateTo && t.parsedDate > new Date(dateTo + 'T23:59:59')) return false;
    if (amountMin !== null && Math.abs(t.amount) < amountMin) return false;
    if (amountMax !== null && Math.abs(t.amount) > amountMax) return false;
    if (type === 'expense' && t.amount >= 0) return false;
    if (type === 'income' && t.amount < 0) return false;
    if (category !== 'all' && t.category !== category) return false;
    if (search && !t.description.toLowerCase().includes(search)) return false;
    return true;
  });
  
  // Sort
  txnPageData.sort((a, b) => {
    switch (sort) {
      case 'date-asc': return a.parsedDate - b.parsedDate;
      case 'date-desc': return b.parsedDate - a.parsedDate;
      case 'amount-asc': return a.amount - b.amount;
      case 'amount-desc': return b.amount - a.amount;
      case 'category': return a.category.localeCompare(b.category);
      default: return b.parsedDate - a.parsedDate;
    }
  });
  
  txnCurrentPage = 1;
  renderTxnTable();
  updateTxnSummary();
}

function clearTxnFilters() {
  $('dateFrom').value = '';
  $('dateTo').value = '';
  $('amountMin').value = '';
  $('amountMax').value = '';
  $('txnType').value = 'all';
  $('txnCategory').value = 'all';
  $('txnSearch').value = '';
  $('txnSort').value = 'date-desc';
  selectedTxns.clear();
  applyTxnFilters();
}

function renderTxnTable() {
  const start = (txnCurrentPage - 1) * txnPerPage;
  const end = start + txnPerPage;
  const pageData = txnPageData.slice(start, end);
  
  $('txnPageCount').textContent = txnPageData.length + ' transactions';
  
  $('txnTableBody').innerHTML = pageData.map(t => {
    const cfg = CATS[t.category] || CATS.Other;
    const isSelected = selectedTxns.has(t.id);
    return `<div class="txn-table-row ${isSelected ? 'selected' : ''}" data-id="${t.id}">
      <div class="txn-col-check"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTxnSelect('${t.id}')"></div>
      <div class="txn-col-date">${t.date}<br><span style="font-size:10px;color:var(--muted)">${WDAYS[t.weekday]}</span></div>
      <div class="txn-col-desc" title="${t.description}">${t.description}${txnNotes[t.description] ? ' üìù' : ''}</div>
      <div class="txn-col-cat"><span style="background:${cfg.c}20;color:${cfg.c}">${cfg.i} ${t.category}</span></div>
      <div class="txn-col-amount ${t.amount >= 0 ? 'green' : 'red'}">${t.amount >= 0 ? '+' : ''}${fmt(t.amount)}</div>
      <div class="txn-col-balance">${fmt(t.balance)}</div>
      <div class="txn-col-actions"><button class="btn btn-small btn-blue" onclick="editTxn('${t.id}')" style="padding:4px 8px">‚úèÔ∏è</button></div>
    </div>`;
  }).join('');
  
  renderPagination();
  updateSelectionBar();
}

function renderPagination() {
  const totalPages = Math.ceil(txnPageData.length / txnPerPage);
  if (totalPages <= 1) {
    $('pagination').innerHTML = '';
    return;
  }
  
  let html = `<button class="page-btn" onclick="goToPage(${txnCurrentPage - 1})" ${txnCurrentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`;
  
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= txnCurrentPage - 2 && i <= txnCurrentPage + 2)) {
      html += `<button class="page-btn ${i === txnCurrentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    } else if (i === txnCurrentPage - 3 || i === txnCurrentPage + 3) {
      html += `<span style="color:var(--muted)">...</span>`;
    }
  }
  
  html += `<button class="page-btn" onclick="goToPage(${txnCurrentPage + 1})" ${txnCurrentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>`;
  $('pagination').innerHTML = html;
}

function goToPage(page) {
  const totalPages = Math.ceil(txnPageData.length / txnPerPage);
  if (page < 1 || page > totalPages) return;
  txnCurrentPage = page;
  renderTxnTable();
  $('pageTransactions').scrollTo({ top: 0, behavior: 'smooth' });
}

function updateTxnSummary() {
  const income = txnPageData.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const expenses = Math.abs(txnPageData.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const net = income - expenses;
  
  $('filteredIncome').textContent = fmt(income);
  $('filteredExpenses').textContent = fmt(expenses);
  $('filteredNet').textContent = fmt(net);
  $('filteredNet').className = 'summary-value ' + (net >= 0 ? 'green' : 'red');
}

// Selection
function toggleTxnSelect(id) {
  if (selectedTxns.has(id)) {
    selectedTxns.delete(id);
  } else {
    selectedTxns.add(id);
  }
  renderTxnTable();
}

function toggleSelectAll() {
  const allChecked = $('selectAll').checked;
  const start = (txnCurrentPage - 1) * txnPerPage;
  const end = start + txnPerPage;
  const pageData = txnPageData.slice(start, end);
  
  if (allChecked) {
    pageData.forEach(t => selectedTxns.add(t.id));
  } else {
    pageData.forEach(t => selectedTxns.delete(t.id));
  }
  renderTxnTable();
}

function clearSelection() {
  selectedTxns.clear();
  renderTxnTable();
}

function updateSelectionBar() {
  const count = selectedTxns.size;
  $('selectionBar').classList.toggle('hidden', count === 0);
  $('selectedCount').textContent = count + ' selected';
}

// Bulk operations
function bulkChangeCategory() {
  if (selectedTxns.size === 0) return;
  bulkSelectedCat = null;
  $('bulkCount').textContent = selectedTxns.size;
  $('bulkCatGrid').innerHTML = Object.entries(CATS).map(([name, cfg]) => 
    `<div class="cat-opt" onclick="selectBulkCat('${name}')" id="bulkCat_${name}"><div class="cat-opt-icon">${cfg.i}</div><div class="cat-opt-name">${name}</div></div>`
  ).join('');
  $('bulkCatModal').classList.remove('hidden');
}

function selectBulkCat(cat) {
  bulkSelectedCat = cat;
  document.querySelectorAll('#bulkCatGrid .cat-opt').forEach(el => el.classList.remove('selected'));
  $('bulkCat_' + cat).classList.add('selected');
}

function hideBulkCatModal() {
  $('bulkCatModal').classList.add('hidden');
}

async function applyBulkCategory() {
  if (!bulkSelectedCat || selectedTxns.size === 0) return;
  
  selectedTxns.forEach(id => {
    const txn = activeTxns.find(t => t.id === id);
    if (txn) {
      catOverrides[txn.description] = bulkSelectedCat;
    }
  });
  
  await saveData();
  loadActiveTxns();
  selectedTxns.clear();
  hideBulkCatModal();
  applyTxnFilters();
  notify(`Changed ${selectedTxns.size} transactions to ${bulkSelectedCat}`);
}

function bulkCategorize() {
  if (selectedTxns.size === 0) {
    notify('Select transactions first', 'warning');
    return;
  }
  bulkChangeCategory();
}

// ==================== SMART ALERTS ====================

function generateAlerts() {
  alerts = [];
  const now = new Date();
  const largeThreshold = parseFloat($('alertLargeAmount')?.value) || 100;
  
  // Large transactions in last 7 days
  const recentLarge = activeTxns.filter(t => {
    const daysDiff = (now - t.parsedDate) / 864e5;
    return daysDiff <= 7 && t.amount < -largeThreshold;
  });
  
  recentLarge.forEach(t => {
    alerts.push({
      type: 'warning',
      icon: 'üí∏',
      title: 'Large Transaction',
      desc: `${t.description.slice(0, 30)} - ${fmt(t.amount)}`,
      time: t.date
    });
  });
  
  // Unusual spending (compare this week to average)
  const thisWeek = activeTxns.filter(t => (now - t.parsedDate) / 864e5 <= 7 && t.amount < 0);
  const thisWeekTotal = Math.abs(thisWeek.reduce((s, t) => s + t.amount, 0));
  
  const allWeeks = {};
  activeTxns.filter(t => t.amount < 0).forEach(t => {
    const weekNum = Math.floor((now - t.parsedDate) / (7 * 864e5));
    if (weekNum > 0 && weekNum <= 8) {
      allWeeks[weekNum] = (allWeeks[weekNum] || 0) + Math.abs(t.amount);
    }
  });
  
  const avgWeekly = Object.values(allWeeks).length > 0 
    ? Object.values(allWeeks).reduce((a, b) => a + b, 0) / Object.values(allWeeks).length 
    : 0;
  
  if (avgWeekly > 0 && thisWeekTotal > avgWeekly * 1.5) {
    alerts.push({
      type: 'danger',
      icon: '‚ö†Ô∏è',
      title: 'Unusual Spending',
      desc: `This week: ${fmt(thisWeekTotal)} (${((thisWeekTotal / avgWeekly - 1) * 100).toFixed(0)}% above average)`,
      time: 'This week'
    });
  }
  
  // Low balance warning
  const lastBal = activeTxns.length ? activeTxns[activeTxns.length - 1].balance : 0;
  if (lastBal < 500 && lastBal > 0) {
    alerts.push({
      type: 'danger',
      icon: 'üî¥',
      title: 'Low Balance',
      desc: `Current balance: ${fmt(lastBal)}`,
      time: 'Now'
    });
  }
  
  // Good savings rate
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const monthIncome = thisMonth.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const monthExpenses = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const savingsRate = monthIncome > 0 ? ((monthIncome - monthExpenses) / monthIncome * 100) : 0;
  
  if (savingsRate >= 30) {
    alerts.push({
      type: 'success',
      icon: 'üèÜ',
      title: 'Great Savings!',
      desc: `${savingsRate.toFixed(0)}% savings rate this month`,
      time: 'This month'
    });
  }
  
  // Recurring payment reminder
  const recurring = detectRecurring();
  const today = now.getDate();
  recurring.forEach(r => {
    r.dates.sort((a, b) => b - a);
    const lastDate = r.dates[0];
    const dayOfMonth = lastDate.getDate();
    if (Math.abs(dayOfMonth - today) <= 3) {
      alerts.push({
        type: 'info',
        icon: 'üîÑ',
        title: 'Recurring Payment Due',
        desc: `${r.m} - ${fmt(r.a)} (usually around ${dayOfMonth}th)`,
        time: 'Soon'
      });
    }
  });
  
  // Update alert dot
  const hasImportant = alerts.some(a => a.type === 'danger' || a.type === 'warning');
  $('alertDot').classList.toggle('hidden', !hasImportant);
}

function showAlertsModal() {
  generateAlerts();
  
  $('alertsList').innerHTML = alerts.length ? alerts.map(a => `
    <div class="alert-item ${a.type}">
      <div class="alert-icon">${a.icon}</div>
      <div class="alert-content">
        <div class="alert-title">${a.title}</div>
        <div class="alert-desc">${a.desc}</div>
      </div>
      <div class="alert-time">${a.time}</div>
    </div>
  `).join('') : '<div style="text-align:center;padding:20px;color:var(--muted)">No alerts - you\'re doing great! üéâ</div>';
  
  $('alertsModal').classList.remove('hidden');
}

function hideAlertsModal() {
  $('alertsModal').classList.add('hidden');
}

// ==================== FINANCIAL TOOLS ====================

function initToolsPage() {
  calculateDebt();
  calculateInvestment();
  initWhatIf();
}

function switchToolTab(tab) {
  document.querySelectorAll('.tool-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tool-panel').forEach(p => p.classList.add('hidden'));
  event.target.classList.add('active');
  $('tool' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
}

// ========== DEBT PAYOFF CALCULATOR ==========

function setDebtExtra(amount) {
  $('debtExtraPayment').value = amount;
  calculateDebt();
}

function calculateDebt() {
  const principal = parseFloat($('debtAmount').value) || 0;
  const apr = parseFloat($('debtInterest').value) || 0;
  const minPayment = parseFloat($('debtMinPayment').value) || 0;
  const extraPayment = parseFloat($('debtExtraPayment').value) || 0;
  
  const monthlyRate = apr / 100 / 12;
  const totalPayment = minPayment + extraPayment;
  
  if (principal <= 0 || totalPayment <= 0) return;
  
  // Calculate with minimum payment only
  let balanceMin = principal;
  let monthsMin = 0;
  let interestMin = 0;
  const dataMin = [{ month: 0, balance: principal }];
  
  while (balanceMin > 0 && monthsMin < 600) {
    const interest = balanceMin * monthlyRate;
    interestMin += interest;
    balanceMin = Math.max(0, balanceMin + interest - minPayment);
    monthsMin++;
    dataMin.push({ month: monthsMin, balance: balanceMin });
  }
  
  // Calculate with extra payment
  let balance = principal;
  let months = 0;
  let totalInterest = 0;
  const data = [{ month: 0, balance: principal }];
  
  while (balance > 0 && months < 600) {
    const interest = balance * monthlyRate;
    totalInterest += interest;
    balance = Math.max(0, balance + interest - totalPayment);
    months++;
    data.push({ month: months, balance });
  }
  
  const totalPaid = principal + totalInterest;
  const payoffDate = new Date();
  payoffDate.setMonth(payoffDate.getMonth() + months);
  
  // Update UI
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;
  $('debtPayoffTime').textContent = years > 0 ? `${years}y ${remainingMonths}m` : `${months} months`;
  $('debtPayoffDate').textContent = `Debt-free by ${payoffDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
  $('debtTotalInterest').textContent = fmt(totalInterest);
  $('debtTotalPaid').textContent = fmt(totalPaid);
  
  // Show savings if extra payment
  if (extraPayment > 0) {
    const interestSaved = interestMin - totalInterest;
    const monthsSaved = monthsMin - months;
    $('debtSavingsCard').classList.remove('hidden');
    $('debtSavings').textContent = fmt(interestSaved) + ' in interest';
    $('debtTimeSaved').textContent = `${monthsSaved} months faster!`;
  } else {
    $('debtSavingsCard').classList.add('hidden');
  }
  
  // Draw chart
  renderDebtChart(data, dataMin, extraPayment > 0);
}

function renderDebtChart(data, dataMin, showComparison) {
  const ctx = $('debtChart').getContext('2d');
  if (debtChart) debtChart.destroy();
  
  const datasets = [{
    label: 'With Extra Payment',
    data: data.map(d => ({ x: d.month, y: d.balance })),
    borderColor: '#22d3ee',
    backgroundColor: 'rgba(34,211,238,0.1)',
    fill: true,
    tension: 0.3
  }];
  
  if (showComparison) {
    datasets.push({
      label: 'Minimum Only',
      data: dataMin.map(d => ({ x: d.month, y: d.balance })),
      borderColor: '#fb7185',
      backgroundColor: 'rgba(251,113,133,0.1)',
      fill: true,
      tension: 0.3,
      borderDash: [5, 5]
    });
  }
  
  debtChart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: showComparison, labels: { color: '#94a3b8' } } },
      scales: {
        x: { type: 'linear', title: { display: true, text: 'Months', color: '#94a3b8' }, ticks: { color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.1)' } },
        y: { title: { display: true, text: 'Balance (‚Ç¨)', color: '#94a3b8' }, ticks: { color: '#64748b', callback: v => '‚Ç¨' + v.toLocaleString() }, grid: { color: 'rgba(148,163,184,0.1)' } }
      }
    }
  });
}

// ========== INVESTMENT GROWTH CALCULATOR ==========

function setInvestReturn(rate) {
  $('investReturn').value = rate;
  calculateInvestment();
}

function calculateInvestment() {
  const initial = parseFloat($('investInitial').value) || 0;
  const monthly = parseFloat($('investMonthly').value) || 0;
  const annualReturn = parseFloat($('investReturn').value) || 0;
  const years = parseInt($('investYears').value) || 0;
  
  const monthlyRate = annualReturn / 100 / 12;
  const months = years * 12;
  
  let balance = initial;
  let totalContributions = initial;
  const data = [{ month: 0, balance: initial, contributions: initial }];
  const milestones = [];
  
  for (let m = 1; m <= months; m++) {
    balance = balance * (1 + monthlyRate) + monthly;
    totalContributions += monthly;
    
    if (m % 12 === 0) {
      data.push({ month: m, balance, contributions: totalContributions });
    }
    
    // Check milestones
    if (balance >= 100000 && !milestones.find(x => x.amount === 100000)) {
      milestones.push({ amount: 100000, months: m });
    }
    if (balance >= 250000 && !milestones.find(x => x.amount === 250000)) {
      milestones.push({ amount: 250000, months: m });
    }
    if (balance >= 500000 && !milestones.find(x => x.amount === 500000)) {
      milestones.push({ amount: 500000, months: m });
    }
    if (balance >= 1000000 && !milestones.find(x => x.amount === 1000000)) {
      milestones.push({ amount: 1000000, months: m });
    }
  }
  
  const interestEarned = balance - totalContributions;
  const contribPercent = (totalContributions / balance * 100) || 0;
  const interestPercent = (interestEarned / balance * 100) || 0;
  
  // Update UI
  $('investFutureValue').textContent = fmt(balance);
  $('investYearsLabel').textContent = `in ${years} years`;
  $('investContributions').textContent = fmt(totalContributions);
  $('investInterestEarned').textContent = fmt(interestEarned);
  
  $('compoundContrib').style.width = contribPercent + '%';
  $('compoundInterest').style.width = interestPercent + '%';
  
  // Milestones
  $('investMilestones').innerHTML = milestones.length ? `
    <h4>üèÜ Milestones</h4>
    ${milestones.map(m => {
      const y = Math.floor(m.months / 12);
      const mo = m.months % 12;
      return `<div class="milestone-item"><span><span class="milestone-icon">üéØ</span>${fmt(m.amount)}</span><span>${y > 0 ? y + 'y ' : ''}${mo}m</span></div>`;
    }).join('')}
  ` : '';
  
  // Draw chart
  renderInvestChart(data);
}

function renderInvestChart(data) {
  const ctx = $('investChart').getContext('2d');
  if (investChart) investChart.destroy();
  
  investChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => `Year ${d.month / 12}`),
      datasets: [
        {
          label: 'Total Value',
          data: data.map(d => d.balance),
          borderColor: '#34d399',
          backgroundColor: 'rgba(52,211,153,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Contributions',
          data: data.map(d => d.contributions),
          borderColor: '#22d3ee',
          backgroundColor: 'rgba(34,211,238,0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#94a3b8' } } },
      scales: {
        x: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.1)' } },
        y: { ticks: { color: '#64748b', callback: v => '‚Ç¨' + (v/1000).toFixed(0) + 'k' }, grid: { color: 'rgba(148,163,184,0.1)' } }
      }
    }
  });
}

// ========== WHAT IF SCENARIOS ==========

function initWhatIf() {
  // Populate category dropdown
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  
  const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  $('cutCategory').innerHTML = sorted.map(([cat, amt]) => 
    `<option value="${cat}">${CATS[cat]?.i || 'üí≥'} ${cat} (${fmt(amt)}/mo avg)</option>`
  ).join('');
  
  // Set current values
  updateWhatIfCurrent();
}

function updateWhatIfCurrent() {
  const now = new Date();
  const months = {};
  
  activeTxns.forEach(t => {
    const key = t.year + '-' + t.month;
    if (!months[key]) months[key] = { income: 0, expenses: 0 };
    if (t.amount > 0) months[key].income += t.amount;
    else months[key].expenses += Math.abs(t.amount);
  });
  
  const monthData = Object.values(months);
  const avgIncome = monthData.reduce((s, m) => s + m.income, 0) / Math.max(1, monthData.length);
  const avgExpenses = monthData.reduce((s, m) => s + m.expenses, 0) / Math.max(1, monthData.length);
  const avgSavings = avgIncome - avgExpenses;
  const savingsRate = avgIncome > 0 ? (avgSavings / avgIncome * 100) : 0;
  
  $('currentIncome').textContent = fmt(avgIncome);
  $('currentExpenses').textContent = fmt(avgExpenses);
  $('currentSavings').textContent = fmt(avgSavings);
  $('currentRate').textContent = savingsRate.toFixed(1) + '%';
  
  return { avgIncome, avgExpenses, avgSavings, savingsRate };
}

function selectScenario(scenario) {
  currentScenario = scenario;
  
  // Update UI
  document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
  event.target.closest('.scenario-card').classList.add('selected');
  
  $('scenarioInputs').classList.remove('hidden');
  document.querySelectorAll('.scenario-form').forEach(f => f.classList.add('hidden'));
  $(`${scenario}Inputs`).classList.remove('hidden');
  
  const titles = {
    raise: 'üí∞ Raise Scenario',
    cut: '‚úÇÔ∏è Spending Cut Scenario',
    save: 'üéØ Savings Goal Scenario',
    invest: 'üìà Investment Scenario'
  };
  $('scenarioTitle').textContent = titles[scenario];
  
  $('whatifTip').classList.add('hidden');
  calculateWhatIf();
}

function calculateWhatIf() {
  if (!currentScenario) return;
  
  const current = updateWhatIfCurrent();
  let newIncome = current.avgIncome;
  let newExpenses = current.avgExpenses;
  
  switch (currentScenario) {
    case 'raise':
      const raiseAmount = parseFloat($('raiseAmount').value) || 0;
      newIncome = current.avgIncome + raiseAmount;
      break;
      
    case 'cut':
      const cutCategory = $('cutCategory').value;
      const cutPercent = parseFloat($('cutPercent').value) || 0;
      const categories = {};
      filteredTxns.filter(t => t.amount < 0).forEach(t => {
        categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
      });
      const monthCount = [...new Set(activeTxns.map(t => t.year + '-' + t.month))].length || 1;
      const catMonthly = (categories[cutCategory] || 0) / monthCount;
      const cutAmount = catMonthly * (cutPercent / 100);
      newExpenses = current.avgExpenses - cutAmount;
      break;
      
    case 'save':
      const targetRate = parseFloat($('targetSavingsRate').value) || 0;
      // To achieve target rate: savings = income * rate/100
      // savings = income - expenses
      // income - expenses = income * rate/100
      // expenses = income - income * rate/100 = income * (1 - rate/100)
      newExpenses = current.avgIncome * (1 - targetRate / 100);
      break;
      
    case 'invest':
      // For invest scenario, we show how monthly investment grows
      break;
  }
  
  const newSavings = newIncome - newExpenses;
  const newRate = newIncome > 0 ? (newSavings / newIncome * 100) : 0;
  
  // Update new values
  $('newIncome').textContent = fmt(newIncome);
  $('newIncome').className = newIncome > current.avgIncome ? 'green' : '';
  $('newExpenses').textContent = fmt(newExpenses);
  $('newExpenses').className = newExpenses < current.avgExpenses ? 'green' : '';
  $('newSavings').textContent = fmt(newSavings);
  $('newSavings').className = newSavings > current.avgSavings ? 'green' : '';
  $('newRate').textContent = newRate.toFixed(1) + '%';
  $('newRate').className = newRate > current.savingsRate ? 'green' : '';
  
  // Calculate impact
  const extraMonthlySavings = newSavings - current.avgSavings;
  const extraYearly = extraMonthlySavings * 12;
  
  // Future value with 7% return
  const monthlyRate = 0.07 / 12;
  const fv5 = extraMonthlySavings > 0 ? extraMonthlySavings * ((Math.pow(1 + monthlyRate, 60) - 1) / monthlyRate) : 0;
  const fv10 = extraMonthlySavings > 0 ? extraMonthlySavings * ((Math.pow(1 + monthlyRate, 120) - 1) / monthlyRate) : 0;
  
  // Handle invest scenario separately
  if (currentScenario === 'invest') {
    const monthlyInvest = parseFloat($('monthlyInvest').value) || 0;
    const expectedReturn = parseFloat($('expectedReturn').value) || 7;
    const mr = expectedReturn / 100 / 12;
    const fv5i = monthlyInvest * ((Math.pow(1 + mr, 60) - 1) / mr);
    const fv10i = monthlyInvest * ((Math.pow(1 + mr, 120) - 1) / mr);
    
    $('extraYearlySavings').textContent = fmt(monthlyInvest * 12) + ' invested';
    $('impact5Years').textContent = fmt(fv5i);
    $('impact10Years').textContent = fmt(fv10i);
  } else {
    $('extraYearlySavings').textContent = fmt(extraYearly);
    $('impact5Years').textContent = fmt(fv5);
    $('impact10Years').textContent = fmt(fv10);
  }
}

// ==================== AI CHAT ASSISTANT ====================

function toggleAIChat() {
  aiChatOpen = !aiChatOpen;
  $('aiChatPanel').classList.toggle('hidden', !aiChatOpen);
  if (aiChatOpen) {
    $('aiInput').focus();
  }
}

function sendAIMessage() {
  const input = $('aiInput');
  const message = input.value.trim();
  if (!message) return;
  
  addChatMessage(message, 'user');
  input.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  // Process the question
  setTimeout(() => {
    removeTypingIndicator();
    const response = processAIQuery(message);
    addChatMessage(response, 'bot');
  }, 800 + Math.random() * 500);
}

function askAI(question) {
  $('aiInput').value = question;
  sendAIMessage();
}

function addChatMessage(content, type) {
  const messages = $('aiChatMessages');
  const div = document.createElement('div');
  div.className = 'ai-message ' + type;
  div.innerHTML = `
    <div class="ai-message-avatar">${type === 'bot' ? 'ü§ñ' : 'üë§'}</div>
    <div class="ai-message-content">${content}</div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTypingIndicator() {
  const messages = $('aiChatMessages');
  const div = document.createElement('div');
  div.className = 'ai-message bot';
  div.id = 'typingIndicator';
  div.innerHTML = `
    <div class="ai-message-avatar">ü§ñ</div>
    <div class="ai-message-content"><div class="ai-typing"><span></span><span></span><span></span></div></div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function removeTypingIndicator() {
  const indicator = $('typingIndicator');
  if (indicator) indicator.remove();
}

function processAIQuery(query) {
  const q = query.toLowerCase();
  const now = new Date();
  
  // Get data
  const thisMonth = activeTxns.filter(t => t.parsedDate.getMonth() === now.getMonth() && t.parsedDate.getFullYear() === now.getFullYear());
  const lastMonth = activeTxns.filter(t => {
    const lm = new Date(now.getFullYear(), now.getMonth() - 1);
    return t.parsedDate.getMonth() === lm.getMonth() && t.parsedDate.getFullYear() === lm.getFullYear();
  });
  
  const allIncome = filteredTxns.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const allExpenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const thisMonthExp = Math.abs(thisMonth.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const thisMonthInc = thisMonth.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const lastMonthExp = Math.abs(lastMonth.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const lastMonthInc = lastMonth.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  
  // Categories
  const categories = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
  });
  const sortedCats = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  
  // Merchants
  const merchants = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const name = t.description.split(/\s+/).slice(0, 2).join(' ').toUpperCase();
    merchants[name] = (merchants[name] || 0) + Math.abs(t.amount);
  });
  const sortedMerchants = Object.entries(merchants).sort((a, b) => b[1] - a[1]);

  // Query matching
  
  // Spending this month
  if (q.includes('spend') && (q.includes('this month') || q.includes('month'))) {
    return `<p>This month you've spent <span class="ai-highlight">${fmt(thisMonthExp)}</span>.</p>
      <div class="ai-data-card">
        <h4>üìä This Month Breakdown</h4>
        <div class="ai-data-row"><span class="label">Expenses</span><span class="value red">${fmt(thisMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Income</span><span class="value green">${fmt(thisMonthInc)}</span></div>
        <div class="ai-data-row"><span class="label">Net</span><span class="value ${thisMonthInc - thisMonthExp >= 0 ? 'green' : 'red'}">${fmt(thisMonthInc - thisMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Transactions</span><span class="value">${thisMonth.length}</span></div>
      </div>`;
  }
  
  // Total spending
  if (q.includes('total') && q.includes('spend')) {
    return `<p>Your total spending in the selected period is <span class="ai-highlight">${fmt(allExpenses)}</span> across ${filteredTxns.filter(t => t.amount < 0).length} transactions.</p>`;
  }
  
  // Biggest/top category
  if ((q.includes('biggest') || q.includes('top') || q.includes('most')) && q.includes('categor')) {
    const top5 = sortedCats.slice(0, 5);
    return `<p>Your biggest spending category is <span class="ai-highlight">${CATS[top5[0]?.[0]]?.i || 'üí≥'} ${top5[0]?.[0] || 'N/A'}</span> at ${fmt(top5[0]?.[1] || 0)}.</p>
      <div class="ai-data-card">
        <h4>üèÜ Top 5 Categories</h4>
        ${top5.map(([cat, amt], i) => `<div class="ai-data-row"><span class="label">${i + 1}. ${CATS[cat]?.i || 'üí≥'} ${cat}</span><span class="value">${fmt(amt)}</span></div>`).join('')}
      </div>`;
  }
  
  // Compare months
  if (q.includes('compar') && (q.includes('month') || q.includes('last'))) {
    const diff = thisMonthExp - lastMonthExp;
    const pct = lastMonthExp > 0 ? ((diff / lastMonthExp) * 100).toFixed(1) : 0;
    const better = diff < 0;
    return `<p>Compared to last month, you've spent <span class="ai-highlight">${better ? fmt(Math.abs(diff)) + ' less' : fmt(diff) + ' more'}</span> (${better ? '‚Üì' : '‚Üë'}${Math.abs(pct)}%).</p>
      <div class="ai-data-card">
        <h4>üìà Month Comparison</h4>
        <div class="ai-data-row"><span class="label">This Month</span><span class="value">${fmt(thisMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Last Month</span><span class="value">${fmt(lastMonthExp)}</span></div>
        <div class="ai-data-row"><span class="label">Difference</span><span class="value ${better ? 'green' : 'red'}">${better ? '‚Üì' : '‚Üë'} ${fmt(Math.abs(diff))}</span></div>
      </div>
      <p style="margin-top:10px;font-size:13px">${better ? 'üéâ Great job reducing your spending!' : 'üí° Consider reviewing your expenses to find savings opportunities.'}</p>`;
  }
  
  // Specific category query
  for (const [catName, catConfig] of Object.entries(CATS)) {
    if (q.includes(catName.toLowerCase())) {
      const catTotal = categories[catName] || 0;
      const catTxns = filteredTxns.filter(t => t.category === catName && t.amount < 0);
      const pct = allExpenses > 0 ? ((catTotal / allExpenses) * 100).toFixed(1) : 0;
      return `<p>You've spent <span class="ai-highlight">${fmt(catTotal)}</span> on ${catConfig.i} ${catName} (${pct}% of total expenses).</p>
        <div class="ai-data-card">
          <h4>${catConfig.i} ${catName} Details</h4>
          <div class="ai-data-row"><span class="label">Total Spent</span><span class="value">${fmt(catTotal)}</span></div>
          <div class="ai-data-row"><span class="label">Transactions</span><span class="value">${catTxns.length}</span></div>
          <div class="ai-data-row"><span class="label">Average</span><span class="value">${fmt(catTotal / Math.max(1, catTxns.length))}</span></div>
          <div class="ai-data-row"><span class="label">% of Total</span><span class="value">${pct}%</span></div>
        </div>`;
    }
  }
  
  // Recurring payments
  if (q.includes('recurring') || q.includes('subscription') || q.includes('bills')) {
    const recurring = detectRecurring();
    const monthly = recurring.filter(r => r.pat === 'Monthly');
    const total = monthly.reduce((s, r) => s + r.a, 0);
    return `<p>I found <span class="ai-highlight">${monthly.length} recurring payments</span> totaling approximately <span class="ai-highlight">${fmt(total)}/month</span>.</p>
      <div class="ai-data-card">
        <h4>üîÑ Recurring Payments</h4>
        ${monthly.slice(0, 6).map(r => `<div class="ai-data-row"><span class="label">${r.m}</span><span class="value">${fmt(r.a)}</span></div>`).join('') || '<div class="ai-data-row"><span class="label">No recurring payments found</span></div>'}
      </div>
      ${monthly.length > 6 ? `<p style="font-size:12px;color:var(--muted);margin-top:8px">And ${monthly.length - 6} more...</p>` : ''}`;
  }
  
  // Top merchants
  if (q.includes('merchant') || q.includes('store') || q.includes('where') && q.includes('spend')) {
    const top5 = sortedMerchants.slice(0, 5);
    return `<p>Here are the top places you've spent money:</p>
      <div class="ai-data-card">
        <h4>üè™ Top Merchants</h4>
        ${top5.map(([name, amt], i) => `<div class="ai-data-row"><span class="label">${i + 1}. ${name}</span><span class="value">${fmt(amt)}</span></div>`).join('')}
      </div>`;
  }
  
  // Income
  if (q.includes('income') || q.includes('earn') || q.includes('salary')) {
    return `<p>Your total income in the selected period is <span class="ai-highlight">${fmt(allIncome)}</span>.</p>
      <div class="ai-data-card">
        <h4>üí∞ Income Breakdown</h4>
        <div class="ai-data-row"><span class="label">Total Income</span><span class="value green">${fmt(allIncome)}</span></div>
        <div class="ai-data-row"><span class="label">This Month</span><span class="value">${fmt(thisMonthInc)}</span></div>
        <div class="ai-data-row"><span class="label">Last Month</span><span class="value">${fmt(lastMonthInc)}</span></div>
        <div class="ai-data-row"><span class="label">Income Txns</span><span class="value">${filteredTxns.filter(t => t.amount > 0).length}</span></div>
      </div>`;
  }
  
  // Savings rate
  if (q.includes('saving') || q.includes('save')) {
    const savingsRate = allIncome > 0 ? ((allIncome - allExpenses) / allIncome * 100) : 0;
    const saved = allIncome - allExpenses;
    return `<p>Your savings rate is <span class="ai-highlight">${savingsRate.toFixed(1)}%</span>. You've saved <span class="ai-highlight">${fmt(saved)}</span> in the selected period.</p>
      <div class="ai-data-card">
        <h4>üéØ Savings Analysis</h4>
        <div class="ai-data-row"><span class="label">Income</span><span class="value green">${fmt(allIncome)}</span></div>
        <div class="ai-data-row"><span class="label">Expenses</span><span class="value red">${fmt(allExpenses)}</span></div>
        <div class="ai-data-row"><span class="label">Saved</span><span class="value ${saved >= 0 ? 'green' : 'red'}">${fmt(saved)}</span></div>
        <div class="ai-data-row"><span class="label">Savings Rate</span><span class="value">${savingsRate.toFixed(1)}%</span></div>
      </div>
      <p style="margin-top:10px;font-size:13px">${savingsRate >= 20 ? 'üèÜ Excellent! You\'re saving more than the recommended 20%!' : savingsRate >= 10 ? 'üëç Good progress! Try to reach 20% savings rate.' : 'üí° Tip: Aim to save at least 20% of your income.'}</p>`;
  }
  
  // Summary
  if (q.includes('summary') || q.includes('overview') || q.includes('how am i doing')) {
    const savingsRate = allIncome > 0 ? ((allIncome - allExpenses) / allIncome * 100) : 0;
    const topCat = sortedCats[0];
    return `<p>Here's your financial summary:</p>
      <div class="ai-data-card">
        <h4>üìã Financial Summary</h4>
        <div class="ai-data-row"><span class="label">üí∞ Total Income</span><span class="value green">${fmt(allIncome)}</span></div>
        <div class="ai-data-row"><span class="label">üí∏ Total Expenses</span><span class="value red">${fmt(allExpenses)}</span></div>
        <div class="ai-data-row"><span class="label">üìà Net</span><span class="value ${allIncome - allExpenses >= 0 ? 'green' : 'red'}">${fmt(allIncome - allExpenses)}</span></div>
        <div class="ai-data-row"><span class="label">üéØ Savings Rate</span><span class="value">${savingsRate.toFixed(1)}%</span></div>
        <div class="ai-data-row"><span class="label">üìä Top Category</span><span class="value">${topCat ? CATS[topCat[0]]?.i + ' ' + topCat[0] : 'N/A'}</span></div>
        <div class="ai-data-row"><span class="label">üìù Transactions</span><span class="value">${filteredTxns.length}</span></div>
      </div>
      <p style="margin-top:10px;font-size:13px">${savingsRate >= 20 ? 'üéâ You\'re doing great! Keep up the excellent financial habits.' : 'üí° Consider reducing spending on ' + (topCat?.[0] || 'your top category') + ' to improve savings.'}</p>`;
  }
  
  // Balance
  if (q.includes('balance')) {
    const lastBal = filteredTxns.length ? filteredTxns[filteredTxns.length - 1].balance : 0;
    return `<p>Your current balance is <span class="ai-highlight">${fmt(lastBal)}</span>.</p>`;
  }
  
  // Average daily
  if (q.includes('daily') || q.includes('per day') || q.includes('average')) {
    const days = filteredTxns.length > 1 ? Math.max(1, Math.ceil((filteredTxns[filteredTxns.length-1].parsedDate - filteredTxns[0].parsedDate) / 864e5)) : 1;
    const dailyAvg = allExpenses / days;
    return `<p>Your average daily spending is <span class="ai-highlight">${fmt(dailyAvg)}</span>.</p>
      <div class="ai-data-card">
        <h4>üìÖ Daily Stats</h4>
        <div class="ai-data-row"><span class="label">Daily Average</span><span class="value">${fmt(dailyAvg)}</span></div>
        <div class="ai-data-row"><span class="label">Weekly Estimate</span><span class="value">${fmt(dailyAvg * 7)}</span></div>
        <div class="ai-data-row"><span class="label">Monthly Estimate</span><span class="value">${fmt(dailyAvg * 30)}</span></div>
        <div class="ai-data-row"><span class="label">Days Analyzed</span><span class="value">${days}</span></div>
      </div>`;
  }
  
  // Largest transaction
  if (q.includes('largest') || q.includes('biggest') && (q.includes('transaction') || q.includes('purchase') || q.includes('expense'))) {
    const largest = [...filteredTxns].filter(t => t.amount < 0).sort((a, b) => a.amount - b.amount).slice(0, 5);
    return `<p>Your largest expense was <span class="ai-highlight">${fmt(largest[0]?.amount || 0)}</span> at ${largest[0]?.description?.slice(0, 30) || 'N/A'}.</p>
      <div class="ai-data-card">
        <h4>üî• Top 5 Largest Expenses</h4>
        ${largest.map((t, i) => `<div class="ai-data-row"><span class="label">${i + 1}. ${t.description.slice(0, 20)}</span><span class="value">${fmt(t.amount)}</span></div>`).join('')}
      </div>`;
  }
  
  // Default / help
  return `<p>I can help you with questions like:</p>
    <div class="ai-suggestions" style="margin-top:8px">
      <button onclick="askAI('How much did I spend this month?')">üí∞ Monthly spending</button>
      <button onclick="askAI('What is my biggest expense category?')">üìä Top category</button>
      <button onclick="askAI('How much on groceries?')">üõí Category totals</button>
      <button onclick="askAI('Compare this month to last')">üìà Comparisons</button>
      <button onclick="askAI('What are my recurring payments?')">üîÑ Subscriptions</button>
      <button onclick="askAI('What is my savings rate?')">üéØ Savings</button>
    </div>
    <p style="margin-top:12px;font-size:13px;color:var(--muted)">Try asking about specific categories like "groceries", "restaurants", or "fuel".</p>`;
}

// ==================== DASHBOARD CUSTOMIZATION ====================

const WIDGET_NAMES = {
  insights: 'üí° Smart Insights',
  stats: 'üìä Stats Cards',
  sankey: 'üí∏ Money Flow',
  treemap: 'üì¶ Treemap',
  radials: 'üéØ Progress Rings',
  prediction: 'üîÆ Predictions',
  quickstats: '‚ö° Quick Stats',
  race: 'üèÅ Spending Race',
  charts: 'üìà Charts',
  monthly: 'üìÜ Monthly',
  patterns: 'üóìÔ∏è Patterns',
  yoy: 'üìÖ Year-over-Year',
  merchants: 'üè™ Merchants',
  recurring: 'üîÑ Recurring',
  categories: 'üìã Categories',
  transactions: 'üìù Transactions'
};

function loadDashboardSettings() {
  const saved = localStorage.getItem('dashboardSettings');
  if (saved) {
    try {
      dashboardSettings = { ...dashboardSettings, ...JSON.parse(saved) };
    } catch (e) {}
  }
  applyDashboardSettings();
}

function saveDashboardSettings() {
  localStorage.setItem('dashboardSettings', JSON.stringify(dashboardSettings));
}

function applyDashboardSettings() {
  // Apply theme
  document.body.className = dashboardSettings.theme === 'dark' ? '' : dashboardSettings.theme;
  
  // Apply layout
  $('dashboard').className = $('dashboard').className.replace(/layout-\w+/g, '');
  if (dashboardSettings.layout !== 'default') {
    $('dashboard').classList.add('layout-' + dashboardSettings.layout);
  }
  
  // Apply card size
  $('dashboard').className = $('dashboard').className.replace(/card-size-\w+/g, '');
  if (dashboardSettings.cardSize !== 'medium') {
    $('dashboard').classList.add('card-size-' + dashboardSettings.cardSize);
  }
  
  // Apply widget visibility
  document.querySelectorAll('.widget').forEach(w => {
    const widgetId = w.dataset.widget;
    if (widgetId && dashboardSettings.widgets[widgetId] === false) {
      w.classList.add('hidden-widget');
    } else {
      w.classList.remove('hidden-widget');
    }
  });
  
  // Update layout select
  if ($('layoutSelect')) $('layoutSelect').value = dashboardSettings.layout;
}

function showCustomizeModal() {
  // Update theme selection
  document.querySelectorAll('.theme-opt').forEach(el => el.classList.remove('selected'));
  $('theme' + dashboardSettings.theme.charAt(0).toUpperCase() + dashboardSettings.theme.slice(1))?.classList.add('selected');
  
  // Render widget toggles
  $('widgetToggles').innerHTML = Object.entries(WIDGET_NAMES).map(([id, name]) => `
    <label class="widget-toggle">
      <input type="checkbox" ${dashboardSettings.widgets[id] !== false ? 'checked' : ''} onchange="toggleWidget('${id}')">
      <span>${name}</span>
    </label>
  `).join('');
  
  // Update card size
  document.querySelectorAll('input[name="cardSize"]').forEach(el => {
    el.checked = el.value === dashboardSettings.cardSize;
  });
  
  $('customizeModal').classList.remove('hidden');
}

function hideCustomizeModal() {
  $('customizeModal').classList.add('hidden');
  saveDashboardSettings();
}

function setTheme(theme) {
  dashboardSettings.theme = theme;
  document.querySelectorAll('.theme-opt').forEach(el => el.classList.remove('selected'));
  $('theme' + theme.charAt(0).toUpperCase() + theme.slice(1))?.classList.add('selected');
  applyDashboardSettings();
  saveDashboardSettings();
  
  // Re-render charts with new colors
  setTimeout(() => {
    renderCharts();
    renderSankeyChart();
    renderTreemap();
  }, 100);
}

function toggleWidget(id) {
  dashboardSettings.widgets[id] = !dashboardSettings.widgets[id];
  applyDashboardSettings();
  saveDashboardSettings();
}

function setCardSize(size) {
  dashboardSettings.cardSize = size;
  applyDashboardSettings();
  saveDashboardSettings();
}

function changeLayout() {
  dashboardSettings.layout = $('layoutSelect').value;
  applyDashboardSettings();
  saveDashboardSettings();
}

function resetDashboardSettings() {
  dashboardSettings = {
    theme: 'dark',
    layout: 'default',
    cardSize: 'medium',
    widgets: {
      insights: true, stats: true, sankey: true, treemap: true, radials: true,
      prediction: true, quickstats: true, race: true, charts: true, monthly: true,
      patterns: true, yoy: true, merchants: true, recurring: true, categories: true, transactions: true
    }
  };
  saveDashboardSettings();
  applyDashboardSettings();
  showCustomizeModal();
  notify('Dashboard reset to defaults');
}

// Admin Functions
async function loadAllUsers() {
  const snap = await db.ref('users').once('value');
  allUsers = snap.val() || {};
  $('usersBadge').textContent = Object.keys(allUsers).length;
}

function renderUsers() {
  const users = Object.entries(allUsers);
  const admins = users.filter(([,u]) => u.role === 'admin').length;
  $('statUsers').textContent = users.length;
  $('statAdmins').textContent = admins;
  
  $('usersList').innerHTML = users.map(([uid, u]) => {
    const initial = (u.name || u.email || '?')[0].toUpperCase();
    const isMe = uid === currentUser.uid;
    return `<div class="user-card">
      <div class="user-avatar">${initial}</div>
      <div class="user-info">
        <div class="user-name">${u.name || 'No name'}<span class="role-badge ${u.role}">${u.role}</span></div>
        <div class="user-email">${u.email}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">Joined ${new Date(u.createdAt).toLocaleDateString()}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${!isMe ? `<button class="btn btn-small btn-blue" onclick="viewUserData('${uid}')">üëÅÔ∏è View</button>` : ''}
        ${!isMe && u.role !== 'admin' ? `<button class="btn btn-small btn-green" onclick="makeAdmin('${uid}')">üëë Admin</button>` : ''}
        ${!isMe ? `<button class="btn btn-small btn-red" onclick="deleteUser('${uid}')">üóëÔ∏è</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function viewUserData(uid) {
  viewingUserId = uid;
  const snap = await db.ref('data/' + uid).once('value');
  const data = snap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  $('profileLabel').textContent = 'üëÅÔ∏è Viewing: ' + (allUsers[uid]?.name || allUsers[uid]?.email);
  renderImports();
  loadActiveTxns();
  switchPage('overview');
  notify('Viewing ' + (allUsers[uid]?.name || 'user') + "'s data");
}

async function makeAdmin(uid) {
  if (!confirm('Make this user an admin?')) return;
  await db.ref('users/' + uid + '/role').set('admin');
  allUsers[uid].role = 'admin';
  renderUsers();
  notify('User is now admin');
}

async function deleteUser(uid) {
  if (!confirm('Delete this user and ALL their data?')) return;
  await db.ref('users/' + uid).remove();
  await db.ref('data/' + uid).remove();
  delete allUsers[uid];
  renderUsers();
  notify('User deleted');
}

function showInviteModal() {
  $('inviteEmail').value = '';
  $('inviteName').value = '';
  $('invitePassword').value = '';
  $('inviteModal').classList.remove('hidden');
}

function hideInviteModal() {
  $('inviteModal').classList.add('hidden');
}

async function createUser() {
  const email = $('inviteEmail').value.trim();
  const name = $('inviteName').value.trim();
  const password = $('invitePassword').value;
  
  if (!email || !name || !password) {
    notify('Fill all fields', 'warning');
    return;
  }
  if (password.length < 6) {
    notify('Password must be 6+ characters', 'warning');
    return;
  }
  
  try {
    // Create with secondary auth to keep admin signed in
    const tempApp = firebase.initializeApp(firebaseConfig, 'temp' + Date.now());
    const tempAuth = tempApp.auth();
    const cred = await tempAuth.createUserWithEmailAndPassword(email, password);
    await cred.user.updateProfile({ displayName: name });
    await db.ref('users/' + cred.user.uid).set({ email, name, role: 'user', createdAt: Date.now() });
    await tempAuth.signOut();
    await tempApp.delete();
    
    allUsers[cred.user.uid] = { email, name, role: 'user', createdAt: Date.now() };
    $('usersBadge').textContent = Object.keys(allUsers).length;
    hideInviteModal();
    renderUsers();
    notify('User created! They can sign in with: ' + email);
  } catch (e) {
    notify(e.message, 'warning');
  }
}

// Print Report
function printReport() {
  // Generate summary for print
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const net = income - expenses;
  const sr = income > 0 ? (net / income * 100).toFixed(1) : 0;
  
  // Category breakdown
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { 
    cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); 
  });
  const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Bank Report - ${new Date().toLocaleDateString()}</title>
      <style>
        body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
        h1{color:#0f172a;border-bottom:2px solid #22d3ee;padding-bottom:10px}
        h2{color:#334155;margin-top:30px}
        .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:20px 0}
        .stat{background:#f8fafc;padding:15px;border-radius:8px;text-align:center}
        .stat-value{font-size:24px;font-weight:bold;color:#0f172a}
        .stat-label{font-size:12px;color:#64748b;margin-top:5px}
        .green{color:#059669}.red{color:#dc2626}.blue{color:#0891b2}
        table{width:100%;border-collapse:collapse;margin:20px 0}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #e2e8f0}
        th{background:#f8fafc;font-weight:600}
        .amount{text-align:right;font-family:monospace}
        .footer{margin-top:40px;text-align:center;color:#64748b;font-size:12px}
      </style>
    </head>
    <body>
      <h1>üí≥ Bank Analyzer Report</h1>
      <p>Generated: ${new Date().toLocaleString()}</p>
      <p>Period: ${filteredTxns.length ? filteredTxns[0].date + ' - ' + filteredTxns[filteredTxns.length-1].date : 'N/A'}</p>
      
      <div class="summary">
        <div class="stat"><div class="stat-value green">‚Ç¨${income.toFixed(2)}</div><div class="stat-label">Income</div></div>
        <div class="stat"><div class="stat-value red">‚Ç¨${expenses.toFixed(2)}</div><div class="stat-label">Expenses</div></div>
        <div class="stat"><div class="stat-value blue">‚Ç¨${net.toFixed(2)}</div><div class="stat-label">Net</div></div>
        <div class="stat"><div class="stat-value">${sr}%</div><div class="stat-label">Savings Rate</div></div>
      </div>
      
      <h2>üìä Spending by Category</h2>
      <table>
        <tr><th>Category</th><th class="amount">Amount</th><th class="amount">%</th></tr>
        ${sortedCats.map(([cat, amt]) => `<tr><td>${CATS[cat]?.i || 'üí≥'} ${cat}</td><td class="amount">‚Ç¨${amt.toFixed(2)}</td><td class="amount">${(amt/expenses*100).toFixed(1)}%</td></tr>`).join('')}
      </table>
      
      <h2>üî• Top 10 Expenses</h2>
      <table>
        <tr><th>#</th><th>Description</th><th>Date</th><th>Category</th><th class="amount">Amount</th></tr>
        ${filteredTxns.filter(t => t.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10).map((t,i) => `<tr><td>${i+1}</td><td>${t.description.slice(0,40)}</td><td>${t.date}</td><td>${t.category}</td><td class="amount red">‚Ç¨${Math.abs(t.amount).toFixed(2)}</td></tr>`).join('')}
      </table>
      
      <h2>üìù All Transactions (${filteredTxns.length})</h2>
      <table>
        <tr><th>Date</th><th>Description</th><th>Category</th><th class="amount">Amount</th></tr>
        ${filteredTxns.slice().reverse().map(t => `<tr><td>${t.date}</td><td>${t.description.slice(0,40)}</td><td>${t.category}</td><td class="amount ${t.amount > 0 ? 'green' : 'red'}">${t.amount > 0 ? '+' : ''}‚Ç¨${t.amount.toFixed(2)}</td></tr>`).join('')}
      </table>
      
      <div class="footer">
        <p>Bank Analyzer v9 ‚Ä¢ Cloud Sync Edition</p>
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// ==================== STOCKS ====================

const STOCK_API = 'https://query1.finance.yahoo.com/v8/finance/chart/';
const MARKET_INDICES = [
  { symbol: '^GSPC', name: 'S&P 500' },
  { symbol: '^DJI', name: 'Dow Jones' },
  { symbol: '^IXIC', name: 'NASDAQ' },
  { symbol: '^FTSE', name: 'FTSE 100' }
];

async function fetchStockPrice(symbol) {
  try {
    // Using a CORS proxy for Yahoo Finance
    const proxy = 'https://api.allorigins.win/raw?url=';
    const url = `${proxy}${encodeURIComponent(STOCK_API + symbol + '?interval=1d&range=5d')}`;
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.chart?.result?.[0]) {
      const result = data.chart.result[0];
      const meta = result.meta;
      const quote = result.indicators?.quote?.[0];
      
      return {
        symbol: meta.symbol,
        price: meta.regularMarketPrice,
        previousClose: meta.previousClose || meta.chartPreviousClose,
        currency: meta.currency,
        name: meta.shortName || meta.symbol,
        change: meta.regularMarketPrice - (meta.previousClose || meta.chartPreviousClose),
        changePercent: ((meta.regularMarketPrice - (meta.previousClose || meta.chartPreviousClose)) / (meta.previousClose || meta.chartPreviousClose) * 100)
      };
    }
    return null;
  } catch (e) {
    console.error('Error fetching stock:', symbol, e);
    return null;
  }
}

async function loadStocks() {
  $('stocksBadge').textContent = Object.keys(stocks).length;
  $('emailEnabled').checked = emailSettings.enabled;
  $('notificationEmail').value = emailSettings.email || currentUser.email;
  
  if (Object.keys(stocks).length === 0) {
    $('stocksList').innerHTML = '';
    $('noStocks').classList.remove('hidden');
    $('portfolioSummary').classList.add('hidden');
    renderMarketOverview();
    return;
  }
  
  $('noStocks').classList.add('hidden');
  $('portfolioSummary').classList.remove('hidden');
  
  // Fetch current prices
  $('stocksList').innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="color:var(--muted)">Loading prices...</p></div>';
  
  const symbols = [...new Set(Object.values(stocks).map(s => s.symbol))];
  for (const symbol of symbols) {
    const price = await fetchStockPrice(symbol);
    if (price) stockPrices[symbol] = price;
  }
  
  renderStocks();
  renderMarketOverview();
}

function renderStocks() {
  let totalInvested = 0;
  let totalValue = 0;
  
  const stockList = Object.entries(stocks).map(([id, stock]) => {
    const price = stockPrices[stock.symbol];
    const currentPrice = price?.price || stock.purchasePrice;
    const invested = stock.shares * stock.purchasePrice;
    const value = stock.shares * currentPrice;
    const gain = value - invested;
    const gainPct = invested > 0 ? (gain / invested * 100) : 0;
    
    totalInvested += invested;
    totalValue += value;
    
    return {
      id, ...stock,
      currentPrice,
      invested,
      value,
      gain,
      gainPct,
      priceData: price
    };
  }).sort((a, b) => b.value - a.value);
  
  const totalGain = totalValue - totalInvested;
  const totalGainPct = totalInvested > 0 ? (totalGain / totalInvested * 100) : 0;
  
  // Update summary
  $('totalInvested').textContent = fmt(totalInvested);
  $('totalValue').textContent = fmt(totalValue);
  $('totalValue').className = 'card-value ' + (totalGain >= 0 ? 'green' : 'red');
  $('totalGain').textContent = (totalGain >= 0 ? '+' : '') + fmt(totalGain);
  $('totalGain').className = 'card-value ' + (totalGain >= 0 ? 'green' : 'red');
  $('totalGainPct').textContent = (totalGain >= 0 ? '+' : '') + totalGainPct.toFixed(2) + '%';
  $('holdingsCount').textContent = stockList.length;
  
  // Render stock cards
  $('stocksList').innerHTML = stockList.map(s => `
    <div class="stock-card ${s.gain >= 0 ? 'profit' : 'loss'}">
      <div class="stock-symbol">${s.symbol}</div>
      <div class="stock-info">
        <div class="stock-name">${s.priceData?.name || s.symbol}</div>
        <div class="stock-meta">
          ${s.shares} shares @ ${fmt(s.purchasePrice)} ‚Ä¢ Invested: ${fmt(s.invested)}
        </div>
        <div class="stock-meta">
          Bought: ${new Date(s.purchaseDate).toLocaleDateString()} ${s.notes ? '‚Ä¢ ' + s.notes : ''}
        </div>
      </div>
      <div class="stock-values">
        <div class="stock-current">${fmt(s.value)}</div>
        <div class="stock-gain ${s.gain >= 0 ? 'profit' : 'loss'}">
          ${s.gain >= 0 ? '+' : ''}${fmt(s.gain)} (${s.gain >= 0 ? '+' : ''}${s.gainPct.toFixed(2)}%)
        </div>
        <div style="font-size:11px;color:var(--muted)">@ ${fmt(s.currentPrice)}/share</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-small btn-blue" onclick="editStock('${s.id}')">‚úèÔ∏è</button>
        <button class="btn btn-small btn-red" onclick="deleteStock('${s.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

async function renderMarketOverview() {
  $('marketOverview').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px"><div class="spinner"></div></div>';
  
  const indices = [];
  for (const index of MARKET_INDICES) {
    const data = await fetchStockPrice(index.symbol);
    if (data) indices.push({ ...index, ...data });
  }
  
  $('marketOverview').innerHTML = indices.map(idx => `
    <div class="card">
      <div class="card-label">${idx.name}</div>
      <div class="card-value" style="font-size:18px">${idx.price?.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) || 'N/A'}</div>
      <div class="card-sub ${idx.change >= 0 ? 'green' : 'red'}" style="color:${idx.change >= 0 ? 'var(--green)' : 'var(--red)'}">
        ${idx.change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(idx.change || 0).toFixed(2)} (${(idx.changePercent || 0).toFixed(2)}%)
      </div>
    </div>
  `).join('') || '<div style="color:var(--muted);text-align:center;padding:20px">Unable to load market data</div>';
}

function showAddStockModal() {
  editingStockId = null;
  $('stockModalTitle').textContent = 'üìà Add Stock';
  $('stockSymbol').value = '';
  $('stockShares').value = '';
  $('stockPrice').value = '';
  $('stockDate').value = new Date().toISOString().split('T')[0];
  $('stockNotes').value = '';
  $('stockModal').classList.remove('hidden');
}

function editStock(id) {
  const stock = stocks[id];
  if (!stock) return;
  
  editingStockId = id;
  $('stockModalTitle').textContent = '‚úèÔ∏è Edit Stock';
  $('stockSymbol').value = stock.symbol;
  $('stockShares').value = stock.shares;
  $('stockPrice').value = stock.purchasePrice;
  $('stockDate').value = stock.purchaseDate;
  $('stockNotes').value = stock.notes || '';
  $('stockModal').classList.remove('hidden');
}

function hideStockModal() {
  $('stockModal').classList.add('hidden');
  editingStockId = null;
}

async function saveStock() {
  const symbol = $('stockSymbol').value.toUpperCase().trim();
  const shares = parseFloat($('stockShares').value);
  const price = parseFloat($('stockPrice').value);
  const date = $('stockDate').value;
  const notes = $('stockNotes').value.trim();
  
  if (!symbol || !shares || !price || !date) {
    notify('Please fill all required fields', 'warning');
    return;
  }
  
  // Verify symbol exists
  const priceData = await fetchStockPrice(symbol);
  if (!priceData) {
    notify('Could not find stock symbol: ' + symbol, 'warning');
    return;
  }
  
  const id = editingStockId || 'stock_' + Date.now();
  stocks[id] = {
    symbol,
    shares,
    purchasePrice: price,
    purchaseDate: date,
    notes,
    addedAt: stocks[id]?.addedAt || Date.now()
  };
  
  await saveData();
  hideStockModal();
  loadStocks();
  notify(editingStockId ? 'Stock updated' : 'Stock added');
}

async function deleteStock(id) {
  if (!confirm('Delete this stock from your portfolio?')) return;
  delete stocks[id];
  await saveData();
  loadStocks();
  notify('Stock removed');
}

// Email notification settings
function toggleEmailNotifications() {
  emailSettings.enabled = $('emailEnabled').checked;
}

async function saveEmailSettings() {
  emailSettings.enabled = $('emailEnabled').checked;
  emailSettings.email = $('notificationEmail').value.trim();
  
  if (emailSettings.enabled && !emailSettings.email) {
    notify('Please enter an email address', 'warning');
    return;
  }
  
  await saveData();
  
  // Save to a separate notifications collection for the cloud function to process
  if (emailSettings.enabled) {
    await db.ref('notifications/' + currentUser.uid).set({
      email: emailSettings.email,
      enabled: true,
      stocks: stocks,
      updatedAt: Date.now()
    });
    notify('Email notifications enabled! You\'ll receive daily updates at 8:00 AM.');
  } else {
    await db.ref('notifications/' + currentUser.uid).remove();
    notify('Email notifications disabled');
  }
}
</script>
</body>
</html>
