<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer v9</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
:root{--bg:#0f172a;--bg2:#1e293b;--card:rgba(30,41,59,0.5);--item:rgba(51,65,85,0.3);--border:#334155;--text:#f8fafc;--text2:#94a3b8;--muted:#64748b;--accent:#22d3ee;--green:#34d399;--red:#fb7185}
.light{--bg:#f1f5f9;--bg2:#e2e8f0;--card:rgba(255,255,255,0.8);--item:rgba(241,245,249,0.8);--border:#cbd5e1;--text:#0f172a;--text2:#475569;--muted:#64748b}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}
.hidden{display:none!important}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}

/* Auth */
.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;max-width:400px;width:100%}
.auth-box h1{font-size:28px;margin-bottom:8px}
.auth-box p{color:var(--muted);margin-bottom:24px}
.auth-input{width:100%;padding:14px;background:var(--item);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:12px}
.auth-input:focus{outline:none;border-color:var(--accent)}
.btn{padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--green));color:#0f172a;width:100%}
.btn-small{padding:8px 14px;font-size:12px}
.btn-red{background:rgba(251,113,133,0.15);border:1px solid rgba(251,113,133,0.3);color:var(--red)}
.btn-green{background:rgba(52,211,153,0.15);border:1px solid rgba(52,211,153,0.3);color:var(--green)}
.btn-blue{background:rgba(34,211,238,0.15);border:1px solid rgba(34,211,238,0.3);color:var(--accent)}
.auth-toggle{color:var(--accent);cursor:pointer;margin-top:20px;font-size:13px}
.auth-error{color:var(--red);font-size:13px;margin-top:12px;display:none}

/* Nav */
.nav{display:flex;background:var(--card);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100}
.nav-tab{padding:16px 20px;font-size:14px;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{border-color:var(--accent)}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--green),var(--accent));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.logo h1{font-size:22px}
.logo p{font-size:12px;color:var(--muted)}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
.card-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.card-value{font-size:22px;font-weight:700;font-family:monospace}
.card-sub{font-size:11px;color:var(--muted);margin-top:4px}
.green{color:var(--green)}.red{color:var(--red)}.blue{color:var(--accent)}.purple{color:#a78bfa}.yellow{color:#fbbf24}

/* Chart Box */
.chart-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.chart-box h3{font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.badge{font-size:10px;padding:2px 8px;background:var(--accent);color:#0f172a;border-radius:10px}
.chart-container{position:relative;height:260px}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}

/* Lists */
.list-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--item);border-radius:10px;margin-bottom:8px}
.list-item:hover{background:var(--card)}
.list-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.list-info{flex:1;min-width:0}
.list-title{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.list-sub{font-size:12px;color:var(--muted)}
.list-value{font-family:monospace;font-weight:600;font-size:14px}
.rank{width:24px;height:24px;background:var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}

/* Transactions */
.txn-box{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px}
.txn-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.txn-item{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--bg2);cursor:pointer}
.txn-item:hover{background:var(--item)}
.txn-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.txn-details{flex:1;min-width:0}
.txn-desc{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txn-meta{font-size:11px;color:var(--muted)}
.txn-cat{padding:2px 6px;border-radius:6px;font-size:10px;margin-left:6px}
.txn-amount{text-align:right}
.txn-amt{font-weight:600;font-family:monospace}
.txn-bal{font-size:10px;color:var(--muted)}
.search-box{padding:8px 12px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;width:200px}
.show-more{width:100%;padding:12px;background:transparent;border:none;color:var(--text2);cursor:pointer}

/* Filters */
.filters{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.filter-select{padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
.month-pills{display:flex;gap:6px;flex-wrap:wrap}
.month-pill{padding:6px 12px;background:var(--item);border:1px solid var(--border);border-radius:20px;color:var(--text2);font-size:12px;cursor:pointer}
.month-pill.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}

/* Upload */
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;margin-bottom:24px;cursor:pointer}
.upload-zone:hover{border-color:var(--accent)}
.upload-zone input{display:none}
.upload-icon{font-size:48px;margin-bottom:12px}

/* Import Cards */
.import-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.import-card.inactive{opacity:0.5}
.import-icon{width:48px;height:48px;background:var(--item);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
.import-info{flex:1}
.import-name{font-weight:600;margin-bottom:4px}
.import-meta{font-size:12px;color:var(--muted)}
.import-toggle{width:48px;height:26px;background:var(--border);border-radius:13px;position:relative;cursor:pointer}
.import-toggle.active{background:var(--green)}
.import-toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
.import-toggle.active::after{transform:translateX(22px)}

/* Stats */
.import-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:24px}
.import-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.import-stat-value{font-size:24px;font-weight:700;color:var(--accent);font-family:monospace}
.import-stat-label{font-size:11px;color:var(--muted);margin-top:4px}

/* YoY */
.yoy-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
.yoy-item{padding:14px;background:var(--item);border-radius:10px;text-align:center}
.yoy-label{font-size:11px;color:var(--muted);margin-bottom:6px}
.yoy-values{display:flex;justify-content:center;gap:16px;margin-bottom:6px}
.yoy-year{text-align:center}
.yoy-year-label{font-size:10px;color:var(--muted)}
.yoy-year-value{font-size:15px;font-weight:600;font-family:monospace}
.yoy-change{font-size:12px;font-weight:500}
.yoy-change.up{color:var(--red)}.yoy-change.down{color:var(--green)}

/* Heatmap */
.heatmap{display:flex;gap:3px;overflow-x:auto;padding:10px 0}
.heatmap-week{display:flex;flex-direction:column;gap:3px}
.heatmap-cell{width:12px;height:12px;border-radius:2px;background:var(--item)}
.heatmap-cell.l1{background:rgba(34,197,94,0.3)}.heatmap-cell.l2{background:rgba(250,204,21,0.5)}.heatmap-cell.l3{background:rgba(249,115,22,0.6)}.heatmap-cell.l4{background:rgba(239,68,68,0.7)}

/* Weekday */
.weekday-bars{display:flex;gap:8px;align-items:flex-end;height:150px;padding:10px 0}
.weekday-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.weekday-fill{width:100%;border-radius:4px 4px 0 0;min-height:4px}
.weekday-label{font-size:11px;color:var(--text2)}
.weekday-value{font-size:9px;color:var(--muted);font-family:monospace}

/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-box{background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal-box h2{margin-bottom:16px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px}
.cat-opt{padding:10px;background:var(--item);border:2px solid transparent;border-radius:8px;cursor:pointer;text-align:center}
.cat-opt:hover{background:var(--card)}
.cat-opt.selected{border-color:var(--accent)}
.cat-opt-icon{font-size:20px}
.cat-opt-name{font-size:10px;color:var(--text2);margin-top:4px}
.note-input{width:100%;padding:10px;background:var(--item);border:1px solid var(--border);border-radius:8px;color:var(--text);margin-bottom:12px}

/* Notifications */
.notif-container{position:fixed;top:20px;right:20px;z-index:9999}
.notif{padding:14px 18px;background:var(--bg);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px;animation:slideIn .3s}
.notif.success{border-color:rgba(52,211,153,0.5)}
.notif.warning{border-color:rgba(251,191,36,0.5)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* User dropdown */
.user-menu{position:relative}
.user-dropdown{position:absolute;top:48px;right:0;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:200px;display:none}
.user-dropdown.show{display:block}
.user-item{padding:10px 12px;border-radius:8px;cursor:pointer}
.user-item:hover{background:var(--item)}

/* Empty */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:56px;margin-bottom:16px}

/* Savings gauge */
.savings-gauge{height:6px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden}
.savings-fill{height:100%;border-radius:3px}
.savings-fill.good{background:var(--green)}.savings-fill.ok{background:#fbbf24}.savings-fill.bad{background:var(--red)}

.page{display:none}.page.active{display:block}

/* User cards */
.user-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.user-card:hover{border-color:var(--accent)}
.user-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--green));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:#0f172a}
.user-info{flex:1}
.user-name{font-weight:600;margin-bottom:2px}
.user-email{font-size:12px;color:var(--muted)}
.role-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;margin-left:8px}
.role-badge.admin{background:rgba(251,191,36,0.2);color:#fbbf24}
.role-badge.user{background:rgba(34,211,238,0.2);color:#22d3ee}

/* Stock cards */
.stock-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
.stock-card:hover{border-color:var(--accent)}
.stock-card.profit{border-left:4px solid var(--green)}
.stock-card.loss{border-left:4px solid var(--red)}
.stock-symbol{width:60px;height:60px;background:var(--item);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--accent)}
.stock-info{flex:1}
.stock-name{font-weight:600;font-size:16px;margin-bottom:4px}
.stock-meta{font-size:12px;color:var(--muted)}
.stock-values{text-align:right}
.stock-current{font-size:18px;font-weight:700;font-family:monospace}
.stock-gain{font-size:14px;font-weight:600}
.stock-gain.profit{color:var(--green)}
.stock-gain.loss{color:var(--red)}

/* Print styles */
@media print {
  body{background:#fff!important;color:#000!important}
  .nav,.upload-zone,.filters,.btn,.icon-btn,.search-box,.show-more,.modal,.notif-container{display:none!important}
  .page{display:block!important}
  #pageImports,#pageUsers{display:none!important}
  .card,.chart-box,.txn-box,.list-item{background:#fff!important;border:1px solid #ddd!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .card-value,.list-value{color:#000!important}
  .green{color:#059669!important}.red{color:#dc2626!important}.blue{color:#0891b2!important}
}

@media(max-width:600px){.cards{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="notif-container" id="notifBox"></div>

<!-- Loading -->
<div class="auth-screen" id="loading"><div class="spinner"></div></div>

<!-- Auth -->
<div class="auth-screen hidden" id="authScreen">
  <div class="auth-box">
    <div style="font-size:48px;margin-bottom:16px">ğŸ’³</div>
    <h1>Bank Analyzer</h1>
    <p id="authSubtitle">Sign in to continue</p>
    <input type="email" class="auth-input" id="authEmail" placeholder="Email">
    <input type="password" class="auth-input" id="authPassword" placeholder="Password">
    <input type="text" class="auth-input hidden" id="authName" placeholder="Your name">
    <button class="btn btn-primary" id="authBtn">Sign In</button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-toggle" id="authToggle">Don't have an account? Sign up</div>
  </div>
</div>

<!-- Main App -->
<div class="hidden" id="mainApp">
  <nav class="nav">
    <div class="nav-tab active" onclick="switchPage('overview')">ğŸ“Š Overview</div>
    <div class="nav-tab" onclick="switchPage('imports')">ğŸ“ Imports <span class="badge" id="importsBadge">0</span></div>
    <div class="nav-tab" onclick="switchPage('stocks')">ğŸ“ˆ Stocks <span class="badge" id="stocksBadge">0</span></div>
    <div class="nav-tab hidden" id="usersTab" onclick="switchPage('users')">ğŸ‘¥ Users <span class="badge" id="usersBadge">0</span></div>
    <div class="nav-right">
      <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
      <button class="icon-btn" onclick="showRulesModal()">ğŸ“‹</button>
      <button class="icon-btn" onclick="exportCSV()">ğŸ“¥</button>
      <button class="icon-btn" onclick="printReport()">ğŸ–¨ï¸</button>
      <div class="user-menu">
        <button class="icon-btn" onclick="toggleUserMenu()">ğŸ‘¤</button>
        <div class="user-dropdown" id="userDropdown">
          <div style="padding:12px;border-bottom:1px solid var(--border)">
            <div style="font-weight:600" id="userName">User</div>
            <div style="font-size:12px;color:var(--muted)" id="userEmail">email</div>
            <div style="font-size:11px;color:var(--accent);margin-top:4px" id="userRole"></div>
          </div>
          <div class="user-item" onclick="signOut()">ğŸšª Sign Out</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Overview Page -->
  <div class="page active" id="pageOverview">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">ğŸ’³</div>
          <div><h1>Bank Analyzer</h1><p id="profileLabel">Cloud Sync</p></div>
        </div>
      </header>

      <div id="emptyState" class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <h2>No transactions</h2>
        <p>Go to Imports to add bank statements</p>
        <button class="btn btn-blue" onclick="switchPage('imports')" style="margin-top:16px">ğŸ“ Import PDFs</button>
      </div>

      <div id="dashboard" class="hidden">
        <div class="filters">
          <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
          <div class="month-pills" id="monthPills"></div>
          <button class="btn btn-small btn-blue" onclick="resetFilters()" style="margin-left:auto">â†º Reset</button>
        </div>

        <div class="cards">
          <div class="card"><div class="card-label">ğŸ’° Income</div><div class="card-value green" id="totalIncome">â‚¬0</div><div class="card-sub" id="incomeCount">0 txns</div></div>
          <div class="card"><div class="card-label">ğŸ’¸ Expenses</div><div class="card-value red" id="totalExpenses">â‚¬0</div><div class="card-sub" id="expenseCount">0 txns</div></div>
          <div class="card"><div class="card-label">ğŸ“ˆ Net</div><div class="card-value blue" id="netBalance">â‚¬0</div><div class="card-sub" id="avgDaily">â‚¬0/day</div></div>
          <div class="card"><div class="card-label">ğŸ¯ Savings</div><div class="card-value purple" id="savingsRate">0%</div><div class="savings-gauge"><div class="savings-fill" id="savingsGauge"></div></div></div>
          <div class="card"><div class="card-label">ğŸ“Š Total</div><div class="card-value yellow" id="txnCount">0</div><div class="card-sub" id="dateRange">-</div></div>
        </div>

        <div class="chart-box" id="yoyBox"><h3>ğŸ“… Year-over-Year <span class="badge" id="yoyYears"></span></h3><div class="yoy-grid" id="yoyGrid"></div></div>
        
        <div class="chart-box"><h3>ğŸ—“ï¸ Spending Heatmap</h3><div class="heatmap" id="heatmap"></div></div>

        <div class="grid-2">
          <div class="chart-box"><h3>ğŸ“… By Weekday</h3><div class="weekday-bars" id="weekdayBars"></div></div>
          <div class="chart-box"><h3>ğŸ”„ Recurring <span class="badge" id="recurringCount">0</span></h3><div id="recurringList"></div></div>
        </div>

        <div class="grid-2">
          <div class="chart-box"><h3>ğŸ“Š Categories</h3><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
          <div class="chart-box"><h3>ğŸ“‰ Balance</h3><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
        </div>

        <div class="grid-2">
          <div class="chart-box"><h3>ğŸª Top Merchants</h3><div id="merchantsAmt"></div></div>
          <div class="chart-box"><h3>ğŸ”¢ Most Visited</h3><div id="merchantsFreq"></div></div>
        </div>

        <div class="chart-box"><h3>ğŸ”¥ Top 10 Expenses</h3><div id="topExpenses"></div></div>
        
        <div class="chart-box"><h3>ğŸ“† Monthly Overview</h3><div class="chart-container" style="height:300px"><canvas id="barChart"></canvas></div></div>

        <div class="chart-box"><h3>ğŸ“‹ All Categories</h3><div id="categoryList"></div></div>

        <div class="txn-box">
          <div class="txn-header">
            <h3>ğŸ“ <span id="txnTitle">Transactions</span></h3>
            <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” Search..." oninput="applyFilters()">
          </div>
          <div id="txnList"></div>
          <button class="show-more" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Imports Page -->
  <div class="page" id="pageImports">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">ğŸ“</div>
          <div><h1>Imports</h1><p>Manage bank statements</p></div>
        </div>
      </header>

      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".pdf" multiple>
        <div id="uploadContent"><div class="upload-icon">ğŸ“„</div><h3>Drop NLB statements here</h3><p>PDF files supported</p></div>
        <div id="uploadLoading" class="hidden"><div class="spinner"></div><p id="uploadStatus">Processing...</p></div>
      </div>

      <div class="import-stats">
        <div class="import-stat"><div class="import-stat-value" id="statFiles">0</div><div class="import-stat-label">Files</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statTxns">0</div><div class="import-stat-label">Transactions</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statActive">0</div><div class="import-stat-label">Active</div></div>
      </div>

      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <button class="btn btn-green" onclick="activateAll()">âœ“ Load All</button>
        <button class="btn btn-blue" onclick="deactivateAll()">â—‹ Unload All</button>
        <button class="btn btn-red" onclick="deleteAllImports()">ğŸ—‘ï¸ Delete All</button>
      </div>

      <div id="importsList"></div>
      <div id="noImports" class="empty-state"><div class="empty-icon">ğŸ“</div><h2>No imports</h2><p>Upload PDFs above</p></div>
    </div>
  </div>

  <!-- Users Page (Admin) -->
  <div class="page" id="pageUsers">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">ğŸ‘¥</div>
          <div><h1>User Management</h1><p>Manage accounts</p></div>
        </div>
        <button class="btn btn-primary" onclick="showInviteModal()">+ Invite User</button>
      </header>

      <div class="import-stats">
        <div class="import-stat"><div class="import-stat-value" id="statUsers">0</div><div class="import-stat-label">Total Users</div></div>
        <div class="import-stat"><div class="import-stat-value" id="statAdmins">0</div><div class="import-stat-label">Admins</div></div>
      </div>

      <div id="usersList"></div>
    </div>
  </div>

  <!-- Stocks Page -->
  <div class="page" id="pageStocks">
    <div class="container">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">ğŸ“ˆ</div>
          <div><h1>Stock Portfolio</h1><p>Track your investments</p></div>
        </div>
        <button class="btn btn-primary" onclick="showAddStockModal()">+ Add Stock</button>
      </header>

      <!-- Portfolio Summary -->
      <div class="cards" id="portfolioSummary">
        <div class="card"><div class="card-label">ğŸ’° Invested</div><div class="card-value blue" id="totalInvested">â‚¬0</div></div>
        <div class="card"><div class="card-label">ğŸ“Š Current Value</div><div class="card-value" id="totalValue">â‚¬0</div></div>
        <div class="card"><div class="card-label">ğŸ“ˆ Gain/Loss</div><div class="card-value" id="totalGain">â‚¬0</div><div class="card-sub" id="totalGainPct">0%</div></div>
        <div class="card"><div class="card-label">ğŸ† Holdings</div><div class="card-value yellow" id="holdingsCount">0</div></div>
      </div>

      <!-- Email Notifications -->
      <div class="chart-box">
        <h3>ğŸ“§ Daily Email Notifications</h3>
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="emailEnabled" onchange="toggleEmailNotifications()">
            <span>Enable daily portfolio summary</span>
          </label>
          <input type="email" class="search-box" id="notificationEmail" placeholder="your@email.com" style="width:250px">
          <button class="btn btn-small btn-green" onclick="saveEmailSettings()">Save</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-top:8px">You'll receive daily updates at 8:00 AM with your portfolio performance</p>
      </div>

      <!-- Stock List -->
      <div class="chart-box">
        <h3>ğŸ“‹ Your Holdings</h3>
        <div id="stocksList"></div>
        <div id="noStocks" class="empty-state"><div class="empty-icon">ğŸ“ˆ</div><h2>No stocks yet</h2><p>Add your first stock above</p></div>
      </div>

      <!-- Market Overview -->
      <div class="chart-box">
        <h3>ğŸŒ Market Overview</h3>
        <div id="marketOverview" class="cards"></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal hidden" id="editModal">
  <div class="modal-box">
    <h2>Edit Transaction</h2>
    <p id="editDesc" style="color:var(--muted);margin-bottom:16px"></p>
    <label style="font-size:12px;color:var(--muted)">Note</label>
    <input type="text" class="note-input" id="editNote" placeholder="Add a note...">
    <label style="font-size:12px;color:var(--muted)">Category</label>
    <div class="cat-grid" id="catGrid"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideEditModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- Rules Modal -->
<div class="modal hidden" id="rulesModal">
  <div class="modal-box">
    <h2>ğŸ“‹ Category Rules</h2>
    <p style="color:var(--muted);margin-bottom:16px">Auto-categorize by description</p>
    <div id="rulesList"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="clearAllRules()">Clear All</button>
      <button class="btn btn-blue" onclick="hideRulesModal()">Close</button>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal hidden" id="inviteModal">
  <div class="modal-box">
    <h2>ğŸ‘¤ Invite User</h2>
    <p style="color:var(--muted);margin-bottom:16px">Create a new account</p>
    <input type="email" class="note-input" id="inviteEmail" placeholder="Email address">
    <input type="text" class="note-input" id="inviteName" placeholder="Name">
    <input type="password" class="note-input" id="invitePassword" placeholder="Temporary password (min 6 chars)">
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideInviteModal()">Cancel</button>
      <button class="btn btn-green" onclick="createUser()">Create User</button>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal hidden" id="stockModal">
  <div class="modal-box">
    <h2 id="stockModalTitle">ğŸ“ˆ Add Stock</h2>
    <p style="color:var(--muted);margin-bottom:16px">Enter your investment details</p>
    <input type="text" class="note-input" id="stockSymbol" placeholder="Symbol (e.g., AAPL, MSFT, GOOGL)" style="text-transform:uppercase">
    <input type="number" class="note-input" id="stockShares" placeholder="Number of shares" step="0.0001">
    <input type="number" class="note-input" id="stockPrice" placeholder="Purchase price per share (â‚¬)" step="0.01">
    <input type="date" class="note-input" id="stockDate">
    <input type="text" class="note-input" id="stockNotes" placeholder="Notes (optional)">
    <div class="modal-actions">
      <button class="btn btn-red" onclick="hideStockModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveStock()">Save</button>
    </div>
  </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAifLv-J1WahMz0DERGXJSt9qDF0z6F5oA",
  authDomain: "bank-app-b907a.firebaseapp.com",
  databaseURL: "https://bank-app-b907a-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bank-app-b907a",
  storageBucket: "bank-app-b907a.firebasestorage.app",
  messagingSenderId: "834229293620",
  appId: "1:834229293620:web:8ac5d5fdb4a0d635597061"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// State
let currentUser = null;
let imports = {};
let catOverrides = {};
let txnNotes = {};
let activeTxns = [];
let filteredTxns = [];
let selYear = 'all', selMonth = 'all', selCat = null, searchQ = '', showAll = false;
let editingTxn = null, selNewCat = null;
let pieChart = null, lineChart = null, barChart = null;
let isDark = true;
let isSignUp = false;
let isAdmin = false;
let allUsers = {};
let viewingUserId = null;
let stocks = {};
let stockPrices = {};
let editingStockId = null;
let emailSettings = { enabled: false, email: '' };

const $ = id => document.getElementById(id);
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const WDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const COLORS = ['#f87171','#fb923c','#fbbf24','#a3e635','#34d399','#22d3ee','#a78bfa'];
const CATS = {
  Groceries:{kw:['LIDL','HOFER','SPAR','MERCATOR','TUS','EUROSPIN'],c:'#10B981',i:'ğŸ›’'},
  Fuel:{kw:['MOL','PETROL','OMV'],c:'#F59E0B',i:'â›½'},
  Restaurants:{kw:['MCDONALDS','RESTAVRACIJA','PIZZA','GOSTILNA','SUSHI'],c:'#EC4899',i:'ğŸ”'},
  Travel:{kw:['BOOKING','HOTEL','AIRBNB','BANKOMAT'],c:'#3B82F6',i:'âœˆï¸'},
  Shopping:{kw:['AMAZON','IKEA','MERKUR'],c:'#8B5CF6',i:'ğŸ›ï¸'},
  Clothing:{kw:['ZARA','H&M','ABOUTYOU','C&A','MANGO','RESERVED'],c:'#F97316',i:'ğŸ‘•'},
  Jewelry:{kw:['ZLATARNA','PANDORA','SWAROVSKI'],c:'#FBBF24',i:'ğŸ’'},
  Sports:{kw:['INTERSPORT','DECATHLON','SPORTINA','HERVIS','FITNESS','GYM'],c:'#22D3EE',i:'ğŸƒ'},
  Parties:{kw:['CLUB','DISCO','NIGHT','LOUNGE','COCKTAIL'],c:'#E879F9',i:'ğŸ‰'},
  Entertainment:{kw:['NETFLIX','SPOTIFY','STEAM','KINO','CINEMA'],c:'#06B6D4',i:'ğŸ¬'},
  Transportation:{kw:['PSTOP','PARK','TAXI','UBER','BOLT'],c:'#EF4444',i:'ğŸš—'},
  Transfers:{kw:['REVOLUT','FLIK','PAYPAL'],c:'#6366F1',i:'ğŸ’¸'},
  Education:{kw:['UL EF','FAKULT','UNIV'],c:'#F472B6',i:'ğŸ“'},
  Health:{kw:['LEKARNA','APOTEKA','DOCTOR','ZDRAVNIK'],c:'#84CC16',i:'ğŸ¥'},
  Services:{kw:['POSTA','TELEKOM','PROVIZIJA','A1 '],c:'#64748B',i:'ğŸ“‹'},
  Income:{kw:['PLACA','REDNO DELO','VRACILO','SICOD'],c:'#22C55E',i:'ğŸ’°'},
  Personal:{kw:[],c:'#14B8A6',i:'ğŸ‘¤'},
  Other:{kw:[],c:'#94A3B8',i:'ğŸ’³'}
};

// Helpers
function fmt(n) { return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n); }
function notify(msg, type='success') {
  const n = document.createElement('div');
  n.className = 'notif ' + type;
  n.innerHTML = `<span>${type==='success'?'âœ…':'âš ï¸'}</span><span>${msg}</span>`;
  $('notifBox').appendChild(n);
  setTimeout(() => n.remove(), 3000);
}
function categorize(desc) {
  if (catOverrides[desc]) return catOverrides[desc];
  const u = desc.toUpperCase();
  for (const [cat, cfg] of Object.entries(CATS)) {
    if (cat === 'Other') continue;
    if (cfg.kw.some(k => u.includes(k))) return cat;
  }
  return 'Other';
}

// Auth
auth.onAuthStateChanged(async user => {
  $('loading').classList.add('hidden');
  if (user) {
    currentUser = user;
    $('authScreen').classList.add('hidden');
    $('mainApp').classList.remove('hidden');
    $('userName').textContent = user.displayName || 'User';
    $('userEmail').textContent = user.email;
    
    // Check if admin
    const userSnap = await db.ref('users/' + user.uid).once('value');
    const userData = userSnap.val() || {};
    isAdmin = userData.role === 'admin';
    $('userRole').textContent = isAdmin ? 'ğŸ‘‘ Admin' : '';
    $('usersTab').classList.toggle('hidden', !isAdmin);
    
    if (isAdmin) {
      await loadAllUsers();
    }
    
    loadData();
  } else {
    $('authScreen').classList.remove('hidden');
    $('mainApp').classList.add('hidden');
  }
});

$('authToggle').onclick = () => {
  isSignUp = !isSignUp;
  $('authName').classList.toggle('hidden', !isSignUp);
  $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  $('authSubtitle').textContent = isSignUp ? 'Create your account' : 'Sign in to continue';
  $('authToggle').textContent = isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up";
  $('authError').style.display = 'none';
};

$('authBtn').onclick = async () => {
  const email = $('authEmail').value;
  const pass = $('authPassword').value;
  const name = $('authName').value;
  try {
    $('authBtn').textContent = 'Please wait...';
    if (isSignUp) {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      // First user becomes admin
      const usersSnap = await db.ref('users').once('value');
      const isFirstUser = !usersSnap.exists();
      await db.ref('users/' + cred.user.uid).set({ email, name, role: isFirstUser ? 'admin' : 'user', createdAt: Date.now() });
    } else {
      await auth.signInWithEmailAndPassword(email, pass);
    }
  } catch (e) {
    $('authError').textContent = e.message;
    $('authError').style.display = 'block';
    $('authBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  }
};

function signOut() { auth.signOut(); toggleUserMenu(); }
function toggleUserMenu() { $('userDropdown').classList.toggle('show'); }

// Data
async function loadData() {
  const snap = await db.ref('data/' + currentUser.uid).once('value');
  const data = snap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  stocks = data.stocks || {};
  emailSettings = data.emailSettings || { enabled: false, email: currentUser.email };
  renderImports();
  loadActiveTxns();
  loadStocks();
}

async function saveData() {
  await db.ref('data/' + currentUser.uid).set({
    imports, overrides: catOverrides, notes: txnNotes, stocks, emailSettings, updatedAt: Date.now()
  });
}

// Pages
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  $('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
  const tabIndex = page === 'overview' ? 0 : page === 'imports' ? 1 : page === 'stocks' ? 2 : 3;
  document.querySelectorAll('.nav-tab')[tabIndex].classList.add('active');
  if (page === 'users' && isAdmin) renderUsers();
  if (page === 'stocks') loadStocks();
}

// Theme
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  $('themeBtn').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
  render();
}

// Imports
function loadActiveTxns() {
  activeTxns = [];
  Object.values(imports).filter(i => i.active).forEach(imp => {
    (imp.txns || []).forEach(t => {
      const pd = new Date(t.parsedDate);
      const cat = catOverrides[t.description] || categorize(t.description);
      activeTxns.push({...t, parsedDate: pd, year: pd.getFullYear(), month: pd.getMonth(), weekday: pd.getDay(), category: cat});
    });
  });
  activeTxns.sort((a,b) => a.parsedDate - b.parsedDate);
  applyFilters();
}

function renderImports() {
  const keys = Object.keys(imports).sort((a,b) => (imports[b].importedAt||0) - (imports[a].importedAt||0));
  $('importsBadge').textContent = keys.length;
  $('noImports').classList.toggle('hidden', keys.length > 0);
  
  const total = Object.values(imports).reduce((s,i) => s + (i.txns?.length||0), 0);
  const active = Object.values(imports).filter(i => i.active).length;
  $('statFiles').textContent = keys.length;
  $('statTxns').textContent = total;
  $('statActive').textContent = active;
  
  $('importsList').innerHTML = keys.map(id => {
    const imp = imports[id];
    const dates = (imp.txns||[]).map(t => new Date(t.parsedDate)).sort((a,b)=>a-b);
    const range = dates.length ? dates[0].toLocaleDateString('sl') + ' - ' + dates[dates.length-1].toLocaleDateString('sl') : '';
    return `<div class="import-card ${imp.active?'':'inactive'}">
      <div class="import-icon">ğŸ“„</div>
      <div class="import-info">
        <div class="import-name">${imp.filename}</div>
        <div class="import-meta">${imp.txns?.length||0} txns â€¢ ${range}</div>
      </div>
      <div class="import-toggle ${imp.active?'active':''}" onclick="toggleImport('${id}')"></div>
      <button class="btn btn-small btn-red" onclick="deleteImport('${id}')">ğŸ—‘ï¸</button>
    </div>`;
  }).join('');
}

async function toggleImport(id) {
  imports[id].active = !imports[id].active;
  await saveData();
  renderImports();
  loadActiveTxns();
  notify(imports[id].active ? 'Loaded' : 'Unloaded');
}

async function deleteImport(id) {
  if (!confirm('Delete this import?')) return;
  delete imports[id];
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('Deleted');
}

async function activateAll() {
  Object.keys(imports).forEach(id => imports[id].active = true);
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All loaded');
}

async function deactivateAll() {
  Object.keys(imports).forEach(id => imports[id].active = false);
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All unloaded');
}

async function deleteAllImports() {
  if (!confirm('Delete ALL imports?')) return;
  imports = {};
  await saveData();
  renderImports();
  loadActiveTxns();
  notify('All deleted');
}

// Upload
$('uploadZone').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => handleFiles(e.target.files);
$('uploadZone').ondragover = e => { e.preventDefault(); $('uploadZone').style.borderColor = 'var(--accent)'; };
$('uploadZone').ondragleave = () => $('uploadZone').style.borderColor = '';
$('uploadZone').ondrop = e => { e.preventDefault(); $('uploadZone').style.borderColor = ''; handleFiles(e.dataTransfer.files); };

async function handleFiles(files) {
  const pdfs = [...files].filter(f => f.name.endsWith('.pdf'));
  if (!pdfs.length) return;
  
  $('uploadContent').classList.add('hidden');
  $('uploadLoading').classList.remove('hidden');
  let total = 0;
  
  for (let i = 0; i < pdfs.length; i++) {
    const f = pdfs[i];
    if (Object.values(imports).some(imp => imp.filename === f.name)) {
      notify(f.name + ' already imported', 'warning');
      continue;
    }
    $('uploadStatus').textContent = `${i+1}/${pdfs.length}: ${f.name}`;
    
    try {
      const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
      let text = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      const txns = parseStatement(text);
      if (txns.length) {
        const id = 'imp_' + Date.now() + '_' + i;
        imports[id] = { filename: f.name, importedAt: Date.now(), txns, active: true };
        total += txns.length;
      }
    } catch (e) {
      notify('Error: ' + f.name, 'warning');
    }
  }
  
  await saveData();
  renderImports();
  loadActiveTxns();
  if (total) notify(`Imported ${total} transactions`);
  
  $('uploadContent').classList.remove('hidden');
  $('uploadLoading').classList.add('hidden');
}

function parseStatement(txt) {
  const txns = [];
  const dateRegex = /(\d{2}\.\d{2}\.\d{2})/g;
  const matches = [...txt.matchAll(dateRegex)];
  
  for (let i = 0; i < matches.length; i++) {
    const seg = txt.substring(matches[i].index, matches[i+1]?.index || txt.length);
    if (/STANJE|SKUPNI|Datum izpiska/i.test(seg)) continue;
    
    const amtMatch = seg.match(/([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g);
    if (amtMatch && amtMatch.length >= 2) {
      const amtStr = amtMatch[amtMatch.length-2];
      const balStr = amtMatch[amtMatch.length-1];
      let amt = parseFloat(amtStr.replace(/\./g,'').replace(',','.'));
      const bal = parseFloat(balStr.replace(/\./g,'').replace(',','.'));
      const desc = seg.slice(8, seg.indexOf(amtMatch[0])).trim().replace(/^[\.,]\s*/,'');
      if (!desc || desc.length < 2) continue;
      
      const isInc = amtStr.startsWith('+') || /PLACA|REDNO DELO|VRACILO/i.test(desc);
      if (!amtStr.startsWith('+') && !amtStr.startsWith('-') && !isInc) amt = -Math.abs(amt);
      
      const dateParts = matches[i][1].split('.');
      const pd = new Date(2000 + parseInt(dateParts[2]), parseInt(dateParts[1])-1, parseInt(dateParts[0]));
      if (isNaN(pd.getTime())) continue;
      
      txns.push({
        id: matches[i][1] + '_' + txns.length + '_' + Math.random().toString(36).slice(2,8),
        date: matches[i][1],
        parsedDate: pd.toISOString(),
        description: desc,
        amount: amt,
        balance: bal,
        category: categorize(desc)
      });
    }
  }
  return txns;
}

// Filters
function applyFilters() {
  selYear = $('yearFilter')?.value || 'all';
  searchQ = $('searchBox')?.value?.toLowerCase() || '';
  
  filteredTxns = activeTxns.filter(t => {
    if (selYear !== 'all' && t.year !== parseInt(selYear)) return false;
    if (selMonth !== 'all' && t.month !== parseInt(selMonth)) return false;
    if (selCat && t.category !== selCat) return false;
    if (searchQ && !t.description.toLowerCase().includes(searchQ)) return false;
    return true;
  });
  showAll = false;
  render();
}

function resetFilters() {
  selYear = 'all'; selMonth = 'all'; selCat = null; searchQ = '';
  if ($('yearFilter')) $('yearFilter').value = 'all';
  if ($('searchBox')) $('searchBox').value = '';
  applyFilters();
}

function selectMonth(m) {
  selMonth = selMonth === m ? 'all' : m;
  applyFilters();
}

function filterByCat(c) {
  selCat = selCat === c ? null : c;
  applyFilters();
}

function toggleShowAll() {
  showAll = !showAll;
  renderTxns();
}

// Render
function render() {
  if (!activeTxns.length) {
    $('emptyState').classList.remove('hidden');
    $('dashboard').classList.add('hidden');
    return;
  }
  $('emptyState').classList.add('hidden');
  $('dashboard').classList.remove('hidden');
  
  // Filters
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  $('yearFilter').innerHTML = '<option value="all">All Years</option>' + years.map(y => `<option value="${y}" ${selYear==y?'selected':''}>${y}</option>`).join('');
  $('monthPills').innerHTML = `<div class="month-pill ${selMonth==='all'?'active':''}" onclick="selectMonth('all')">All</div>` + MONTHS.map((m,i) => `<div class="month-pill ${selMonth===i?'active':''}" onclick="selectMonth(${i})">${m}</div>`).join('');
  
  // Stats
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const net = income - expenses;
  const sr = income > 0 ? (net / income) * 100 : 0;
  const days = filteredTxns.length > 1 ? Math.max(1, Math.ceil((filteredTxns[filteredTxns.length-1].parsedDate - filteredTxns[0].parsedDate) / 864e5)) : 1;
  
  $('totalIncome').textContent = fmt(income);
  $('totalExpenses').textContent = fmt(expenses);
  $('netBalance').textContent = fmt(net);
  $('netBalance').className = 'card-value ' + (net >= 0 ? 'blue' : 'red');
  $('incomeCount').textContent = filteredTxns.filter(t => t.amount > 0).length + ' txns';
  $('expenseCount').textContent = filteredTxns.filter(t => t.amount < 0).length + ' txns';
  $('savingsRate').textContent = sr.toFixed(1) + '%';
  $('savingsGauge').style.width = Math.min(100, Math.max(0, sr)) + '%';
  $('savingsGauge').className = 'savings-fill ' + (sr >= 20 ? 'good' : sr >= 10 ? 'ok' : 'bad');
  $('txnCount').textContent = filteredTxns.length;
  $('avgDaily').textContent = fmt(expenses/days) + '/day';
  $('dateRange').textContent = filteredTxns.length ? filteredTxns[0].date + ' - ' + filteredTxns[filteredTxns.length-1].date : '-';
  
  renderYoY();
  renderHeatmap();
  renderWeekday();
  renderRecurring();
  renderMerchants();
  renderCategories();
  renderTopExpenses();
  renderCharts();
  renderTxns();
}

function renderYoY() {
  const years = [...new Set(activeTxns.map(t => t.year))].sort();
  if (years.length < 2) { $('yoyBox').classList.add('hidden'); return; }
  $('yoyBox').classList.remove('hidden');
  const y1 = years[years.length-2], y2 = years[years.length-1];
  $('yoyYears').textContent = y1 + ' vs ' + y2;
  
  const t1 = activeTxns.filter(t => t.year === y1), t2 = activeTxns.filter(t => t.year === y2);
  const inc1 = t1.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const inc2 = t2.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const exp1 = Math.abs(t1.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  const exp2 = Math.abs(t2.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  
  const pct = (a,b) => b > 0 ? ((a-b)/b*100).toFixed(1) : '0';
  $('yoyGrid').innerHTML = `
    <div class="yoy-item"><div class="yoy-label">ğŸ’° Income</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(inc1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(inc2)}</div></div></div><div class="yoy-change ${inc2>inc1?'down':'up'}">${inc2>inc1?'â†‘':'â†“'} ${Math.abs(pct(inc2,inc1))}%</div></div>
    <div class="yoy-item"><div class="yoy-label">ğŸ’¸ Expenses</div><div class="yoy-values"><div class="yoy-year"><div class="yoy-year-label">${y1}</div><div class="yoy-year-value">${fmt(exp1)}</div></div><div class="yoy-year"><div class="yoy-year-label">${y2}</div><div class="yoy-year-value">${fmt(exp2)}</div></div></div><div class="yoy-change ${exp2>exp1?'up':'down'}">${exp2>exp1?'â†‘':'â†“'} ${Math.abs(pct(exp2,exp1))}%</div></div>
  `;
}

function renderHeatmap() {
  const ds = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const k = t.parsedDate.toISOString().split('T')[0];
    ds[k] = (ds[k]||0) + Math.abs(t.amount);
  });
  const vals = Object.values(ds), max = Math.max(...vals, 1);
  const th = [0, max*.2, max*.4, max*.6, max*.8];
  
  if (!filteredTxns.length) { $('heatmap').innerHTML = '<div style="color:var(--muted)">No data</div>'; return; }
  
  const start = new Date(filteredTxns[0].parsedDate);
  const end = new Date(filteredTxns[filteredTxns.length-1].parsedDate);
  start.setDate(start.getDate() - start.getDay());
  
  const weeks = [];
  let cur = new Date(start);
  while (cur <= end) {
    const wk = [];
    for (let d = 0; d < 7; d++) {
      const k = cur.toISOString().split('T')[0];
      const v = ds[k] || 0;
      let lv = 0;
      for (let i = th.length-1; i >= 0; i--) if (v >= th[i]) { lv = i; break; }
      wk.push({ k, v, lv });
      cur.setDate(cur.getDate() + 1);
    }
    weeks.push(wk);
  }
  
  $('heatmap').innerHTML = weeks.map(wk => '<div class="heatmap-week">' + wk.map(d => `<div class="heatmap-cell ${d.lv?'l'+d.lv:''}" title="${d.k}: ${fmt(d.v)}"></div>`).join('') + '</div>').join('');
}

function renderWeekday() {
  const w = [0,0,0,0,0,0,0];
  filteredTxns.filter(t => t.amount < 0).forEach(t => w[t.weekday] += Math.abs(t.amount));
  const max = Math.max(...w, 1);
  $('weekdayBars').innerHTML = WDAYS.map((d,i) => `<div class="weekday-bar"><div class="weekday-value">${fmt(w[i])}</div><div class="weekday-fill" style="height:${(w[i]/max)*100}%;background:${COLORS[i]}"></div><div class="weekday-label">${d}</div></div>`).join('');
}

function renderRecurring() {
  const g = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const m = t.description.split(/\s+/).slice(0,2).join(' ').toUpperCase();
    const a = Math.abs(t.amount).toFixed(2);
    const k = m + '|' + a;
    if (!g[k]) g[k] = { m, a: Math.abs(t.amount), dates: [] };
    g[k].dates.push(t.parsedDate);
  });
  
  const r = [];
  for (const gr of Object.values(g)) {
    if (gr.dates.length >= 2) {
      gr.dates.sort((a,b) => a-b);
      const diffs = [];
      for (let i = 1; i < gr.dates.length; i++) diffs.push((gr.dates[i] - gr.dates[i-1]) / 864e5);
      const avg = diffs.reduce((a,b) => a+b, 0) / diffs.length;
      if (avg >= 25 && avg <= 35) r.push({ ...gr, pat: 'Monthly' });
      else if (avg >= 5 && avg <= 9) r.push({ ...gr, pat: 'Weekly' });
    }
  }
  
  $('recurringCount').textContent = r.length;
  $('recurringList').innerHTML = r.length ? r.sort((a,b) => b.a - a.a).slice(0,5).map(x => `<div class="list-item"><div class="list-icon" style="background:rgba(99,102,241,0.2)">ğŸ”„</div><div class="list-info"><div class="list-title">${x.m}</div><div class="list-sub">${x.pat} â€¢ ${x.dates.length}Ã—</div></div><div class="list-value blue">${fmt(-x.a)}</div></div>`).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">None found</div>';
}

function renderMerchants() {
  const m = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => {
    const n = t.description.split(/\s+/).slice(0,2).join(' ').toUpperCase();
    if (!m[n]) m[n] = { n, tot: 0, cnt: 0 };
    m[n].tot += Math.abs(t.amount);
    m[n].cnt++;
  });
  const list = Object.values(m);
  const byAmt = [...list].sort((a,b) => b.tot - a.tot).slice(0,6);
  const byFreq = [...list].sort((a,b) => b.cnt - a.cnt).slice(0,6);
  
  $('merchantsAmt').innerHTML = byAmt.map((x,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${x.n}</div><div class="list-sub">${x.cnt} visits</div></div><div class="list-value red">${fmt(-x.tot)}</div></div>`).join('');
  $('merchantsFreq').innerHTML = byFreq.map((x,i) => `<div class="list-item"><div class="rank">${i+1}</div><div class="list-info"><div class="list-title">${x.n}</div><div class="list-sub">${fmt(-x.tot)}</div></div><div class="list-value blue">${x.cnt}Ã—</div></div>`).join('');
}

function renderCategories() {
  const cats = {};
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  $('categoryList').innerHTML = sorted.map(([cat, amt]) => {
    const cfg = CATS[cat] || CATS.Other;
    const pct = expenses > 0 ? (amt/expenses*100).toFixed(1) : 0;
    return `<div class="list-item" style="cursor:pointer" onclick="filterByCat('${cat}')"><div class="list-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="list-info"><div class="list-title">${cat}</div><div style="height:4px;background:var(--border);border-radius:2px;margin-top:4px"><div style="height:100%;width:${pct}%;background:${cfg.c};border-radius:2px"></div></div></div><div style="text-align:right"><div class="list-value red">${fmt(-amt)}</div><div class="list-sub">${pct}%</div></div></div>`;
  }).join('');
}

function renderTopExpenses() {
  const top = filteredTxns.filter(t => t.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10);
  $('topExpenses').innerHTML = top.map((t,i) => {
    const cfg = CATS[t.category] || CATS.Other;
    const note = txnNotes[t.description];
    return `<div class="list-item" style="cursor:pointer" onclick="editTxn('${t.id}')"><div class="rank" style="${i<3?'background:linear-gradient(135deg,#f59e0b,#f97316);color:#000':''}">${i+1}</div><div class="list-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="list-info"><div class="list-title">${t.description}${note?' ğŸ“':''}</div><div class="list-sub">${t.date} â€¢ ${t.category}</div></div><div class="list-value red">${fmt(t.amount)}</div></div>`;
  }).join('');
}

function renderCharts() {
  const tc = isDark ? '#94a3b8' : '#64748b';
  const gc = isDark ? '#334155' : '#e2e8f0';
  
  // Pie
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); });
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  if (pieChart) pieChart.destroy();
  if (sorted.length) {
    pieChart = new Chart($('pieChart'), {
      type: 'doughnut',
      data: { labels: sorted.map(([c]) => c), datasets: [{ data: sorted.map(([,v]) => v), backgroundColor: sorted.map(([c]) => (CATS[c]||CATS.Other).c), borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false } } }
    });
  }
  
  // Line
  const balances = [];
  filteredTxns.forEach(t => {
    const ex = balances.find(b => b.date === t.date);
    if (ex) ex.bal = t.balance;
    else balances.push({ date: t.date, bal: t.balance });
  });
  
  if (lineChart) lineChart.destroy();
  if (balances.length) {
    lineChart = new Chart($('lineChart'), {
      type: 'line',
      data: { labels: balances.map(b => b.date), datasets: [{ data: balances.map(b => b.bal), borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.3, pointRadius: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gc }, ticks: { color: tc, maxTicksLimit: 6 } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0)+'k' } } } }
    });
  }
  
  // Bar
  const monthly = {};
  activeTxns.forEach(t => {
    const k = t.year + '-' + String(t.month+1).padStart(2,'0');
    if (!monthly[k]) monthly[k] = { inc: 0, exp: 0 };
    if (t.amount > 0) monthly[k].inc += t.amount;
    else monthly[k].exp += Math.abs(t.amount);
  });
  const mKeys = Object.keys(monthly).sort();
  
  if (barChart) barChart.destroy();
  if (mKeys.length) {
    barChart = new Chart($('barChart'), {
      type: 'bar',
      data: { labels: mKeys.map(k => MONTHS[parseInt(k.split('-')[1])-1] + ' ' + k.split('-')[0].slice(2)), datasets: [{ label: 'Income', data: mKeys.map(k => monthly[k].inc), backgroundColor: '#22c55e' }, { label: 'Expenses', data: mKeys.map(k => monthly[k].exp), backgroundColor: '#fb7185' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: tc } } }, scales: { x: { grid: { display: false }, ticks: { color: tc } }, y: { grid: { color: gc }, ticks: { color: tc, callback: v => (v/1000).toFixed(0)+'k' } } } }
    });
  }
}

function renderTxns() {
  const list = showAll ? filteredTxns.slice().reverse() : filteredTxns.slice(-15).reverse();
  $('txnTitle').textContent = selCat || 'Transactions';
  
  $('txnList').innerHTML = list.map(t => {
    const cfg = CATS[t.category] || CATS.Other;
    const pos = t.amount > 0;
    const note = txnNotes[t.description];
    return `<div class="txn-item" onclick="editTxn('${t.id}')"><div class="txn-icon" style="background:${cfg.c}30">${cfg.i}</div><div class="txn-details"><div class="txn-desc">${t.description}${note?' ğŸ“':''}</div><div class="txn-meta">${t.date} â€¢ ${WDAYS[t.weekday]}<span class="txn-cat" style="background:${cfg.c}30;color:${cfg.c}">${t.category}</span></div></div><div class="txn-amount"><div class="txn-amt ${pos?'green':'red'}">${pos?'+':''}${fmt(t.amount)}</div><div class="txn-bal">Bal: ${fmt(t.balance)}</div></div></div>`;
  }).join('');
  
  $('showMoreBtn').textContent = showAll ? 'â–² Show less' : `â–¼ Show all ${filteredTxns.length}`;
  $('showMoreBtn').classList.toggle('hidden', filteredTxns.length <= 15);
}

// Edit Transaction
function editTxn(id) {
  const t = activeTxns.find(x => x.id === id);
  if (!t) return;
  editingTxn = t;
  selNewCat = t.category;
  $('editDesc').textContent = t.description;
  $('editNote').value = txnNotes[t.description] || '';
  renderCatGrid();
  $('editModal').classList.remove('hidden');
}

function renderCatGrid() {
  $('catGrid').innerHTML = Object.entries(CATS).map(([name, cfg]) => `<div class="cat-opt ${selNewCat===name?'selected':''}" onclick="selNewCat='${name}';renderCatGrid()"><div class="cat-opt-icon">${cfg.i}</div><div class="cat-opt-name">${name}</div></div>`).join('');
}

function hideEditModal() { $('editModal').classList.add('hidden'); editingTxn = null; }

async function saveEdit() {
  if (!editingTxn) return;
  catOverrides[editingTxn.description] = selNewCat;
  const note = $('editNote').value.trim();
  if (note) txnNotes[editingTxn.description] = note;
  else delete txnNotes[editingTxn.description];
  await saveData();
  loadActiveTxns();
  hideEditModal();
  notify('Saved');
}

// Rules
function showRulesModal() {
  $('rulesList').innerHTML = Object.entries(catOverrides).length ? Object.entries(catOverrides).map(([desc, cat]) => {
    const cfg = CATS[cat] || CATS.Other;
    return `<div class="list-item"><div class="list-info"><div class="list-title">${desc.slice(0,30)}${desc.length>30?'...':''}</div></div><div style="display:flex;align-items:center;gap:8px"><span>${cfg.i} ${cat}</span><span style="color:var(--red);cursor:pointer" onclick="deleteRule('${desc.replace(/'/g,"\\'")}')">Ã—</span></div></div>`;
  }).join('') : '<div style="text-align:center;padding:20px;color:var(--muted)">No rules yet</div>';
  $('rulesModal').classList.remove('hidden');
}

function hideRulesModal() { $('rulesModal').classList.add('hidden'); }

async function deleteRule(desc) {
  delete catOverrides[desc];
  await saveData();
  loadActiveTxns();
  showRulesModal();
  notify('Rule deleted');
}

async function clearAllRules() {
  if (!confirm('Clear all rules?')) return;
  catOverrides = {};
  await saveData();
  loadActiveTxns();
  showRulesModal();
  notify('All rules cleared');
}

// Export
function exportCSV() {
  const rows = [['Date','Day','Description','Amount','Balance','Category','Note']];
  filteredTxns.forEach(t => rows.push([t.date, WDAYS[t.weekday], `"${t.description}"`, t.amount.toFixed(2), t.balance.toFixed(2), t.category, `"${txnNotes[t.description]||''}"`]));
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bank-export-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  notify('Exported CSV');
}

// Close dropdowns on outside click
document.onclick = e => {
  if (!e.target.closest('.user-menu')) $('userDropdown').classList.remove('show');
};

// Admin Functions
async function loadAllUsers() {
  const snap = await db.ref('users').once('value');
  allUsers = snap.val() || {};
  $('usersBadge').textContent = Object.keys(allUsers).length;
}

function renderUsers() {
  const users = Object.entries(allUsers);
  const admins = users.filter(([,u]) => u.role === 'admin').length;
  $('statUsers').textContent = users.length;
  $('statAdmins').textContent = admins;
  
  $('usersList').innerHTML = users.map(([uid, u]) => {
    const initial = (u.name || u.email || '?')[0].toUpperCase();
    const isMe = uid === currentUser.uid;
    return `<div class="user-card">
      <div class="user-avatar">${initial}</div>
      <div class="user-info">
        <div class="user-name">${u.name || 'No name'}<span class="role-badge ${u.role}">${u.role}</span></div>
        <div class="user-email">${u.email}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">Joined ${new Date(u.createdAt).toLocaleDateString()}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${!isMe ? `<button class="btn btn-small btn-blue" onclick="viewUserData('${uid}')">ğŸ‘ï¸ View</button>` : ''}
        ${!isMe && u.role !== 'admin' ? `<button class="btn btn-small btn-green" onclick="makeAdmin('${uid}')">ğŸ‘‘ Admin</button>` : ''}
        ${!isMe ? `<button class="btn btn-small btn-red" onclick="deleteUser('${uid}')">ğŸ—‘ï¸</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function viewUserData(uid) {
  viewingUserId = uid;
  const snap = await db.ref('data/' + uid).once('value');
  const data = snap.val() || {};
  imports = data.imports || {};
  catOverrides = data.overrides || {};
  txnNotes = data.notes || {};
  $('profileLabel').textContent = 'ğŸ‘ï¸ Viewing: ' + (allUsers[uid]?.name || allUsers[uid]?.email);
  renderImports();
  loadActiveTxns();
  switchPage('overview');
  notify('Viewing ' + (allUsers[uid]?.name || 'user') + "'s data");
}

async function makeAdmin(uid) {
  if (!confirm('Make this user an admin?')) return;
  await db.ref('users/' + uid + '/role').set('admin');
  allUsers[uid].role = 'admin';
  renderUsers();
  notify('User is now admin');
}

async function deleteUser(uid) {
  if (!confirm('Delete this user and ALL their data?')) return;
  await db.ref('users/' + uid).remove();
  await db.ref('data/' + uid).remove();
  delete allUsers[uid];
  renderUsers();
  notify('User deleted');
}

function showInviteModal() {
  $('inviteEmail').value = '';
  $('inviteName').value = '';
  $('invitePassword').value = '';
  $('inviteModal').classList.remove('hidden');
}

function hideInviteModal() {
  $('inviteModal').classList.add('hidden');
}

async function createUser() {
  const email = $('inviteEmail').value.trim();
  const name = $('inviteName').value.trim();
  const password = $('invitePassword').value;
  
  if (!email || !name || !password) {
    notify('Fill all fields', 'warning');
    return;
  }
  if (password.length < 6) {
    notify('Password must be 6+ characters', 'warning');
    return;
  }
  
  try {
    // Create with secondary auth to keep admin signed in
    const tempApp = firebase.initializeApp(firebaseConfig, 'temp' + Date.now());
    const tempAuth = tempApp.auth();
    const cred = await tempAuth.createUserWithEmailAndPassword(email, password);
    await cred.user.updateProfile({ displayName: name });
    await db.ref('users/' + cred.user.uid).set({ email, name, role: 'user', createdAt: Date.now() });
    await tempAuth.signOut();
    await tempApp.delete();
    
    allUsers[cred.user.uid] = { email, name, role: 'user', createdAt: Date.now() };
    $('usersBadge').textContent = Object.keys(allUsers).length;
    hideInviteModal();
    renderUsers();
    notify('User created! They can sign in with: ' + email);
  } catch (e) {
    notify(e.message, 'warning');
  }
}

// Print Report
function printReport() {
  // Generate summary for print
  const income = filteredTxns.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0);
  const expenses = Math.abs(filteredTxns.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0));
  const net = income - expenses;
  const sr = income > 0 ? (net / income * 100).toFixed(1) : 0;
  
  // Category breakdown
  const cats = {};
  filteredTxns.filter(t => t.amount < 0).forEach(t => { 
    cats[t.category] = (cats[t.category]||0) + Math.abs(t.amount); 
  });
  const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]);
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Bank Report - ${new Date().toLocaleDateString()}</title>
      <style>
        body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
        h1{color:#0f172a;border-bottom:2px solid #22d3ee;padding-bottom:10px}
        h2{color:#334155;margin-top:30px}
        .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:20px 0}
        .stat{background:#f8fafc;padding:15px;border-radius:8px;text-align:center}
        .stat-value{font-size:24px;font-weight:bold;color:#0f172a}
        .stat-label{font-size:12px;color:#64748b;margin-top:5px}
        .green{color:#059669}.red{color:#dc2626}.blue{color:#0891b2}
        table{width:100%;border-collapse:collapse;margin:20px 0}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #e2e8f0}
        th{background:#f8fafc;font-weight:600}
        .amount{text-align:right;font-family:monospace}
        .footer{margin-top:40px;text-align:center;color:#64748b;font-size:12px}
      </style>
    </head>
    <body>
      <h1>ğŸ’³ Bank Analyzer Report</h1>
      <p>Generated: ${new Date().toLocaleString()}</p>
      <p>Period: ${filteredTxns.length ? filteredTxns[0].date + ' - ' + filteredTxns[filteredTxns.length-1].date : 'N/A'}</p>
      
      <div class="summary">
        <div class="stat"><div class="stat-value green">â‚¬${income.toFixed(2)}</div><div class="stat-label">Income</div></div>
        <div class="stat"><div class="stat-value red">â‚¬${expenses.toFixed(2)}</div><div class="stat-label">Expenses</div></div>
        <div class="stat"><div class="stat-value blue">â‚¬${net.toFixed(2)}</div><div class="stat-label">Net</div></div>
        <div class="stat"><div class="stat-value">${sr}%</div><div class="stat-label">Savings Rate</div></div>
      </div>
      
      <h2>ğŸ“Š Spending by Category</h2>
      <table>
        <tr><th>Category</th><th class="amount">Amount</th><th class="amount">%</th></tr>
        ${sortedCats.map(([cat, amt]) => `<tr><td>${CATS[cat]?.i || 'ğŸ’³'} ${cat}</td><td class="amount">â‚¬${amt.toFixed(2)}</td><td class="amount">${(amt/expenses*100).toFixed(1)}%</td></tr>`).join('')}
      </table>
      
      <h2>ğŸ”¥ Top 10 Expenses</h2>
      <table>
        <tr><th>#</th><th>Description</th><th>Date</th><th>Category</th><th class="amount">Amount</th></tr>
        ${filteredTxns.filter(t => t.amount < 0).sort((a,b) => a.amount - b.amount).slice(0,10).map((t,i) => `<tr><td>${i+1}</td><td>${t.description.slice(0,40)}</td><td>${t.date}</td><td>${t.category}</td><td class="amount red">â‚¬${Math.abs(t.amount).toFixed(2)}</td></tr>`).join('')}
      </table>
      
      <h2>ğŸ“ All Transactions (${filteredTxns.length})</h2>
      <table>
        <tr><th>Date</th><th>Description</th><th>Category</th><th class="amount">Amount</th></tr>
        ${filteredTxns.slice().reverse().map(t => `<tr><td>${t.date}</td><td>${t.description.slice(0,40)}</td><td>${t.category}</td><td class="amount ${t.amount > 0 ? 'green' : 'red'}">${t.amount > 0 ? '+' : ''}â‚¬${t.amount.toFixed(2)}</td></tr>`).join('')}
      </table>
      
      <div class="footer">
        <p>Bank Analyzer v9 â€¢ Cloud Sync Edition</p>
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// ==================== STOCKS ====================

const STOCK_API = 'https://query1.finance.yahoo.com/v8/finance/chart/';
const MARKET_INDICES = [
  { symbol: '^GSPC', name: 'S&P 500' },
  { symbol: '^DJI', name: 'Dow Jones' },
  { symbol: '^IXIC', name: 'NASDAQ' },
  { symbol: '^FTSE', name: 'FTSE 100' }
];

async function fetchStockPrice(symbol) {
  try {
    // Using a CORS proxy for Yahoo Finance
    const proxy = 'https://api.allorigins.win/raw?url=';
    const url = `${proxy}${encodeURIComponent(STOCK_API + symbol + '?interval=1d&range=5d')}`;
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.chart?.result?.[0]) {
      const result = data.chart.result[0];
      const meta = result.meta;
      const quote = result.indicators?.quote?.[0];
      
      return {
        symbol: meta.symbol,
        price: meta.regularMarketPrice,
        previousClose: meta.previousClose || meta.chartPreviousClose,
        currency: meta.currency,
        name: meta.shortName || meta.symbol,
        change: meta.regularMarketPrice - (meta.previousClose || meta.chartPreviousClose),
        changePercent: ((meta.regularMarketPrice - (meta.previousClose || meta.chartPreviousClose)) / (meta.previousClose || meta.chartPreviousClose) * 100)
      };
    }
    return null;
  } catch (e) {
    console.error('Error fetching stock:', symbol, e);
    return null;
  }
}

async function loadStocks() {
  $('stocksBadge').textContent = Object.keys(stocks).length;
  $('emailEnabled').checked = emailSettings.enabled;
  $('notificationEmail').value = emailSettings.email || currentUser.email;
  
  if (Object.keys(stocks).length === 0) {
    $('stocksList').innerHTML = '';
    $('noStocks').classList.remove('hidden');
    $('portfolioSummary').classList.add('hidden');
    renderMarketOverview();
    return;
  }
  
  $('noStocks').classList.add('hidden');
  $('portfolioSummary').classList.remove('hidden');
  
  // Fetch current prices
  $('stocksList').innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="color:var(--muted)">Loading prices...</p></div>';
  
  const symbols = [...new Set(Object.values(stocks).map(s => s.symbol))];
  for (const symbol of symbols) {
    const price = await fetchStockPrice(symbol);
    if (price) stockPrices[symbol] = price;
  }
  
  renderStocks();
  renderMarketOverview();
}

function renderStocks() {
  let totalInvested = 0;
  let totalValue = 0;
  
  const stockList = Object.entries(stocks).map(([id, stock]) => {
    const price = stockPrices[stock.symbol];
    const currentPrice = price?.price || stock.purchasePrice;
    const invested = stock.shares * stock.purchasePrice;
    const value = stock.shares * currentPrice;
    const gain = value - invested;
    const gainPct = invested > 0 ? (gain / invested * 100) : 0;
    
    totalInvested += invested;
    totalValue += value;
    
    return {
      id, ...stock,
      currentPrice,
      invested,
      value,
      gain,
      gainPct,
      priceData: price
    };
  }).sort((a, b) => b.value - a.value);
  
  const totalGain = totalValue - totalInvested;
  const totalGainPct = totalInvested > 0 ? (totalGain / totalInvested * 100) : 0;
  
  // Update summary
  $('totalInvested').textContent = fmt(totalInvested);
  $('totalValue').textContent = fmt(totalValue);
  $('totalValue').className = 'card-value ' + (totalGain >= 0 ? 'green' : 'red');
  $('totalGain').textContent = (totalGain >= 0 ? '+' : '') + fmt(totalGain);
  $('totalGain').className = 'card-value ' + (totalGain >= 0 ? 'green' : 'red');
  $('totalGainPct').textContent = (totalGain >= 0 ? '+' : '') + totalGainPct.toFixed(2) + '%';
  $('holdingsCount').textContent = stockList.length;
  
  // Render stock cards
  $('stocksList').innerHTML = stockList.map(s => `
    <div class="stock-card ${s.gain >= 0 ? 'profit' : 'loss'}">
      <div class="stock-symbol">${s.symbol}</div>
      <div class="stock-info">
        <div class="stock-name">${s.priceData?.name || s.symbol}</div>
        <div class="stock-meta">
          ${s.shares} shares @ ${fmt(s.purchasePrice)} â€¢ Invested: ${fmt(s.invested)}
        </div>
        <div class="stock-meta">
          Bought: ${new Date(s.purchaseDate).toLocaleDateString()} ${s.notes ? 'â€¢ ' + s.notes : ''}
        </div>
      </div>
      <div class="stock-values">
        <div class="stock-current">${fmt(s.value)}</div>
        <div class="stock-gain ${s.gain >= 0 ? 'profit' : 'loss'}">
          ${s.gain >= 0 ? '+' : ''}${fmt(s.gain)} (${s.gain >= 0 ? '+' : ''}${s.gainPct.toFixed(2)}%)
        </div>
        <div style="font-size:11px;color:var(--muted)">@ ${fmt(s.currentPrice)}/share</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-small btn-blue" onclick="editStock('${s.id}')">âœï¸</button>
        <button class="btn btn-small btn-red" onclick="deleteStock('${s.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>
  `).join('');
}

async function renderMarketOverview() {
  $('marketOverview').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px"><div class="spinner"></div></div>';
  
  const indices = [];
  for (const index of MARKET_INDICES) {
    const data = await fetchStockPrice(index.symbol);
    if (data) indices.push({ ...index, ...data });
  }
  
  $('marketOverview').innerHTML = indices.map(idx => `
    <div class="card">
      <div class="card-label">${idx.name}</div>
      <div class="card-value" style="font-size:18px">${idx.price?.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) || 'N/A'}</div>
      <div class="card-sub ${idx.change >= 0 ? 'green' : 'red'}" style="color:${idx.change >= 0 ? 'var(--green)' : 'var(--red)'}">
        ${idx.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(idx.change || 0).toFixed(2)} (${(idx.changePercent || 0).toFixed(2)}%)
      </div>
    </div>
  `).join('') || '<div style="color:var(--muted);text-align:center;padding:20px">Unable to load market data</div>';
}

function showAddStockModal() {
  editingStockId = null;
  $('stockModalTitle').textContent = 'ğŸ“ˆ Add Stock';
  $('stockSymbol').value = '';
  $('stockShares').value = '';
  $('stockPrice').value = '';
  $('stockDate').value = new Date().toISOString().split('T')[0];
  $('stockNotes').value = '';
  $('stockModal').classList.remove('hidden');
}

function editStock(id) {
  const stock = stocks[id];
  if (!stock) return;
  
  editingStockId = id;
  $('stockModalTitle').textContent = 'âœï¸ Edit Stock';
  $('stockSymbol').value = stock.symbol;
  $('stockShares').value = stock.shares;
  $('stockPrice').value = stock.purchasePrice;
  $('stockDate').value = stock.purchaseDate;
  $('stockNotes').value = stock.notes || '';
  $('stockModal').classList.remove('hidden');
}

function hideStockModal() {
  $('stockModal').classList.add('hidden');
  editingStockId = null;
}

async function saveStock() {
  const symbol = $('stockSymbol').value.toUpperCase().trim();
  const shares = parseFloat($('stockShares').value);
  const price = parseFloat($('stockPrice').value);
  const date = $('stockDate').value;
  const notes = $('stockNotes').value.trim();
  
  if (!symbol || !shares || !price || !date) {
    notify('Please fill all required fields', 'warning');
    return;
  }
  
  // Verify symbol exists
  const priceData = await fetchStockPrice(symbol);
  if (!priceData) {
    notify('Could not find stock symbol: ' + symbol, 'warning');
    return;
  }
  
  const id = editingStockId || 'stock_' + Date.now();
  stocks[id] = {
    symbol,
    shares,
    purchasePrice: price,
    purchaseDate: date,
    notes,
    addedAt: stocks[id]?.addedAt || Date.now()
  };
  
  await saveData();
  hideStockModal();
  loadStocks();
  notify(editingStockId ? 'Stock updated' : 'Stock added');
}

async function deleteStock(id) {
  if (!confirm('Delete this stock from your portfolio?')) return;
  delete stocks[id];
  await saveData();
  loadStocks();
  notify('Stock removed');
}

// Email notification settings
function toggleEmailNotifications() {
  emailSettings.enabled = $('emailEnabled').checked;
}

async function saveEmailSettings() {
  emailSettings.enabled = $('emailEnabled').checked;
  emailSettings.email = $('notificationEmail').value.trim();
  
  if (emailSettings.enabled && !emailSettings.email) {
    notify('Please enter an email address', 'warning');
    return;
  }
  
  await saveData();
  
  // Save to a separate notifications collection for the cloud function to process
  if (emailSettings.enabled) {
    await db.ref('notifications/' + currentUser.uid).set({
      email: emailSettings.email,
      enabled: true,
      stocks: stocks,
      updatedAt: Date.now()
    });
    notify('Email notifications enabled! You\'ll receive daily updates at 8:00 AM.');
  } else {
    await db.ref('notifications/' + currentUser.uid).remove();
    notify('Email notifications disabled');
  }
}
</script>
</body>
</html>
