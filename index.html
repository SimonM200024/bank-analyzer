<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Analyzer - NLB Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:rgba(30,41,59,0.5);--bg-item:rgba(51,65,85,0.3);--border:#334155;--text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b}
    .light-mode{--bg-primary:#f1f5f9;--bg-secondary:#e2e8f0;--bg-card:rgba(255,255,255,0.8);--bg-item:rgba(241,245,249,0.8);--border:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--text-muted:#64748b}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',system-ui,sans-serif;background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary));color:var(--text-primary);min-height:100vh;padding:20px;transition:all .3s}
    .container{max-width:1200px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:44px;height:44px;background:linear-gradient(135deg,#34d399,#22d3ee);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
    .logo h1{font-size:20px;font-weight:600}
    .logo p{font-size:12px;color:var(--text-muted)}
    .header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .theme-toggle{width:44px;height:44px;border-radius:12px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .upload-zone{border:2px dashed var(--border);border-radius:16px;padding:48px 24px;text-align:center;margin-bottom:24px;background:var(--bg-card);cursor:pointer;transition:all .3s}
    .upload-zone:hover,.upload-zone.dragging{border-color:#34d399;background:rgba(52,211,153,0.1)}
    .upload-zone input{display:none}
    .upload-icon{font-size:48px;margin-bottom:16px}
    .file-tags{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:16px}
    .file-tag{padding:6px 12px;background:rgba(52,211,153,0.2);color:#34d399;border-radius:20px;font-size:13px}
    .filters{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
    .filter-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px}
    .month-pills{display:flex;gap:6px;flex-wrap:wrap}
    .month-pill{padding:6px 12px;background:var(--bg-item);border:1px solid var(--border);border-radius:20px;color:var(--text-secondary);font-size:12px;cursor:pointer}
    .month-pill.active{background:#22d3ee;color:#0f172a;border-color:#22d3ee}
    .filter-btn{padding:8px 16px;background:var(--bg-item);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-size:13px;cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
    .card{padding:18px;border-radius:16px;border:1px solid rgba(255,255,255,0.1);background:var(--bg-card)}
    .card-income{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));border-color:rgba(16,185,129,0.2)}
    .card-expense{background:linear-gradient(135deg,rgba(244,63,94,0.15),rgba(244,63,94,0.05));border-color:rgba(244,63,94,0.2)}
    .card-balance{background:linear-gradient(135deg,rgba(34,211,238,0.15),rgba(34,211,238,0.05));border-color:rgba(34,211,238,0.2)}
    .card-savings{background:linear-gradient(135deg,rgba(168,85,247,0.15),rgba(168,85,247,0.05));border-color:rgba(168,85,247,0.2)}
    .card-count{background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05));border-color:rgba(251,191,36,0.2)}
    .card-label{color:var(--text-secondary);font-size:12px;margin-bottom:6px}
    .card-value{font-size:22px;font-weight:700;font-family:monospace}
    .card-value.green{color:#34d399}.card-value.red{color:#fb7185}.card-value.blue{color:#22d3ee}.card-value.purple{color:#a78bfa}.card-value.yellow{color:#fbbf24}
    .card-sub{font-size:11px;color:var(--text-muted);margin-top:4px}
    .chart-box{padding:24px;border-radius:16px;background:var(--bg-card);border:1px solid var(--border);margin-bottom:24px}
    .chart-box h3{font-size:16px;margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .chart-box h3 .badge{font-size:11px;padding:2px 8px;background:#22d3ee;color:#0f172a;border-radius:10px}
    .chart-container{position:relative;height:280px}
    .chart-container.tall{height:350px}
    .comparison-box{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:24px}
    .comparison-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
    .comparison-item{text-align:center;padding:16px;background:var(--bg-item);border-radius:12px}
    .comparison-label{font-size:12px;color:var(--text-secondary);margin-bottom:8px}
    .comparison-value{font-size:20px;font-weight:700;font-family:monospace}
    .comparison-change{font-size:13px;margin-top:6px}
    .comparison-change.up{color:#fb7185}.comparison-change.down{color:#34d399}.comparison-change.neutral{color:var(--text-secondary)}
    .heatmap-container{overflow-x:auto}
    .heatmap{display:flex;gap:8px}
    .heatmap-days{display:flex;flex-direction:column;gap:2px;padding-top:2px}
    .heatmap-day-label{font-size:10px;color:var(--text-muted);height:14px;line-height:14px}
    .heatmap-grid{display:flex;gap:2px}
    .heatmap-week{display:flex;flex-direction:column;gap:2px}
    .heatmap-cell{width:14px;height:14px;border-radius:3px;background:var(--bg-item);cursor:pointer;transition:transform .1s}
    .heatmap-cell:hover{transform:scale(1.3);z-index:10}
    .heatmap-cell.level-0{background:var(--bg-item)}.heatmap-cell.level-1{background:rgba(34,197,94,0.3)}.heatmap-cell.level-2{background:rgba(250,204,21,0.4)}.heatmap-cell.level-3{background:rgba(249,115,22,0.5)}.heatmap-cell.level-4{background:rgba(239,68,68,0.6)}.heatmap-cell.level-5{background:rgba(239,68,68,0.9)}
    .heatmap-legend{display:flex;align-items:center;gap:8px;margin-top:16px;justify-content:flex-end}
    .heatmap-legend-label{font-size:11px;color:var(--text-muted)}
    .heatmap-legend-cells{display:flex;gap:2px}
    .heatmap-tooltip{position:fixed;background:var(--bg-primary);border:1px solid var(--border);padding:8px 12px;border-radius:8px;font-size:12px;pointer-events:none;z-index:1000;display:none}
    .weekday-bars{display:flex;gap:8px;align-items:flex-end;height:180px;padding:20px 0}
    .weekday-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:8px}
    .weekday-bar-fill{width:100%;border-radius:6px 6px 0 0;min-height:4px}
    .weekday-bar-label{font-size:12px;color:var(--text-secondary)}
    .weekday-bar-value{font-size:11px;color:var(--text-muted);font-family:monospace}
    .weekday-bar.highlight .weekday-bar-label{color:#fb7185;font-weight:600}
    .top-expense-item,.merchant-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-item);border-radius:10px;margin-bottom:8px}
    .top-expense-rank{width:28px;height:28px;background:linear-gradient(135deg,#f59e0b,#f97316);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#0f172a;flex-shrink:0}
    .top-expense-rank.silver{background:linear-gradient(135deg,#94a3b8,#64748b)}.top-expense-rank.bronze{background:linear-gradient(135deg,#b45309,#92400e);color:#fef3c7}
    .top-expense-details,.merchant-info{flex:1;min-width:0}
    .top-expense-desc,.merchant-name{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .top-expense-meta,.merchant-stats{font-size:12px;color:var(--text-muted);margin-top:2px}
    .top-expense-amount,.merchant-total{font-family:monospace;font-weight:600;color:#fb7185;font-size:14px;flex-shrink:0}
    .merchant-rank{width:24px;height:24px;background:var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:var(--text-secondary)}
    .recurring-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:10px;margin-bottom:8px}
    .recurring-icon{width:36px;height:36px;background:rgba(99,102,241,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .recurring-info{flex:1;min-width:0}
    .recurring-name{font-weight:500;font-size:14px}
    .recurring-pattern{font-size:12px;color:#a5b4fc;margin-top:2px}
    .recurring-value{font-family:monospace;font-weight:600;color:#a5b4fc;font-size:14px}
    .recurring-freq{font-size:11px;color:var(--text-muted);margin-top:2px}
    .category-item{display:flex;align-items:center;gap:12px;padding:14px;margin-bottom:8px;background:var(--bg-item);border-radius:12px;cursor:pointer}
    .category-item:hover{background:var(--bg-card)}.category-item.active{background:var(--border)}
    .category-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .category-info{flex:1;min-width:0}
    .category-name{font-weight:500;margin-bottom:4px}
    .category-bar{height:4px;background:var(--border);border-radius:2px}
    .category-bar-fill{height:100%;border-radius:2px}
    .category-amount{font-family:monospace;color:var(--text-secondary);font-size:14px}
    .category-percent{color:var(--text-muted);font-size:13px;width:50px;text-align:right}
    .transactions{border-radius:16px;background:var(--bg-card);border:1px solid var(--border);overflow:hidden;margin-bottom:24px}
    .transactions-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .transaction{display:flex;align-items:center;gap:14px;padding:14px 20px;border-bottom:1px solid var(--bg-secondary)}
    .transaction:hover{background:var(--bg-item)}
    .transaction-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .transaction-details{flex:1;min-width:0}
    .transaction-desc{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
    .transaction-meta{font-size:12px;color:var(--text-muted)}
    .transaction-cat{padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px}
    .transaction-amount{text-align:right}
    .transaction-amount-value{font-weight:600;font-family:monospace}
    .transaction-amount-value.positive{color:#34d399}
    .transaction-balance{font-size:11px;color:var(--text-muted);margin-top:2px}
    .show-more{width:100%;padding:14px;background:transparent;border:none;border-top:1px solid var(--bg-secondary);color:var(--text-secondary);cursor:pointer;font-size:14px}
    .btn{padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:14px;display:inline-flex;align-items:center;gap:6px}
    .btn-clear{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171}
    .btn-export{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:#4ade80}
    .btn-print{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);color:#a5b4fc}
    .btn-filter{padding:4px 12px;background:var(--border);color:var(--text-secondary);border-radius:20px;margin-left:8px;font-size:12px;border:none;cursor:pointer}
    .empty-state{text-align:center;padding:80px 20px;color:var(--text-muted)}
    .empty-state-icon{font-size:64px;margin-bottom:20px}
    .footer{text-align:center;padding:32px 0;color:var(--text-muted);font-size:13px}
    .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:#22d3ee;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none!important}
    .error-box{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:16px;border-radius:12px;margin-bottom:24px}
    .search-box{flex:1;min-width:200px;max-width:300px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px}
    .savings-gauge{width:100%;height:8px;background:var(--border);border-radius:4px;margin-top:8px;overflow:hidden}
    .savings-gauge-fill{height:100%;border-radius:4px}
    .savings-gauge-fill.good{background:linear-gradient(90deg,#22c55e,#34d399)}.savings-gauge-fill.ok{background:linear-gradient(90deg,#f59e0b,#fbbf24)}.savings-gauge-fill.bad{background:linear-gradient(90deg,#ef4444,#fb7185)}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:24px}
    .insights-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;margin-bottom:24px}
    .no-data{text-align:center;padding:40px;color:var(--text-muted)}
    .print-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000}
    .print-modal-content{background:var(--bg-primary);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:500px;width:90%}
    .print-options{display:flex;flex-direction:column;gap:12px;margin:20px 0}
    .print-option{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-item);border-radius:8px;cursor:pointer}
    .print-option input{width:18px;height:18px}
    .print-modal-actions{display:flex;gap:12px;justify-content:flex-end}
    @media print{body{background:#fff!important;color:#000!important;padding:0!important}.no-print{display:none!important}.chart-box,.card{break-inside:avoid;background:#fff!important;border:1px solid #ddd!important}.card-value{color:#000!important}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo"><div class="logo-icon">üí≥</div><div><h1>Bank Analyzer</h1><p>NLB Statement Dashboard</p></div></div>
      <div class="header-actions" id="headerActions">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåô</button>
        <button class="btn btn-print no-print" onclick="showPrintModal()">üñ®Ô∏è Report</button>
        <button class="btn btn-export no-print" onclick="exportToCSV()">üì• CSV</button>
        <button class="btn btn-clear no-print" onclick="clearAllData()">üóëÔ∏è</button>
      </div>
    </header>
    <div class="upload-zone no-print" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf" multiple>
      <div id="uploadContent"><div class="upload-icon">üìÑ</div><h3>Drop NLB bank statements here</h3><p>or click to browse ‚Ä¢ PDF files ‚Ä¢ Multiple supported</p></div>
      <div id="uploadLoading" class="hidden"><div class="spinner"></div><h3>Processing...</h3><p id="loadingStatus" style="color:var(--text-muted);margin-top:8px"></p></div>
      <div class="file-tags" id="fileTags"></div>
    </div>
    <div id="errorBox" class="error-box hidden"></div>
    <div id="emptyState" class="empty-state"><div class="empty-state-icon">üìä</div><h2>No transactions yet</h2><p>Upload your NLB bank statement PDFs to see analytics</p></div>
    <div id="dashboard" class="hidden">
      <div class="filters no-print">
        <select class="filter-select" id="yearFilter" onchange="applyFilters()"></select>
        <div class="month-pills" id="monthPills"></div>
        <button class="filter-btn" onclick="resetFilters()" style="margin-left:auto">‚Ü∫ Reset</button>
      </div>
      <div class="cards">
        <div class="card card-income"><div class="card-label">üí∞ Income</div><div class="card-value green" id="totalIncome">‚Ç¨0</div><div class="card-sub" id="incomeCount">0 txns</div></div>
        <div class="card card-expense"><div class="card-label">üí∏ Expenses</div><div class="card-value red" id="totalExpenses">‚Ç¨0</div><div class="card-sub" id="expenseCount">0 txns</div></div>
        <div class="card card-balance"><div class="card-label">üìà Net</div><div class="card-value blue" id="netBalance">‚Ç¨0</div><div class="card-sub" id="avgDaily">Avg/day: ‚Ç¨0</div></div>
        <div class="card card-savings"><div class="card-label">üéØ Savings</div><div class="card-value purple" id="savingsRate">0%</div><div class="savings-gauge"><div class="savings-gauge-fill" id="savingsGauge"></div></div></div>
        <div class="card card-count"><div class="card-label">üìä Total</div><div class="card-value yellow" id="txnTotal">0</div><div class="card-sub" id="dateRange">-</div></div>
      </div>
      <div class="comparison-box" id="comparisonBox"><h3>üìä Month Comparison</h3><div class="comparison-grid" id="comparisonGrid"></div></div>
      <div class="chart-box"><h3>üóìÔ∏è Spending Heatmap <span class="badge">daily</span></h3><div class="heatmap-container" id="heatmapContainer"></div><div class="heatmap-legend"><span class="heatmap-legend-label">Less</span><div class="heatmap-legend-cells"><div class="heatmap-cell level-0"></div><div class="heatmap-cell level-1"></div><div class="heatmap-cell level-2"></div><div class="heatmap-cell level-3"></div><div class="heatmap-cell level-4"></div><div class="heatmap-cell level-5"></div></div><span class="heatmap-legend-label">More</span></div></div>
      <div class="insights-grid">
        <div class="chart-box" style="margin-bottom:0"><h3>üìÖ By Weekday</h3><div class="weekday-bars" id="weekdayBars"></div></div>
        <div class="chart-box" style="margin-bottom:0"><h3>üîÑ Recurring <span class="badge" id="recurringCount">0</span></h3><div id="recurringList"></div></div>
      </div>
      <div class="grid-2">
        <div class="chart-box" style="margin-bottom:0"><h3>üìä By Category</h3><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
        <div class="chart-box" style="margin-bottom:0"><h3>üìâ Balance</h3><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
      </div>
      <div class="grid-2" style="margin-top:24px">
        <div class="chart-box" style="margin-bottom:0"><h3>üè™ Top Merchants</h3><div id="merchantsByAmount"></div></div>
        <div class="chart-box" style="margin-bottom:0"><h3>üî¢ Most Visited</h3><div id="merchantsByFrequency"></div></div>
      </div>
      <div class="chart-box" style="margin-top:24px"><h3>üî• Top 10 Expenses</h3><div id="topExpensesList"></div></div>
      <div class="chart-box"><h3>üìÜ Monthly Overview</h3><div class="chart-container tall"><canvas id="monthlyChart"></canvas></div></div>
      <div class="chart-box"><h3>üìã Categories</h3><div id="categoryList"></div></div>
      <div class="transactions">
        <div class="transactions-header"><h3>üìù <span id="txnTitle">Transactions</span><button class="btn-filter hidden no-print" id="clearCatFilter" onclick="clearCategoryFilter()">Clear √ó</button></h3><input type="text" class="search-box no-print" id="searchBox" placeholder="üîç Search..." oninput="applyFilters()"><span id="txnListCount" style="color:var(--text-muted);font-size:13px"></span></div>
        <div id="transactionList"></div>
        <button class="show-more hidden no-print" id="showMoreBtn" onclick="toggleShowAll()">Show all</button>
      </div>
      <footer class="footer">Bank Analyzer v5 ‚Ä¢ Data stored locally</footer>
    </div>
  </div>
  <div class="heatmap-tooltip" id="heatmapTooltip"></div>
  <div class="print-modal hidden" id="printModal">
    <div class="print-modal-content">
      <h2>üìÑ Generate Report</h2>
      <div class="print-options">
        <label class="print-option"><input type="checkbox" id="printSummary" checked><span>Summary</span></label>
        <label class="print-option"><input type="checkbox" id="printCategories" checked><span>Categories</span></label>
        <label class="print-option"><input type="checkbox" id="printTopExpenses" checked><span>Top Expenses</span></label>
        <label class="print-option"><input type="checkbox" id="printMerchants" checked><span>Merchants</span></label>
        <label class="print-option"><input type="checkbox" id="printTransactions"><span>All Transactions</span></label>
      </div>
      <div class="print-modal-actions">
        <button class="btn btn-clear" onclick="hidePrintModal()">Cancel</button>
        <button class="btn btn-print" onclick="generatePrintReport()">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>
  <script type="module">
    const pdfjsLib=await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs');pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';
    window.clearAllData=clearAllData;window.clearCategoryFilter=clearCategoryFilter;window.toggleShowAll=toggleShowAll;window.filterByCategory=filterByCategory;window.applyFilters=applyFilters;window.resetFilters=resetFilters;window.selectMonth=selectMonth;window.exportToCSV=exportToCSV;window.toggleTheme=toggleTheme;window.showPrintModal=showPrintModal;window.hidePrintModal=hidePrintModal;window.generatePrintReport=generatePrintReport;
    let allTransactions=[],filteredTransactions=[],uploadedFiles=[],selectedCategory=null,selectedYear='all',selectedMonth='all',searchQuery='',showAll=false,isDarkMode=true,pieChart=null,lineChart=null,monthlyChart=null;
    const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],FULL_MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'],WEEKDAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],WEEKDAY_COLORS=['#f87171','#fb923c','#fbbf24','#a3e635','#34d399','#22d3ee','#a78bfa'];
    const CATEGORIES={'Groceries':{keywords:['LIDL','HOFER','SPAR','INTERSPAR','MERCATOR','TUS','EUROSPIN'],color:'#10B981',icon:'üõí'},'Fuel':{keywords:['MOL ','MOL-','PETROL','OMV'],color:'#F59E0B',icon:'‚õΩ'},'Restaurants':{keywords:['MCDONALDS','PUB','BAR ','RESTAVRACIJA','PIVNICA','GOSTILNA','PIZZA'],color:'#EC4899',icon:'üçî'},'Travel':{keywords:['ASFINAG','DARS','BOOKING','HOTEL','BANKOMAT DVIG','AIRBNB'],color:'#3B82F6',icon:'‚úàÔ∏è'},'Shopping':{keywords:['ZARA','AMAZON','AMZN','H&M','ABOUTYOU','MERKUR','DM -','IKEA'],color:'#8B5CF6',icon:'üõçÔ∏è'},'Entertainment':{keywords:['NETFLIX','SPOTIFY','STEAM','KINO'],color:'#06B6D4',icon:'üé¨'},'Transportation':{keywords:['PSTOP','PARK','TAXI','UBER'],color:'#EF4444',icon:'üöó'},'Transfers':{keywords:['REVOLUT','FLIK','PAYPAL'],color:'#6366F1',icon:'üí∏'},'Education':{keywords:['UL EF','FAKULT','UNIV'],color:'#F472B6',icon:'üéì'},'Health':{keywords:['LEKARNA','APOTEKA'],color:'#84CC16',icon:'üè•'},'Services':{keywords:['POSTA','PROVIZIJA','TELEKOM'],color:'#64748B',icon:'üìã'},'Income':{keywords:['ADRIAL','REDNO DELO','PLACA','SICOD','RETURN','VRACILO'],color:'#22C55E',icon:'üí∞'},'Personal':{keywords:['ROK ','MILAN V','ANDRAZ','NEJC P','FLIK PLA'],color:'#14B8A6',icon:'üë§'},'Other':{keywords:[],color:'#94A3B8',icon:'üí≥'}};
    function toggleTheme(){isDarkMode=!isDarkMode;document.documentElement.classList.toggle('light-mode',!isDarkMode);document.querySelector('.theme-toggle').textContent=isDarkMode?'üåô':'‚òÄÔ∏è';localStorage.setItem('bankTheme',isDarkMode?'dark':'light');if(pieChart)render();}
    function loadTheme(){if(localStorage.getItem('bankTheme')==='light'){isDarkMode=false;document.documentElement.classList.add('light-mode');document.querySelector('.theme-toggle').textContent='‚òÄÔ∏è';}}
    function showPrintModal(){document.getElementById('printModal').classList.remove('hidden');}
    function hidePrintModal(){document.getElementById('printModal').classList.add('hidden');}
    function generatePrintReport(){const inc=document.getElementById('printSummary').checked,cat=document.getElementById('printCategories').checked,top=document.getElementById('printTopExpenses').checked,mer=document.getElementById('printMerchants').checked,txn=document.getElementById('printTransactions').checked;const income=filteredTransactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),expenses=Math.abs(filteredTransactions.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0)),net=income-expenses,sr=income>0?((income-expenses)/income)*100:0;const catTotals={};filteredTransactions.filter(t=>t.amount<0).forEach(t=>{catTotals[t.category]=(catTotals[t.category]||0)+Math.abs(t.amount)});const sortedCats=Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);const topExp=filteredTransactions.filter(t=>t.amount<0).sort((a,b)=>a.amount-b.amount).slice(0,10);const{byAmount}=getMerchantRankings(filteredTransactions);const vt=filteredTransactions.filter(t=>t.parsedDate);const dr=vt.length?`${vt[0].date} - ${vt[vt.length-1].date}`:'-';let h=`<!DOCTYPE html><html><head><title>Bank Report</title><style>body{font-family:Inter,Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#1e293b}h1{font-size:24px;margin-bottom:4px}.subtitle{color:#64748b;margin-bottom:24px;font-size:14px}.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:32px}.summary-item{padding:20px;background:#f8fafc;border-radius:12px;text-align:center}.summary-label{font-size:12px;color:#64748b;margin-bottom:4px}.summary-value{font-size:24px;font-weight:700}.section{margin-bottom:32px}.section h3{font-size:14px;color:#64748b;margin-bottom:12px;border-bottom:2px solid #e2e8f0;padding-bottom:8px}table{width:100%;border-collapse:collapse;font-size:13px}th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #e2e8f0}th{font-weight:600;color:#64748b;background:#f8fafc}.amount{font-family:monospace;text-align:right}.negative{color:#dc2626}.positive{color:#16a34a}</style></head><body><h1>üí≥ Bank Statement Report</h1><p class="subtitle">Period: ${dr} ‚Ä¢ Generated: ${new Date().toLocaleDateString()}</p>`;if(inc)h+=`<div class="summary-grid"><div class="summary-item"><div class="summary-label">Income</div><div class="summary-value" style="color:#16a34a">${formatCurrency(income)}</div></div><div class="summary-item"><div class="summary-label">Expenses</div><div class="summary-value" style="color:#dc2626">${formatCurrency(expenses)}</div></div><div class="summary-item"><div class="summary-label">Net</div><div class="summary-value">${formatCurrency(net)}</div></div></div>`;if(cat&&sortedCats.length)h+=`<div class="section"><h3>üìä Categories</h3><table><tr><th>Category</th><th>Amount</th><th>%</th></tr>${sortedCats.map(([c,a])=>`<tr><td>${CATEGORIES[c]?.icon||'üí≥'} ${c}</td><td class="amount negative">${formatCurrency(-a)}</td><td>${(a/expenses*100).toFixed(1)}%</td></tr>`).join('')}</table></div>`;if(top&&topExp.length)h+=`<div class="section"><h3>üî• Top 10 Expenses</h3><table><tr><th>#</th><th>Date</th><th>Description</th><th>Amount</th></tr>${topExp.map((t,i)=>`<tr><td>${i+1}</td><td>${t.date}</td><td>${t.description.slice(0,40)}</td><td class="amount negative">${formatCurrency(t.amount)}</td></tr>`).join('')}</table></div>`;if(mer&&byAmount.length)h+=`<div class="section"><h3>üè™ Top Merchants</h3><table><tr><th>#</th><th>Merchant</th><th>Visits</th><th>Total</th></tr>${byAmount.slice(0,10).map((m,i)=>`<tr><td>${i+1}</td><td>${m.name}</td><td>${m.count}</td><td class="amount negative">${formatCurrency(-m.total)}</td></tr>`).join('')}</table></div>`;if(txn)h+=`<div class="section"><h3>üìù Transactions</h3><table><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr>${filteredTransactions.slice().reverse().map(t=>`<tr><td>${t.date}</td><td>${t.description.slice(0,35)}</td><td>${t.category}</td><td class="amount ${t.amount>=0?'positive':'negative'}">${formatCurrency(t.amount)}</td></tr>`).join('')}</table></div>`;h+='</body></html>';const w=window.open('','_blank');w.document.write(h);w.document.close();setTimeout(()=>w.print(),500);hidePrintModal();}
    function formatCurrency(a){return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(a);}
    function categorize(d){const u=d.toUpperCase();for(const[c,cfg]of Object.entries(CATEGORIES)){if(c==='Other')continue;if(cfg.keywords.some(k=>u.includes(k.toUpperCase())))return c;}return'Other';}
    function parseDate(s){try{if(!s||typeof s!=='string')return null;const p=s.split('.');if(p.length!==3)return null;const d=parseInt(p[0],10),m=parseInt(p[1],10);let y=parseInt(p[2],10);if(isNaN(d)||isNaN(m)||isNaN(y))return null;if(y<100)y=2000+y;if(d<1||d>31||m<1||m>12||y<2000||y>2100)return null;const dt=new Date(y,m-1,d);if(isNaN(dt.getTime()))return null;return dt;}catch(e){return null;}}
    function normalizeMerchant(d){let n=d.toUpperCase().trim().replace(/^(NAKUP |POS |PSTOP |PARK\. )/,'').replace(/\s+(LJUBLJANA|MARIBOR|KRANJ|CELJE|CERKLJE|MOSTE|VODICE).*$/i,'').replace(/\s+\d+.*$/,'').replace(/\*[A-Z0-9]+/,'');if(n.includes('SPAR'))return'SPAR';if(n.includes('LIDL'))return'LIDL';if(n.includes('HOFER'))return'HOFER';if(n.includes('MERCATOR'))return'MERCATOR';if(n.includes('PETROL'))return'PETROL';if(n.includes('MOL'))return'MOL';if(n.includes('AMAZON'))return'AMAZON';const w=n.split(/\s+/).filter(x=>x.length>2);return w.slice(0,2).join(' ')||n.slice(0,20);}
    function detectRecurring(txns){const g={};txns.filter(t=>t.amount<0).forEach(t=>{const m=normalizeMerchant(t.description),a=Math.abs(t.amount).toFixed(2),k=`${m}|${a}`;if(!g[k])g[k]={merchant:m,amount:Math.abs(t.amount),dates:[]};g[k].dates.push(t.parsedDate);});const r=[];for(const[,gr]of Object.entries(g)){if(gr.dates.length>=2){gr.dates.sort((a,b)=>a-b);const iv=[];for(let i=1;i<gr.dates.length;i++)iv.push(Math.round((gr.dates[i]-gr.dates[i-1])/86400000));const avg=iv.reduce((a,b)=>a+b,0)/iv.length;const monthly=avg>=25&&avg<=35,weekly=avg>=5&&avg<=9,biweekly=avg>=12&&avg<=16;if((monthly||weekly||biweekly)&&gr.dates.length>=2)r.push({merchant:gr.merchant,amount:gr.amount,pattern:monthly?'Monthly':weekly?'Weekly':'Bi-weekly',count:gr.dates.length,totalSpent:gr.amount*gr.dates.length});}}return r.sort((a,b)=>b.totalSpent-a.totalSpent).slice(0,8);}
    function getMerchantRankings(txns){const m={};txns.filter(t=>t.amount<0).forEach(t=>{const n=normalizeMerchant(t.description);if(!m[n])m[n]={name:n,total:0,count:0};m[n].total+=Math.abs(t.amount);m[n].count++;});const l=Object.values(m);return{byAmount:[...l].sort((a,b)=>b.total-a.total).slice(0,10),byFrequency:[...l].sort((a,b)=>b.count-a.count).slice(0,10)};}
    function getWeekdaySpending(txns){const w=[0,0,0,0,0,0,0];txns.filter(t=>t.amount<0&&t.parsedDate).forEach(t=>{w[t.parsedDate.getDay()]+=Math.abs(t.amount);});const max=Math.max(...w);return WEEKDAYS.map((n,i)=>({name:n,total:w[i],percent:max>0?(w[i]/max)*100:0}));}
    function getHeatmapData(txns){const ds={};txns.filter(t=>t.amount<0&&t.parsedDate).forEach(t=>{const k=t.parsedDate.toISOString().split('T')[0];ds[k]=(ds[k]||0)+Math.abs(t.amount);});const v=Object.values(ds),max=Math.max(...v,1),th=[0,max*.1,max*.25,max*.5,max*.75,max];return{dailySpending:ds,thresholds:th};}
    function renderHeatmap(){const{dailySpending,thresholds}=getHeatmapData(filteredTransactions);const vt=filteredTransactions.filter(t=>t.parsedDate);if(!vt.length){document.getElementById('heatmapContainer').innerHTML='<div class="no-data">No data</div>';return;}const start=new Date(vt[0].parsedDate),end=new Date(vt[vt.length-1].parsedDate);start.setDate(start.getDate()-start.getDay());const weeks=[];let cur=new Date(start);while(cur<=end){const week=[];for(let d=0;d<7;d++){const k=cur.toISOString().split('T')[0],sp=dailySpending[k]||0;let lv=0;for(let i=thresholds.length-1;i>=0;i--)if(sp>=thresholds[i]){lv=i;break;}week.push({date:new Date(cur),dateKey:k,spending:sp,level:lv});cur.setDate(cur.getDate()+1);}weeks.push(week);}let h='<div class="heatmap"><div class="heatmap-days"><div class="heatmap-day-label"></div><div class="heatmap-day-label">Mon</div><div class="heatmap-day-label"></div><div class="heatmap-day-label">Wed</div><div class="heatmap-day-label"></div><div class="heatmap-day-label">Fri</div><div class="heatmap-day-label"></div></div><div class="heatmap-grid">';weeks.forEach(wk=>{h+='<div class="heatmap-week">';wk.forEach(day=>{h+=`<div class="heatmap-cell level-${day.level}" data-date="${day.dateKey}" data-amount="${day.spending}" title="${day.date.toLocaleDateString()}: ${formatCurrency(day.spending)}"></div>`;});h+='</div>';});h+='</div></div>';document.getElementById('heatmapContainer').innerHTML=h;document.querySelectorAll('.heatmap-cell').forEach(c=>{c.addEventListener('mouseenter',e=>{const tt=document.getElementById('heatmapTooltip');tt.innerHTML=`<strong>${c.dataset.date}</strong><br>Spent: ${formatCurrency(parseFloat(c.dataset.amount))}`;tt.style.display='block';tt.style.left=(e.pageX+10)+'px';tt.style.top=(e.pageY-30)+'px';});c.addEventListener('mouseleave',()=>{document.getElementById('heatmapTooltip').style.display='none';});});}
    function parseStatement(txt){const txns=[],clean=txt.replace(/\s+/g,' '),dp=/(\d{2}\.\d{2}\.\d{2})/g,dates=[];let m;while((m=dp.exec(clean))!==null)dates.push({date:m[1],index:m.index});for(let i=0;i<dates.length;i++){const seg=clean.substring(dates[i].index,(i+1<dates.length)?dates[i+1].index:clean.length).trim();if(/STANJE|SKUPNI|Datum izpiska|predhodnega|LETNA OBRESTNA|EUR\s*-\s*EVRO|NLB PAKET|Obvestilo|Varnostna/i.test(seg))continue;const dt=dates[i].date,ap=/([+-]?\d{1,3}(?:\.\d{3})*,\d{2})/g,amts=[];let am;while((am=ap.exec(seg))!==null)amts.push(am[1]);if(amts.length>=2){const as=amts[amts.length-2],bs=amts[amts.length-1];let amt=parseFloat(as.replace(/\./g,'').replace(',','.'));const bal=parseFloat(bs.replace(/\./g,'').replace(',','.'));let desc=seg.substring(dt.length,seg.indexOf(amts[0])).trim().replace(/^\s*[\.,]\s*/,'').trim();if(!desc||desc.length<2)continue;const isInc=as.startsWith('+')||/ADRIAL|REDNO DELO|RETURN|SICOD|VRACILO/i.test(desc);if(!as.startsWith('+')&&!as.startsWith('-')&&!isInc)amt=-Math.abs(amt);let cat=categorize(desc);if(amt>0&&cat==='Other')cat='Income';const pd=parseDate(dt);if(pd)txns.push({id:`${dt}-${txns.length}-${Math.random().toString(36).substr(2,5)}`,date:dt,parsedDate:pd,year:pd.getFullYear(),month:pd.getMonth(),weekday:pd.getDay(),description:desc,amount:amt,balance:bal,category:cat});}}return txns;}
    async function extractPDF(f){const ab=await f.arrayBuffer(),pdf=await pdfjsLib.getDocument({data:ab}).promise;let txt='';for(let i=1;i<=pdf.numPages;i++){const pg=await pdf.getPage(i),ct=await pg.getTextContent();let ly=null;ct.items.forEach(it=>{if(ly!==null&&Math.abs(it.transform[5]-ly)>5)txt+='\n';txt+=it.str+' ';ly=it.transform[5];});txt+='\n';}return txt;}
    async function handleFiles(files){const pdfs=Array.from(files).filter(f=>f.name.toLowerCase().endsWith('.pdf'));if(!pdfs.length)return;document.getElementById('uploadContent').classList.add('hidden');document.getElementById('uploadLoading').classList.remove('hidden');document.getElementById('errorBox').classList.add('hidden');try{for(let i=0;i<pdfs.length;i++){const f=pdfs[i];if(uploadedFiles.includes(f.name))continue;document.getElementById('loadingStatus').textContent=`Processing ${i+1}/${pdfs.length}: ${f.name}`;const txt=await extractPDF(f),parsed=parseStatement(txt);allTransactions=[...allTransactions,...parsed];uploadedFiles.push(f.name);}const seen=new Set();allTransactions=allTransactions.filter(t=>{const k=`${t.date}-${t.description}-${t.amount}`;if(seen.has(k))return false;seen.add(k);return true;});allTransactions.sort((a,b)=>(a.parsedDate?.getTime()||0)-(b.parsedDate?.getTime()||0));saveData();applyFilters();}catch(e){document.getElementById('errorBox').textContent=`Error: ${e.message}`;document.getElementById('errorBox').classList.remove('hidden');}document.getElementById('uploadContent').classList.remove('hidden');document.getElementById('uploadLoading').classList.add('hidden');}
    function saveData(){try{localStorage.setItem('bankAnalyzer',JSON.stringify({transactions:allTransactions.map(t=>({...t,parsedDate:t.parsedDate?.toISOString()})),uploadedFiles}));}catch(e){}}
    function loadData(){try{const s=localStorage.getItem('bankAnalyzer');if(s){const d=JSON.parse(s);allTransactions=(d.transactions||[]).map(t=>{const pd=t.parsedDate?new Date(t.parsedDate):parseDate(t.date);return{...t,parsedDate:pd,year:pd?.getFullYear()||2025,month:pd?.getMonth()||0,weekday:pd?.getDay()||0};}).filter(t=>t.parsedDate);uploadedFiles=d.uploadedFiles||[];}}catch(e){allTransactions=[];uploadedFiles=[];}}
    function clearAllData(){if(confirm('Clear all data?')){localStorage.removeItem('bankAnalyzer');location.reload();}}
    function filterByCategory(c){selectedCategory=selectedCategory===c?null:c;applyFilters();}
    function clearCategoryFilter(){selectedCategory=null;applyFilters();}
    function selectMonth(m){selectedMonth=selectedMonth===m?'all':m;applyFilters();}
    function resetFilters(){selectedYear='all';selectedMonth='all';selectedCategory=null;searchQuery='';document.getElementById('yearFilter').value='all';document.getElementById('searchBox').value='';applyFilters();}
    function applyFilters(){selectedYear=document.getElementById('yearFilter')?.value||'all';searchQuery=document.getElementById('searchBox')?.value?.toLowerCase()||'';filteredTransactions=allTransactions.filter(t=>{if(!t.parsedDate)return false;if(selectedYear!=='all'&&t.year!==parseInt(selectedYear))return false;if(selectedMonth!=='all'&&t.month!==parseInt(selectedMonth))return false;if(selectedCategory&&t.category!==selectedCategory)return false;if(searchQuery&&!t.description.toLowerCase().includes(searchQuery))return false;return true;});showAll=false;render();}
    function toggleShowAll(){showAll=!showAll;renderTransactions();}
    function exportToCSV(){const h=['Date','Weekday','Description','Amount','Balance','Category'],r=filteredTransactions.map(t=>[t.date,WEEKDAYS[t.weekday],`"${t.description.replace(/"/g,'""')}"`,t.amount.toFixed(2),t.balance.toFixed(2),t.category]),csv=[h.join(','),...r.map(x=>x.join(','))].join('\n'),blob=new Blob([csv],{type:'text/csv'}),link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=`bank-${new Date().toISOString().split('T')[0]}.csv`;link.click();}
    function getMonthComparison(){if(!allTransactions.length)return null;let cm,cy;if(selectedMonth!=='all'&&selectedYear!=='all'){cm=parseInt(selectedMonth);cy=parseInt(selectedYear);}else{const lt=allTransactions.filter(t=>t.parsedDate).pop();if(!lt)return null;cm=lt.month;cy=lt.year;}const pm=cm===0?11:cm-1,py=cm===0?cy-1:cy;const cd=allTransactions.filter(t=>t.year===cy&&t.month===cm),pd=allTransactions.filter(t=>t.year===py&&t.month===pm);if(!cd.length&&!pd.length)return null;const ce=Math.abs(cd.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0)),pe=Math.abs(pd.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0)),ci=cd.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),pi=pd.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0);return{currentMonth:FULL_MONTHS[cm],currentYear:cy,prevMonth:FULL_MONTHS[pm],prevYear:py,currentExpenses:ce,prevExpenses:pe,currentIncome:ci,prevIncome:pi,expenseChange:pe>0?((ce-pe)/pe)*100:0,incomeChange:pi>0?((ci-pi)/pi)*100:0};}
    function render(){document.getElementById('fileTags').innerHTML=uploadedFiles.map(f=>`<span class="file-tag">üìÑ ${f}</span>`).join('');if(!allTransactions.length){document.getElementById('emptyState').classList.remove('hidden');document.getElementById('dashboard').classList.add('hidden');document.getElementById('headerActions').classList.add('hidden');return;}document.getElementById('emptyState').classList.add('hidden');document.getElementById('dashboard').classList.remove('hidden');document.getElementById('headerActions').classList.remove('hidden');const yrs=[...new Set(allTransactions.map(t=>t.year))].sort();document.getElementById('yearFilter').innerHTML='<option value="all">All Years</option>'+yrs.map(y=>`<option value="${y}" ${selectedYear==y?'selected':''}>${y}</option>`).join('');document.getElementById('monthPills').innerHTML=`<span class="month-pill ${selectedMonth==='all'?'active':''}" onclick="selectMonth('all')">All</span>`+MONTHS.map((m,i)=>`<span class="month-pill ${selectedMonth===i?'active':''}" onclick="selectMonth(${i})">${m}</span>`).join('');const income=filteredTransactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),expenses=Math.abs(filteredTransactions.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0)),net=income-expenses,sr=income>0?((income-expenses)/income)*100:0,sc=sr>=20?'good':sr>=10?'ok':'bad';const vt=filteredTransactions.filter(t=>t.parsedDate),dr=vt.length?`${vt[0].date} - ${vt[vt.length-1].date}`:'-',days=vt.length>1?Math.max(1,Math.ceil((vt[vt.length-1].parsedDate-vt[0].parsedDate)/86400000)):1;document.getElementById('totalIncome').textContent=formatCurrency(income);document.getElementById('totalExpenses').textContent=formatCurrency(expenses);document.getElementById('netBalance').textContent=(net>=0?'+':'')+formatCurrency(net);document.getElementById('netBalance').className='card-value '+(net>=0?'blue':'red');document.getElementById('incomeCount').textContent=`${filteredTransactions.filter(t=>t.amount>0).length} txns`;document.getElementById('expenseCount').textContent=`${filteredTransactions.filter(t=>t.amount<0).length} txns`;document.getElementById('savingsRate').textContent=sr.toFixed(1)+'%';document.getElementById('savingsGauge').style.width=Math.max(0,Math.min(100,sr))+'%';document.getElementById('savingsGauge').className='savings-gauge-fill '+sc;document.getElementById('txnTotal').textContent=filteredTransactions.length;document.getElementById('dateRange').textContent=dr;document.getElementById('avgDaily').textContent=`Avg/day: ${formatCurrency(expenses/days)}`;const comp=getMonthComparison();if(comp&&(comp.prevExpenses>0||comp.currentExpenses>0)){document.getElementById('comparisonBox').classList.remove('hidden');document.getElementById('comparisonGrid').innerHTML=`<div class="comparison-item"><div class="comparison-label">üìÖ ${comp.currentMonth} ${comp.currentYear}</div><div class="comparison-value" style="color:#fb7185">${formatCurrency(comp.currentExpenses)}</div><div class="comparison-change ${comp.expenseChange>0?'up':comp.expenseChange<0?'down':'neutral'}">${comp.expenseChange>0?'‚Üë':comp.expenseChange<0?'‚Üì':'‚Üí'} ${Math.abs(comp.expenseChange).toFixed(1)}%</div></div><div class="comparison-item"><div class="comparison-label">üìÖ ${comp.prevMonth} ${comp.prevYear}</div><div class="comparison-value" style="color:var(--text-secondary)">${formatCurrency(comp.prevExpenses)}</div><div class="comparison-change neutral">Previous</div></div><div class="comparison-item"><div class="comparison-label">üí∞ Income Œî</div><div class="comparison-value" style="color:${comp.incomeChange>=0?'#34d399':'#fb7185'}">${comp.incomeChange>=0?'+':''}${comp.incomeChange.toFixed(1)}%</div><div class="comparison-change neutral">${formatCurrency(comp.currentIncome)} vs ${formatCurrency(comp.prevIncome)}</div></div><div class="comparison-item"><div class="comparison-label">üíµ Diff</div><div class="comparison-value" style="color:${comp.currentExpenses<=comp.prevExpenses?'#34d399':'#fb7185'}">${comp.currentExpenses<=comp.prevExpenses?'‚àí':'+'}${formatCurrency(Math.abs(comp.currentExpenses-comp.prevExpenses))}</div><div class="comparison-change ${comp.currentExpenses<=comp.prevExpenses?'down':'up'}">${comp.currentExpenses<=comp.prevExpenses?'Saved!':'Spent more'}</div></div>`;}else{document.getElementById('comparisonBox').classList.add('hidden');}renderHeatmap();renderWeekday();renderRecurring();renderMerchants();const catTotals={};filteredTransactions.filter(t=>t.amount<0).forEach(t=>{catTotals[t.category]=(catTotals[t.category]||0)+Math.abs(t.amount);});const sortedCats=Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);document.getElementById('categoryList').innerHTML=sortedCats.map(([cat,amt])=>{const cfg=CATEGORIES[cat]||CATEGORIES.Other,pct=expenses>0?((amt/expenses)*100).toFixed(1):'0';return`<div class="category-item ${selectedCategory===cat?'active':''}" onclick="filterByCategory('${cat}')"><div class="category-icon" style="background:${cfg.color}20">${cfg.icon}</div><div class="category-info"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span class="category-name">${cat}</span><span class="category-amount">${formatCurrency(amt)}</span></div><div class="category-bar"><div class="category-bar-fill" style="width:${pct}%;background:${cfg.color}"></div></div></div><span class="category-percent">${pct}%</span></div>`;}).join('');renderTopExpenses();renderCharts(sortedCats);renderMonthlyChart();renderTransactions();}
    function renderWeekday(){const d=getWeekdaySpending(filteredTransactions),mx=d.reduce((m,x)=>x.total>m.total?x:m,d[0]);document.getElementById('weekdayBars').innerHTML=d.map((x,i)=>`<div class="weekday-bar ${x.name===mx.name?'highlight':''}"><div class="weekday-bar-value">${formatCurrency(x.total)}</div><div class="weekday-bar-fill" style="height:${x.percent}%;background:${WEEKDAY_COLORS[i]}"></div><div class="weekday-bar-label">${x.name}</div></div>`).join('');}
    function renderRecurring(){const r=detectRecurring(filteredTransactions);document.getElementById('recurringCount').textContent=r.length;document.getElementById('recurringList').innerHTML=r.length?r.map(x=>`<div class="recurring-item"><div class="recurring-icon">üîÑ</div><div class="recurring-info"><div class="recurring-name">${x.merchant}</div><div class="recurring-pattern">${x.pattern} ‚Ä¢ ${x.count}√ó</div></div><div style="text-align:right"><div class="recurring-value">${formatCurrency(-x.amount)}</div><div class="recurring-freq">Total: ${formatCurrency(-x.totalSpent)}</div></div></div>`).join(''):'<div class="no-data">No recurring found</div>';}
    function renderMerchants(){const{byAmount,byFrequency}=getMerchantRankings(filteredTransactions);document.getElementById('merchantsByAmount').innerHTML=byAmount.length?byAmount.map((m,i)=>`<div class="merchant-item"><div class="merchant-rank">${i+1}</div><div class="merchant-info"><div class="merchant-name">${m.name}</div><div class="merchant-stats">${m.count} visits</div></div><div class="merchant-total">${formatCurrency(-m.total)}</div></div>`).join(''):'<div class="no-data">No data</div>';document.getElementById('merchantsByFrequency').innerHTML=byFrequency.length?byFrequency.map((m,i)=>`<div class="merchant-item"><div class="merchant-rank">${i+1}</div><div class="merchant-info"><div class="merchant-name">${m.name}</div><div class="merchant-stats">${formatCurrency(-m.total)}</div></div><div style="text-align:right"><div class="merchant-total" style="color:#22d3ee">${m.count}√ó</div></div></div>`).join(''):'<div class="no-data">No data</div>';}
    function renderTopExpenses(){const t=filteredTransactions.filter(x=>x.amount<0).sort((a,b)=>a.amount-b.amount).slice(0,10);document.getElementById('topExpensesList').innerHTML=t.map((x,i)=>{const cfg=CATEGORIES[x.category]||CATEGORIES.Other;return`<div class="top-expense-item"><div class="top-expense-rank ${i===0?'':i<3?'silver':'bronze'}">${i+1}</div><div class="category-icon" style="background:${cfg.color}20;width:32px;height:32px;font-size:14px">${cfg.icon}</div><div class="top-expense-details"><div class="top-expense-desc">${x.description}</div><div class="top-expense-meta">${x.date} ‚Ä¢ ${x.category}</div></div><div class="top-expense-amount">${formatCurrency(x.amount)}</div></div>`;}).join('');}
    function renderCharts(sortedCats){const tc=isDarkMode?'#94a3b8':'#64748b',gc=isDarkMode?'#334155':'#e2e8f0';const pc=document.getElementById('pieChart').getContext('2d');if(pieChart)pieChart.destroy();if(sortedCats.length){pieChart=new Chart(pc,{type:'doughnut',data:{labels:sortedCats.map(([c])=>c),datasets:[{data:sortedCats.map(([,v])=>v),backgroundColor:sortedCats.map(([c])=>(CATEGORIES[c]||CATEGORIES.Other).color),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${formatCurrency(ctx.raw)}`}}},onClick:(e,el)=>{if(el.length)filterByCategory(sortedCats[el[0].index][0]);}}});}const lc=document.getElementById('lineChart').getContext('2d');if(lineChart)lineChart.destroy();const db=[];filteredTransactions.forEach(t=>{const ex=db.find(d=>d.date===t.date);if(ex)ex.balance=t.balance;else db.push({date:t.date,balance:t.balance});});if(db.length){lineChart=new Chart(lc,{type:'line',data:{labels:db.map(d=>d.date),datasets:[{data:db.map(d=>d.balance),borderColor:'#22d3ee',backgroundColor:'rgba(34,211,238,0.1)',fill:true,tension:0.3,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:gc},ticks:{color:tc,maxTicksLimit:8}},y:{grid:{color:gc},ticks:{color:tc,callback:v=>(v/1000).toFixed(0)+'k'}}}}});}}
    function renderMonthlyChart(){const tc=isDarkMode?'#94a3b8':'#64748b',gc=isDarkMode?'#334155':'#e2e8f0';const ctx=document.getElementById('monthlyChart').getContext('2d');if(monthlyChart)monthlyChart.destroy();const d={};allTransactions.forEach(t=>{if(!t.year||t.month===undefined)return;const k=`${t.year}-${String(t.month+1).padStart(2,'0')}`;if(!d[k])d[k]={income:0,expenses:0};if(t.amount>0)d[k].income+=t.amount;else d[k].expenses+=Math.abs(t.amount);});const m=Object.keys(d).sort();if(m.length){monthlyChart=new Chart(ctx,{type:'bar',data:{labels:m.map(k=>`${MONTHS[parseInt(k.split('-')[1])-1]} ${k.split('-')[0].slice(2)}`),datasets:[{label:'Income',data:m.map(k=>d[k].income),backgroundColor:'#22C55E'},{label:'Expenses',data:m.map(k=>d[k].expenses),backgroundColor:'#fb7185'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{color:tc,usePointStyle:true}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`}}},scales:{x:{grid:{display:false},ticks:{color:tc}},y:{grid:{color:gc},ticks:{color:tc,callback:v=>(v/1000).toFixed(0)+'k'}}}}});}}
    function renderTransactions(){const disp=showAll?filteredTransactions.slice().reverse():filteredTransactions.slice(-15).reverse();document.getElementById('txnTitle').textContent=selectedCategory||'Transactions';document.getElementById('clearCatFilter').classList.toggle('hidden',!selectedCategory);document.getElementById('txnListCount').textContent=`${filteredTransactions.length} items`;document.getElementById('transactionList').innerHTML=disp.map(t=>{const cfg=CATEGORIES[t.category]||CATEGORIES.Other,pos=t.amount>0;return`<div class="transaction"><div class="transaction-icon" style="background:${cfg.color}20">${cfg.icon}</div><div class="transaction-details"><div class="transaction-desc">${t.description}</div><div class="transaction-meta">${t.date} ‚Ä¢ ${WEEKDAYS[t.weekday]}<span class="transaction-cat" style="background:${cfg.color}20;color:${cfg.color}">${t.category}</span></div></div><div class="transaction-amount"><div class="transaction-amount-value ${pos?'positive':''}">${pos?'+':''}${formatCurrency(t.amount)}</div><div class="transaction-balance">Bal: ${formatCurrency(t.balance)}</div></div></div>`;}).join('');const btn=document.getElementById('showMoreBtn');if(filteredTransactions.length>15){btn.classList.remove('hidden');btn.textContent=showAll?'‚ñ≤ Show less':`‚ñº Show all ${filteredTransactions.length}`;}else{btn.classList.add('hidden');}}
    document.getElementById('uploadZone').addEventListener('click',()=>document.getElementById('fileInput').click());document.getElementById('fileInput').addEventListener('change',e=>handleFiles(e.target.files));const uz=document.getElementById('uploadZone');uz.addEventListener('dragover',e=>{e.preventDefault();uz.classList.add('dragging');});uz.addEventListener('dragleave',()=>uz.classList.remove('dragging'));uz.addEventListener('drop',e=>{e.preventDefault();uz.classList.remove('dragging');handleFiles(e.dataTransfer.files);});
    loadTheme();loadData();applyFilters();console.log('Bank Analyzer v5 loaded!');
  </script>
</body>
</html>
